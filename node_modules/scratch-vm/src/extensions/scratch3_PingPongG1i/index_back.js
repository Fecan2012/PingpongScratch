const ArgumentType = require('../../extension-support/argument-type');
const BlockType = require('../../extension-support/block-type');
const log = require('../../util/log');
const cast = require('../../util/cast');
const formatMessage = require('format-message');
const BLE = require('../../io/blepingpong');
const Base64Util = require('../../util/base64-util');

const PingPongUtil = require('../../util/pingpong-util');
const blockIconURI = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAABQCAYAAACOEfKtAAAACXBIWXMAAC4jAAAuIwF4pT92AAAF+mlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxNDUgNzkuMTYzNDk5LCAyMDE4LzA4LzEzLTE2OjQwOjIyICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdEV2dD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlRXZlbnQjIiB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iIHhtbG5zOnBob3Rvc2hvcD0iaHR0cDovL25zLmFkb2JlLmNvbS9waG90b3Nob3AvMS4wLyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ0MgMjAxOSAoV2luZG93cykiIHhtcDpDcmVhdGVEYXRlPSIyMDE5LTA2LTA0VDEzOjU4OjA1KzA5OjAwIiB4bXA6TWV0YWRhdGFEYXRlPSIyMDE5LTA2LTA0VDEzOjU4OjA1KzA5OjAwIiB4bXA6TW9kaWZ5RGF0ZT0iMjAxOS0wNi0wNFQxMzo1ODowNSswOTowMCIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDowZDFjYTFiNC0xMTQxLWI1NDgtOTM4Mi1hNTI1ZDVjOGQ2YjUiIHhtcE1NOkRvY3VtZW50SUQ9ImFkb2JlOmRvY2lkOnBob3Rvc2hvcDo5YmZhZjExNi1lNjNlLWNjNDEtOTUwMC1iNjIwOTcyNjc5OTkiIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDphYThlMTc5NC02MDgxLTc0NDctYjc0MC00NzA3NTc4NTFiNTEiIGRjOmZvcm1hdD0iaW1hZ2UvcG5nIiBwaG90b3Nob3A6Q29sb3JNb2RlPSIzIiBwaG90b3Nob3A6SUNDUHJvZmlsZT0ic1JHQiBJRUM2MTk2Ni0yLjEiPiA8eG1wTU06SGlzdG9yeT4gPHJkZjpTZXE+IDxyZGY6bGkgc3RFdnQ6YWN0aW9uPSJjcmVhdGVkIiBzdEV2dDppbnN0YW5jZUlEPSJ4bXAuaWlkOmFhOGUxNzk0LTYwODEtNzQ0Ny1iNzQwLTQ3MDc1Nzg1MWI1MSIgc3RFdnQ6d2hlbj0iMjAxOS0wNi0wNFQxMzo1ODowNSswOTowMCIgc3RFdnQ6c29mdHdhcmVBZ2VudD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTkgKFdpbmRvd3MpIi8+IDxyZGY6bGkgc3RFdnQ6YWN0aW9uPSJzYXZlZCIgc3RFdnQ6aW5zdGFuY2VJRD0ieG1wLmlpZDowZDFjYTFiNC0xMTQxLWI1NDgtOTM4Mi1hNTI1ZDVjOGQ2YjUiIHN0RXZ0OndoZW49IjIwMTktMDYtMDRUMTM6NTg6MDUrMDk6MDAiIHN0RXZ0OnNvZnR3YXJlQWdlbnQ9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE5IChXaW5kb3dzKSIgc3RFdnQ6Y2hhbmdlZD0iLyIvPiA8L3JkZjpTZXE+IDwveG1wTU06SGlzdG9yeT4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz7FC+CWAAAQEElEQVR4nO2de3RU1b3HP3ufM2fOZGYyScgDCCDyEkUpCMhLRLtc7QIr+MJetb1FbSlWrVrrxdfycX20YlsUvF5UxFWr3iuoveIDxFd9AIr3ahVUEAWFQEKSSSaZ98w5Z98/Jokg5DmTEGg/a80KrJWc/Tvf7N9+/H6/vSMia8t3Avn0EC4djHwNDCCiUJaiMmjzZYVFZdChOmQTiamD/mzAJykrlJQWagwt1+jXR0O4BHgFpCDVaJO2eupNAGjUgQGA6K4WlAKP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';
var GroupId="";
try {
   GroupId = document.getElementById('isGroup').value == "false" ? "" : document.getElementById('groupId').value;
}catch(e){

}
const BLEUUID = {
    namePrefix: 'PINGPONG.'+GroupId,
    service: '6e400001-b5a3-f393-e0a9-e50e24dcca9e',
    txChar: '6e400002-b5a3-f393-e0a9-e50e24dcca9e',
    rxChar: '6e400003-b5a3-f393-e0a9-e50e24dcca9e',
    groupID: GroupId
};
class PingPongG1i {

    constructor (runtime, extensionId) {
        this._runtime = runtime;

        this._ble = null;
        this._runtime.registerPeripheralExtension(extensionId, this);

        this._extensionId = extensionId;

        this.disconnect = this.disconnect.bind(this);
        this._onConnect = this._onConnect.bind(this);
        this._onMessage = this._onMessage.bind(this);

        this.connectCount = 2;

        this.AllConnected = false;

        this._sensors = {
            C1tiltX: 0,
            C1tiltY: 0,
            C1tiltZ: 0,

            C1moveX: 0,
            C1moveY: 0,
            c1moveZ: 0
        };

        this._buttons = {
            C1Button: 0,
        };

        this._proximity = {
            C1ProxOld: 0,
            C1Prox: 0,
            C1ProxInterVal: 0,
        };
    }

    scan() {
        if (this._ble) {
            this._ble.disconnect();
        }
        this._ble = new BLE(this._runtime, this._extensionId, {
            filters: [
                { namePrefix: BLEUUID.namePrefix , groupID: BLEUUID.groupID}
            ]
        }, this._onConnect, this.disconnect, true);
    }

    connect(id) {
        console.log("connect " + id);
        if (this._ble) {
            this._ble.connectPeripheral(id);
        }
    }

    disconnect() {
        if (this._ble) {
            this._ble.disconnect();
        }

        this.AllConnected = false;
    }

    isConnected() {
        let connected = false;
        if (this._ble) {
            connected = this._ble.isConnected();
        }

        if (connected == true)
            return this.AllConnected;

        this.AllConnected = false;
        return this.AllConnected;
    }

    send(message, force = false) {
        if (force == false)
            if (!this.isConnected()) return;

        const data = Base64Util.uint8ArrayToBase64(message);

        this._ble.write(BLEUUID.service, BLEUUID.txChar, data, 'base64', false).then(
            () => {
                console.log("send done to scratch links");
            }
        );
    }

    CheckProximityData(value)
    {
        var x1 = PingPongUtil.getSignedIntfromByteData(value[12]);
        var x2 = PingPongUtil.getSignedIntfromByteData(value[13]);
        var x3 = PingPongUtil.getSignedIntfromByteData(value[14]);
        var xx = PingPongUtil.getACCDataToDegreeMinus90To90fromByteData(value[15]);
        var yy = PingPongUtil.getACCDataToDegreeMinus90To90fromByteData(value[16]);
        yy *= -1;
        var zz = PingPongUtil.getACCDataToDegreeMinus90To90fromByteData(value[17]);


        this._sensors.C1moveX = x1;
        this._sensors.C1moveY = x2;
        this._sensors.C1moveZ = x3;

        this._sensors.C1tiltX = xx;
        this._sensors.C1tiltY = yy;
        this._sensors.C1tiltZ = zz;
        this._buttons.C1Button = value[11];
        
        this._proximity.C1Prox = PingPongUtil.getUnsignedIntfromByteData(value[18]);
        this._proximity.C1ProxInterVal = this._proximity.C1Prox - this._proximity.C1ProxOld;
        this._proximity.C1ProxOld = this._proximity.C1Prox;
    }

    NotificationEventFC(value)
    {
        if (value == null)
            return;
        if (value.byteLength == 20) {
            if (value[6] == 0xb8 && value[5] == 0xc8) {
                if (value[8] == 0x14){
                    this.CheckProximityData(value);
                }
            }
        }

    }

    _onConnect() {
        this._ble.startNotifications(BLEUUID.service, BLEUUID.rxChar, this._onMessage);

        this.AllConnected = true;
        this._runtime.emit(this._runtime.constructor.PERIPHERAL_CONNECTED);

        console.log("pingpong g1i _onconnect called");

        window.setTimeout(() => {
            if (this._ble) {
                console.log("pingpong g1i will send connect color data");
                this.send(PingPongUtil.getOrangeRedForSoundData());
            }
        }, 200);


        window.setTimeout(() => {
            if (this._ble) {
                console.log("PingPongUtil.getSensorsData");

	        this.send(PingPongUtil.getSensorsData(0xff, 10));
	    }
	}, 3000);
    }

    _onMessage (base64) {
        const datas = Base64Util.base64ToUint8Array(base64);

        PingPongUtil.printUint8ArrayToHex(datas, "Notification Data");
        this.NotificationEventFC(datas);
    }
}

const simple_act_degreeradius = {
    degree10: '10',
    degree20: '20',
    degree30: '30',
    degree40: '40',
    degree50: '50',
    degree60: '60',
    degree70: '70',
    degree80: '80',
    degree90: '90',
    degree100: '100',
    degree110: '110',
    degree120: '120',
    degree130: '130',
    degree140: '140',
    degree150: '150',
    degree160: '160',
    degree170: '170',
    degree180: '180',
    degree190: '190',
    degree200: '200',
    degree210: '210',
    degree220: '220',
    degree230: '230',
    degree240: '240',
    degree250: '250',
    degree260: '260',
    degree270: '270',
    degree280: '280',
    degree290: '290',
    degree300: '300',
    degree310: '310',
    degree320: '320',
    degree330: '330',
    degree340: '340',
    degree350: '350',
    degree360: '360'
};

const PingPongG1IButtons = {
    A: 'a'
};

const PingPongG1ILoDirect = {
    L: 'left',
    R: 'right',
};

const PingPongG1ITiltDirection = {
    FRONT: 'front',
    BACK: 'back',
    LEFT: 'left',
    RIGHT: 'right',
    ANY: 'any'
};

const PingPongG1IMoveDirection = {
    LEFT: 'left',
    RIGHT: 'right'
};

const PingPongG1IUpperDirection = {
    FRONT: 'front',
    BACK: 'back',
    LEFT: 'left',
    RIGHT: 'right',
    UP: 'up',
    DOWN: 'down'
};

class Scratch3PingPongG1iBlocks {
    static get EXTENSION_NAME () {
        return 'PingPong G1i';
    }

    static get EXTENSION_ID () {
        return 'PingPongG1i';
    }

    static get TILT_THRESHOLD() {
        return 20;
    }

    static get MOVE_THRESHOLD() {
        return 30;
    }

    get DEGREERADIUSALL() {
        return [
            {
                text: '10',
                value: simple_act_degreeradius.degree10
            },
            {
                text: '20',
                value: simple_act_degreeradius.degree20
            },
            {
                text: '30',
                value: simple_act_degreeradius.degree30
            },
            {
                text: '40',
                value: simple_act_degreeradius.degree40
            },
            {
                text: '50',
                value: simple_act_degreeradius.degree50
            },
            {
                text: '60',
                value: simple_act_degreeradius.degree60
            },
            {
                text: '70',
                value: simple_act_degreeradius.degree70
            },
            {
                text: '80',
                value: simple_act_degreeradius.degree80
            },
            {
                text: '90',
                value: simple_act_degreeradius.degree90
            },
            {
                text: '100',
                value: simple_act_degreeradius.degree100
            },
            {
                text: '110',
                value: simple_act_degreeradius.degree110
            },
            {
                text: '120',
                value: simple_act_degreeradius.degree120
            },
            {
                text: '130',
                value: simple_act_degreeradius.degree130
            },
            {
                text: '140',
                value: simple_act_degreeradius.degree140
            },
            {
                text: '150',
                value: simple_act_degreeradius.degree150
            },
            {
                text: '160',
                value: simple_act_degreeradius.degree160
            },
            {
                text: '170',
                value: simple_act_degreeradius.degree170
            },
            {
                text: '180',
                value: simple_act_degreeradius.degree180
            },
            {
                text: '190',
                value: simple_act_degreeradius.degree190
            },
            {
                text: '200',
                value: simple_act_degreeradius.degree200
            },
            {
                text: '210',
                value: simple_act_degreeradius.degree210
            },
            {
                text: '220',
                value: simple_act_degreeradius.degree220
            },
            {
                text: '230',
                value: simple_act_degreeradius.degree230
            },
            {
                text: '240',
                value: simple_act_degreeradius.degree240
            },
            {
                text: '250',
                value: simple_act_degreeradius.degree250
            },
            {
                text: '260',
                value: simple_act_degreeradius.degree260
            },
            {
                text: '270',
                value: simple_act_degreeradius.degree270
            },
            {
                text: '280',
                value: simple_act_degreeradius.degree280
            },
            {
                text: '290',
                value: simple_act_degreeradius.degree290
            },
            {
                text: '300',
                value: simple_act_degreeradius.degree300
            },
            {
                text: '310',
                value: simple_act_degreeradius.degree310
            },
            {
                text: '320',
                value: simple_act_degreeradius.degree320
            },
            {
                text: '330',
                value: simple_act_degreeradius.degree330
            },
            {
                text: '340',
                value: simple_act_degreeradius.degree340
            },
            {
                text: '350',
                value: simple_act_degreeradius.degree350
            },
            {
                text: '360',
                value: simple_act_degreeradius.degree360
            }
        ];
    }

    get LODIRECT_MENU() {
        return [
            {
                text: formatMessage({
                    id: 'pingpongwormbot.PingPongWormBotLoDirect.R',
                    default: 'clockwise',
                    description: 'lotate clock'
                }),
                value: PingPongG1ILoDirect.R
            },
            {
                text: formatMessage({
                    id: 'pingpongwormbot.PingPongWormBotLoDirect.L',
                    default: 'counterclockwise',
                    description: 'lotate counter clock'
                }),
                value: PingPongG1ILoDirect.L
            }
        ];
    }

    get GESTURES_MENU() {
        return [
            {
                text: 'A',
                value: PingPongG1IButtons.A
            }
        ];
    }

    get UPPER_DIRECTION_MENU() {
        return [
            {
                text: formatMessage({
                    id: 'pingpongg1i.upperDirectionMenu.front',
                    default: 'rectangle',
                    description: 'label for front element in upper direction'
                }),
                value: PingPongG1IUpperDirection.FRONT
            },
            {
                text: formatMessage({
                    id: 'pingpongg1i.upperDirectionMenu.back',
                    default: 'star',
                    description: 'label for front element in upper direction'
                }),
                value: PingPongG1IUpperDirection.BACK
            },
            {
                text: formatMessage({
                    id: 'pingpongg1i.upperDirectionMenu.left',
                    default: 'triangle',
                    description: 'label for front element in upper direction'
                }),
                value: PingPongG1IUpperDirection.LEFT
            },
            {
                text: formatMessage({
                    id: 'pingpongg1i.upperDirectionMenu.right',
                    default: 'circle',
                    description: 'label for front element in upper direction'
                }),
                value: PingPongG1IUpperDirection.RIGHT
            },
            {
                text: formatMessage({
                    id: 'pingpongg1i.upperDirectionMenu.up',
                    default: 'heart',
                    description: 'label for front element in upper direction'
                }),
                value: PingPongG1IUpperDirection.UP
            },
            {
                text: formatMessage({
                    id: 'pingpongg1i.upperDirectionMenu.down',
                    default: 'none',
                    description: 'label for front element in upper direction'
                }),
                value: PingPongG1IUpperDirection.DOWN
            }
        ];
    }

    get TILT_DIRECTION_MENU() {
        return [
            {
                text: formatMessage({
                    id: 'pingpongg1i.tiltDirectionMenu.front',
                    default: 'circle',
                    description: 'label for front element in tilt direction'
                }),
                value: PingPongG1ITiltDirection.FRONT
            },
            {
                text: formatMessage({
                    id: 'pingpongg1i.tiltDirectionMenu.back',
                    default: 'triangle',
                    description: 'label for front element in tilt direction'
                }),
                value: PingPongG1ITiltDirection.BACK
            },
            {
                text: formatMessage({
                    id: 'pingpongg1i.tiltDirectionMenu.left',
                    default: 'rectangle',
                    description: 'label for front element in tilt direction'
                }),
                value: PingPongG1ITiltDirection.LEFT
            },
            {
                text: formatMessage({
                    id: 'pingpongg1i.tiltDirectionMenu.right',
                    default: 'star',
                    description: 'label for front element in tilt direction'
                }),
                value: PingPongG1ITiltDirection.RIGHT
            }
        ];
    }

    get MOVE_DIRECTION_MENU() {
        return [
            {
                text: formatMessage({
                    id: 'PingPongAutoCar.simple_act_direction.left',
                    default: 'left',
                    description: 'label for element in left direction'
                }),
                value: PingPongG1IMoveDirection.LEFT
            },
            {
                text: formatMessage({
                    id: 'PingPongAutoCar.simple_act_direction.right',
                    default: 'right',
                    description: 'label for element in right direction'
                }),
                value: PingPongG1IMoveDirection.RIGHT
            }
        ];
    }

    constructor(runtime) {
        /**
         * The Scratch 3.0 runtime.
         * @type {Runtime}
         */
        this.runtime = runtime;

        // Create a new PingPongG1i peripheral instance
        this._peripheral = new PingPongG1i(this.runtime, Scratch3PingPongG1iBlocks.EXTENSION_ID);

        this.inActionC1C2 = false;
    }

    /**
     * @returns {object} metadata for this extension and its blocks.
     */
    getInfo() {
        return {
            id: Scratch3PingPongG1iBlocks.EXTENSION_ID,
            name: Scratch3PingPongG1iBlocks.EXTENSION_NAME,
            blockIconURI: blockIconURI,
            showStatusButton: true,
            blocks: [
                {
                    opcode: 'whenButtonPressed',
                    text: formatMessage({
                        id: 'pingpongg1i.whenButtonPressed',
                        default: 'button pressed',
                        description: 'when the selected button on the cube is pressed'
                    }),
                    blockType: BlockType.HAT
                },
                {
                    opcode: 'isButtonPressed',
                    text: formatMessage({
                        id: 'pingpongg1i.isButtonPressed',
                        default: 'button pressed?',
                        description: 'is the button on the cube pressed?'
                    }),
                    blockType: BlockType.BOOLEAN
                },
                {
                    opcode: 'whenTilted',
                    text: formatMessage({
                        id: 'pingpongg1i.whenTilted',
                        default: 'tilted to [DIRECTION]',
                        description: 'is the cube is tilted in a direction?'
                    }),
                    blockType: BlockType.HAT,
                    arguments: {
                        DIRECTION: {
                            type: ArgumentType.STRING,
                            menu: 'tiltDirectionAny',
                            defaultValue: PingPongG1ITiltDirection.FRONT
                        }
                    }
                },
                {
                    opcode: 'whenMoved',
                    text: formatMessage({
                        id: 'pingpongg1i.whenMoved',
                        default: 'when cube moved to [DIRECTIONM]',
                        description: 'is the cube is moved in a direction?'
                    }),
                    blockType: BlockType.HAT,
                    arguments: {
                        DIRECTIONM: {
                            type: ArgumentType.STRING,
                            menu: 'moveDirection',
                            defaultValue: PingPongG1IMoveDirection.LEFT
                        }
                    }
                },
                {
                    opcode: 'isTilted',
                    text: formatMessage({
                        id: 'pingpongg1i.isTilted',
                        default: 'cube tilted to [DIRECTION]?',
                        description: 'is the cube is tilted in a direction?'
                    }),
                    blockType: BlockType.BOOLEAN,
                    arguments: {
                        DIRECTION: {
                            type: ArgumentType.STRING,
                            menu: 'tiltDirectionAny',
                            defaultValue: PingPongG1ITiltDirection.FRONT
                        }
                    }
                },
                {
                    opcode: 'motor1',
                    text: formatMessage({
                        id: 'pingpongg1i.motor1',
                        default: 'rotate [RADIUS] degrees [LODIRECT]',
                        description: 'move motor direction'
                    }),
                    arguments: {
                        LODIRECT: {
                            type: ArgumentType.STRING,
                            menu: 'lodirect',
                            defaultValue: PingPongG1ILoDirect.R
                        },
                        RADIUS: {
                            type: ArgumentType.STRING,
                            menu: 'radius',
                            defaultValue: simple_act_degreeradius.degree90
                        }
                    }
                }
                ,
                {
                    opcode: 'getGyroXCCircle',
                    text: formatMessage({
                        id: 'pingpongg1i.getGyroXCCircle',
                        default: 'tilt angle to circle',
                        description: 'the value returned by the distance sensor'
                    }),
                    blockType: BlockType.REPORTER
                }
                ,
                {
                    opcode: 'getGyroXCTriangle',
                    text: formatMessage({
                        id: 'pingpongg1i.getGyroXCTriangle',
                        default: 'tilt angle to triangle',
                        description: 'the value returned by the distance sensor'
                    }),
                    blockType: BlockType.REPORTER
                },
                {
                    opcode: 'getGyroYCStar',
                    text: formatMessage({
                        id: 'pingpongg1i.getGyroYCStar',
                        default: 'tilt angle to star',
                        description: 'the value returned by the distance sensor'
                    }),
                    blockType: BlockType.REPORTER
                },
                {
                    opcode: 'getGyroYCSquare',
                    text: formatMessage({
                        id: 'pingpongg1i.getGyroYCSquare',
                        default: 'tilt angle to rectanble',
                        description: 'the value returned by the distance sensor'
                    }),
                    blockType: BlockType.REPORTER
                },/*
                {
                    opcode: 'getButtonC1',
                    text: formatMessage({
                        id: 'pingpongg1i.getButtonC1',
                        default: '큐브 버튼 눌림',
                        description: 'the value returned by the distance sensor'
                    }),
                    blockType: BlockType.REPORTER
                },
                {
                    opcode: 'getUpper',
                    text: formatMessage({
                        id: 'pingpongg1i.getUpper',
                        default: '큐브 윗면',
                        description: 'the value returned by the distance sensor'
                    }),
                    blockType: BlockType.REPORTER
                },*/
                {
                    opcode: 'isUpper',
                    text: formatMessage({
                        id: 'pingpongg1i.isUpper',
                        default: '[DIRECTION] shown in top view?',
                        description: 'is the cube is tilted in a direction?'
                    }),
                    blockType: BlockType.BOOLEAN,
                    arguments: {
                        DIRECTION: {
                            type: ArgumentType.STRING,
                            menu: 'upperDirection',
                            defaultValue: PingPongG1IUpperDirection.FRONT
                        }
                    }
                }
            ],
            menus: {
                upperDirection: this.UPPER_DIRECTION_MENU,
                tiltDirectionAny: this.TILT_DIRECTION_MENU,
                moveDirection: this.MOVE_DIRECTION_MENU,
                lodirect: this.LODIRECT_MENU,
                radius: this.DEGREERADIUSALL
//                gestures: this.GESTURES_MENU
            }
        };
    }

    _isTilted(direction) {
        switch (direction) {
            case PingPongG1ITiltDirection.ANY:
                return (Math.abs(this._peripheral.tiltX) >= Scratch3PingPongG1iBlocks.TILT_THRESHOLD) ||
                    (Math.abs(this._peripheral.tiltY) >= Scratch3PingPongG1iBlocks.TILT_THRESHOLD);
            default:
                return this._getTiltAngle(direction) >= Scratch3PingPongG1iBlocks.TILT_THRESHOLD;
        }
    }


    _isTiltedC1(direction) {
        switch (direction) {
            case PingPongG1ITiltDirection.ANY:
                return (Math.abs(this._peripheral._sensors.C1tiltX) >= Scratch3PingPongG1iBlocks.TILT_THRESHOLD) ||
                    (Math.abs(this._peripheral._sensors.C1tiltY) >= Scratch3PingPongG1iBlocks.TILT_THRESHOLD);
            default:
                return this._getTiltAngleC1(direction) >= Scratch3PingPongG1iBlocks.TILT_THRESHOLD;
        }
    }

    _isMovedC1(direction) {
        return this._getMoveC1(direction) >= Scratch3PingPongG1iBlocks.MOVE_THRESHOLD;
    }

    _getTiltAngle(direction) {
        switch (direction) {
            case PingPongG1ITiltDirection.FRONT:
                return Math.round(this._peripheral._sensors.C1moveX * -1);
            case PingPongG1ITiltDirection.BACK:
                return Math.round(this._peripheral._sensors.C1moveX);
            case PingPongG1ITiltDirection.LEFT:
                return Math.round(this._peripheral._sensors.C1moveY * -1);
            case PingPongG1ITiltDirection.RIGHT:
                return Math.round(this._peripheral._sensors.C1moveY);
            default:
                log.warn(`Unknown tilt direction in _getTiltAngle: ${direction}`);
        }
    }

    _getTiltAngleC1(direction) {
        switch (direction) {
            case PingPongG1ITiltDirection.FRONT:
                return Math.round(this._peripheral._sensors.C1tiltX * -1);
            case PingPongG1ITiltDirection.BACK:
                return Math.round(this._peripheral._sensors.C1tiltX);
            case PingPongG1ITiltDirection.LEFT:
                return Math.round(this._peripheral._sensors.C1tiltY * -1);
            case PingPongG1ITiltDirection.RIGHT:
                return Math.round(this._peripheral._sensors.C1tiltY);
            default:
                log.warn(`Unknown tilt direction in _getTiltAngle: ${direction}`);
        }
    }

    _getMoveC1(direction) {
        switch (direction) {
            case PingPongG1IMoveDirection.LEFT:
                return Math.round(this._peripheral._sensors.C1moveZ * -1);
            case PingPongG1IMoveDirection.RIGHT:
                return Math.round(this._peripheral._sensors.C1moveZ);
            default:
                log.warn(`Unknown tilt direction in _getTiltMove: ${direction}`);
        }
    }

    isTilted(args) {
        return this._isTiltedC1(args.DIRECTION);
    }

    whenTilted(args) {
        return this._isTiltedC1(args.DIRECTION);
    }

    whenMoved(args) {
        return this._isMovedC1(args.DIRECTIONM);
    }


    motor1(args) {
        if (this._peripheral.AllConnected == false)
            return;

        if (this.inActionC1C2 == true)
            return;

        var Speed = 800;

        this.inActionC1C2 = true;

        if (args.LODIRECT == PingPongG1ILoDirect.L) {
            Speed *= -1;
        }

        var Step = Math.round(args.RADIUS * 5.5);

        console.log(Speed + Step + " " + args.RADIUS + " " + args.RADIUS);

        var OutPutData = PingPongUtil.makeSingleDataByStep(0, 0, Speed, Step);
        OutPutData[12] = 2; // make resume

        var TimeDelay = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed), Step) + 400

        this._peripheral.send(OutPutData);

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2 = false;
                clearInterval(repeat);
                resolve();
            }, TimeDelay);
        });
    }

    whenButtonPressed()
    {
        if (this._peripheral._buttons.C1Button > 0)
            return true;

        return false;
    }

    isButtonPressed() {
        if (this._peripheral._buttons.C1Button > 0)
                return true;

        return false;
    }

    getButtonC1() {
        return this._peripheral._buttons.C1Button;
    }

    getProxiC1Interval() {
        return this._peripheral._proximity.C1ProxInterVal;
    }

    getProxiC1() {
        return this._peripheral._proximity.C1Prox;
    }

    getGyroXC1() {
        return this._peripheral._sensors.C1tiltX;
    }

    getGyroYC1() {
        return this._peripheral._sensors.C1tiltY;
    }

    getGyroZC1() {
        return this._peripheral._sensors.C1tiltZ;
    }

    getGyroXCCircle() {
        return this._peripheral._sensors.C1tiltX * -1;
    }

    getGyroXCTriangle() {
        return this._peripheral._sensors.C1tiltX;
    }

    getGyroYCStar() {
        return this._peripheral._sensors.C1tiltY;
    }

    getGyroYCSquare() {
        return this._peripheral._sensors.C1tiltY * -1;
    }

    getUpper() {
        if (this._peripheral._sensors.C1tiltX > 70)
            return "circle";

        if (this._peripheral._sensors.C1tiltX < -70)
            return "triangle";

        if (this._peripheral._sensors.C1tiltY > 70)
            return "rectangle";

        if (this._peripheral._sensors.C1tiltY < -70)
            return "star";

        if (this._peripheral._sensors.C1tiltZ > 70)
            return "none";

        if (this._peripheral._sensors.C1tiltZ < -70)
            return "heart";

        return "unknown";
    }

    isUpper(args) {

        if (args.DIRECTION == PingPongG1IUpperDirection.FRONT)
        {
            if (this._peripheral._sensors.C1tiltY > 70)
                return true;
        }

        if (args.DIRECTION == PingPongG1IUpperDirection.BACK) {
            if (this._peripheral._sensors.C1tiltY < -70)
                return true;
        }

        if (args.DIRECTION == PingPongG1IUpperDirection.LEFT) {
            if (this._peripheral._sensors.C1tiltX < -70)
                return true;
        }

        if (args.DIRECTION == PingPongG1IUpperDirection.RIGHT) {
            if (this._peripheral._sensors.C1tiltX > 70)
                return true;
        }

        if (args.DIRECTION == PingPongG1IUpperDirection.UP) {
            if (this._peripheral._sensors.C1tiltZ < -70)
                return true;
        }

        if (args.DIRECTION == PingPongG1IUpperDirection.DOWN) {
            if (this._peripheral._sensors.C1tiltZ > 70)
                return true;
        }

        return false;
    }
}

module.exports = Scratch3PingPongG1iBlocks;
