const ArgumentType = require('../../extension-support/argument-type');
const BlockType = require('../../extension-support/block-type');
const log = require('../../util/log');
const cast = require('../../util/cast');
const formatMessage = require('format-message');
const BLE = require('../../io/webble');
const Base64Util = require('../../util/base64-util');

// fldgo addd
const PingPongUtil = require('../../util/pingpong-util');

/**
 * Icon png to be displayed at the left edge of each extension block, encoded as a data URI.
 * @type {string}
 */
// eslint-disable-next-line max-len
//const blockIconURI = 'data:image/png;base64,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';
const blockIconURI = 'data:image/png;base64,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';

var staticAutoCarHandle = null;

const webbleSendDataBufferManager_status = {
    STATUS_NONE: 0,
    STATUS_WAITING: 1
};

const webbleSendDataBufferManager_group = {
    GROUP1: 0,
    GROUP2: 1,
    GROUP3: 2,
    GROUP4: 3,
    GROUP5: 4,
    GROUP6: 5
}

class webbleSendDataBufferStruct {

    constructor(waitResponseOPCode, waitTimeOut, group, data) {
        this.waitResponseOPCode = waitResponseOPCode;
        this.waitTimeOut = waitTimeOut;
        this.group = group;
        this.data = data;
    }
}

class webbleSendDataBufferManager {
    constructor(peripheral) {
        this.SendBufferArray = new Array();

        this.timeOutID = null;
        this.waitSendDoneFlag = false;
        this.waitTimeOutFlag = false;
        this.waitResponseOPCode = -1;

        this._peripheral = peripheral;
    }

    getCountOfSendBuffer() {
        return this.SendBufferArray.length;
    }

    isEmptySendBuffer() {
        if (this.SendBufferArray.length == 0)
            return true;

        return false;
    }

    addSendData(data, first) {
        if (first == true)
            this.SendBufferArray.unshift(data);
        else
            this.SendBufferArray.push(data);
    }

    addSendDataReplaceGroup(data, first) {
        var group = data.group;
        var itemToFind = this.SendBufferArray.findIndex(x => x.group == group);

        if (itemToFind > -1)
            this.SendBufferArray.splice(itemToFind);

        this.addSendData(data, first);
    }

    popData() {
        if (this.isEmptySendBuffer())
            return null;

        var item = this.SendBufferArray[0];

        this.SendBufferArray.splice(0);

        return item;
    }

    runManager() {
        console.log(" runManager 001 ");

        if (this.isEmptySendBuffer())
            return;

        console.log(" runManager 002 " + this.waitTimeOutFlag + " " + this.waitSendDoneFlag);

        if (this.waitTimeOutFlag || this.waitSendDoneFlag)
            return;

        console.log(" runManager 003 ");

        var item = this.popData();

        console.log(" pop data " + item);

        if (item == null)
            return;

        this.waitResponseOPCode = item.waitResponseOPCode;
        this.waitSendDoneFlag = true;

        if (item.waitTimeOut > 200) {
            this.waitTimeOutFlag = true;

            this.timeOutID = window.setTimeout(() => {
                this.timeOutID = null;

                this.waitResponseOPCode = -1;
                this.waitTimeOutFlag = false;
                this.waitsendDoneFlag = false;
                this.runManager();
            }, item.waitTimeOut);
        }

        this._peripheral._ble.write(item.data);
    }

    checkResponseData(datas) {

        if (this.waitResponseOPCode == -1) {
            return;
        }   

        if (datas.byteLength < 7) {
            return;
        }

        console.log("checkresponsedatas " + datas.getUint8(6) + " " + this.waitSendDoneFlag + " " + this.waitResponseOPCode + " " + staticAutoCarHandle.SendBufferManager.waitResponseOPCode );

        if (datas.getUint8(6) == this.waitResponseOPCode) {
            console.log("checkresponsedatas found waitcode " + this.waitResponseOPCode + " " + staticAutoCarHandle.waitScheduledDataResponse + " " + staticAutoCarHandle.sendScheduledData + " " + staticAutoCarHandle.waitScheduledDataResponse);
            
            if (staticAutoCarHandle.waitScheduledDataResponse == true) {
                staticAutoCarHandle.sendScheduledData = true;
                staticAutoCarHandle.waitScheduledDataResponse = false;
            }

            if (this.timeOutID != null) {
                window.clearTimeout(this.timeOutID);
                this.timeOutID = null;

                this.waitResponseOPCode = -1;
                this.waitTimeOutFlag = false;
            }

            this.runManager();
        }

    }
}


/**
 * Manage communication with a PingPong peripheral over a Scrath Link client socket.
 */
class PingPongAutoCar {

    /**
     * Construct a MicroBit communication object.
     * @param {Runtime} runtime - the Scratch 3.0 runtime
     * @param {string} extensionId - the id of the extension
     */
    constructor (runtime, extensionId) {

        /**
         * The Scratch 3.0 runtime used to trigger the green flag button.
         * @type {Runtime}
         * @private
         */
        this._runtime = runtime;

        console.log("pingpong autocar constructor");
        /**
         * The BluetoothLowEnergy connection socket for reading/writing peripheral data.
         * @type {BLE}
         * @private
         */
        this._ble = null;
        this._runtime.registerPeripheralExtension(extensionId, this);

        console.log("pingpong autocar constructor2");


        /**
         * The id of the extension this peripheral belongs to.
         */
        this._extensionId = extensionId;

        /**
         * Interval ID for data reading timeout.
         * @type {number}
         * @private
         */
        this._timeoutID = null;

        console.log("pingpong autocar constructor4");


        /**
         * A flag that is true while we are busy sending data to the BLE socket.
         * @type {boolean}
         * @private
         */
        this._busy = false;

        /**
         * ID for a timeout which is used to clear the busy flag if it has been
         * true for a long time.
         */
        this._busyTimeoutID = null;

        this.disconnect = this.disconnect.bind(this);
        this._onConnect = this._onConnect.bind(this);
        this._onMessage = this._onMessage.bind(this);

        this.waitingConnect = false;
        this.waitingDataSend = false;

        this.serviceUUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
        this.txCharUUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e';
        this.rxCharUUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e';

        this.connectCount = 2;

        this.AllConnected = false;
        this.inAction = false;
        this.sendScheduledData = false;
        this.waitScheduledDataResponse = false;

        staticAutoCarHandle = this;

        ///////////////////////////////////////////////////////////
        this.SendBufferManager = new webbleSendDataBufferManager(this);

        this.receivedLastPointData = -1;
        this.receivedLastPointDone = -1;
        this.waitLastPointDone = false;

        this.receivedNotifyData = null;
        this.bContinueReceived = false;

        this.SafeCheckCount = 0;

        console.log("pingpong autocar constructor5");
    }


    ////////////////////////////////////////////////////////////////////





    ////////////////////////////////////////////////////////////////////

    /**
     * Called by the runtime when user wants to scan for a peripheral.
     */
    scan() {
        console.log("index js scan");
        if (this._ble) {
            this._ble.disconnect();
        }
        this._ble = new BLE(this._runtime, this._extensionId, 0,
            this._onConnect, this._onDisconnect, this._onMessage, this._onDataSendDone, 
            this.serviceUUID, this.txCharUUID, this.rxCharUUID,
            this.connectCount - 1);
    }

    /**
     * Called by the runtime when user wants to connect to a certain peripheral.
     * @param {number} id - the id of the peripheral to connect to.
     */
    connect(id) {
        console.log("index js connect");

        console.log("connect " + id);
        if (this._ble) {
            this._ble.connectPeripheral(id);
        }
    }

    /**
     * Disconnect from the micro:bit.
     */
    disconnect() {
        console.log("index js disconnect");

        this.AllConnected = false;
        window.clearInterval(this._timeoutID);
        if (this._ble) {
            this._ble.write(PingPongUtil.getDisconnectData());
            //            this._ble.disconnect();
        }
    }

    _onDisconnect() {

        console.log("index js onDisconnect");

        staticAutoCarHandle.AllConnected = false;
        staticAutoCarHandle.sendScheduledData = false;
        staticAutoCarHandle.waitScheduledDataResponse = false;

        staticAutoCarHandle._runtime.emit(staticAutoCarHandle._runtime.constructor.PERIPHERAL_DISCONNECTED);

        staticAutoCarHandle._ble._handleRequestError();
//        staticHandler._handleRequestError();
    }

    /**
     * Return true if all pingpong device connected and predata was send
     * @return {boolean} - whether the pingpong is connected.
     */
    isConnected() {
        console.log("index js isConnected  " + this.AllConnected);
        return this.AllConnected;
    }

    send(waitResponseOPcode, waitTimeOut, group, data, first, DELandREP) {
        if (!this.isConnected()) return;
        if (this._busy) return;

        var item = new webbleSendDataBufferStruct(waitResponseOPcode,
            waitTimeOut, group, data);

        if (DELandREP) {
            this.SendBufferManager.addSendDataReplaceGroup(item, first);
        }
        else {
            this.SendBufferManager.addSendData(item, first);
        }

        this.SendBufferManager.runManager();
    }

    NotificationEventFC(event)
    {
        console.log('NotificationEventFC');

        if (event == null)
            return;
        
        this.SendBufferManager.checkResponseData(event.target.value);

        let value = event.target.value
        
        // check and rule policy
        if (value.byteLength == 18)
        {
            if (value.getUint8(6) == 0xad) {
                if (value.getUint8(11) == 0x01) {
                    this.AllConnected = true;
                    this._runtime.emit(this._runtime.constructor.PERIPHERAL_CONNECTED);
                }
            }
        }

        if (value.byteLength == 10) {
            if (value.getUint8(9) == 0xd0) {

                this.receivedLastPointDone = value.getUint8(9);
                //console.log('fldgo003  ' + strSplit.length + " " + strSplit);
            }
        }

    }
  
    /**
     * Starts reading data from peripheral after BLE has connected to it.
     * @private
     */
    _onConnect() {
        console.log("index called _onConnect");
        
        window.setTimeout(() => {
            this._ble.write(PingPongUtil.getSetAggData(this.connectCount - 1));
       //     this._ble.write(PingPongUtil.getSetMultiroleInAction(this.connectCount));
        }, 100);


        // if ble needs predata it will send this time
    }

    /**
     * Process the sensor data from the incoming BLE characteristic.
     * @param {object} base64 - the incoming BLE data.
     * @private
     */
    _onMessage (event) {
        console.log("_onMessage called");

        // The received notification consists of a DataView object, assigned to value
        let value = event.target.value;
        value = value.buffer ? value : new DataView(value);

        var strShow = "";
        console.log("_onMessage " + value.byteLength);
        for (var i = 0; i < value.byteLength; i++) {
            strShow += value.getUint8(i).toString(16) + " "
        }

        console.log(strShow);

        this.NotificationEventFC(event);
    }

    _onDataSendDone(event) {
        console.log("_onDataSendDone called " + staticAutoCarHandle + " " + staticAutoCarHandle.SendBufferManager + " ");

        staticAutoCarHandle.SendBufferManager.waitSendDoneFlag = false;

        if (staticAutoCarHandle.SendBufferManager.waitResponseOPCode == -1) {
            if (staticAutoCarHandle.SendBufferManager.timeOutID != null) {
                window.clearTimeout(this.timeOutID);
                staticAutoCarHandle.SendBufferManager.timeOutID = null;

                staticAutoCarHandle.SendBufferManager.waitTimeOutFlag = false;
                staticAutoCarHandle.SendBufferManager.waitsendDoneFlag = false;
            }
        }

        staticAutoCarHandle.SendBufferManager.runManager();
    }
}

const simple_act_direction = {
    Up: 0,
    Down: 1,
    left: 2,
    right: 3
};

const simple_act_interval = {
    cm10: 10,
    cm20: 20,
    cm30: 30,
    cm40: 40,
    cm50: 50
};

const simple_act_degree = {
    degree90: 90,
    degree180: 180,
    degree270: 270
};

const continuous_act_speed = {
    speedI100: -100,
    speedI90: -90,
    speedI80: -80,
    speedI70: -70,
    speedI60: -60,
    speedI50: -50,
    speedI40: -40,
    speedI30: -30,
    speedI20: -20,
    speedI10: -10,
    speed0: 0,
    speed10: 10,
    speed20: 20,
    speed30: 30,
    speed40: 40,
    speed50: 50,
    speed60: 60,
    speed70: 70,
    speed80: 80,
    speed90: 90,
    speed100: 100
};


/**
 * Scratch 3.0 blocks to interact with a Robo risen peripheral.
 */
class Scratch3PingPongAutoCarBlocks {

    /**
     * @return {string} - the name of this extension.
     */
    static get EXTENSION_NAME () {
        return 'Auto Car';
    }

    /**
     * @return {string} - the ID of this extension.
     */
    static get EXTENSION_ID () {
        return 'PingPongAutoCar';
    }

    get UP_DOWN_DIRECTION() {
        return [
            {
                text: '앞으로',
                value: simple_act_direction.Up
            },
            {
                text: '뒤로',
                value: simple_act_direction.Down
            }
        ];
    }

    get LEFT_RIGHT_DIRECTION() {
        return [
            {
                text: '왼쪽',
                value: simple_act_direction.left
            },
            {
                text: '오른쪽',
                value: simple_act_direction.right
            }
        ];
    }

    get INTERVAL() {
        return [
            {
                text: '10',
                value: simple_act_interval.cm10
            },
            {
                text: '20',
                value: simple_act_interval.cm20
            },
            {
                text: '30',
                value: simple_act_interval.cm30
            },
            {
                text: '40',
                value: simple_act_interval.cm40
            },
            {
                text: '50',
                value: simple_act_interval.cm50
            }
        ];
    }

    get UP_DOWN_CONTINUOUS() {
        return [
            {
                text: '-100',
                value: continuous_act_speed.speedI100
            },
            {
                text: '-80',
                value: continuous_act_speed.speedI80
            },
            {
                text: '-60',
                value: continuous_act_speed.speedI60
            },
            {
                text: '-40',
                value: continuous_act_speed.speedI40
            },
            {
                text: '-20',
                value: continuous_act_speed.speedI20
            },
            {
                text: '0',
                value: continuous_act_speed.speed0
            },
            {
                text: '20',
                value: continuous_act_speed.speed20
            },
            {
                text: '40',
                value: continuous_act_speed.speed40
            },
            {
                text: '60',
                value: continuous_act_speed.speed60
            },
            {
                text: '80',
                value: continuous_act_speed.speed80
            },
            {
                text: '100',
                value: continuous_act_speed.speed100
            }
        ];
    }

    get DEGREE() {
        return [
            {
                text: '90',
                value: simple_act_degree.degree90
            },
            {
                text: '180',
                value: simple_act_degree.degree180
            },
            {
                text: '270',
                value: simple_act_degree.degree270
            }
        ];
    }

    
    /**
     * Construct a set of MicroBit blocks.
     * @param {Runtime} runtime - the Scratch 3.0 runtime.
     */
    constructor (runtime) {
        /**
         * The Scratch 3.0 runtime.
         * @type {Runtime}
         */
        this.runtime = runtime;

        console.log("Scratch3PingPongAutoCarBlocks constructor called 001");

        // Create a new PingPongAutocar peripheral instance
        this._peripheral = new PingPongAutoCar(this.runtime, Scratch3PingPongAutoCarBlocks.EXTENSION_ID);

        console.log("Scratch3PingPongAutoCarBlocks constructor called 002");

        this.frameToggle = false;

        setInterval(() => {
            this.frameToggle = !this.frameToggle;
        }, this.runtime.currentStepTime);

        this.inActionC1C2 = false;

    }

    /**
     * @returns {object} metadata for this extension and its blocks.
     */
    getInfo() {
        console.log("getinfo pingpong autocar called");
        return {
            id: Scratch3PingPongAutoCarBlocks.EXTENSION_ID,
            name: Scratch3PingPongAutoCarBlocks.EXTENSION_NAME,
            blockIconURI: blockIconURI,
            showStatusButton: true,
            blocks: [
                {
                    opcode: 'updownact',
                    text: formatMessage({
                        id: 'pingpongautocar.updownact',
                        default: '[DIRECTION] [INTERVAL]cm 이동하기',
                        description: 'fldgo002'
                    }),
                    arguments: {
                        DIRECTION: {
                            type: ArgumentType.NUMBER,
                            menu: 'updowndirection',
                            defaultValue: simple_act_direction.Up
                        },
                        INTERVAL: {
                            type: ArgumentType.NUMBER,
                            menu: 'interval',
                            defaultValue: simple_act_interval.cm10
                        }
                    }
                },
                {
                    opcode: 'leftrightact',
                    text: formatMessage({
                        id: 'pingpongautocar.leftrightact',
                        default: '[DIRECTION] 으로 [DEGREE]도 회전하기',
                        description: 'fldgo002'
                    }),
                    arguments: {
                        DIRECTION: {
                            type: ArgumentType.NUMBER,
                            menu: 'leftrightdirection',
                            defaultValue: simple_act_direction.left
                        },
                        DEGREE: {
                            type: ArgumentType.NUMBER,
                            menu: 'degree',
                            defaultValue: simple_act_degree.degree90
                        }
                    }
                },
                {
                    opcode: 'updownactC',
                    text: formatMessage({
                        id: 'pingpongautocar.updownactC',
                        default: '왼쪽 바퀴를 속도[SPEED1] 으로 오른쪽바퀴를 속도[SPEED2] 으로 회전하기',
                        description: 'fldgo002'
                    }),
                    arguments: {
                        SPEED1: {
                            type: ArgumentType.NUMBER,
                            menu: 'updowncontinuous',
                            defaultValue: continuous_act_speed.speed100
                        },
                        SPEED2: {
                            type: ArgumentType.NUMBER,
                            menu: 'updowncontinuous',
                            defaultValue: continuous_act_speed.speed100
                        }
                    }
                },
                {
                    opcode: 'updownactCL',
                    text: formatMessage({
                        id: 'pingpongautocar.updownactCL',
                        default: '왼쪽 바퀴를 속도[SPEED1] 으로 회전하기',
                        description: 'fldgo002'
                    }),
                    arguments: {
                        SPEED1: {
                            type: ArgumentType.NUMBER,
                            menu: 'updowncontinuous',
                            defaultValue: simple_act_direction.Up
                        }
                    }
                },
                {
                    opcode: 'updownactCR',
                    text: formatMessage({
                        id: 'pingpongautocar.updownactCR',
                        default: '오른쪽 바퀴를 속도[SPEED1] 으로 회전하기',
                        description: 'fldgo002'
                    }),
                    arguments: {
                        SPEED1: {
                            type: ArgumentType.NUMBER,
                            menu: 'updowncontinuous',
                            defaultValue: simple_act_direction.Up
                        }
                    }
                }
            ],
            menus: {
                updowndirection: this.UP_DOWN_DIRECTION,
                leftrightdirection: this.LEFT_RIGHT_DIRECTION,
                interval: this.INTERVAL,
                updowncontinuous: this.UP_DOWN_CONTINUOUS,
                degree: this.DEGREE
            }
        };
    }

    checkEndActionData() {
        console.log("hahaha : " + this._peripheral.receivedLastPointData);
        
        if (this._peripheral.receivedLastPointDone == 0xd0) {
            this._peripheral.receivedLastPointDone = -1;
            this._peripheral.SafeCheckCount = 0;
            return true;
        }

        if (this._peripheral.isConnected() == false)
        {
            this._peripheral.receivedLastPointDone = -1;
            this._peripheral.SafeCheckCount = 0;
            return true;
        }

        if (this._peripheral.SafeCheckCount++ > 6) {
            this._peripheral.receivedLastPointDone = -1;
            this._peripheral.SafeCheckCount = 0;
            return true;
        }

        return false;
    }

    
    updownact(args) {
        console.log("updownAct " + args.DIRECTION + " " + args.INTERVAL);

        if (this._peripheral.AllConnected == false)
            return;

        if (this.inActionC1C2 == true)
            return;
        
        if (args.DIRECTION != simple_act_direction.Up && args.DIRECTION != simple_act_direction.Down) {
            console.log("updwonAct unknown direction!");
            return;
        }

        this.inActionC1C2 = true;

        var Speed = 80;


        if (args.DIRECTION == simple_act_direction.Down) {
            Speed *= -1;
        }

        var SinglesData = new Array(2);
        SinglesData[0] = PingPongUtil.makeSingleData(0, 0, Speed * -1, args.INTERVAL, 24.44444);
        SinglesData[1] = PingPongUtil.makeSingleData(1, 0, Speed, args.INTERVAL, 24.44444);

        SinglesData[0][4] = 0x20; // make grouping
        SinglesData[1][4] = 0x20; // make grouping

        SinglesData[0][12] = 2; // make resume
        SinglesData[1][12] = 2; // make resume


        var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(SinglesData, 2, 1);

        var TimeDelay = PingPongUtil.calculateTimeFromspeeddistance(Speed, args.INTERVAL, 24.44444) + 400;

        console.log("will delay " + TimeDelay);


       // this._peripheral.send(-1, 201, webbleSendDataBufferManager_group.GROUP1, SinglesData[1], false, false);
       // this._peripheral.send(-1, 201, webbleSendDataBufferManager_group.GROUP1, SinglesData[0], false, false);

//        this._peripheral.send(-1, 201, webbleSendDataBufferManager_group.GROUP1, PingPongUtil.getDummyData(), false, false);
        this._peripheral.send(0xcd, 1000, webbleSendDataBufferManager_group.GROUP1, OutPutData, false, false);

//        this._peripheral.send(-1, 201, webbleSendDataBufferManager_group.GROUP1, PingPongUtil.getDummyData(), false, false);
//        this._peripheral.send(-1, 10, webbleSendDataBufferManager_group.GROUP1, PingPongUtil.getDummyData(), false, false);

     //   this._peripheral.send(0xcd, 300, 0, PingPongUtil.getResumeData(), false, false);
        
        this._peripheral.receivedLastPointDone = -1;
        
        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2 = false;
                clearInterval(repeat);
                resolve();
            }, TimeDelay);
        });
    }

    leftrightact(args) {
        console.log("leftrightact " + args.DIRECTION + " " + args.INTERVAL);

        if (this._peripheral.AllConnected == false)
            return;
        
        
        if (args.DIRECTION != simple_act_direction.left && args.DIRECTION != simple_act_direction.right) {
            console.log("updwonAct unknown direction!");
            return;
        }

        if (this.inActionC1C2 == true)
            return;

        this.inActionC1C2 = true;

        var Speed = 80;

        if (args.DIRECTION == simple_act_direction.right) {
            Speed *= -1;
        }

        var SinglesData = new Array(2);
        SinglesData[0] = PingPongUtil.makeSingleData(0, 0, Speed, args.DEGREE, 2.25);
        SinglesData[1] = PingPongUtil.makeSingleData(1, 0, Speed, args.DEGREE, 2.25);

        SinglesData[0][12] = 2; // make resume
        SinglesData[1][12] = 2; // make resume

        var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(SinglesData, 2, 1);

        this._peripheral.send(0xcd, 1000, webbleSendDataBufferManager_group.GROUP1, OutPutData, false, false);
  //      this._peripheral.send(-1, 100, 0, PingPongUtil.getResumeData(), false, false);

        this._peripheral.receivedLastPointDone = -1;

        var TimeDelay = PingPongUtil.calculateTimeFromspeeddistance(Speed, args.DEGREE, 2.25) + 400;

        console.log("will delay " + TimeDelay);
        
        /*return new Promise(resolve => {
            var repeat = setInterval(() => {
                if (this.checkEndActionData() == true) {
                    clearInterval(repeat);
                    resolve();
                }
            }, 200);
        });*/

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2 = false;
                clearInterval(repeat);
                resolve();
            }, TimeDelay);
        });
    }

    updownactC(args) {
        console.log("updownActC " + args.SPEED1 + " " + args.SPEED2);

        var ContinuousData = new Array(2);
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, args.SPEED1 * -1);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, args.SPEED2);
        var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(ContinuousData, 2, 0);

        this._peripheral.send(0xcd, 1000, webbleSendDataBufferManager_group.GROUP1, OutPutData, false, false);

        return new Promise(resolve => {
            setInterval(() => {
                resolve();
            }, 200);
        });
    }

    updownactCL(args) {
        console.log("updownActC " + args.SPEED1);

        var ContinuousData = new Array(2);
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, args.SPEED1 * -1);
//        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, args.SPEED2);
  //      var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(ContinuousData, 2, 0);

        this._peripheral.send(-1, 1000, webbleSendDataBufferManager_group.GROUP1, ContinuousData[0], false, false);

        return new Promise(resolve => {
            setInterval(() => {
                resolve();
            }, 200);
        });
    }


    updownactCR(args) {
        console.log("updownActC " + args.SPEED1);

        var ContinuousData = new Array(2);
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, args.SPEED1 * -1);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, args.SPEED1);
        //var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(ContinuousData, 2, 0);

        this._peripheral.send(-1, 1000, webbleSendDataBufferManager_group.GROUP1, ContinuousData[1], false, false);

        return new Promise(resolve => {
            setInterval(() => {
                resolve();
            }, 200);
        });
    }



}

module.exports = Scratch3PingPongAutoCarBlocks;
