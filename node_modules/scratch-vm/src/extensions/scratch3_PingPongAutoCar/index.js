const ArgumentType = require('../../extension-support/argument-type');
const BlockType = require('../../extension-support/block-type');
const log = require('../../util/log');
const cast = require('../../util/cast');
const formatMessage = require('format-message');
const BLE = require('../../io/blepingpong');
const Base64Util = require('../../util/base64-util');
const PingPongUtil = require('../../util/pingpong-util');
const blockIconURI = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAABQCAYAAACOEfKtAAAACXBIWXMAAC4jAAAuIwF4pT92AAAF+mlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxNDUgNzkuMTYzNDk5LCAyMDE4LzA4LzEzLTE2OjQwOjIyICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdEV2dD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlRXZlbnQjIiB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iIHhtbG5zOnBob3Rvc2hvcD0iaHR0cDovL25zLmFkb2JlLmNvbS9waG90b3Nob3AvMS4wLyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ0MgMjAxOSAoV2luZG93cykiIHhtcDpDcmVhdGVEYXRlPSIyMDE5LTA2LTA0VDE0OjIwOjU2KzA5OjAwIiB4bXA6TWV0YWRhdGFEYXRlPSIyMDE5LTA2LTA0VDE0OjIwOjU2KzA5OjAwIiB4bXA6TW9kaWZ5RGF0ZT0iMjAxOS0wNi0wNFQxNDoyMDo1NiswOTowMCIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDo1NjYyODcxMC1kYzA1LTczNDEtYWNiYS03NWI3M2I2NTg0MWMiIHhtcE1NOkRvY3VtZW50SUQ9ImFkb2JlOmRvY2lkOnBob3Rvc2hvcDo0ZGNjZTUwYS1hMTE5LWIyNDQtODI0NS1lOWJhNjZlMWQ0MjMiIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo4M2VjMjFlYy1iOGZkLWIwNDEtOTgzYS1iNTk2YTEyNjM1YjkiIGRjOmZvcm1hdD0iaW1hZ2UvcG5nIiBwaG90b3Nob3A6Q29sb3JNb2RlPSIzIiBwaG90b3Nob3A6SUNDUHJvZmlsZT0ic1JHQiBJRUM2MTk2Ni0yLjEiPiA8eG1wTU06SGlzdG9yeT4gPHJkZjpTZXE+IDxyZGY6bGkgc3RFdnQ6YWN0aW9uPSJjcmVhdGVkIiBzdEV2dDppbnN0YW5jZUlEPSJ4bXAuaWlkOjgzZWMyMWVjLWI4ZmQtYjA0MS05ODNhLWI1OTZhMTI2MzViOSIgc3RFdnQ6d2hlbj0iMjAxOS0wNi0wNFQxNDoyMDo1NiswOTowMCIgc3RFdnQ6c29mdHdhcmVBZ2VudD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTkgKFdpbmRvd3MpIi8+IDxyZGY6bGkgc3RFdnQ6YWN0aW9uPSJzYXZlZCIgc3RFdnQ6aW5zdGFuY2VJRD0ieG1wLmlpZDo1NjYyODcxMC1kYzA1LTczNDEtYWNiYS03NWI3M2I2NTg0MWMiIHN0RXZ0OndoZW49IjIwMTktMDYtMDRUMTQ6MjA6NTYrMDk6MDAiIHN0RXZ0OnNvZnR3YXJlQWdlbnQ9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE5IChXaW5kb3dzKSIgc3RFdnQ6Y2hhbmdlZD0iLyIvPiA8L3JkZjpTZXE+IDwveG1wTU06SGlzdG9yeT4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz5HZ19gAAAd+klEQVR4nO2ceZBd1X3nP+ecu7399aqlWYQldkyEDNgT43jJYDDxhARsJpM4TipTmYLMmLFjg4EYyBTlOHbGTpzBFTyVyHYyYxibBBKXQS4CGGzMIiI0MtgCSWhptZbXy+vu1++9u54zf9x3X79ehBQ6rtRU9a/qqt9799yzfM9vP78rYYxhld48yX/tCfz/TqsArpBWAVwhrQK4QloFcIW0CuAKaRXAFdIqgCukVQBXSKsArpBWAVwhrQK4QrIM4Ne2E47+A9IuETYOErfG6L/kDur2ZcyO78WyrAUPua5LvV7n+edfSDvp3DfGdC8pJXEc4zgO119/Pblc7qSTmZmZYWZ6mjPOPJNHHvnuW/fu3Xf95s2bz5iZmf6bd7/7PU+WikWElJwsASKEQGvNww8/zNTUVHdsrTVCCIwxCCEQQjA9Pc37r7ySs885B6P10n6EIJjaTfDqvWidYBXPQMctvMEtqNN/FWu5CfxLkTEGpRS2bZ9Se8/zsAYHeeKJJ+742te+/qHdu3df4nkew8PD73vttT0PffKTn/wz4OCp9JUB9LOmnymASilarRb1ep2hoaE35BwhBK7rOp/97GefvOeee34eoFgsEkURQRCc+cgjj3z8xRdf/Nj999//TiHE8xk3vVF/Gbf9LOkEAP7L7JxSinq9zuHDhxkaGjpp+29+839/7Z577vn5arVKX1/fgsVHUcQDDzygBgYGnrj33nsLmZguJmMMlmVRq9WYnJzEcZx/kbUsxST9LgVgecMY2Q+qjFQeKAe7OIRtn3iSUspTEpFSqcRPf/pTtE66XLHcBVx+1113/boQgmq1ShgEjI+PU6vV8H0fy7KoVvv4yle+kn/55Zc/bowhCIIlV5IkAGzfvp0gCJbo7+VIyhPbUgm4uQpYRYTysLwqyhvALqzBlmBpwzl6/KF71cwD64x9lp46fhwzs1+q6oOT4pxbPpLPFw4vxqlQyDM7O0scxyil3nByuVyO6elpHn30e6xfv67LIb3cValU2L59+3WHDo2yZs0a4jimVqsRxTEA7XabdevWUamUmZ6uc//93/zdP/zD//ZnGVgZCSHwPI/nnnuOAwcOUK1WuwbjRJQkyRuuQUOhOb7rbn/sex8w7hrTqu8zujkq/PEduFsu+KT1tw9t+07+lU+c857N0IoO0u8NUu6TfP1bX6H5lg23fvDfXnrz1NQkMC8e4+MT7N27N92hN9g9SC1fpVLh2LGj7Nu3l/37X2dycnLBc/39/bz++utxuVzGsmzCMCCKYxzbRiqF7/u02+2uOB46NLretu1ljdNrr73Gzp07KRaLbzgvSAHP5/O8sH0760dGlhX3Ha9M/uqub915y0ffsZvZeJraxBx2OMHrr+7kiccGv2odOTIWDzRd7NJbSKYhmJ2g7LVpNuDAwSPJVL3OxMQEQHenxsbGCIKAXC53Skpaa41t2wwODjI4OMjwcKoPs2dLpTI7d75kPfroNizLwrZtLGURRhFEEYLUdcrUycDAwNG5uTmazWZ3DNd1mZiY4Mknn8TzPGzbXlb9LKZ8Pk+tVuPBBx/k+uuvx3XdBffnWr48emQUHYe0G1MMDa2hUl7L8V3HGH11rGkBQbFqcPojir5m9+GEnBYkcYitTKSkQgjRBe/YsWPEcUw+nz+lCfaS7/usXbuO97znvUt009ve9rbv3HnnnZ+empxk7dq1DAwOMD09jdaaaqWCbVk0Gg0APvzhDz/sOA5JkupVx3GI45gD+/cjpcRxnFO2vlpr+vv7qdfrfPvb3+aGG25YwImSOI6NS6Ar+KZAzrSxZAtLzxLHcSTDKCKOQ1BT5AoB524sU3lLFS1dgiBa4A5MTU0RBAG2bb8p9yB1riP27NmzBHzbtp+59dZbH4/iGD/wkVIwMNDP0OAgtmMTJzH1ep3rr78ufOc73/kFx3GoVCqUy2VmGw2mpqaoVKsopf7Zc9NaMzAw0AWx1Wp17wVhgm0llAYl64YUs7Ntjh2cJGgGIDRSa008C8zEREFEqZpg9UUY7eOHMXGSYIwhDMNTtmono0KhQKvV5IUXXuhyFcAtt9z6wV/5lWt3T05OkiRJeumYOI6ZmqpzySWbW9/4xl9fC0wDhGHISy+9xOP/+I8AK5pbBuLExATf+973iKIIgDjWYGKwNUomhLFixi8SCYkgRuokIWWGMklsgWPAtdBGE/ghxmhyudwpuy2nQqmYuezatYuvf/3r7Nu3L7vl/97v/ee/19oQxwlaG7Q2GANBEPDe977v6Xa7ve2FF17g6aef5qGHHuKpp54CUl22UqdZa01fXx/NZpPnn3++228cBxD5CO2zZlAxMqJwbPD9BCvRGlEAqgYvEtTHGvQlEUk7pDJSnrjs0rdx8OBBJiYmkFJ2RU8IgSF1J3stahAEhGFIuVxesCBjDFprhoeHGR4exrJs+vr68H2fxx57jDAMOf/886nX61WAxS4KwPj4uKnVaoyOjjI1NYVlWQwMDGBZFv39/QAcOXIEz/O6Y2ZzzfqUnVhaCLFgPdnnMAwZGBgkn891AMyNRWEMjZDZhkW1T2INSHJ7DX4QY2ltEB5QAjGZMHYkos8TDPZ77JmZ+uA3/vp/rT94YL+XJLEJgoDJyQm30WgWcjlvulKpaK11F8B2u00ul6NQKDA6Okq5XO7qyw6AwrIsceWVV+6/5pprvlAoFPTAwABJkvDUU09x/vnnMzg4WM8Wmy082wfXdduO4xBFEaVSqWuZC4UCzz333L//0TPPvPfAwYPYtm2WC+OMASFYkEyQUtBoNESr1e5zXTeqVMqNfL5ALpfjkUe36Wm/79z1Q0PgjBMZF60NGIHBYIzGMsbQ2SeMMFi2A7bF2vVlXnp4x7u+dt9n32VZEtd1SRLN2rVr091KEg4eOtSdpG1buK7HFVdcwYYNG3j66aeYm5tjcnKqB4i07X333cd99933tsHBwW/HcWx3FmMee+yxZPv2Fy9TStEbqmWRz/T09KbXX3/913zfF1JKmSQJ+Xw+mZmZzt10001bDxw40N1MKUW6WEx3AxaDmn3esOFMbNumVhsnikKkkERxTBAErN/0C3zxP6YA5vMCZUkwGh2D1gbLGDAa0CEqbzFyJpiiZqYR4Xk51o+cRhIFCCmZmZnl3e9+92f+5E++8Gd/9VdbX7n77rvPHBkZ6aaJPM+jXq8zMzPD2rXrmJmZplgsIoRcIEphGHLnnXd+qFgsfihbiBCCKIpoNuc47bQRpuvTzMw2AcO6NUMMDw/z/HPPXbxr1677FzvvGdhnnHFGT1RhejhuiTboiu2hQ4e48MKLwrvvvmvg4MFDl95xxx1P1o4fp1yuMDk1SaVcJeEIVBUVYVE76iNrPpEPrgMWGGgBsyEmkpTW2zCoMYTEkcFSCqMVSik8z+WVV17ZOzQ03Gy1WkkYhgs4pdFxJ7TWWJaFZVkopRa4LJlPmUUXiw2TbSuEkLT9ACUShACNwLZtms0m7ampBc9kXOR5Hkqpru7MwFvcbgGAQhDHMT/5yU84/fQz5qrVvqMAQkqkJVHKSjcim7/WBBF4tke+2EJJgYUxCBco5GHOQGggNgiZziIV8PlEaS6XqwAkSdJlg2xBSqVALwZlue/LJVhTEdNobQhDeNcFkpwrePZ1TSlOsCxrSaSwXB8dyE44PotaWJZFvV6n3W6Xtemkycx8ghgpwJFgS5RMvZokSfGxEAKTAH4CRoKjwFMYYpKOD9i7edlOZmK03M5qbUgSzcnSYkoJpBK9a+3tBdezcNzlM9CZ2BtjiGKNWDTWQgts0rHkIsPSATbbmFar1QUug1goiYkTmPZJ2hZDQw6x0MRHIYhMmg8UDpC3oC2IZmNsK0IkCUKeaHG9c1jKXcYYosgHOrvZbZIus7uz5LAsB206xmJ++YCk3Q4xCQhZOSE4cRwTha2FSY2O3uvyogEhPKRc3tHOXJoTjSEN0DI0pyPKwznsIYvCaxBEGksYoAAMuJjpiLFXWmw4ByolB6nEyfBbQo2Gz8hImVtv+QiDg/00W+0lbZSSFIsF/vIvt/Hd7z5Lf38VIUAY0BkCnZUrkUpQ7zzmQ8sZ3v72C7j55msxOiGM4oXAALZjY7Tmy3/+EC++uJ9qNb/gfgbWibjcaINyFPTnsNo2JtaIUKA7km0JKRAGiA061liOgsEcygWTmHT7esR2bm5OpyD05tAylxpc18L3Y/7+H57Fc12ieN4hziYspMC2LfbvP0KhkO8qe7PwH2wLcg4IllcjuZzH8eNTPPDAE2itMdrM99MhKQUgGB9vkM8vfzZjtMZxHGx7aRIilUIJzYgoVORLDng2lpXuqiWEQNiAJRFKoiMDMxHgpCdgmO6EWq0Wl112WR3AcZwwW3avxXMcRbsds23brtQaK0GjLTDxQqBBg+3h5T3qrSy6MWidARAz1UibTdcNkRD4vkGprA+DVC7HX5tl167nWaJvLUkpl0Y/BqiU83ie0/ENF1KhWDSe5+E49n7HcRb4nwJB0hnSKygQEE228NupJFlKWQgfqLdRtsXQ2QXIRzRmI3L5MkopojAAyNyE39269a/k97///UrKhb0TTwGQUjA4UMAgOTiWsK6/zVs3CXQi0V0Os1J0aHUmOy+qxhjqU4qLz5KUPPBVQrHQJIoCpFyYPRYCtLa78xACbGX46aGE0XGP09baWFKjDcuC5zgOzWZTff7zn7/h4MEDm5Ik6XoISZLgOgVyJQ8GPVwnx8RoC93yMVqQzyksqSSiDTQTCC1ya10YsgmTJq++vB0Tt1FKIaVkcHCQrVu3XrV169arAAYHB5cYmUw/GSE5eCzkl98e88WPV9h0ugNhRxtklr2j3+a5LgVfYEANEUYKnYCjYmKdIJiPrztBBkJAotPvWXTu2nDoWMBnts7ywDMJ64dclFjeKxgcHGT37t3W7t27/w/AyMgInud1c54H977EeE2D5UKk0RqK1TyVIEAgsIQxyDzQn4NjEtoJRCAk1I7+hFKpTKVSwhhDkiTYtt1N9WSmbt4Sdw6tgbFxw3suCvj7Lw9BrkIyHtNVmyLlQkHHQov087zXKUCDFAZhgRZW+kinuTGpwTEmBc/IhRa3FcNbNpb55uc8wluP87fPWpyxZnmXqtfJTx3/ebfJdT3Gj/+Eyckh8MogE5LEELQMSSKRSqQ6kATwTbqNSoDKQLG7HJVlK7KEZRzH6M5AvQc3KUcI4ijgY79ShFKJxgEf2xJkCZYO83Sx7H7v/Cg7a9WGTtDemU8nbs/0vNak+mmxZBoYH08YWl/id65u8Z0XmkRJAUsuPUvudVdsx+kyQdp/AhSwlA3tAIyiXLEJo4DW0ZAoBkkGYBCB6jhPzYgkTsXB9MxucVJgyUQ6cqkN2I5huM+FUKDkQqC6TxtIsgV0wO/qwZ6+U4Y1C37rVQGLAw0DSAn4mnJeUPAMyamcPpjebc36lYhEQD2iOeFTKFv0nVPCcQXtdow02kARGHIwynDslTkYiyjmLSCh4+N2lfty4IlMjDvcaklD1FI895NZKMdYQi3QPplvnXGT1qnYZ5xnutGAWWi4TZr40HpRgmCBi5P9JKFieHm/T33WwlFvfLyZzX1hCCiBEKmAUg4hLUyYQJSlw3orE6Qk8SPitoE+DzcPqSsjunsilSIIgu4j80VF88BkbfsGHP74/ibvuug4b792HcyqTCZ7VtoTMmSIZp1ICe3Ob17HShiRyuzicHcxmAbIGXb8cJzPfSumWMojRe9OzFN3DVrj+z5JnGDZdmeTDOAilQRMZ2odKewMammtO65FJxQg1YUSwcWXvo/a2E7iOMK2JUEQsHnz5lkw248cOfpvms1mPj1/FQsSlQB9ZcNYLc8HPhPwiR8f4efOtEkSQazpWuFOzI4UHQOiU+NlNERxzGBZohSMz8hOfk93jA0d5hTdPujZRCVh3+GQ//EPIeNzOc4YhjhZnvtarRb9/X26UCg+5brO6QKxqdVOo6fGXINzt1zJ2uHjUPspJskj3BzYois5ltYGnQA6QbkK5WiYnCVouuRLRZSSxJ3dmJyc5Oabb77rtttv+/Itn7rltT/90z89OwVtqV6MYxgZhum5HHd9NQLld6oRF/qNvewkhEijCQNEx7l8E/QXYdvOCqpQIQnaiI4pN91nwBgBC0RPYGJJta/IGWsMcbxU7WRUr9d5xzveEf3x5//4fe1W+6JPf/rTPx6fmKBQKGC0wXU8lCOhrMhbDs2ZiKAW0W5pPE9gaRJMA6gF4Fusu7AE5ZDZVkTQ8rMpAWm11COPPDLxB3/wB1SrVTvb8ROVT8QxlHKG0uk2BruL2QJz0INh14c0cHjUZe1AwGARSmWPgUGXMNAouUwZhljUVzcy0sTx0uaLabpeF5t/bjO1Wk3Ozs4usMxREKaZpZwDvmB6KsAT4DlgKYGVxY9IgYg1GAU5B2XFPR3NL5A09UDcnZlYYgW76+okW3vPNwAsy2aeh3rBNwgxD2+SQKxBSIMUHb9QnJibpFLEcUQURXieixCSUzn8F1IyNTXF7Oys25vPzDJJ2pjOZBKUEtiOREjdEeHMPbBIdy8Bwo7Snh+i+ylLIiw8W1jqSmSUgZeehmXt5p/NTsmycTJYAYIYwo7vmCnw3grTXtJaE0Vht4wkjhNAo5Q8YZ3gibeip01vUlUJLGVoz7VoNtJ7lsFgIlJHUbrpubA0REmq0BcnKpejkxU6LtzV9Pc0Xb60rda6s9gYIXOpodZL5XCh857+zUqKlVLEcUIcRyh1avWBmVuy8LtASIGJNExENGcUgwM2iac4ND5H28/ygXmg6kEI0/vbVKYNrpJYtlzgWWQTf6PF9C5oyWQ6x4hhGDFeOzqv/nraa6PJeXnAougJCh5oIxawy3JnIpZlobUmO2aVMq2Z6eW+kwYCvXPujgVKGtDgtzQ5V6BKDo6bzsvqBpiWIPYTjo1GVCs2ldL8SZoQsgtAEAQGUtfjRIAt/j0IA1RHVG07zUA3e+pPlpA2OI7Djj0NbAtcp9TJ6514jAyA+UMl3dG1JwYq61HrtPqi2XTnmUFIhJRdVxUBkjTBmiUVhBBY870YhDapuMSgEwchJInWJHGMlIIg8Nm4ceM4QKFYDIFusWR2tVotoiiiWCwiZXqeHPeYQqUUyrJS0dBgWSpDgjiKcGybtevWMTFe4+B4euu0kfREcHJygrm5uQUFmsYYhJQMDw/jeV63+iD726szF3NZps/L5bJRSmFZ1j7HcQjDkDiJ0UkCdM6XfR9bSZTtdEBPudMSACHgm07KygIVEQQWrZbP0SNHsBTYlk3b96nX67fffvttb3vxxX8aARgdHSUrvHRdhw0bzqLaV2Xvnr20221mZ2cXGJ6sDPeqq66aWr9+/YtJEtuZ3lNKRRMTkxe9+E//tN6yHfL5NCEaRjHHjx9n48aNU2efvWlHFEVKqRREx7F1u912H3ro4SuSJOn4b7qrFk5W2A4QBIF7xx2333P0yNHTjh8/ju/7RFFEGIZMTdZxPA8G8xStHPXpBDOl8YOOKyOkQDSAqYSkLRjaWIABzcRMmzPOOJO3rP93TE+ndShCCPbv33/5zp07L+/r6+Pyyy8nDNPEdMoVmvPOO4+RkRFmZ2axbZt2e/5MJEkSwjBky5Ytr997773/Yd++vS/s2bMHx3Go1Y7z0Y/+Fs8++9wXr7zyyt8vFotdHdZqtZibm+PDH/7wDz/2sf9y7XPPPUuxWEYIg1IWtu2wYcOGbU8//YOrgiA4adlx5jCmKsUmDEMef/zxzxgD559/HrlcWqjUaDQorbkA3/8R6DRSqs/EuJZAqXTNaUq/w5NGC/A1+Jparc7FF1/8jdt//wv//aUdO9T0dJ25uTkAZKqQTK8VzPKFmbi89a1vRUrZTX8ZQCcJlUpZbNmyZWdfXx/j4xMcOHAAYwwXXHAhhUKR2dnZXGeMrouTlfK2Wi3Xth0cx2V09FC3sHLNmjX80R/90dWvvvrq5h07XsJ1XdMruicq6ej9bowRQggTRRHlcpliscj551+Q7Njd+ODL3/67z2F0epajQEQtglYnry6lSkMs1Ua5edLUg8F2FbXa+N4jR468HMdRtwo+yw32TqRXkWegRVG0rIK3bYvDhw+zfv0IjUaDWq3GVVddxdVXfwAAx3FmgW4WvJdyudycMYbh4TVorTl06BAAcRxx6NBhZmamd7bb7a7veaoA9pLWmtnZGYwxrF+/jgM1OdJqhegZmJ0z9FVtcjk4UPOJYpmKsCwB5QpiDo4e1Aw0JULaFAteOemcqsVxTBiGCypAT+QeCCEWVVfNAxjHaYSTlpEN8Bu/8REuvfTS7gL27NlzGaTGJX1+Ps49cuTIxRs3bhRKSXPuuedQq42za9f/pV6fQeuEOE66hZlvBsDOqSOWZfH+918FQKvVHDAo9FzMVD1mzaCFKhax3BmkkliWpVAh4EvCNhw6PEspSbCFRlmSKE45qVKpMDc3RxRFuK77hrt4MgrDtHDzF3/xFxf8/uyzz37uU5/61PvK5VKXkzPgBwb6efjhh8/+8z//8ndvvvm/XgNw2mmns2XLFn74wx8yPV1/0/OBFLxms0kcx1xzzTWsWbMGSPOKtgIjW5RckR7yxwJjFLalkJZSxJHCtByCxGbDiMJdmyCERkinq3/6+vrYsGFDF4A3U62accTAwACu6y2+3X/TjTfeprWmUi5jKYt226fVbiOlJOflcB2bT3ziEx8YGxu7LusP4IorruC0006n0Wi8qY2VUtJqtWg2m1x33XWcffbZvbPG9TzsSplitczkDIyOQiu0yOdcLMdyiOYSoqlp4ijH8Lq1iL4E6c7i2GmxkGVZxHFMtVpl06ZN7NmzhyAI/lnV8B03Bdt2KBaLHDky1j1mLBaL7Nix46OvvPIK/X19QPoWZbOVvsbQdt30FYmhYcbGxti6detNN954499lrzlklfnFYhHfb3crVE8VvGazSavV4kMf+hBnnXXWgvtKgrSKYCx8XaDRmMBJpjF+iOO4WFpzZrEMzlCCPaEYOxazpu0T+i20Mf1xFHf1VloZWmTjxo28+uqrGGPwPO+kIKbV+QmtVpODBw/wgx88jTHzWZK+vj727tl7WrFUIpfPE4QRzVYTy7KQafRDu92mVCoBsGfPnkuGhobE0NDQgoHXrl1LHCf8+Mc/plwunxS8TmRFFEVcd911bNq0aWkb6VTmZus0x5vUmzH9fQWGKh61Ro1W219jXXX1e74qf/rB2+eO76MRD1CvHyKaqHH5Ze+i74prX9p01iAjI2uB+dR9oVDgvPPOY9u2bYRh+Iavswoh8H2fXC7H+vXrKJWKS8S/Wq2CEUTRd4D0xB9Sw5W1zfxQAM/zZicnJ03v8UL6nOLCCy9k3759tFqt1Kk+icVtt9tcffXVXbFdEOoJwfnnrNlRuPbXgij8n67nKhJR5Vi9TWngLfz2b//WM8IYg578/pbWj+8ewTszipI8cTBtDb39rnEKFzx/wtGBBx98kNHR0S5nZGKqlKK3+HJmZmZZ8eilWu341Zs2nf2oMYaBgQGazSb1+hTGQLlcplwuE0URR48e5f7777/3/e9//8dmZmaW9JOJ76OPPkq7nYrziaxwFmL+5m/+JoVCYdnC9tSQxWdN/ejjFylposbsNI2j28W6t/461S1/+KgVAHGgd9huYUciLYx2UHaRZivGK8Ab+fSLE6XL0dzcHJdccglnnXUWYRixfBZOMDy8ZttHPvKRsb/4i78Y6evro1gsdtVDxn1Hjx7l4osv5oYbbvi8lLJbmb8cXXTRRTz55JOn9Ka87/sUCoVl7xmAqLlfKHe/TnyU7eLmiwgrbZ/Kig4xOsaYJP2rQ4wOTzrwyShLMJx77rlA59y3E2H0XtkefOlLX/rlSy+9lNHRUSYmJrqJ2EajwYEDB8jl83zrW9+6UUp52Pd9giBc9koSzQUXXMjQ0BCLxfxNrUNHoEPo4pOgk7Tfn/l/OtFbQ23bdrd2uvfKdKjneTueePzxX7jpppueGRwcxPd9wjDEdV2uv/76V3/0zDP/6dxzz/1qpy2u6yx7ZfWHhUJhQSboZ0E/01f+M+otFzsRZVX6pXL5B7fddtvvXHTRRTc+8MAD1WazyS/90jX+tdde+zebN29+dmZmhkqlckrjnoqKWSmJlUQUq7T6/8asmFYBXCGtArhCWgVwhbQK4AppFcAV0iqAK6RVAFdIqwCukFYBXCGtArhCWgVwhfT/AL8a5XRtOTU1AAAAAElFTkSuQmCC';

var GroupId="";
try {
   GroupId = document.getElementById('isGroup').value == "false" ? "" : document.getElementById('groupId').value;
}catch(e){

}
const BLEUUID = {
    namePrefix: 'PINGPONG.'+ GroupId,
    service: '6e400001-b5a3-f393-e0a9-e50e24dcca9e',
    txChar: '6e400002-b5a3-f393-e0a9-e50e24dcca9e',
    rxChar: '6e400003-b5a3-f393-e0a9-e50e24dcca9e',
    groupID: GroupId
};

class PingPongAutoCar {
    constructor (runtime, extensionId) {
        this._runtime = runtime;
        this._ble = null;
        this._runtime.registerPeripheralExtension(extensionId, this);

        this._extensionId = extensionId;
        this._timeoutID = null;

        console.log("pingpong autocar constructor4");

        this.disconnect = this.disconnect.bind(this);
        this._onConnect = this._onConnect.bind(this);
        this._onMessage = this._onMessage.bind(this);

        this.connectCount = 2;
        this.AllConnected = false;

        this.waitResponseOPCode = -1;
        this.waitResponseOPCodetimeoutID = null;

        this._sensors = {
            C1tiltX: 0,
            C1tiltY: 0,
            C1tiltZ: 0,
            C2tiltX: 0,
            C2tiltY: 0,
            C2tiltZ: 0,

            C1moveX: 0,
            C1moveY: 0,
            c1moveZ: 0,
            C2moveX: 0,
            C2moveY: 0,
            c2moveZ: 0
        };

        this._buttons = {
            C1Button: 0,
            C2Button: 0
        };

        this._proximity = {
            C1ProxOld: 0,
            C2ProxOld: 0,
            C1Prox: 0,
            C2Prox: 0,
            C1ProxInterVal: 0,
            C2ProxInterVal: 0
        };
    }

    scan() {
        if (this._ble) {
            this._ble.disconnect();
        }
        this._ble = new BLE(this._runtime, this._extensionId, {
            filters: [
                { namePrefix: BLEUUID.namePrefix, groupID: BLEUUID.groupID }
            ]
        }, this._onConnect, this.disconnect);
    }

    connect(id) {
        console.log("connect " + id);
        if (this._ble) {
            this._ble.connectPeripheral(id);
        }
    }

    disconnect() {
        console.log("called autocar disconnect");

        if (this._ble) {
            this._ble.disconnect();
        }

        this.AllConnected = false;
    }

    isConnected() {
        let connected = false;
        if (this._ble) {
            connected = this._ble.isConnected();
        }

        if (connected == true)
            return this.AllConnected;

        this.AllConnected = false;
        return this.AllConnected;
    }

    send(message, force = false) {
        if (force == false)
            if (!this.isConnected()) return;

        if (this.waitResponseOPCode != -1) {

            console.log("canceld");
            return;
        }

        console.log("willsendData");
        const data = Base64Util.uint8ArrayToBase64(message);

        this._ble.write(BLEUUID.service, BLEUUID.txChar, data, 'base64', false).then(
            () => {
                console.log("send done to scratch links:" + message);
            }
        );
    }

    CheckProximityData(value)
    {
        var x1 = PingPongUtil.getSignedIntfromByteData(value[12]);
        var x2 = PingPongUtil.getSignedIntfromByteData(value[13]);
        var x3 = PingPongUtil.getSignedIntfromByteData(value[14]);

        var xx = PingPongUtil.getACCDataToDegreeMinus90To90fromByteData(value[15]);
        var yy = PingPongUtil.getACCDataToDegreeMinus90To90fromByteData(value[16]);
        yy *= -1;
        var zz = PingPongUtil.getACCDataToDegreeMinus90To90fromByteData(value[17]);

        if (value[3] == 0) {
            console.log("cube1 Detect " + value[3]);

            this._sensors.C1moveX = x1;
            this._sensors.C1moveY = x2;
            this._sensors.C1moveZ = x3;

            this._sensors.C1tiltX = xx;
            this._sensors.C1tiltY = yy;
            this._sensors.C1tiltZ = zz;
            this._buttons.C1Button = value[11];
            this._proximity.C1Prox = PingPongUtil.getUnsignedIntfromByteData(value[18]);
            this._proximity.C1ProxInterVal = this._proximity.C1Prox - this._proximity.C1ProxOld;
            this._proximity.C1ProxOld = this._proximity.C1Prox;
        }

        if (value[3] == 1) {
            console.log("cube2 Detect " + value[3]);

            this._sensors.C2moveX = x1;
            this._sensors.C2moveY = x2;
            this._sensors.C2moveZ = x3;

            this._sensors.C2tiltX = xx;
            this._sensors.C2tiltY = yy;
            this._sensors.C2tiltZ = zz;
            this._buttons.C2Button = value[11];
            this._proximity.C2Prox = PingPongUtil.getUnsignedIntfromByteData(value[18]);
            this._proximity.C2ProxInterVal = this._proximity.C2Prox - this._proximity.C2ProxOld;
            this._proximity.C2ProxOld = this._proximity.C2Prox;
        }
    }

    setWaitResponseOPCode(nCode, nTimeOut) {
        if (this.waitResponseOPCode != -1)
            return;

        if (this.waitResponseOPCodetimeoutID != null) {
            console.log("will cancel timer");
            window.clearTimeout(this.waitResponseOPCodetimeoutID);
            this.waitResponseOPCodetimeoutID = null;
        }

        this.waitResponseOPCode = nCode;

        console.log("set opcode");

        this.waitResponseOPCodetimeoutID = window.setTimeout(() => {
            console.log("timer called will clear opcode");
            this.waitResponseOPCode = -1;
            this.waitResponseOPCodetimeoutID = null;
        }, nTimeOut);
    }

    checkResponseData(value)
    {
        if (this.waitResponseOPCode == -1) {
            return;
        }

        if (value.byteLength < 7) {
            return;
        }

        if (value[6] == this.waitResponseOPCode) {
            if (this.waitResponseOPCodetimeoutID != null) {
                window.clearTimeout(this.waitResponseOPCodetimeoutID);
                this.waitResponseOPCodetimeoutID = null;
            }
            this.waitResponseOPCode = -1;
        }
    }

    NotificationEventFC(value)
    {
        if (value == null)
            return;

        if (value.byteLength == 18)
        {
            if (value[6] == 0xad || value[6] == 0xae) {
                if (value[11] == 0x01) {
                    this.AllConnected = true;
                    this._runtime.emit(this._runtime.constructor.PERIPHERAL_CONNECTED);

                    window.setTimeout(() => {
                        if (this._ble) {
                            this.send(PingPongUtil.getSensorsData(0xff, 10));
                        }
                    }, 3000);
                }
            }
        }

        // get sensor data
        if (value.byteLength == 19 || value.byteLength == 20) {
            if (value[6] == 0xb8 && value[5] == 0xc8) {
                if (value[8] == 0x13 || value[8] == 0x14) {
                    this.CheckProximityData(value);
                }
            }
        }
    }

    _onConnect() {
        this._ble.startNotifications(BLEUUID.service, BLEUUID.rxChar, this._onMessage);

        window.setTimeout(() => {
        this.send(PingPongUtil.getSetMultiroleInAction(this.connectCount), true);
        }, 1000);
    }

    _onMessage(base64) {
        const datas = Base64Util.base64ToUint8Array(base64);

        PingPongUtil.printUint8ArrayToHex(datas, "Notification Data");
        this.checkResponseData(datas);
        this.NotificationEventFC(datas);
    }
}

const simple_act_direction = {
    Up: '0',
    Down: '1',
    left: '2',
    right: '3'
};

const simple_act_interval = {
    cm10: '10',
    cm20: '20',
    cm30: '30',
    cm40: '40',
    cm50: '50'
};

const simple_act_degree = {
    degree90: '90',
    degree180: '180',
    degree270: '270'
};

const continuous_act_speed = {
    speedI100: '-100',
    speedI90: '-90',
    speedI80: '-80',
    speedI70: '-70',
    speedI60: '-60',
    speedI50: '-50',
    speedI40: '-40',
    speedI30: '-30',
    speedI20: '-20',
    speedI10: '-10',
    speed0: '0',
    speed10: '10',
    speed20: '20',
    speed30: '30',
    speed40: '40',
    speed50: '50',
    speed60: '60',
    speed70: '70',
    speed80: '80',
    speed90: '90',
    speed100: '100'
};

const PingPongAutoCarButtons = {
    A: 'a',
    B: 'b'
};
const PingPongAutoCarCubes = {
    LEFT: 'LEFT',
    RIGHT: 'RIGHT',
    ALL:'All'
};
const PingPongAutoCarTiltDirection = {
    FRONT: 'front',
    BACK: 'back',
    LEFT: 'left',
    RIGHT: 'right'
};

/**
 * Scratch 3.0 blocks to interact with a Robo risen peripheral.
 */
class Scratch3PingPongAutoCarBlocks {

    /**
     * @return {string} - the name of this extension.
     */
    static get EXTENSION_NAME () {
        return 'Auto Car';
    }

    /**
     * @return {string} - the ID of this extension.
     */
    static get EXTENSION_ID () {
        return 'PingPongAutoCar';
    }

    static get TILT_THRESHOLD() {
        return 20;
    }

    static get MOVE_THRESHOLD() {
        return 30;
    }

    get UP_DOWN_DIRECTION() {
        return [
            {
                text: formatMessage({
                    id: 'PingPongAutoCar.simple_act_direction.Up',
                    default: 'forward',
                    description: 'label for front element in up direction'
                }),
                value: simple_act_direction.Up
            },
            {
                text: formatMessage({
                    id: 'PingPongAutoCar.simple_act_direction.Down',
                    default: 'backward',
                    description: 'label for front element in Down direction'
                }),
                value: simple_act_direction.Down
            }
        ];
    }

    get LEFT_RIGHT_DIRECTION() {
        return [
            {
                text: formatMessage({
                    id: 'PingPongAutoCar.simple_act_direction.left',
                    default: 'left',
                    description: 'label for front element in left direction'
                }),
                value: simple_act_direction.left
            },
            {
                text: formatMessage({
                    id: 'PingPongAutoCar.simple_act_direction.right',
                    default: 'right',
                    description: 'label for front element in right direction'
                }),
                value: simple_act_direction.right
            }
        ];
    }

    get INTERVAL() {
        return [
            {
                text: '10',
                value: simple_act_interval.cm10
            },
            {
                text: '20',
                value: simple_act_interval.cm20
            },
            {
                text: '30',
                value: simple_act_interval.cm30
            },
            {
                text: '40',
                value: simple_act_interval.cm40
            },
            {
                text: '50',
                value: simple_act_interval.cm50
            }
        ];
    }

    get UP_DOWN_CONTINUOUS() {
        return [
            {
                text: '-100',
                value: continuous_act_speed.speedI100
            },
            {
                text: '-80',
                value: continuous_act_speed.speedI80
            },
            {
                text: '-60',
                value: continuous_act_speed.speedI60
            },
            {
                text: '-40',
                value: continuous_act_speed.speedI40
            },
            {
                text: '-20',
                value: continuous_act_speed.speedI20
            },
            {
                text: '0',
                value: continuous_act_speed.speed0
            },
            {
                text: '20',
                value: continuous_act_speed.speed20
            },
            {
                text: '40',
                value: continuous_act_speed.speed40
            },
            {
                text: '60',
                value: continuous_act_speed.speed60
            },
            {
                text: '80',
                value: continuous_act_speed.speed80
            },
            {
                text: '100',
                value: continuous_act_speed.speed100
            }
        ];
    }

    get DEGREE() {
        return [
            {
                text: '90',
                value: simple_act_degree.degree90
            },
            {
                text: '180',
                value: simple_act_degree.degree180
            },
            {
                text: '270',
                value: simple_act_degree.degree270
            }
        ];
    }

    get TILT_DIRECTION_MENU() {
        return [
            {
                text: formatMessage({
                    id: 'pingpongg2i.tiltDirectionMenu.front',
                    default: 'circle',
                    description: 'label for element in tilt direction'
                }),
                value: PingPongAutoCarTiltDirection.FRONT
            },
            {
                text: formatMessage({
                    id: 'pingpongg2i.tiltDirectionMenu.back',
                    default: 'triangle',
                    description: 'label for element in tilt direction'
                }),
                value: PingPongAutoCarTiltDirection.BACK
            },
            {
                text: formatMessage({
                    id: 'pingpongg2i.tiltDirectionMenu.left',
                    default: 'rectangle',
                    description: 'label for element in tilt direction'
                }),
                value: PingPongAutoCarTiltDirection.LEFT
            },
            {
                text: formatMessage({
                    id: 'pingpongg2i.tiltDirectionMenu.right',
                    default: 'star',
                    description: 'label for element in tilt direction'
                }),
                value: PingPongAutoCarTiltDirection.RIGHT
            }
        ];
    }
    //rozen 11.07 add
    get CUBES(){
      return [
          {   text: formatMessage({
              id: 'pingpong.LEFT',
              default: PingPongAutoCarCubes.LEFT,
              description: '1'
              }),
              value: PingPongAutoCarCubes.LEFT
          },
          {
            text: formatMessage({
                id: 'pingpong.RIGHT',
                default: PingPongAutoCarCubes.RIGHT,
                description: '2'
                }),
                value: PingPongAutoCarCubes.RIGHT
          },
          {
            text: formatMessage({
                id: 'pingpong.ALL',
                default: PingPongAutoCarCubes.ALL,
                description: 'all'
                }),
                value: PingPongAutoCarCubes.ALL
          }
      ];
    }

    get BUTTONS_MENU() {
        return [
            {
                text: '1',
                value: PingPongAutoCarButtons.A
            },
            {
                text: '2',
                value: PingPongAutoCarButtons.B
            }
        ];
    }

    constructor (runtime) {
        /**
         * The Scratch 3.0 runtime.
         * @type {Runtime}
         */
        this.runtime = runtime;

        console.log("Scratch3PingPongAutoCarBlocks constructor called 001");

        // Create a new PingPongAutocar peripheral instance
        this._peripheral = new PingPongAutoCar(this.runtime, Scratch3PingPongAutoCarBlocks.EXTENSION_ID);

        console.log("Scratch3PingPongAutoCarBlocks constructor called 002");

        this.frameToggle = false;

        setInterval(() => {
            this.frameToggle = !this.frameToggle;
        }, this.runtime.currentStepTime);

        this.inActionC1C2 = false;
    }

    /**
     * @returns {object} metadata for this extension and its blocks.
     */
    getInfo() {
        console.log("getinfo pingpong autocar called");
        return {
            id: Scratch3PingPongAutoCarBlocks.EXTENSION_ID,
            name: Scratch3PingPongAutoCarBlocks.EXTENSION_NAME,
            blockIconURI: blockIconURI,
            showStatusButton: true,
            blocks: [
                {
                    opcode: 'updownact',
                    text: formatMessage({
                        id: 'pingpongautocar.updownact',
                        default: 'go [INTERVAL] cm [DIRECTION]',
                        description: 'fldgo002'
                    }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                        DIRECTION: {
                            type: ArgumentType.STRING,
                            menu: 'updowndirection',
                            defaultValue: simple_act_direction.Up
                        },
                        INTERVAL: {
                            type: ArgumentType.STRING,
                            defaultValue: simple_act_interval.cm10
                        }
                    }
                },
                {
                    opcode: 'leftrightact',
                    text: formatMessage({
                        id: 'pingpongautocar.leftrightact',
                        default: 'turn [DEGREE] degrees [DIRECTION]',
                        description: 'fldgo002'
                    }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                        DIRECTION: {
                            type: ArgumentType.STRING,
                            menu: 'leftrightdirection',
                            defaultValue: simple_act_direction.left
                        },
                        DEGREE: {
                            type: ArgumentType.STRING,
                            defaultValue: simple_act_degree.degree90
                        }
                    }
                },
                {
                    opcode: 'updownactC',
                    text: formatMessage({
                        id: 'pingpongautocar.updownactC',
                        default: 'set velocity to left: [SPEED1] right: [SPEED2]',
                        description: 'fldgo002'
                    }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                        SPEED1: {
                            type: ArgumentType.STRING,
                            menu: 'updowncontinuous',
                            defaultValue: continuous_act_speed.speed100
                        },
                        SPEED2: {
                            type: ArgumentType.STRING,
                            menu: 'updowncontinuous',
                            defaultValue: continuous_act_speed.speed100
                        }
                    }
                },
                {
                    opcode: 'updownactCLA',
                    text: formatMessage({
                        id: 'pingpongautocar.updownactCLA',
                        default: 'set velocity to [CUBE]: [SPEED1]',
                        description: 'fldgo002'
                    }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                        CUBE: {
                          type: ArgumentType.STRING,
                          menu: 'cubes',
                          defaultValue: PingPongAutoCarCubes.LEFT
                        },
                        SPEED1: {
                            type: ArgumentType.STRING,
                            menu: 'updowncontinuous',
                            defaultValue: simple_act_direction.Up
                        }
                    }
                },
                {
                  //rozen 11.07 ADD
                    opcode: 'stopMotors',
                    text: formatMessage({
                        id: 'pingpongautocar.allStop',
                        default: '[CUBE] stop',
                        description: 'fldgo002'
                    }),
                    blockType: BlockType.COMMAND,
                    arguments:{
                      CUBE: {
                        type: ArgumentType.STRING,
                        menu: 'cubes',
                        defaultValue: PingPongAutoCarCubes.LEFT
                      }
                    }
                },
                {
                    opcode: 'isTilted',
                    text: formatMessage({
                        id: 'pingpongg2i.isTilted',
                        default: 'cube [BTN] tilted to [DIRECTION]?',
                        description: 'is the cube is tilted in a direction?'
                    }),
                    blockType: BlockType.BOOLEAN,
                    arguments: {
                        BTN: {
                            type: ArgumentType.STRING,
                            menu: 'buttons',
                            defaultValue: PingPongAutoCarButtons.A
                        },
                        DIRECTION: {
                            type: ArgumentType.STRING,
                            menu: 'tiltDirection',
                            defaultValue: PingPongAutoCarTiltDirection.FRONT
                        }
                    }
                },
                {
                     opcode: 'getAllGyro',
                     text: formatMessage({
                         id: 'pingpongg2i.getAllGyro',
                         default: 'tilt angle of [CUBE] to [DIRECTION]',
                         description: 'the value returned by the distance sensor'
                     }),
                     blockType: BlockType.REPORTER,
                     arguments:{
                       CUBE: {
                           type: ArgumentType.STRING,
                           menu: 'cubes',
                           defaultValue: PingPongAutoCarCubes.LEFT
                       },
                       DIRECTION: {
                           type: ArgumentType.STRING,
                           menu: 'tiltDirection',
                           defaultValue: PingPongAutoCarTiltDirection.FRONT
                       }
                     }
                }
            ],
            menus: {
                updowndirection: this.UP_DOWN_DIRECTION,
                leftrightdirection: this.LEFT_RIGHT_DIRECTION,
                tiltDirection: this.TILT_DIRECTION_MENU,
                interval:{
                    acceptReporters: true,
                    items: this.INTERVAL
                } ,
                updowncontinuous: {
                    acceptReporters: true,
                    items: this.UP_DOWN_CONTINUOUS
                },
                buttons: this.BUTTONS_MENU,
                degree: {
                    acceptReporters: true,
                    items: this.DEGREE
                },
                cubes : this.CUBES
            }
        };
    }

    setValues(arg){

    }

    _isTiltedC1(direction) {
        return this._getTiltAngleC1(direction) >= Scratch3PingPongAutoCarBlocks.TILT_THRESHOLD;
    }

    _isTiltedC2(direction) {
        return this._getTiltAngleC2(direction) >= Scratch3PingPongAutoCarBlocks.TILT_THRESHOLD;
    }

    updownact(args) {
        console.log("updownAct " + args.DIRECTION + " " + args.INTERVAL);

        if (this._peripheral.AllConnected == false)
            return;

        if (this.inActionC1C2 == true)
            return;

        if (args.DIRECTION != simple_act_direction.Up && args.DIRECTION != simple_act_direction.Down) {
            console.log("updwonAct unknown direction!");
            return;
        }

        this.inActionC1C2 = true;
        var Speed = 80;

        if (args.DIRECTION == simple_act_direction.Down) {
            Speed *= -1;
        }

        var SinglesData = new Array(2);
        SinglesData[0] = PingPongUtil.makeSingleData(0, 0, Speed * -1, args.INTERVAL, 24.44444);
        SinglesData[1] = PingPongUtil.makeSingleData(1, 0, Speed, args.INTERVAL, 24.44444);

        SinglesData[0][4] = 0x20; // make grouping
        SinglesData[1][4] = 0x20; // make grouping

        SinglesData[0][12] = 2; // make resume
        SinglesData[1][12] = 2; // make resume


        var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(SinglesData, 2, 1);
        var TimeDelay = PingPongUtil.calculateTimeFromspeeddistance(Speed, args.INTERVAL, 24.44444) + 400;

        console.log("will delay " + TimeDelay);


        this._peripheral.send(OutPutData);
        this._peripheral.setWaitResponseOPCode(0xcd, 400);

        this._peripheral.receivedLastPointDone = -1;

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2 = false;
                clearInterval(repeat);
                resolve();
            }, TimeDelay);
        });
    }

    leftrightact(args) {
        console.log("leftrightact " + args.DIRECTION + " " + args.INTERVAL);

        if (this._peripheral.AllConnected == false)
            return;


        if (args.DIRECTION != simple_act_direction.left && args.DIRECTION != simple_act_direction.right) {
            console.log("updwonAct unknown direction!");
            return;
        }

        if (this.inActionC1C2 == true)
            return;

        this.inActionC1C2 = true;
        var Speed = 80;

        if (args.DIRECTION == simple_act_direction.right) {
            Speed *= -1;
        }

        var SinglesData = new Array(2);
        SinglesData[0] = PingPongUtil.makeSingleData(0, 0, Speed, args.DEGREE, 2.25);
        SinglesData[1] = PingPongUtil.makeSingleData(1, 0, Speed, args.DEGREE, 2.25);

        SinglesData[0][12] = 2; // make resume
        SinglesData[1][12] = 2; // make resume

        var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(SinglesData, 2, 1);

        this._peripheral.receivedLastPointDone = -1;

        var TimeDelay = PingPongUtil.calculateTimeFromspeeddistance(Speed, args.DEGREE, 2.25) + 200;

        console.log("will delay " + TimeDelay);

        this._peripheral.send(OutPutData);
        this._peripheral.setWaitResponseOPCode(0xcd, 400);

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2 = false;
                clearInterval(repeat);
                resolve();
            }, TimeDelay);
        });
    }

    updownactC(args) {
        console.log("updownActC " + args.SPEED1 + " " + args.SPEED2);

        if (this._peripheral.AllConnected == false)
            return;

        var ContinuousData = new Array(2);
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, args.SPEED1 * -1);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, args.SPEED2);
        var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(ContinuousData, 2, 0);

        this._peripheral.send(OutPutData);
        this._peripheral.setWaitResponseOPCode(0xcd, 400);

        return new Promise(resolve => {
            setInterval(() => {
                resolve();
            }, 400);
        });
    }

    updownactCLA(args) {
      if(args.CUBE == PingPongAutoCarCubes.ALL){
        if (this._peripheral.AllConnected == false)
            return;

        var ContinuousData = new Array(2);
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, args.SPEED1);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, args.SPEED1);
        var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(ContinuousData, 2, 0);

        this._peripheral.send(OutPutData);
        this._peripheral.setWaitResponseOPCode(0xcd, 400);

      }

      if(args.CUBE == PingPongAutoCarCubes.LEFT){
        var ContinuousData = new Array(2);
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, args.SPEED1*-1);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, args.SPEED1);
        ContinuousData[1][6] = 0x00; // make dummy opcode
        var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(ContinuousData, 2, 0);

        //this._peripheral.send(ContinuousData);
        this._peripheral.send(OutPutData);
        this._peripheral.setWaitResponseOPCode(0xcd, 400);
      }

      if(args.CUBE == PingPongAutoCarCubes.RIGHT){
        var ContinuousData = new Array(2);
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, args.SPEED1);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, args.SPEED1);
        ContinuousData[0][6] = 0x00; // make dummy opcode
        var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(ContinuousData, 2, 0);


        //this._peripheral.send(ContinuousData);
        this._peripheral.send(OutPutData);
        this._peripheral.setWaitResponseOPCode(0xcd, 400);

      }
      return new Promise(resolve => {
          setInterval(() => {
              resolve();
          }, 400);
      });
    }

    stopMotors(args) {
      if(args.CUBE == PingPongAutoCarCubes.ALL){
        if (this._peripheral.AllConnected == false)
            return;

        var ContinuousData = new Array(2);
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, 0);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, 0);
        var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(ContinuousData, 2, 0);

        this._peripheral.send(OutPutData);
        this._peripheral.setWaitResponseOPCode(0xcd, 400);

      }

      if(args.CUBE == PingPongAutoCarCubes.LEFT){
        var ContinuousData = new Array(2);
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, 0);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, 1000);
        ContinuousData[1][6] = 0x00; // make dummy opcode
        var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(ContinuousData, 2, 0);

        //this._peripheral.send(ContinuousData);
        this._peripheral.send(OutPutData);
        this._peripheral.setWaitResponseOPCode(0xcd, 400);
      }

      if(args.CUBE == PingPongAutoCarCubes.RIGHT){
        var ContinuousData = new Array(2);
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, 1000);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, 0);
        ContinuousData[0][6] = 0x00; // make dummy opcode
        var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(ContinuousData, 2, 0);

        //this._peripheral.send(ContinuousData);
        this._peripheral.send(OutPutData);
        this._peripheral.setWaitResponseOPCode(0xcd, 400);

      }
      return new Promise(resolve => {
          setInterval(() => {
              resolve();
          }, 400);
      });
    }

    isTilted(args) {
        if (args.BTN === 'a') {
            return this._isTiltedC1(args.DIRECTION);
        } else if (args.BTN === 'b') {
            return this._isTiltedC2(args.DIRECTION);
        }
        return false;
    }

    _getTiltAngleC1(direction) {
        switch (direction) {
            case PingPongAutoCarTiltDirection.FRONT:
                return Math.round(this._peripheral._sensors.C1tiltX * -1);
            case PingPongAutoCarTiltDirection.BACK:
                return Math.round(this._peripheral._sensors.C1tiltX);
            case PingPongAutoCarTiltDirection.LEFT:
                return Math.round(this._peripheral._sensors.C1tiltY * -1);
            case PingPongAutoCarTiltDirection.RIGHT:
                return Math.round(this._peripheral._sensors.C1tiltY);
            default:
                log.warn(`Unknown tilt direction in _getTiltAngle: ${direction}`);
        }
    }

    _getTiltAngleC2(direction) {
        switch (direction) {
            case PingPongAutoCarTiltDirection.FRONT:
                return Math.round(this._peripheral._sensors.C2tiltX * -1);
            case PingPongAutoCarTiltDirection.BACK:
                return Math.round(this._peripheral._sensors.C2tiltX);
            case PingPongAutoCarTiltDirection.LEFT:
                return Math.round(this._peripheral._sensors.C2tiltY * -1);
            case PingPongAutoCarTiltDirection.RIGHT:
                return Math.round(this._peripheral._sensors.C2tiltY);
            default:
                log.warn(`Unknown tilt direction in _getTiltAngle: ${direction}`);
        }
    }

    _getTiltAngle(direction) {
        switch (direction) {
            case PingPongAutoCarTiltDirection.FRONT:
                return Math.round(this._peripheral._sensors.C1tiltX * -1);
            case PingPongAutoCarTiltDirection.BACK:
                return Math.round(this._peripheral._sensors.C1tiltX);
            case PingPongAutoCarTiltDirection.LEFT:
                return Math.round(this._peripheral._sensors.C1tiltY * -1);
            case PingPongAutoCarTiltDirection.RIGHT:
                return Math.round(this._peripheral._sensors.C1tiltY);
            default:
                log.warn(`Unknown tilt direction in _getTiltAngle: ${direction}`);
        }
    }

    getAllGyro(args){
        if(args.CUBE == PingPongAutoCarCubes.LEFT){
          switch (args.DIRECTION) {
            case PingPongAutoCarTiltDirection.FRONT:
              //동그라미
                return this._peripheral._sensors.C1tiltX * -1;
            case PingPongAutoCarTiltDirection.BACK:
              //세모
              return this._peripheral._sensors.C1tiltX;
            case PingPongAutoCarTiltDirection.LEFT:
              //네모
                return this._peripheral._sensors.C1tiltY * -1;
            case PingPongAutoCarTiltDirection.RIGHT:
              //별
              return this._peripheral._sensors.C1tiltY;
          }
        }
        if(args.CUBE == PingPongAutoCarCubes.RIGHT){
          switch (args.DIRECTION) {
            case PingPongAutoCarTiltDirection.FRONT:
              //동그라미
              return this._peripheral._sensors.C2tiltX * -1;
            case PingPongAutoCarTiltDirection.BACK:
              //세모
              return this._peripheral._sensors.C2tiltX;
            case PingPongAutoCarTiltDirection.LEFT:
              //네모
                return this._peripheral._sensors.C2tiltY * -1;
            case PingPongAutoCarTiltDirection.RIGHT:
              //별
              return this._peripheral._sensors.C2tiltY;
          }
        }
    }

    getGyroXC1() {
        return this._peripheral._sensors.C1tiltX;
    }

    getGyroYC1() {
        return this._peripheral._sensors.C1tiltY;
    }

    getGyroZC1() {
        return this._peripheral._sensors.C1tiltZ;
    }

    getGyroXC2() {
        return this._peripheral._sensors.C2tiltX;
    }

    getGyroYC2() {
        return this._peripheral._sensors.C2tiltY;
    }

    getGyroZC2() {
        return this._peripheral._sensors.C2tiltZ;
    }
}

module.exports = Scratch3PingPongAutoCarBlocks;
