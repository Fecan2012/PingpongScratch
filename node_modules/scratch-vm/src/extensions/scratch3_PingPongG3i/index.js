const ArgumentType = require('../../extension-support/argument-type');
const BlockType = require('../../extension-support/block-type');
const log = require('../../util/log');
const cast = require('../../util/cast');
const formatMessage = require('format-message');
const BLE = require('../../io/blepingpong');
const MathUtil = require('../../util/math-util');
const Base64Util = require('../../util/base64-util');
const PingPongUtil = require('../../util/pingpong-util');
const blockIconURI = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAABQCAIAAAABc2X6AAAACXBIWXMAAC4jAAAuIwF4pT92AAAF+mlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxNDUgNzkuMTYzNDk5LCAyMDE4LzA4LzEzLTE2OjQwOjIyICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdEV2dD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlRXZlbnQjIiB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iIHhtbG5zOnBob3Rvc2hvcD0iaHR0cDovL25zLmFkb2JlLmNvbS9waG90b3Nob3AvMS4wLyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ0MgMjAxOSAoV2luZG93cykiIHhtcDpDcmVhdGVEYXRlPSIyMDE5LTA2LTA0VDEzOjU5OjA3KzA5OjAwIiB4bXA6TWV0YWRhdGFEYXRlPSIyMDE5LTA2LTA0VDEzOjU5OjA3KzA5OjAwIiB4bXA6TW9kaWZ5RGF0ZT0iMjAxOS0wNi0wNFQxMzo1OTowNyswOTowMCIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDphMGRmMTIyOC0wYTdmLWVhNDItYjE5NC0zYWQ1OWYwZWJhZDkiIHhtcE1NOkRvY3VtZW50SUQ9ImFkb2JlOmRvY2lkOnBob3Rvc2hvcDo1MDhkZDU3Ny0wY2VjLTM1NDYtYTk0Mi02Y2IyYzg2Y2UyMmUiIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDpmMGJjN2M5OC1mMzkxLWEyNGItOGE3MC1jNDQ5YjFlNzgxYTYiIGRjOmZvcm1hdD0iaW1hZ2UvcG5nIiBwaG90b3Nob3A6Q29sb3JNb2RlPSIzIiBwaG90b3Nob3A6SUNDUHJvZmlsZT0ic1JHQiBJRUM2MTk2Ni0yLjEiPiA8eG1wTU06SGlzdG9yeT4gPHJkZjpTZXE+IDxyZGY6bGkgc3RFdnQ6YWN0aW9uPSJjcmVhdGVkIiBzdEV2dDppbnN0YW5jZUlEPSJ4bXAuaWlkOmYwYmM3Yzk4LWYzOTEtYTI0Yi04YTcwLWM0NDliMWU3ODFhNiIgc3RFdnQ6d2hlbj0iMjAxOS0wNi0wNFQxMzo1OTowNyswOTowMCIgc3RFdnQ6c29mdHdhcmVBZ2VudD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTkgKFdpbmRvd3MpIi8+IDxyZGY6bGkgc3RFdnQ6YWN0aW9uPSJzYXZlZCIgc3RFdnQ6aW5zdGFuY2VJRD0ieG1wLmlpZDphMGRmMTIyOC0wYTdmLWVhNDItYjE5NC0zYWQ1OWYwZWJhZDkiIHN0RXZ0OndoZW49IjIwMTktMDYtMDRUMTM6NTk6MDcrMDk6MDAiIHN0RXZ0OnNvZnR3YXJlQWdlbnQ9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE5IChXaW5kb3dzKSIgc3RFdnQ6Y2hhbmdlZD0iLyIvPiA8L3JkZjpTZXE+IDwveG1wTU06SGlzdG9yeT4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz7WusTnAAARaUlEQVR4nN1caZgU1bl+zzlV1dVdvUz3dM/WMKyyKUS4KBoVFxKjmEXUazCKUWNcEHPVByUoisbEG6Im3CeiUUGSx8QbUcFIJHGULW4gBkRBEdGRdTaa7umu7uruqjrn/uhZWBqma2ZQuO/Tf6an69T31lm+tT6i10XR26AUbi+FhyLLkROxVv7FHntns9Wc4PEkP+jHHheJBFmkjA6sYdEIU90UbgLAbuXZnADpZdmk3hpICEgMahmDBBhiyzZzzebcB5+Z67bk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';
var GroupId="";
var TimeDelay= "";
try {
   GroupId = document.getElementById('isGroup').value == "false" ? "" : document.getElementById('groupId').value;
}catch(e){

}
const BLEUUID = {
    namePrefix: 'PINGPONG.'+ GroupId,
    service: '6e400001-b5a3-f393-e0a9-e50e24dcca9e',
    txChar: '6e400002-b5a3-f393-e0a9-e50e24dcca9e',
    rxChar: '6e400003-b5a3-f393-e0a9-e50e24dcca9e',
    groupID: GroupId
};
class PingPongG3i {

    constructor(runtime, extensionId) {
        this._runtime = runtime;

        this._ble = null;
        this._runtime.registerPeripheralExtension(extensionId, this);

        this._extensionId = extensionId;

        this.disconnect = this.disconnect.bind(this);
        this._onConnect = this._onConnect.bind(this);
        this._onMessage = this._onMessage.bind(this);

        this.connectCount = 3;

        this.AllConnected = false;

        this.receivedNotifyData = null;
        this.bContinueReceived = false;
        this.waitResponseOPCode = -1;

        this._sensors = {
            C1tiltX: 0,
            C1tiltY: 0,
            C1tiltZ: 0,
            C2tiltX: 0,
            C2tiltY: 0,
            C2tiltZ: 0,
            C3tiltX: 0,
            C3tiltY: 0,
            C3tiltZ: 0,

            C1moveX: 0,
            C1moveY: 0,
            c1moveZ: 0,
            C2moveX: 0,
            C2moveY: 0,
            c2moveZ: 0,
            C3moveX: 0,
            C3moveY: 0,
            c3moveZ: 0,

             // 2019.12.20 Fean added
             C1ADval: 0,
             C2ADvaL: 0,
             C3ADVal: 0

        };
        // 2019.12.23 fecan added
        this._tempo = {
            C1Tempo: 60,
            C2Tempo: 60,
            C3Tempo: 60
        };

        this._buttons = {
            C1Button: 0,
            C2Button: 0,
            C3Button: 0
        };

        this._proximity = {
            C1ProxOld: 0,
            C2ProxOld: 0,
            C3ProxOld: 0,
            C1Prox: 0,
            C2Prox: 0,
            C3Prox: 0,
            C1ProxInterVal: 0,
            C2ProxInterVal: 0,
            C3ProxInterVal: 0
        };

        this.receivedNotifyData = null;
        this.bContinueReceived = false;

        console.log("pingpong g3i constructor call end");
    }

    scan() {
        if (this._ble) {
            this._ble.disconnect();
        }
        this._ble = new BLE(this._runtime, this._extensionId, {
            filters: [
                { namePrefix: BLEUUID.namePrefix , groupID: BLEUUID.groupID}
            ]
        }, this._onConnect, this.disconnect);
    }

    connect(id) {
        console.log("connect " + id);
        if (this._ble) {
            this._ble.connectPeripheral(id);
        }
    }

    disconnect() {
        if (this._ble) {
            this._ble.disconnect();
        }

        this.AllConnected = false;
    }

    isConnected() {
        let connected = false;
        if (this._ble) {
            connected = this._ble.isConnected();
        }

        if (connected == true)
            return this.AllConnected;

        this.AllConnected = false;
        return this.AllConnected;
    }

    send(message, force = false) {
        if (force == false)
            if (!this.isConnected()) return;

        const data = Base64Util.uint8ArrayToBase64(message);

        this._ble.write(BLEUUID.service, BLEUUID.txChar, data, 'base64', false).then(
            () => {
                console.log("send done to scratch links");
            }
        );
    }

    NotificationEventFC(value)
    {
        console.log('NotificationEventFC');

        if (value == null)
            return;

        // check connect
        if (value.byteLength == 18) {
            if (value[6] == 0xad || value[6] == 0xae) {
                if (value[12] == 0x02) {
                    this.AllConnected = true;
                    this._runtime.emit(this._runtime.constructor.PERIPHERAL_CONNECTED);

                    window.setTimeout(() => {
                        if (this._ble) {
                            this.send(PingPongUtil.getSensorsData(0xff, 30));
                        }
                    }, 3000);
                }
            }
        }
        if (value.byteLength == 19 || value.byteLength == 20) {
            if (value[6] == 0xb8 && value[5] == 0xc8) {
                if (value[8] == 0x13 || value[8] == 0x14) {
                    this.CheckProximityData(value);
                }
            }
        }
    }

    setWaitResponseOPCode(nCode, nTimeOut) {
        if (this.waitResponseOPCode != -1)
            return;
        if (this.waitResponseOPCodetimeoutID != null) {
            console.log("will cancel timer");
            window.clearTimeout(this.waitResponseOPCodetimeoutID);
            this.waitResponseOPCodetimeoutID = null;
        }
        this.waitResponseOPCode = nCode;
        console.log("set opcode");
        this.waitResponseOPCodetimeoutID = window.setTimeout(() => {
            console.log("timer called will clear opcode");
            this.waitResponseOPCode = -1;
            this.waitResponseOPCodetimeoutID = null;
        }, nTimeOut);
    }

    CheckProximityData(value)
    {
        var x1 = PingPongUtil.getSignedIntfromByteData(value[12]);
        var x2 = PingPongUtil.getSignedIntfromByteData(value[13]);
        var x3 = PingPongUtil.getSignedIntfromByteData(value[14]);
        var xx = PingPongUtil.getACCDataToDegreeMinus90To90fromByteData(value[15]);
        var yy = PingPongUtil.getACCDataToDegreeMinus90To90fromByteData(value[16]);
        yy *= -1;
        var zz = PingPongUtil.getACCDataToDegreeMinus90To90fromByteData(value[17]);
        // 2019.12.20 Roborisen Added
        var ad = PingPongUtil.getUnsignedIntfromByteData(value[19]);

        if (value[3] == 0) {
            console.log("cube1 Detect " + value[3]);
            this._sensors.C1moveX = x1;
            this._sensors.C1moveY = x2;
            this._sensors.C1moveZ = x3;

            this._sensors.C1tiltX = xx;
            this._sensors.C1tiltY = yy;
            this._sensors.C1tiltZ = zz;
            this._sensors.C1ADval = ad;

            this._buttons.C1Button = value[11];
            this._proximity.C1Prox = PingPongUtil.getUnsignedIntfromByteData(value[18]);
            this._proximity.C1ProxInterVal = this._proximity.C1Prox - this._proximity.C1ProxOld;
            this._proximity.C1ProxOld = this._proximity.C1Prox;
        }

        if (value[3] == 1) {
            console.log("cube2 Detect " + value[3]);
            this._sensors.C2moveX = x1;
            this._sensors.C2moveY = x2;
            this._sensors.C2moveZ = x3;

            this._sensors.C2tiltX = xx;
            this._sensors.C2tiltY = yy;
            this._sensors.C2tiltZ = zz;
            this._sensors.C2ADval = ad;

            this._buttons.C2Button = value[11];
            this._proximity.C2Prox = PingPongUtil.getUnsignedIntfromByteData(value[18]);
            this._proximity.C2ProxInterVal = this._proximity.C2Prox - this._proximity.C2ProxOld;
            this._proximity.C2ProxOld = this._proximity.C2Prox;
        }

        if(value[3] == 2){
          console.log("cube3 Detect " + value[3]);
          this._sensors.C3moveX = x1;
          this._sensors.C3moveY = x2;
          this._sensors.C3moveZ = x3;

          this._sensors.C3tiltX = xx;
          this._sensors.C3tiltY = yy;
          this._sensors.C3tiltZ = zz;
          this._sensors.C3ADval = ad;

          this._buttons.C3Button = value[11];
          this._proximity.C3Prox = PingPongUtil.getUnsignedIntfromByteData(value[18]);
          this._proximity.C3ProxInterVal = this._proximity.C3Prox - this._proximity.C3ProxOld;
          this._proximity.C3ProxOld = this._proximity.C3Prox;
        }
    }

    _onConnect() {
        this._ble.startNotifications(BLEUUID.service, BLEUUID.rxChar, this._onMessage);

        window.setTimeout(() => {
            this.send(PingPongUtil.getSetMultiroleInAction(this.connectCount), true);
        }, 1000);
    }

    _onMessage(base64) {
        const datas = Base64Util.base64ToUint8Array(base64);

        PingPongUtil.printUint8ArrayToHex(datas, "Notification Data");
        this.NotificationEventFC(datas);
    }
}

const simple_act_direction = {
    Up: '0',
    Down: '1',
    left: '2',
    right: '3'
};

const simple_act_interval = {
    cm10: '10',
    cm20: '20',
    cm30: '30',
    cm40: '40',
    cm50: '50'
};

const simple_act_degreeradius = {
    degree10: '10',
    degree20: '20',
    degree30: '30',
    degree40: '40',
    degree50: '50',
    degree60: '60',
    degree70: '70',
    degree80: '80',
    degree90: '90',
    degree100: '100',
    degree110: '110',
    degree120: '120',
    degree130: '130',
    degree140: '140',
    degree150: '150',
    degree160: '160',
    degree170: '170',
    degree180: '180',
    degree190: '190',
    degree200: '200',
    degree210: '210',
    degree220: '220',
    degree230: '230',
    degree240: '240',
    degree250: '250',
    degree260: '260',
    degree270: '270',
    degree280: '280',
    degree290: '290',
    degree300: '300',
    degree310: '310',
    degree320: '320',
    degree330: '330',
    degree340: '340',
    degree350: '350',
    degree360: '360'
};

const continuous_act_speed = {
    speedI100: '-100',
    speedI90: '-90',
    speedI80: '-80',
    speedI70: '-70',
    speedI60: '-60',
    speedI50: '-50',
    speedI40: '-40',
    speedI30: '-30',
    speedI20: '-20',
    speedI10: '-10',
    speed0: '0',
    speed10: '10',
    speed20: '20',
    speed30: '30',
    speed40: '40',
    speed50: '50',
    speed60: '60',
    speed70: '70',
    speed80: '80',
    speed90: '90',
    speed100: '100'
};
/*
const matrix_pixel_position = {
    position0: '0',
    position1: '1',
    position2: '2',
    position3: '3',
    position4: '4',
    position5: '5',
    position6: '6',
    position7: '7'
};
*/
const led_turn_onoff = {
    off: '0',
    on: '1'
};
const play_note_beats = {
    note45: '45',
    note46: '46',
    note47: '47',
    note48: '48',
    note49: '49',
    note50: '50',
    note51: '51',
    note52: '52',
    note53: '53',
    note54: '54',
    note55: '55',
    note56: '56',
    note57: '57',
    note58: '58',
    note59: '59',
    note60: '60',
    note61: '61',
    note62: '62',
    note63: '63',
    note64: '64',
    note65: '65',
    note66: '66',
    note67: '67',
    note68: '68',
    note69: '69',
    note70: '70',
    note71: '71',
    note72: '72'
};
const PingPongG3iCube = {
    ONE: '1',
    TWO: '2',
    THREE:'3'
};
const PingPongG3iCubes = {
    ONE: '1',
    TWO: '2',
    THREE:'3',
    ALL:'ALL'
};
const PingPongG3IButtons = {
    A: 'a',
    B: 'b',
    C: 'c',
    ANY: 'any'
};

const PingPongG3ILoDirect = {
    L: 'left',
    R: 'right',
};

const PingPongG3ITiltDirection = {
    FRONT: '원',
    BACK: '세모',
    LEFT: '네모',
    RIGHT: '별모양',
};

const PingPongG3IUpperDirection = {
    FRONT: 'front',
    BACK: 'back',
    LEFT: 'left',
    RIGHT: 'right',
    UP: 'up',
    DOWN: 'down'
};

const PingPongG3ISensorType = {
    ADSENSOR: 'adsensor',
    PROXIMITYS: 'proximity'
};

class Scratch3PingPongG3iBlocks {

    static get EXTENSION_NAME() {
        return 'PingPong G3i';
    }

    static get EXTENSION_ID () {
        return 'PingPongG3i';
    }

    static get TILT_THRESHOLD() {
        return 20;
    }

    static get MOVE_THRESHOLD() {
        return 30;
    }

    get LEFT_RIGHT_DIRECTION() {
        return [
            {
                text: '왼쪽',
                value: simple_act_direction.left
            },
            {
                text: '오른쪽',
                value: simple_act_direction.right
            }
        ];
    }

    get BUTTONS_MENU() {
        return [
            {
                text: '1',
                value: PingPongG3IButtons.A
            },
            {
                text: '2',
                value: PingPongG3IButtons.B
            },
            {
                text: '3',
                value: PingPongG3IButtons.C
            },
            {
                text: 'any',
                value: PingPongG3IButtons.ANY
            }
        ];
    }

    get LODIRECT_MENU() {
        return [
            {
                text: formatMessage({
                    id: 'pingpongwormbot.PingPongWormBotLoDirect.R',
                    default: '시계',
                    description: 'lotate clock'
                }),
                value: PingPongG3ILoDirect.R
            },
            {
                text: formatMessage({
                    id: 'pingpongwormbot.PingPongWormBotLoDirect.L',
                    default: '반시계',
                    description: 'lotate counter clock'
                }),
                value: PingPongG3ILoDirect.L
            }
        ];
    }

    get GESTURES_MENU() {
        return [
            {
                text: 'A',
                value: PingPongG3IButtons.A
            },
            {
                text: 'B',
                value: PingPongG3IButtons.B
            },
            {
                text: 'C',
                value: PingPongG3IButtons.C            }
        ];
    }

    get TILT_DIRECTION_MENU() {
        return [
            {
                text: formatMessage({
                    id: 'pingpongg3i.tiltDirectionMenu.front',
                    default: '원',
                    description: 'label for front element in tilt direction picker for micro:bit extension'
                }),
                value: PingPongG3ITiltDirection.FRONT
            },
            {
                text: formatMessage({
                    id: 'pingpongg3i.tiltDirectionMenu.back',
                    default: '세모',
                    description: 'label for back element in tilt direction picker for micro:bit extension'
                }),
                value: PingPongG3ITiltDirection.BACK
            },
            {
                text: formatMessage({
                    id: 'pingpongg3i.tiltDirectionMenu.left',
                    default: '네모',
                    description: 'label for left element in tilt direction picker for micro:bit extension'
                }),
                value: PingPongG3ITiltDirection.LEFT
            },
            {
                text: formatMessage({
                    id: 'pingpongg3i.tiltDirectionMenu.right',
                    default: '별모양',
                    description: 'label for right element in tilt direction picker for micro:bit extension'
                }),
                value: PingPongG3ITiltDirection.RIGHT
            }
        ];
    }

    get TILT_DIRECTION_ANY_MENU() {
        return [
            ...this.TILT_DIRECTION_MENU,
            {
                text: formatMessage({
                    id: 'pingpongg3i.tiltDirectionMenu.any',
                    default: 'any direction',
                    description: 'label for any direction element in tilt direction picker for micro:bit extension'
                }),
                value: PingPongG3ITiltDirection.ANY
            }
        ];
    }

    get UP_DOWN_CONTINUOUS() {
        return [
            {
                text: '-100',
                value: continuous_act_speed.speedI100
            },
            {
                text: '-80',
                value: continuous_act_speed.speedI80
            },
            {
                text: '-60',
                value: continuous_act_speed.speedI60
            },
            {
                text: '-40',
                value: continuous_act_speed.speedI40
            },
            {
                text: '-20',
                value: continuous_act_speed.speedI20
            },
            {
                text: '0',
                value: continuous_act_speed.speed0
            },
            {
                text: '20',
                value: continuous_act_speed.speed20
            },
            {
                text: '40',
                value: continuous_act_speed.speed40
            },
            {
                text: '60',
                value: continuous_act_speed.speed60
            },
            {
                text: '80',
                value: continuous_act_speed.speed80
            },
            {
                text: '100',
                value: continuous_act_speed.speed100
            }
        ];
    }
    // fecan 2019.12.26 ADDED
    get TURN_ON_OFF() {
        return [
            {
                text: formatMessage({
                    id: 'pingpongg1i.led_turn_onoff.on',
                    default: 'on',
                    description: 'Turn on option for the matrix'
                }),
                value:  led_turn_onoff.on
            },
            {
                text: formatMessage({
                    id: 'pingpongg1i.led_turn_onoff.off',
                    default: 'off',
                    description: 'Turn off option for the matrix'
                }),
                value: led_turn_onoff.off
            }
        ];
    }
    /*
    get PIXELPOSITION() {
        return [
            {
                text: '0',
                value: matrix_pixel_position.postion0
            },
            {
                text: '1',
                value: matrix_pixel_position.postion1
            },
            {
                text: '2',
                value: matrix_pixel_position.postion2
            },
            {
                text: '3',
                value: matrix_pixel_position.postion3
            },
            {
                text: '4',
                value: matrix_pixel_position.postion4
            },
            {
                text: '5',
                value: matrix_pixel_position.postion5
            },
            {
                text: '6',
                value: matrix_pixel_position.postion6
            },
            {
                text: '7',
                value: matrix_pixel_position.postion7
            }
        ];
    }
    */
   // fecan 2019.12.26 added
   get PLAY_MUSIC_BEATS() {
        return [
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.45',
                    default: 'note45',
                    description: 'Play note 45 for duration'
                }),
                value:  play_note_beats.note45
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.46',
                    default: 'note46',
                    description: 'Play note 46 for duration'
                }),
                value:  play_note_beats.note46
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.47',
                    default: 'note47',
                    description: 'Play note 47 for duration'
                }),
                value:  play_note_beats.note47
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.48',
                    default: 'note48',
                    description: 'Play note 48 for duration'
                }),
                value:  play_note_beats.note48
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.49',
                    default: 'note49',
                    description: 'Play note 49 for duration'
                }),
                value:  play_note_beats.note49
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.50',
                    default: 'note50',
                    description: 'Play note 50 for duration'
                }),
                value:  play_note_beats.note50
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.51',
                    default: 'note51',
                    description: 'Play note 51 for duration'
                }),
                value:  play_note_beats.note51
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.52',
                    default: 'note52',
                    description: 'Play note 52 for duration'
                }),
                value:  play_note_beats.note52
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.53',
                    default: 'note53',
                    description: 'Play note 53 for duration'
                }),
                value:  play_note_beats.note53
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.54',
                    default: 'note54',
                    description: 'Play note 54 for duration'
                }),
                value:  play_note_beats.note54
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.55',
                    default: 'note55',
                    description: 'Play note 55 for duration'
                }),
                value:  play_note_beats.note55
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.56',
                    default: 'note56',
                    description: 'Play note 56 for duration'
                }),
                value:  play_note_beats.note56
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.57',
                    default: 'note57',
                    description: 'Play note 57 for duration'
                }),
                value:  play_note_beats.note57
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.58',
                    default: 'note58',
                    description: 'Play note 58 for duration'
                }),
                value:  play_note_beats.note58
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.59',
                    default: 'note59',
                    description: 'Play note 59 for duration'
                }),
                value:  play_note_beats.note59
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.60',
                    default: 'note60',
                    description: 'Play note 60 for duration'
                }),
                value:  play_note_beats.note60
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.61',
                    default: 'note61',
                    description: 'Play note 61 for duration'
                }),
                value:  play_note_beats.note61
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.62',
                    default: 'note62',
                    description: 'Play note 62 for duration'
                }),
                value:  play_note_beats.note62
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.63',
                    default: 'note63',
                    description: 'Play note 63 for duration'
                }),
                value:  play_note_beats.note63
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.64',
                    default: 'note64',
                    description: 'Play note 64 for duration'
                }),
                value:  play_note_beats.note64
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.65',
                    default: 'note65',
                    description: 'Play note 65 for duration'
                }),
                value:  play_note_beats.note65
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.66',
                    default: 'note66',
                    description: 'Play note 66 for duration'
                }),
                value:  play_note_beats.note66
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.67',
                    default: 'note67',
                    description: 'Play note 67 for duration'
                }),
                value:  play_note_beats.note67
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.68',
                    default: 'note68',
                    description: 'Play note 68 for duration'
                }),
                value:  play_note_beats.note68
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.69',
                    default: 'note69',
                    description: 'Play note 69 for duration'
                }),
                value:  play_note_beats.note69
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.70',
                    default: 'note70',
                    description: 'Play note 70 for duration'
                }),
                value:  play_note_beats.note70
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.71',
                    default: 'note71',
                    description: 'Play note 71 for duration'
                }),
                value:  play_note_beats.note71
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.72',
                    default: 'note72',
                    description: 'Play note 72 for duration'
                }),
                value:  play_note_beats.note72
            }
        ];
    }
        //rozen 11.07 add
        get CUBE(){
        return [
            {   text: formatMessage({
                id: 'pingpong.ONE',
                default: PingPongG3iCubes.ONE,
                description: '1'
                }),
                value: PingPongG3iCubes.ONE
            },
            {
            text: formatMessage({
                id: 'pingpong.TWO',
                default: PingPongG3iCubes.TWO,
                description: '2'
                }),
                value: PingPongG3iCubes.TWO
            },
            {
            text: formatMessage({
                id: 'pingpong.THREE',
                default: PingPongG3iCubes.THREE,
                description: '3'
                }),
                value: PingPongG3iCubes.THREE
            }
        ];
    }

    get CUBES(){
      return [
        {   text: formatMessage({
            id: 'pingpong.ONE',
            default: PingPongG3iCubes.ONE,
            description: '1'
            }),
            value: PingPongG3iCubes.ONE
        },
        {
          text: formatMessage({
              id: 'pingpong.TWO',
              default: PingPongG3iCubes.TWO,
              description: '2'
              }),
              value: PingPongG3iCubes.TWO
        },
        {
          text: formatMessage({
              id: 'pingpong.THREE',
              default: PingPongG3iCubes.THREE,
              description: '3'
              }),
              value: PingPongG3iCubes.THREE
        },
        {
          text: formatMessage({
              id: 'pingpong.ALL',
              default: PingPongG3iCubes.ALL,
              description: 'all'
              }),
              value: PingPongG3iCubes.ALL
        }
      ];
    }

    get UPPER_DIRECTION_MENU() {
        return [
            {
                text: formatMessage({
                    id: 'pingpongg1i.upperDirectionMenu.front',
                    default: 'rectangle',
                    description: 'label for front element in upper direction'
                }),
                value: PingPongG3IUpperDirection.FRONT
            },
            {
                text: formatMessage({
                    id: 'pingpongg1i.upperDirectionMenu.back',
                    default: 'star',
                    description: 'label for front element in upper direction'
                }),
                value: PingPongG3IUpperDirection.BACK
            },
            {
                text: formatMessage({
                    id: 'pingpongg1i.upperDirectionMenu.left',
                    default: 'triangle',
                    description: 'label for front element in upper direction'
                }),
                value: PingPongG3IUpperDirection.LEFT
            },
            {
                text: formatMessage({
                    id: 'pingpongg1i.upperDirectionMenu.right',
                    default: 'circle',
                    description: 'label for front element in upper direction'
                }),
                value: PingPongG3IUpperDirection.RIGHT
            },
            {
                text: formatMessage({
                    id: 'pingpongg1i.upperDirectionMenu.up',
                    default: 'heart',
                    description: 'label for front element in upper direction'
                }),
                value: PingPongG3IUpperDirection.UP
            },
            {
                text: formatMessage({
                    id: 'pingpongg1i.upperDirectionMenu.down',
                    default: 'none',
                    description: 'label for front element in upper direction'
                }),
                value: PingPongG3IUpperDirection.DOWN
            }
        ];
    }

    get SENSOR(){
        return [
            {   text: formatMessage({
                id: 'pingpongSensor.ADS',
                default: PingPongG3ISensorType.ADSENSOR,
                description: 'adsensor'
                }),
                value: PingPongG3ISensorType.ADSENSOR
            },
            {
              text: formatMessage({
                  id: 'pingpongSensor.PROX',
                  default: PingPongG3ISensorType.PROXIMITYS,
                  description: 'Proximity'
                  }),
                  value: PingPongG3ISensorType.PROXIMITYS
            }
        ];
    }

    static get BEAT_RANGE () {
        return {min: 0, max: 40};
    }

    static get TEMPO_RANGE () {
        return {min: 20, max: 500};
    }
    /**
     * Construct a set of MicroBit blocks.
     * @param {Runtime} runtime - the Scratch 3.0 runtime.
     */
    constructor (runtime) {
        /**
         * The Scratch 3.0 runtime.
         * @type {Runtime}
         */
        this.runtime = runtime;

        console.log("Scratch3PingPongG3iBlocks constructor called 001");

        // Create a new PingPongG3i peripheral instance
        this._peripheral = new PingPongG3i(this.runtime, Scratch3PingPongG3iBlocks.EXTENSION_ID);

        this.inActionC1C2C3 = false;
        console.log("Scratch3PingPongG3iBlocks constructor called 002");
    }

    /**
     * @returns {object} metadata for this extension and its blocks.
     */
    getInfo() {
        console.log("getinfo pingpong G3i called");
        return {
            id: Scratch3PingPongG3iBlocks.EXTENSION_ID,
            name: Scratch3PingPongG3iBlocks.EXTENSION_NAME,
            blockIconURI: blockIconURI,
            showStatusButton: true,
            blocks: [
                {
                    opcode: 'whenButtonPressed',
                    text: formatMessage({
                        id: 'pingpongg3i.whenButtonPressed',
                        default: '[BTN] 큐브의 버튼을 눌렀을때',
                        description: 'when the selected button on the cube is pressed'
                    }),
                    blockType: BlockType.HAT,
                    arguments: {
                        BTN: {
                            type: ArgumentType.STRING,
                            menu: 'buttons',
                            defaultValue: PingPongG3IButtons.A
                        }
                    }
                },
                {
                    opcode: 'whenTilted',
                    text: formatMessage({
                        id: 'pingpongg3i.isTilted',
                        default: '[BTN] 큐브가 [DIRECTION] 기울어 졌을때',
                        description: 'is the cube is tilted in a direction?'
                    }),
                    blockType: BlockType.HAT,
                    arguments: {
                        BTN: {
                            type: ArgumentType.STRING,
                            menu: 'buttons',
                            defaultValue: PingPongG3IButtons.A
                        },
                        DIRECTION: {
                            type: ArgumentType.STRING,
                            menu: 'tiltDirectionAny',
                            defaultValue: PingPongG3ITiltDirection.FRONT
                        }
                    }
                },
                {
                    opcode: 'motorall',
                    text: formatMessage({
                        id: 'pingpongg3i.motorall',
                        default: 'rotate motor1: [RADIUS1] degrees [LODIRECT1] motor2: [RADIUS2] degrees [LODIRECT2] motor3: [RADIUS3] degrees [LODIRECT3]',
                        description: 'is the micro:bit is tilted in a direction?'
                    }),
                    arguments: {
                        LODIRECT1: {
                            type: ArgumentType.STRING,
                            menu: 'lodirect',
                            defaultValue: PingPongG3ILoDirect.R
                        },
                        LODIRECT2: {
                            type: ArgumentType.STRING,
                            menu: 'lodirect',
                            defaultValue: PingPongG3ILoDirect.R
                        },
                        LODIRECT3: {
                            type: ArgumentType.STRING,
                            menu: 'lodirect',
                            defaultValue: PingPongG3ILoDirect.R
                        },
                        RADIUS1: {
                            type: ArgumentType.STRING,
                            defaultValue: simple_act_degreeradius.degree90
                        },
                        RADIUS2: {
                            type: ArgumentType.STRING,
                            defaultValue: simple_act_degreeradius.degree90
                        },
                        RADIUS3: {
                            type: ArgumentType.STRING,
                            defaultValue: simple_act_degreeradius.degree90
                        }
                    }
                },
                {
                    opcode: 'motorChoice',
                    text: formatMessage({
                        id: 'pingpongg3i.motorChoice',
                        default: 'rotate motor[CUBE]: [RADIUS] degrees [LODIRECT]',
                        description: 'is the micro:bit is tilted in a direction?'
                    }),
                    arguments: {
                        CUBE:{
                          type: ArgumentType.STRING,
                          menu: 'cubes',
                          defaultValue: PingPongG3iCubes.ONE
                        },
                        LODIRECT: {
                            type: ArgumentType.STRING,
                            menu: 'lodirect',
                            defaultValue: PingPongG3ILoDirect.R
                        },
                        RADIUS: {
                            type: ArgumentType.STRING,
                            defaultValue: simple_act_degreeradius.degree90
                        }
                    }
                },
                {
                    opcode: 'updownactC',
                    text: formatMessage({
                        id: 'pingpongg3i.updownactC',
                        default: 'set velocity to CUBE1: [SPEED1] CUBE2: [SPEED2] CUBE3:[SPEED3]',
                        description: 'fldgo002'
                    }),
                    arguments: {
                        SPEED1: {
                            type: ArgumentType.STRING,
                            menu: 'updowncontinuous',
                            defaultValue: continuous_act_speed.speed100
                        },
                        SPEED2: {
                            type: ArgumentType.STRING,
                            menu: 'updowncontinuous',
                            defaultValue: continuous_act_speed.speed100
                        },
                        SPEED3: {
                            type: ArgumentType.STRING,
                            menu: 'updowncontinuous',
                            defaultValue: continuous_act_speed.speed100
                        }
                    }
                },{
                    opcode: 'updownactCLA',
                    text: formatMessage({
                        id: 'pingpongg3i.updownactCLA',
                        default: 'set velocity to CUBE [CUBE]: [SPEED1]',
                        description: 'fldgo002'
                    }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                        CUBE: {
                          type: ArgumentType.STRING,
                          menu: 'cubes',
                          defaultValue: PingPongG3iCubes.ONE
                        },
                        SPEED1: {
                            type: ArgumentType.STRING,
                            menu: 'updowncontinuous',
                            defaultValue: continuous_act_speed.speed100
                        }
                    }
                },
                {
                  //rozen 11.07 ADD
                    opcode: 'stopMotors',
                    text: formatMessage({
                        id: 'pingpongautocar.allStop',
                        default: 'CUBE [CUBE] stop',
                        description: 'fldgo002'
                    }),
                    blockType: BlockType.COMMAND,
                    arguments:{
                      CUBE: {
                        type: ArgumentType.STRING,
                        menu: 'cubes',
                        defaultValue: PingPongG3iCubes.ONE
                      }
                    }
                },
                // fecan 2019.12.22 ADDED
                {
                    opcode: 'turnonoffLedMatrixPixelEach',
                    text: formatMessage({
                        id: 'pingpongg2i.displayPixelEach',
                        default: 'Led [TURNONOFF] CUBE [CUBE]  x: [COORDX] y: [COORDY]',
                        description: 'display a pixel for each cube'
                   }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                       TURNONOFF: {
                            type: ArgumentType.STRING,
                            menu: 'turnonoffpixels',
                            defaultValue: led_turn_onoff.on
                       }, 
                       CUBE: {
                            type: ArgumentType.STRING,
                            defaultValue: PingPongG3iCubes.ONE
                        },
                       COORDX: {
                            type: ArgumentType.NUMBER,
                            defaultValue: 0
                        },
                       COORDY: {
                             type: ArgumentType.NUMBER,
                             defaultValue: 0
                       }
                    }
                },
                {
                    opcode: 'displayLedMatrixStringDurationEach',
                    text: formatMessage({
                        id: 'pingpongg2i.displayStringDurationEach',
                        default: 'display text CUBE [CUBE]  [MSTRING] for  [MSECOND] second',
                        description: 'display string with duration value'
                   }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                      CUBE: {
                            type: ArgumentType.STRING,
                            defaultValue: PingPongG3iCubes.ONE
                      },
                      MSTRING: {
                           type: ArgumentType.STRING,
                           defaultValue: "Hello!"
                       },
                      MSECOND: {
                          type: ArgumentType.STRING,
                          defaultValue: "1"
                    }
                    }
                 },
                {
                    opcode: 'clearMatrixPixelsEach',
                    text: formatMessage({
                        id: 'pingpongg2i.clearPixelsEach',
                        default: 'clear CUBE [CUBE] display',
                        description: 'clear pixels'
                   }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                        CUBE: {
                            type: ArgumentType.STRING,
                            defaultValue: PingPongG3iCubes.ONE
                        }
                      }
                },
                {
                    opcode: 'setServoDegreeEach',
                    text: formatMessage({
                        id: 'pingpongg2i.setServoDegreeEach',
                        default: 'servo motor angle  [SERVODEGREE]',
                        description: 'set servo degree'
                   }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                        CUBE: {
                            type: ArgumentType.STRING,

                            defaultValue: PingPongG3iCubes.ONE
                        },
                        SERVODEGREE: {
                             type: ArgumentType.STRING,
                             defaultValue: "0"
                         }
                    }
                },
                {
                    opcode: 'restForBeatsEach',
                    text: formatMessage({
                        id: 'pingpongg2i.restForBeatsEach',
                        default: 'cube [CUBE]  rest for [BEATS] beats',
                        description: 'rest (play no sound) for a number of beats'
                    }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                        CUBE: {
                            type: ArgumentType.STRING,
                            menu: 'cubes',
                            defaultValue: PingPongG3iCubes.ONE
                        },
                        BEATS: {
                            type: ArgumentType.STRING,
                            defaultValue: "0.5"
                        }
                    }
                },
                /*
                {
                    opcode: 'restForBeatsAll',
                    text: formatMessage({
                        id: 'pingpongg2i.restForBeatsAll',
                        default: 'cube all rest for [BEATS] beats',
                        description: 'all cubes rest (play no sound) for a number of beats'
                    }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                        BEATS: {
                            type: ArgumentType.STRING,
                            defaultValue: "0.5"
                        }
                    }
                },
                */
                {
                    opcode: 'playNoteForBeatsEach',
                    text: formatMessage({
                        id: 'pingpongg2i.playNoteForBeatsEach',
                        default: 'cube [CUBE]  play note [NOTE] for [BEATS] beats',
                        description: 'play a note for a number of beats'
                    }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                        CUBE: {
                            type: ArgumentType.STRING,
                            menu: 'cube',
                            defaultValue: PingPongG3iCubes.ONE
                        },
                        NOTE: {
                            type: ArgumentType.STRING,
                            menu: 'playmusicbeats',
                            defaultValue: play_note_beats.note48
                        },
                        BEATS: {
                            type: ArgumentType.STRING,
                            defaultValue: "1"
                        }
                    }
                },
                {
                    opcode: 'playChordForBeats',
                    text: formatMessage({
                        id: 'pingpongg2i.playChordForBeats',
                        default: 'cube [CUBE1] play [NOTE1] cube [CUBE2] play [NOTE2] cube [CUBE3] play [NOTE3] for [BEATS] beats',
                        description: 'play a chord note for a number of beats'
                    }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                        CUBE1: {
                            type: ArgumentType.STRING,
                            menu: 'cube',
                            defaultValue: PingPongG3iCubes.ONE
                        },
                        CUBE2: {
                            type: ArgumentType.STRING,
                            menu: 'cube',
                            defaultValue: PingPongG3iCubes.TWO
                        },
                        CUBE3: {
                            type: ArgumentType.STRING,
                            menu: 'cube',
                            defaultValue: PingPongG3iCubes.THREE
                        },
                        NOTE1: {
                            type: ArgumentType.STRING,
                            menu: 'playmusicbeats',
                            defaultValue: play_note_beats.note48
                        },
                        NOTE2: {
                            type: ArgumentType.STRING,
                            menu: 'playmusicbeats',
                            defaultValue: play_note_beats.note48
                        },
                        NOTE3: {
                            type: ArgumentType.STRING,
                            menu: 'playmusicbeats',
                            defaultValue: play_note_beats.note48
                        },
                        BEATS: {
                            type: ArgumentType.STRING,
                            defaultValue: "1"
                        }
                    }
                },
                {
                    opcode: 'setTempoEach',
                    blockType: BlockType.COMMAND,
                    text: formatMessage({
                        id: 'pingpongg2i.setTempoEach',
                        default: 'cube [CUBE]  set tempo to [TEMPO]',
                        description: 'set tempo (speed) for notes, drums, and rests played'
                    }),
                    arguments: {
                        CUBE: {
                            type: ArgumentType.STRING,
                            menu: 'cube',
                            defaultValue: PingPongG3iCubes.ONE
                        },
                        TEMPO: {
                            type: ArgumentType.STRING,
                            defaultValue: "60"
                        }
                    }
                },
                {
                    opcode: 'isTilted',
                    text: formatMessage({
                        id: 'pingpongg3i.isTilted',
                        default: '큐브[BTN] 가(이) [DIRECTION]로(으로) 기울어 졌는가?',
                        description: 'is the cube is tilted in a direction?'
                    }),
                    blockType: BlockType.BOOLEAN,
                    arguments: {
                        BTN: {
                            type: ArgumentType.STRING,
                            menu: 'buttons',
                            defaultValue: PingPongG3IButtons.A
                        },
                        DIRECTION: {
                            type: ArgumentType.STRING,
                            menu: 'tiltDirectionAny',
                            defaultValue: PingPongG3ITiltDirection.FRONT
                        }
                    }
                },
                {
                    opcode: 'isUpper',
                    text: formatMessage({
                        id: 'pingpongg2i.isUpper',
                        default: 'cube [BTN] [DIRECTION] shown in top view?',
                        description: 'is the cube is upper in a direction?'
                    }),
                    blockType: BlockType.BOOLEAN,
                    arguments: {
                        BTN: {
                            type: ArgumentType.STRING,
                            menu: 'buttons',
                            defaultValue: PingPongG3IButtons.A
                        },
                        DIRECTION: {
                            type: ArgumentType.STRING,
                            menu: 'upperDirection',
                            defaultValue: PingPongG3IUpperDirection.FRONT
                        }
                    }
                },
                {
                    opcode: 'isButtonPressed',
                    text: formatMessage({
                        id: 'pingpongg3i.isButtonPressed',
                        default: '[BTN] 큐브의 버튼을 눌렀는가?',
                        description: 'is the button on the cube pressed?'
                    }),
                    blockType: BlockType.BOOLEAN,
                    arguments: {
                        BTN: {
                            type: ArgumentType.STRING,
                            menu: 'buttons',
                            defaultValue: PingPongG3IButtons.A
                        }
                    }
                },
                {
                    opcode: 'getGyroSensor',
                    text: formatMessage({
                        id: 'pingpongg3i.getGyroSensor',
                        default: 'tilt angle of cube[CUBE] to [DIRECTION]',
                        description: 'the value returned by the distance sensor'
                    }),
                    blockType: BlockType.REPORTER,
                    arguments:{
                        CUBE:{
                            type: ArgumentType.STRING,
                            menu: "cube",
                            defaultValue: PingPongG3iCube.ONE
                        },
                        DIRECTION:{
                          type: ArgumentType.STRING,
                          menu: 'tiltDirectionAny',
                          defaultValue: PingPongG3ITiltDirection.FRONT
                        }
                    }
                },
                // 2019.12.20 FecanRoborisen Add
                {
                    opcode: 'getTempoEach',
                    text: formatMessage({
                        id: 'pingpongg2i.getTempoEach',
                        default: 'cube [CUBE]  tempo',
                        description: 'get the current tempo (speed) for notes, drums, and rests played'
                    }),
                    blockType: BlockType.REPORTER,
                    arguments: {
                        CUBE: {
                            type: ArgumentType.STRING,
                            menu: 'cube',
                            defaultValue: PingPongG3iCubes.ONE
                        }
                    }
                },
                {
                    opcode: 'getADSensorValueEach',
                    text: formatMessage({
                        id: 'pingpongg3i.getADSensorValueEach',
                        default: 'value of [CUBE]cube [SENSOR] sensor',
                        description: 'the value returned by the each external sensor'
                    }),
                    blockType: BlockType.REPORTER,
                    arguments:{
                        CUBE: {
                            type: ArgumentType.STRING,
                            menu: 'cube',
                            defaultValue: PingPongG3iCube.ONE
                        },
                        SENSOR:{
                            type: ArgumentType.STRING,
                            menu: "sensor",
                            defaultValue: PingPongG3ISensorType.PROXIMITYS
                        }
                    }               
                }
            ],
            
            menus: {
                tiltDirectionAny: this.TILT_DIRECTION_MENU,
                buttons: this.BUTTONS_MENU,
                lodirect: this.LODIRECT_MENU,
                cubes : this.CUBES,
                cube : this.CUBE,
                sensor : this.SENSOR,
                playmusicbeats: {
                    acceptReporters: true,
                    items: this.PLAY_MUSIC_BEATS
                },
                turnonoffpixels: {
                    acceptReporters: true,
                    items: this.TURN_ON_OFF,
                },
                updowncontinuous: this.UP_DOWN_CONTINUOUS,
                upperDirection:this.UPPER_DIRECTION_MENU
//                gestures: this.GESTURES_MENU
            }
        };
    }

    updownactC(args) {

        console.log("updownActC " + args.SPEED1 + " " + args.SPEED2);

        if (this._peripheral.AllConnected == false)
            return;

        var ContinuousData = new Array(3);
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, args.SPEED1);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, args.SPEED2);
        ContinuousData[2] = PingPongUtil.makeContinuousData(2, 0, args.SPEED3);
        var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(ContinuousData, 3, 0);

        this._peripheral.send(OutPutData);
        this._peripheral.setWaitResponseOPCode(0xcd, 400);

        return new Promise(resolve => {
            setInterval(() => {
                resolve();
            }, 400);
        });
    }

    stopMotors(args) {
      if (this._peripheral.AllConnected == false)
          return;

      if(args.CUBE == PingPongG3iCubes.ALL){
        var ContinuousData = new Array(3);
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, 0);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, 0);
        ContinuousData[2] = PingPongUtil.makeContinuousData(2, 0, 0);
        var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(ContinuousData, 3, 0);

      }

      if(args.CUBE == PingPongG3iCubes.ONE){
        var ContinuousData = new Array(3);
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, 0);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, 1000);
        ContinuousData[2] = PingPongUtil.makeContinuousData(2, 0, 1000);
        ContinuousData[1][6] = 0x00; // make dummy opcode
        ContinuousData[2][6] = 0x00; // make dummy opcode
        var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(ContinuousData, 3, 0);

        //this._peripheral.send(ContinuousData);
      }

      if(args.CUBE == PingPongG3iCubes.TWO){
        var ContinuousData = new Array(3);
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, 1000);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, 0);
        ContinuousData[2] = PingPongUtil.makeContinuousData(2, 0, 1000);
        ContinuousData[0][6] = 0x00; // make dummy opcode
        ContinuousData[2][6] = 0x00; // make dummy opcode
        var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(ContinuousData, 3, 0);

      }

      if(args.CUBE == PingPongG3iCubes.THREE){
        var ContinuousData = new Array(3);
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, 1000);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, 1000);
        ContinuousData[2] = PingPongUtil.makeContinuousData(2, 0, 0);
        ContinuousData[0][6] = 0x00; // make dummy opcode
        ContinuousData[1][6] = 0x00; // make dummy opcode
        var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(ContinuousData, 3, 0);

      }

      this._peripheral.send(OutPutData);
      this._peripheral.setWaitResponseOPCode(0xcd, 400);

      return new Promise(resolve => {
          setInterval(() => {
              resolve();
          }, 400);
      });
    }

    updownactCLA(args) {
      if(args.CUBE == PingPongG3iCubes.ALL){
        if (this._peripheral.AllConnected == false)
            return;

        var ContinuousData = new Array(3);
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, args.SPEED1);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, args.SPEED1);
        ContinuousData[2] = PingPongUtil.makeContinuousData(2, 0, args.SPEED1);
        var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(ContinuousData, 3, 0);

      }

      if(args.CUBE == PingPongG3iCubes.ONE){
        var ContinuousData = new Array(3);
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, args.SPEED1);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, args.SPEED1);
        ContinuousData[2] = PingPongUtil.makeContinuousData(2, 0, args.SPEED1);
        ContinuousData[1][6] = 0x00; // make dummy opcode
        ContinuousData[2][6] = 0x00; // make dummy opcode
        var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(ContinuousData, 3, 0);
      }

      if(args.CUBE == PingPongG3iCubes.TWO){
        var ContinuousData = new Array(3);
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, args.SPEED1);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, args.SPEED1);
        ContinuousData[2] = PingPongUtil.makeContinuousData(2, 0, args.SPEED1);
        ContinuousData[0][6] = 0x00; // make dummy opcode
        ContinuousData[2][6] = 0x00; // make dummy opcode
        var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(ContinuousData, 3, 0);

      }
      if(args.CUBE == PingPongG3iCubes.THREE){
        var ContinuousData = new Array(3);
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, args.SPEED1);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, args.SPEED1);
        ContinuousData[2] = PingPongUtil.makeContinuousData(2, 0, args.SPEED1);
        ContinuousData[0][6] = 0x00; // make dummy opcode
        ContinuousData[1][6] = 0x00; // make dummy opcode
        var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(ContinuousData, 3, 0);

      }
      this._peripheral.send(OutPutData);
      this._peripheral.setWaitResponseOPCode(0xcd, 400);
      /*
      return new Promise(resolve => {
          setInterval(() => {
              resolve();
          }, 400);
      });
      */
        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2C3C4 = false;
                clearInterval(repeat);
                resolve();
            }, 400);
        });
    }

    isUpper(args) {

        if (args.BTN == PingPongG3IButtons.A)
        {
            if (args.DIRECTION == PingPongG3IUpperDirection.FRONT) {
                if (this._peripheral._sensors.C1tiltY > 70)
                    return true;
            }

            if (args.DIRECTION == PingPongG3IUpperDirection.BACK) {
                if (this._peripheral._sensors.C1tiltY < -70)
                    return true;
            }

            if (args.DIRECTION == PingPongG3IUpperDirection.LEFT) {
                if (this._peripheral._sensors.C1tiltX < -70)
                    return true;
            }

            if (args.DIRECTION == PingPongG3IUpperDirection.RIGHT) {
                if (this._peripheral._sensors.C1tiltX > 70)
                    return true;
            }

            if (args.DIRECTION == PingPongG3IUpperDirection.UP) {
                if (this._peripheral._sensors.C1tiltZ < -70)
                    return true;
            }

            if (args.DIRECTION == PingPongG3IUpperDirection.DOWN) {
                if (this._peripheral._sensors.C1tiltZ > 70)
                    return true;
            }
        }

        if (args.BTN == PingPongG3IButtons.B)
        {
            if (args.DIRECTION == PingPongG3IUpperDirection.FRONT) {
                if (this._peripheral._sensors.C2tiltY > 70)
                    return true;
            }

            if (args.DIRECTION == PingPongG3IUpperDirection.BACK) {
                if (this._peripheral._sensors.C2tiltY < -70)
                    return true;
            }

            if (args.DIRECTION == PingPongG3IUpperDirection.LEFT) {
                if (this._peripheral._sensors.C2tiltX < -70)
                    return true;
            }

            if (args.DIRECTION == PingPongG3IUpperDirection.RIGHT) {
                if (this._peripheral._sensors.C2tiltX > 70)
                    return true;
            }

            if (args.DIRECTION == PingPongG3IUpperDirection.UP) {
                if (this._peripheral._sensors.C2tiltZ < -70)
                    return true;
            }

            if (args.DIRECTION == PingPongG3IUpperDirection.DOWN) {
                if (this._peripheral._sensors.C2tiltZ > 70)
                    return true;
            }
        }


        if (args.BTN == PingPongG3IButtons.C)
        {
            if (args.DIRECTION == PingPongG3IUpperDirection.FRONT) {
                if (this._peripheral._sensors.C3tiltY > 70)
                    return true;
            }

            if (args.DIRECTION == PingPongG3IUpperDirection.BACK) {
                if (this._peripheral._sensors.C3tiltY < -70)
                    return true;
            }

            if (args.DIRECTION == PingPongG3IUpperDirection.LEFT) {
                if (this._peripheral._sensors.C3tiltX < -70)
                    return true;
            }

            if (args.DIRECTION == PingPongG3IUpperDirection.RIGHT) {
                if (this._peripheral._sensors.C3tiltX > 70)
                    return true;
            }

            if (args.DIRECTION == PingPongG3IUpperDirection.UP) {
                if (this._peripheral._sensors.C3tiltZ < -70)
                    return true;
            }

            if (args.DIRECTION == PingPongG3IUpperDirection.DOWN) {
                if (this._peripheral._sensors.C3tiltZ > 70)
                    return true;
            }
        }

        return false;
    }

    _isTiltedC1(direction) {
        return this._getTiltAngleC1(direction) >= Scratch3PingPongG3iBlocks.TILT_THRESHOLD;
    }

    _isTiltedC2(direction) {
        return this._getTiltAngleC2(direction) >= Scratch3PingPongG3iBlocks.TILT_THRESHOLD;
    }
    _isTiltedC3(direction) {
        return this._getTiltAngleC3(direction) >= Scratch3PingPongG3iBlocks.TILT_THRESHOLD;
    }
    _isMovedC1(direction) {
        return this._getMoveC1(direction) >= Scratch3PingPongG3iBlocks.MOVE_THRESHOLD;
    }

    _isMovedC2(direction) {
        return this._getMoveC2(direction) >= Scratch3PingPongG3iBlocks.MOVE_THRESHOLD;
    }

    _isMovedC3(direction) {
        return this._getMoveC3(direction) >= Scratch3PingPongG3iBlocks.MOVE_THRESHOLD;
    }

    _getTiltAngle(direction) {
        switch (direction) {
            case PingPongG3ITiltDirection.FRONT:
                return Math.round(this._peripheral._sensors.C1tiltX * -1);
            case PingPongG3ITiltDirection.BACK:
                return Math.round(this._peripheral._sensors.C1tiltX);
            case PingPongG3ITiltDirection.LEFT:
                return Math.round(this._peripheral._sensors.C1tiltY * -1);
            case PingPongG3ITiltDirection.RIGHT:
                return Math.round(this._peripheral._sensors.C1tiltY);
            default:
                log.warn(`Unknown tilt direction in _getTiltAngle: ${direction}`);
        }
    }

    _getTiltAngleC1(direction) {
        switch (direction) {
            case PingPongG3ITiltDirection.FRONT:
                return Math.round(this._peripheral._sensors.C1tiltX * -1);
            case PingPongG3ITiltDirection.BACK:
                return Math.round(this._peripheral._sensors.C1tiltX);
            case PingPongG3ITiltDirection.LEFT:
                return Math.round(this._peripheral._sensors.C1tiltY * -1);
            case PingPongG3ITiltDirection.RIGHT:
                return Math.round(this._peripheral._sensors.C1tiltY);
            default:
                log.warn(`Unknown tilt direction in _getTiltAngle: ${direction}`);
        }
    }

    _getTiltAngleC2(direction) {
        switch (direction) {
            case PingPongG3ITiltDirection.FRONT:
                return Math.round(this._peripheral._sensors.C2tiltX * -1);
            case PingPongG3ITiltDirection.BACK:
                return Math.round(this._peripheral._sensors.C2tiltX);
            case PingPongG3ITiltDirection.LEFT:
                return Math.round(this._peripheral._sensors.C2tiltY * -1);
            case PingPongG3ITiltDirection.RIGHT:
                return Math.round(this._peripheral._sensors.C2tiltY);
            default:
                log.warn(`Unknown tilt direction in _getTiltAngle: ${direction}`);
        }
    }

    _getTiltAngleC3(direction) {
        switch (direction) {
            case PingPongG3ITiltDirection.FRONT:
                return Math.round(this._peripheral._sensors.C3tiltX * -1);
            case PingPongG3ITiltDirection.BACK:
                return Math.round(this._peripheral._sensors.C3tiltX);
            case PingPongG3ITiltDirection.LEFT:
                return Math.round(this._peripheral._sensors.C3tiltY * -1);
            case PingPongG3ITiltDirection.RIGHT:
                return Math.round(this._peripheral._sensors.C3tiltY);
            default:
                log.warn(`Unknown tilt direction in _getTiltAngle: ${direction}`);
        }
    }

    _getMoveC1(direction) {
        switch (direction) {
            case PingPongG3ITiltDirection.LEFT:
                return Math.round(this._peripheral._sensors.C1moveZ * -1);
            case PingPongG3ITiltDirection.RIGHT:
                return Math.round(this._peripheral._sensors.C1moveZ);
            default:
                log.warn(`Unknown tilt direction in _getTiltMove: ${direction}`);
        }
    }

    _getMoveC2(direction) {
        switch (direction) {
            case PingPongG3ITiltDirection.LEFT:
                return Math.round(this._peripheral._sensors.C2moveZ * -1);
            case PingPongG3ITiltDirection.RIGHT:
                return Math.round(this._peripheral._sensors.C2moveZ);
            default:
                log.warn(`Unknown tilt direction in _getTiltMove: ${direction}`);
        }
    }

    _getMoveC3(direction) {
        switch (direction) {
            case PingPongG3ITiltDirection.LEFT:
                return Math.round(this._peripheral._sensors.C3moveZ * -1);
            case PingPongG3ITiltDirection.RIGHT:
                return Math.round(this._peripheral._sensors.C3moveZ);
            default:
                log.warn(`Unknown tilt direction in _getTiltMove: ${direction}`);
        }
    }

    isTilted(args) {

        if (args.BTN === 'a') {
            return this._isTiltedC1(args.DIRECTION);
        } else if (args.BTN === 'b') {
            return this._isTiltedC2(args.DIRECTION);
        } else if (args.BTN === 'c') {
            return this._isTiltedC3(args.DIRECTION);
        }
        return false;
    }


    whenTilted(args) {
        if (args.BTN === 'a') {
            return this._isTiltedC1(args.DIRECTION);
        } else if (args.BTN === 'b') {
            return this._isTiltedC2(args.DIRECTION);
        } else if (args.BTN === 'c') {
            return this._isTiltedC3(args.DIRECTION);
        } else if (args.BTN === 'any') {

            if (this._isTiltedC1(args.DIRECTION) == true)
                return true;

            if (this._isTiltedC2(args.DIRECTION) == true)
                return true;

            if (this._isTiltedC3(args.DIRECTION) == true)
                return true;
        }
        return false;
    }

    motorall(args) {
        console.log("motorall ");

        if (this._peripheral.AllConnected == false)
            return;

        if (this.inActionC1C2C3 == true)
            return;

        var Speed1 = 800;
        var Speed2 = 800;
        var Speed3 = 800;

        this.inActionC1C2C3 = true;

        if (args.LODIRECT1 == PingPongG3ILoDirect.L) {
            Speed1 *= -1;
        }

        if (args.LODIRECT2 == PingPongG3ILoDirect.L) {
            Speed2 *= -1;
        }

        if (args.LODIRECT3 == PingPongG3ILoDirect.L) {
            Speed3 *= -1;
        }

        var Step1 = Math.round(args.RADIUS1 * 5.5);
        var Step2 = Math.round(args.RADIUS2 * 5.5);
        var Step3 = Math.round(args.RADIUS3 * 5.5);

        console.log(Speed1 + Speed2 + Speed3 + " " + args.RADIUS1 + " " + args.RADIUS2 + " " + args.RADIUS3);

        var SinglesData = new Array(3);
        SinglesData[0] = PingPongUtil.makeSingleDataByStep(0, 0, Speed1, Step1);
        SinglesData[1] = PingPongUtil.makeSingleDataByStep(1, 0, Speed2, Step2);
        SinglesData[2] = PingPongUtil.makeSingleDataByStep(2, 0, Speed3, Step3);
        SinglesData[0][12] = 2; // make resume
        SinglesData[1][12] = 2; // make resume
        SinglesData[2][12] = 2; // make resume

        var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(SinglesData, 3, 1);

        var TimeDelay1 = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed1), Step1) + 400;

        var TimeDelay2 = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed2), Step2) + 400;

        var TimeDelay3 = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed3), Step3) + 400;

        var TimeDelay = TimeDelay1;

        if (TimeDelay2 > TimeDelay1)
            TimeDelay = TimeDelay2;

        if (TimeDelay3 > TimeDelay)
            TimeDelay = TimeDelay3;

        this._peripheral.send(OutPutData);

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2C3 = false;
                clearInterval(repeat);
                resolve();
            }, TimeDelay);
        });
    }

    motorallInOne(args) {
        console.log("motorallInOne ");

        if (this._peripheral.AllConnected == false)
            return;

        if (this.inActionC1C2C3 == true)
            return;

        var Speed1 = 800;
        var Speed2 = 800;
        var Speed3 = 800;

        this.inActionC1C2C3 = true;

        if (args.LODIRECT == PingPongG3ILoDirect.L) {
            Speed1 *= -1;
        }

        if (args.LODIRECT == PingPongG3ILoDirect.L) {
            Speed2 *= -1;
        }

        if (args.LODIRECT == PingPongG3ILoDirect.L) {
            Speed3 *= -1;
        }

        var Step1 = Math.round(args.RADIUS * 5.5);
        var Step2 = Math.round(args.RADIUS * 5.5);
        var Step3 = Math.round(args.RADIUS * 5.5);

        console.log(Speed1 + Speed2 + Speed3 + " " + args.RADIUS + " " + args.RADIUS + " " + args.RADIUS);

        var SinglesData = new Array(3);
        SinglesData[0] = PingPongUtil.makeSingleDataByStep(0, 0, Speed1, Step1);
        SinglesData[1] = PingPongUtil.makeSingleDataByStep(1, 0, Speed2, Step2);
        SinglesData[2] = PingPongUtil.makeSingleDataByStep(2, 0, Speed3, Step3);
        SinglesData[0][12] = 2; // make resume
        SinglesData[1][12] = 2; // make resume
        SinglesData[2][12] = 2; // make resume

        var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(SinglesData, 3, 1);

        var TimeDelay1 = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed1), Step1) + 400;

        var TimeDelay2 = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed2), Step2) + 400;

        var TimeDelay3 = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed3), Step3) + 400;

        var TimeDelay = TimeDelay1;

        if (TimeDelay2 > TimeDelay1)
            TimeDelay = TimeDelay2;

        if (TimeDelay3 > TimeDelay)
            TimeDelay = TimeDelay3;

        this._peripheral.send(OutPutData);

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2C3 = false;
                clearInterval(repeat);
                resolve();
            }, TimeDelay);
        });
    }

    motorChoice(args){
      if(args.CUBE == PingPongG3iCubes.ONE){
        this.motor1(args);
      }
      if(args.CUBE == PingPongG3iCubes.TWO){
        this.motor2(args);
      }
      if(args.CUBE == PingPongG3iCubes.THREE){
        this.motor3(args);
      }
      if(args.CUBE == PingPongG3iCubes.ALL){
        this.motorallInOne(args);
      }
      // branch function mode selection, pending
      return new Promise(resolve => {
        var repeat = setInterval(() => {
            this.inActionC1C2C3 = false;
            clearInterval(repeat);
            resolve();
            console.log("clearInterval ");
        }, TimeDelay);
    });
    }

    motor1(args) {
        if (this._peripheral.AllConnected == false)
            return;

        if (this.inActionC1C2C3 == true)
            return;

        var Speed = 800;

        this.inActionC1C2C3 = true;

        if (args.LODIRECT == PingPongG3ILoDirect.L) {
            Speed *= -1;
        }

        var Step = Math.round(args.RADIUS * 5.5);

        console.log(Speed + Step + " " + args.RADIUS + " " + args.RADIUS);

        var OutPutData = PingPongUtil.makeSingleDataByStep(0, 0, Speed, Step);
        OutPutData[12] = 2; // make resume

        TimeDelay = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed), Step) + 400

        this._peripheral.send(OutPutData);
        /*
        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2C3 = false;
                clearInterval(repeat);
                resolve();
            }, TimeDelay);
        });
        */
       return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2C3 = false;
                clearInterval(repeat);
                resolve();
                console.log("clearInterval ");
            }, TimeDelay);
        });
    }

    motor2(args) {
        if (this._peripheral.AllConnected == false)
            return;

        if (this.inActionC1C2C3 == true)
            return;

        var Speed = 800;

        this.inActionC1C2C3 = true;

        if (args.LODIRECT == PingPongG3ILoDirect.L) {
            Speed *= -1;
        }

        var Step = Math.round(args.RADIUS * 5.5);

        console.log(Speed + Step + " " + args.RADIUS + " " + args.RADIUS);

        var OutPutData = PingPongUtil.makeSingleDataByStep(1, 0, Speed, Step);
        OutPutData[12] = 2; // make resume

        TimeDelay = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed), Step) + 400

        this._peripheral.send(OutPutData);
        /*
        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2C3 = false;
                clearInterval(repeat);
                resolve();
            }, TimeDelay);
        });
        */
       return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2C3 = false;
                clearInterval(repeat);
                resolve();
                console.log("clearInterval ");
            }, TimeDelay);
        });
    }

    motor3(args) {
        console.log("motor3 ");

        if (this._peripheral.AllConnected == false)
            return;

        if (this.inActionC1C2C3 == true)
            return;

        var Speed = 800;

        this.inActionC1C2C3 = true;

        if (args.LODIRECT == PingPongG3ILoDirect.L) {
            Speed *= -1;
        }

        var Step = Math.round(args.RADIUS * 5.5);

        console.log(Speed + Step + " " + args.RADIUS + " " + args.RADIUS);

        var OutPutData = PingPongUtil.makeSingleDataByStep(2, 0, Speed, Step);
        OutPutData[12] = 2; // make resume

        TimeDelay = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed), Step) + 400

        this._peripheral.send(OutPutData);
        /*
        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2C3 = false;
                clearInterval(repeat);
                resolve();
            }, TimeDelay);
        });
        */
       return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2C3 = false;
                clearInterval(repeat);
                resolve();
                console.log("clearInterval ");
            }, TimeDelay);
        });
    }

    whenButtonPressed(args)
    {
        if (args.BTN === 'a') {
            if (this._peripheral._buttons.C1Button == 1)
                return true;
        } else if (args.BTN === 'b') {
            if (this._peripheral._buttons.C2Button == 1)
                return true;
        }else if (args.BTN === 'c') {
            if (this._peripheral._buttons.C3Button == 1)
                return true;
        }else if (args.BTN === 'any') {
            if (this._peripheral._buttons.C1Button == 1 || this._peripheral._buttons.C2Button == 1 || this._peripheral._buttons.C3Button == 1)
                return true;
        }
        return false;
    }

    isButtonPressed(args) {
        if (args.BTN === 'a') {
            if (this._peripheral._buttons.C1Button == 1)
                return true;
        } else if (args.BTN === 'b') {
            if (this._peripheral._buttons.C2Button == 1)
                return true;
        }else if (args.BTN === 'c') {
            if (this._peripheral._buttons.C3Button == 1)
                return true;
        } else if (args.BTN === 'any') {
            if (this._peripheral._buttons.C1Button == 1 || this._peripheral._buttons.C2Button == 1 || this._peripheral._buttons.C3Button == 1)
                return true;
        }
        return false;
    }

    // Display Maxtrix Pixel Each Cube, fecan 2019.12.22 ADDED 
    turnonoffLedMatrixPixelEach(args){
        if(this._peripheral.AllConnected == false)
          return;
        if (this.inActionC1C2C3 == true)
          return;
  
        this.inActionC1C2C3 = true;
        var MatrixLedPixelData = PingPongUtil.makeMatrixPixelData(0xe1, args.CUBE, args.COORDX, args.COORDY, args.TURNONOFF);
        this._peripheral.send(MatrixLedPixelData);
  
        console.log("Cube " + args.CUBE + "X  " + args.COORDX + " Y  " + args.COORDY);
        console.log("MatrixLedPixelData " + MatrixLedPixelData);
        /*
        return new Promise(resolve => {
          setInterval(() => {
              this.inActionC1C2C3 = false; // after command
              resolve();
          }, 100);
      });
      */
        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2C3 = false;
                clearInterval(repeat);
                resolve();
                console.log("clearInterval ");
            }, 200);
        });
    }
    /*
    turnOffLedMatrixPixelEach(args){
        if(this._peripheral.AllConnected == false)
          return;
        if (this.inActionC1C2C3 == true)
          return;
  
        this.inActionC1C2C3 = true;
        var MatrixLedPixelData = PingPongUtil.makeMatrixPixelData(0xe1, args.CUBE, args.COORDX, args.COORDY, 0x00);
        this._peripheral.send(MatrixLedPixelData);
  
        console.log("Cube " + args.CUBE + "X  " + args.COORDX + " Y  " + args.COORDY);
        console.log("MatrixLedPixelData " + MatrixLedPixelData);
        
        return new Promise(resolve => {
            setInterval(() => {
                this.inActionC1C2C3 = false;
                clearInterval(repeat);
                resolve();
            }, 200);
        });
    }
    */
    // Show Matrix String with duration for each Matrix
    displayLedMatrixStringDurationEach(args){
        if(this._peripheral.AllConnected == false)
          return;
        if (this.inActionC1C2C3 == true)
          return;
        
        this.inActionC1C2C3 = true;
  
        var MatrixLedStringData = PingPongUtil.makeMatrixStringData(0xe3, args.CUBE, args.MSTRING, args.MSECOND);
        this._peripheral.send(MatrixLedStringData);
        var mDuration = args.MSECOND + 200;
        console.log("MatrixLedStringData  " + MatrixLedStringData);
        
        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2C3 = false;
                clearInterval(repeat);
                resolve();
                console.log("clearInterval ");
            }, mDuration);
          });
    }
    // clear Matrix Pixels
    clearMatrixPixelsEach(args){
        if(this._peripheral.AllConnected == false)
            return;
        if (this.inActionC1C2C3 == true)
            return;
        
        this.inActionC1C2C3 = true;

        var MatrixLedStringData = PingPongUtil.makeMatrixStringData(0xe3, args.CUBE, 0x00, 0x00);
        this._peripheral.send(MatrixLedStringData);

        console.log("MatrixLedStringData  " + MatrixLedStringData);
        
        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2C3 = false;
                clearInterval(repeat);
                resolve();
                // console.log("clearInterval ");
            }, 200);
        });
    }
    // set Servo Degree
    setServoDegreeEach(args){
        if(this._peripheral.AllConnected == false)
        return;
        if (this.inActionC1C2C3 == true)
        return;

        this.inActionC1C2C3 = true;

        var ServoDegreeData = PingPongUtil.makeServoDegreeData(args.CUBE, args.SERVODEGREE);
        this._peripheral.send(ServoDegreeData);

        console.log("ServoDegreeData  " + ServoDegreeData);
        
        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2C3 = false;
                clearInterval(repeat);
                resolve();
                // console.log("clearInterval ");
            }, 100);
        });
    }
    // play note for beats
    playNoteForBeatsEach(args){
        if(this._peripheral.AllConnected == false)
          return;
        if (this.inActionC1C2C3 == true)
          return;

        this.inActionC1C2C3 = true;
        beatsEach = this._clampBeats(args.BEATS);
        console.log("args.NOTE " + args.NOTE + " after Clamp(beats) " + beatsEach);
        durationSecEach = this._beatsToDuration(args, beatsEach); 
        console.log("durationSec  " + durationSecEach); 
        var PlayNoteBeatsEach = PingPongUtil.makePlayNoteData(args.CUBE, args.NOTE, durationSecEach, 1);
        console.log("PlayNoteBeats " + PlayNoteBeatsEach);
        this._peripheral.send(PlayNoteBeatsEach);
        
        TimeDelay = (durationSecEach * 10) + 30;
        
        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2C3 = false;
                clearInterval(repeat);
                resolve();
                console.log("clearInterval ");
            }, TimeDelay);
        });
    }
    
     // play chord note for beats
     playChordForBeats(args){
        if(this._peripheral.AllConnected == false)
          return;
        if (this.inActionC1C2C3 == true)
          return;

        this.inActionC1C2C3 = true;
        var beatsEach = this._clampBeats(args.BEATS);
        var durationSecEach = this._beatsToDuration(args, beatsEach);
        var cubeArray = new Array(args.CUBE1, args.CUBE2, args.CUBE3);
        var noteArray = new Array(args.NOTE1, args.NOTE2, args.NOTE3); 
        console.log("beatsEach " + beatsEach);
        var AggMusicNote = PingPongUtil.makeAggregateSetMusicNotes(cubeArray, noteArray, durationSecEach);
        console.log("PlayNoteBeats " + AggMusicNote);
        this._peripheral.send(AggMusicNote);
    
        TimeDelay = (durationSecEach * 10) + 30;
        
        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2C3 = false;
                clearInterval(repeat);
                resolve();
                console.log("clearInterval ");
            }, TimeDelay);
        });
    }

    // rest for a number of beats with no sound
    restForBeatsEach(args){
        if(this._peripheral.AllConnected == false)
          return;
        if (this.inActionC1C2C3 == true)
          return;

        this.inActionC1C2C3 = true;

        beatsEach = this._clampBeats(args.BEATS);       
        durationSecEach = this._beatsToDuration(args, beatsEach); 
  
        TimeDelay = (durationSecEach * 10) + 30;
        
        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2C3 = false;
                clearInterval(repeat);
                resolve();
            }, TimeDelay);
        });
    }
    /* all cubes rest for a number of beats with no sound
    restForBeatsAll(args){
        if(this._peripheral.AllConnected == false)
          return;
        if (this.inActionC1C2C3 == true)
          return;

        this.inActionC1C2C3 = true;
        beatsEach = this._clampBeats(args.BEATS);       
        durationSecEach = this._beatsToDuration(args, beatsEach); 
        console.log("durationSec " + durationSecEach);   
        // var RestBeatsDataEach = PingPongUtil.makePlayNoteData(args.CUBE, 0x28, durationSecEach, 2);
        // console.log("RestBeatsData " + RestBeatsDataEach);
        // var cubeArray = new Array(1,2,3);
        // var noteArray = new Array(0x28, 0x28, 0x28);
        // var AggMusicNote = PingPongUtil.makeAggregateSetMusicNotes(cubeArray, noteArray, durationSecEach);
        // console.log("PlayNoteBeats " + AggMusicNote);
        // this._peripheral.send(AggMusicNote);
  
        TimeDelay = (durationSecEach * 10) + 30;
        
        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2C3 = false;
                clearInterval(repeat);
                resolve();
                console.log("clearInterval ");
            }, TimeDelay);
        });
    }*/
    /*
    // rest for a number of beats with no sound
    restForBeats(args){
        if(this._peripheral.AllConnected == false)
        return;
        if (this.inActionC1C2C3 == true)
        return;

        this.inActionC1C2C3 = true;
        beats = this._clampBeats(args.BEATS);       
        durationSec = this._beatsToDuration(beats); 
        console.log("durationSec " + durationSec);   
        // var RestBeatsData = PingPongUtil.makePlayNoteData(0x00, 0x28, durationSec, 2);
        // this._peripheral.send(RestBeatsData);
        
        TimeDelay = (durationSec * 10) + 30;
        console.log("TimeDelay " + TimeDelay);
        //this._peripheral.setWaitResponseOPCode(0xe8, TimeDelay);

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2C3 = false;
                clearInterval(repeat);
                resolve();
                console.log("clearInterval ");
            }, TimeDelay);
        });
    }
    */
      // set tempo (speed) for notes
    setTempoEach(args){
        if(this._peripheral.AllConnected == false)
          return;
        if (this.inActionC1C2C3 == true)
          return;

        this.inActionC1C2C3 = true;

        tempoEach = this._clampTempo(args.TEMPO);
        console.log("get Cube " + args.CUBE);
        
        if(args.CUBE == PingPongG3iCubes.ONE){
            console.log("tempoEach " + tempoEach);
            this._peripheral._tempo.C1Tempo = tempoEach;
            console.log("CUBE  " + args.CUBE + "_clampTempo(after)  " + this._peripheral._tempo.C1Tempo);
        }

        if(args.CUBE == PingPongG3iCubes.TWO){
            console.log("CUBE  " + args.CUBE + "_clampTempo(after)  " + this._peripheral._tempo.C2Tempo);
            this._peripheral._tempo.C2Tempo = tempoEach;
            // console.log("CUBE  " + args.CUBE + "_clampTempo(after)  " + this._peripheral._tempo.C2Tempo);
        }

        if(args.CUBE == PingPongG3iCubes.THREE){
            console.log("CUBE  " + args.CUBE + "_clampTempo(after)  " + this._peripheral._tempo.C3Tempo);
            this._peripheral._tempo.C3Tempo = tempoEach;
            // console.log("CUBE  " + args.CUBE + "_clampTempo(after)  " + this._peripheral._tempo.C2Tempo);
        }
              
        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2C3 = false;
                clearInterval(repeat);
                resolve();
                // console.log("clearInterval ");
            }, 200);
        });
    }
    // get tempo 
    getTempoEach(args) {
        if(typeof args.CUBE == 'undefined') {
            console.log("chord playing");
            return this._peripheral._tempo.C1Tempo;
        } 
        else 
        {
            if(args.CUBE == PingPongG3iCubes.ONE){
                // console.log("get CUBE  " + nCube + "_clampTempo(after)  " + args.TEMPO);
                return this._peripheral._tempo.C1Tempo;
            }

            if(args.CUBE == PingPongG3iCubes.TWO){
                // console.log("get CUBE  " + nCube + "_clampTempo(after)  " + args.TEMPO);
                return this._peripheral._tempo.C2Tempo;
            }

            if(args.CUBE == PingPongG3iCubes.THREE){
                // console.log("get CUBE  " + nCube + "_clampTempo(after)  " + args.TEMPO);
                return this._peripheral._tempo.C3Tempo;
            }
        }
    }
    getButtonC1() {
        //    console.log("getGyroX ");
        return this._peripheral._buttons.C1Button;
    }

    getButtonC2() {
        //    console.log("getGyroX ");
        return this._peripheral._buttons.C2Button;
    }

    getButtonC3() {
        //    console.log("getGyroX ");
        return this._peripheral._buttons.C3Button;
    }

    getProxiC1Interval() {
        return this._peripheral._proximity.C1ProxInterVal;
    }
    getProxiC2Interval() {
        return this._peripheral._proximity.C2ProxInterVal;
    }
    getProxiC3Interval() {
        return this._peripheral._proximity.C3ProxInterVal;
    }

    getProxiC1() {
        //    console.log("getGyroX ");
        return this._peripheral._proximity.C1Prox;
    }
    getProxiC2() {
        //    console.log("getGyroX ");
        return this._peripheral._proximity.C2Prox;
    }
    getProxiC3() {
        //    console.log("getGyroX ");
        return this._peripheral._proximity.C3Prox;
    }

    getGyroXC1() {
        return this._peripheral._sensors.C1tiltX;
    }

    getGyroYC1() {
        return this._peripheral._sensors.C1tiltY;
    }

    getGyroZC1() {
        return this._peripheral._sensors.C1tiltZ;
    }

    getGyroXC2() {
        return this._peripheral._sensors.C2tiltX;
    }

    getGyroYC2() {
        return this._peripheral._sensors.C2tiltY;
    }

    getGyroZC2() {
        return this._peripheral._sensors.C2tiltZ;
    }

    getGyroXC3() {
        return this._peripheral._sensors.C3tiltX;
    }

    getGyroYC3() {
        return this._peripheral._sensors.C3tiltY;
    }

    getGyroZC3() {
        return this._peripheral._sensors.C3tiltZ;
    }


    getGyroSensor(args){
      if(args.CUBE == PingPongG3iCubes.ONE){
        switch (args.DIRECTION) {
            case PingPongG3ITiltDirection.FRONT:
                return this.getGyroXCCircle1();
            case PingPongG3ITiltDirection.BACK:
                return this.getGyroXCTriangle1();
            case PingPongG3ITiltDirection.LEFT:
                return this.getGyroYCSquare1();
            case PingPongG3ITiltDirection.RIGHT:
              return this.getGyroYCStar1();
            default:
        }
      }

      if(args.CUBE == PingPongG3iCubes.TWO){
        switch (args.DIRECTION) {
            case PingPongG3ITiltDirection.FRONT:
                return this.getGyroXCCircle2();
            case PingPongG3ITiltDirection.BACK:
                return this.getGyroXCTriangle2();
            case PingPongG3ITiltDirection.LEFT:
                return this.getGyroYCSquare2();
            case PingPongG3ITiltDirection.RIGHT:
              return this.getGyroYCStar2();
            default:

        }
      }

      if(args.CUBE == PingPongG3iCubes.THREE){
        switch (args.DIRECTION) {
            case PingPongG3ITiltDirection.FRONT:
                return this.getGyroXCCircle3();
            case PingPongG3ITiltDirection.BACK:
                return this.getGyroXCTriangle3();
            case PingPongG3ITiltDirection.LEFT:
                return this.getGyroYCSquare3();
            case PingPongG3ITiltDirection.RIGHT:
              return this.getGyroYCStar3();
            default:
        }
      }
    }


    getGyroXCCircle1() {
        return this._peripheral._sensors.C1tiltX * -1;
    }

    getGyroXCTriangle1() {
        return this._peripheral._sensors.C1tiltX;
    }

    getGyroYCStar1() {
        return this._peripheral._sensors.C1tiltY;
    }

    getGyroYCSquare1() {
        return this._peripheral._sensors.C1tiltY * -1;
    }

    getGyroXCCircle2() {
        return this._peripheral._sensors.C2tiltX * -1;
    }

    getGyroXCTriangle2() {
        return this._peripheral._sensors.C2tiltX;
    }

    getGyroYCStar2() {
        return this._peripheral._sensors.C2tiltY;
    }

    getGyroYCSquare2() {
        return this._peripheral._sensors.C2tiltY * -1;
    }

    getGyroXCCircle3() {
        return this._peripheral._sensors.C3tiltX * -1;
    }

    getGyroXCTriangle3() {
        return this._peripheral._sensors.C3tiltX;
    }

    getGyroYCStar3() {
        return this._peripheral._sensors.C3tiltY;
    }
    getGyroYCSquare3() {
        return this._peripheral._sensors.C3tiltY * -1;
    }
    // 2019.12.20 Fecan Added
    getADSensorValueEach(args){
        if(args.CUBE == PingPongG3iCubes.ONE){
            if(args.SENSOR == PingPongG3ISensorType.ADSENSOR){
                return this._peripheral._sensors.C1ADval;
            } else {
                return this._peripheral._proximity.C1Prox;
            }       
        }

        if(args.CUBE == PingPongG3iCubes.TWO){
            if(args.SENSOR == PingPongG3ISensorType.ADSENSOR){
                return this._peripheral._sensors.C2ADval;
            } else {
                return this._peripheral._proximity.C2Prox;
            }   
        }

        if(args.CUBE == PingPongG3iCubes.THREE){
            if(args.SENSOR == PingPongG3ISensorType.ADSENSOR){
                return this._peripheral._sensors.C3ADval;
            } else {
                return this._peripheral._proximity.C3Prox;
            } 
        }
    }

    // beats X 100 = duration
    _beatsToDuration (args, beats) {
        console.log("get Tempo" + this.getTempoEach(args));
        var nDuration = Math.round(((60 / this.getTempoEach(args)) * beats) * 100);
        return nDuration;
    }

    // Clamp a duration in beats to the allowed min adn max duration
    _clampBeats (beats) {
        return MathUtil.clamp(beats, Scratch3PingPongG3iBlocks.BEAT_RANGE.min, Scratch3PingPongG3iBlocks.BEAT_RANGE.max);
    }

    // Clamp a duration in tempos to the allowed min adn max duration
    _clampTempo (tempo) {
        return MathUtil.clamp(tempo, Scratch3PingPongG3iBlocks.TEMPO_RANGE.min, Scratch3PingPongG3iBlocks.TEMPO_RANGE.max);
    }
}

module.exports = Scratch3PingPongG3iBlocks;