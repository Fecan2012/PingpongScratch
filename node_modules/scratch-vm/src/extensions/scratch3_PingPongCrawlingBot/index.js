const ArgumentType = require('../../extension-support/argument-type');
const BlockType = require('../../extension-support/block-type');
const log = require('../../util/log');
const cast = require('../../util/cast');
const formatMessage = require('format-message');
const BLE = require('../../io/blepingpong');
const Base64Util = require('../../util/base64-util');

// fldgo addd
const PingPongUtil = require('../../util/pingpong-util');

const blockIconURI = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAABQCAYAAACOEfKtAAAACXBIWXMAAC4jAAAuIwF4pT92AAAF+mlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxNDUgNzkuMTYzNDk5LCAyMDE4LzA4LzEzLTE2OjQwOjIyICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdEV2dD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlRXZlbnQjIiB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iIHhtbG5zOnBob3Rvc2hvcD0iaHR0cDovL25zLmFkb2JlLmNvbS9waG90b3Nob3AvMS4wLyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ0MgMjAxOSAoV2luZG93cykiIHhtcDpDcmVhdGVEYXRlPSIyMDE5LTA2LTA0VDE0OjI2OjE5KzA5OjAwIiB4bXA6TWV0YWRhdGFEYXRlPSIyMDE5LTA2LTA0VDE0OjI2OjE5KzA5OjAwIiB4bXA6TW9kaWZ5RGF0ZT0iMjAxOS0wNi0wNFQxNDoyNjoxOSswOTowMCIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDo2YmRjODI3Ny1mYWJmLTAzNGQtYjZiZi1jNjNmYTUzMzQ0ZGUiIHhtcE1NOkRvY3VtZW50SUQ9ImFkb2JlOmRvY2lkOnBob3Rvc2hvcDo5MmIzYjI5Ni0yMmQ1LTgxNDItYTBiNy1mZTU0NzAyYmEwMTMiIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDpkMjlmZjE0NS1iZmI1LWYzNGMtODlkMy1jYjZlZjNlM2RjNmMiIGRjOmZvcm1hdD0iaW1hZ2UvcG5nIiBwaG90b3Nob3A6Q29sb3JNb2RlPSIzIiBwaG90b3Nob3A6SUNDUHJvZmlsZT0ic1JHQiBJRUM2MTk2Ni0yLjEiPiA8eG1wTU06SGlzdG9yeT4gPHJkZjpTZXE+IDxyZGY6bGkgc3RFdnQ6YWN0aW9uPSJjcmVhdGVkIiBzdEV2dDppbnN0YW5jZUlEPSJ4bXAuaWlkOmQyOWZmMTQ1LWJmYjUtZjM0Yy04OWQzLWNiNmVmM2UzZGM2YyIgc3RFdnQ6d2hlbj0iMjAxOS0wNi0wNFQxNDoyNjoxOSswOTowMCIgc3RFdnQ6c29mdHdhcmVBZ2VudD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTkgKFdpbmRvd3MpIi8+IDxyZGY6bGkgc3RFdnQ6YWN0aW9uPSJzYXZlZCIgc3RFdnQ6aW5zdGFuY2VJRD0ieG1wLmlpZDo2YmRjODI3Ny1mYWJmLTAzNGQtYjZiZi1jNjNmYTUzMzQ0ZGUiIHN0RXZ0OndoZW49IjIwMTktMDYtMDRUMTQ6MjY6MTkrMDk6MDAiIHN0RXZ0OnNvZnR3YXJlQWdlbnQ9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE5IChXaW5kb3dzKSIgc3RFdnQ6Y2hhbmdlZD0iLyIvPiA8L3JkZjpTZXE+IDwveG1wTU06SGlzdG9yeT4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz7dTV7WAAAZF0lEQVR4nNWdeZAdxZ3nP5lZxzv69fW6W+pudbcAIWC8w9oIEGvMRCDWMUgsyF68JsCAmWUj1ou9xjPh8Xo84wPbMeFxsB68MPb6GDAD2ETgWdYOxjMcxjNm1uIwsNY1gDFqSejqVl/vfnVk7h9V9d5rqXW8pxZ4v0HpqUpZlZnfyszfmYUwxtAOvvTlL98qhfhD13XfYVmqNDV1mJmZGVKpFMaA73tksxmGR0bQYQhAVMXx66lUKl2jq0b33fLhW66zLOv/+L4P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';

const strScheduledData = 'ff,ff,ff,aa,40,0,cd,5,19,2,3,0,0,ff,ff,ff,0,0,0,ca,1,43,2,3,0,1,23,3d,0,0,3,20,0,0,3,20,0,0,3,20,3,0a,0,f8,fc,f6,0,f8,0,0,3,20,3,0a,0,f8,fc,f6,0,f8,0,0,3,20,fc,f7,1,ef,fd,52,0,c1,0,0,7,d0,1,2f,0,5e,1,57,0,63,1,df,0,c1,0,0,7,d0,fd,52,0,c1,fd,52,0,c1,fc,ae,3,1d,0,0,2,ee,0,0,2,ee,fe,8b,0,a5,fc,a6,3,39,0,0,3,20,3,9,1,ef,0,0,3,20,fc,f7,1,ef,2,ae,0,c1,3,52,3,1d,0,0,2,ee,0,0,2,ee,1,75,0,a5,3,5a,3,39,0,0,3,20,2,ae,0,c1,0,0,7,d0,fe,d1,0,5e,fe,a9,0,63,fe,21,0,c1,0,0,7,d0,2,ae,0,c1,3,9,1,ef,0,0,3,20,fc,f6,0,f8,3,e8,7,bc,3,0a,0,f8,0,0,3,20,fc,f6,0,f8,fc,18,7,bc,3,0a,0,f8,0,0,3,20,fc,f7,1,ef,2,62,0,37,fd,9e,0,37,2,62,0,37,fd,9e,0,37,3,9,1,ef,0,0,3,20,fc,f7,1,ef,0,0,1,0e,0,0,1,0e,0,0,1,0e,0,0,1,0e,3,9,1,ef,0,0,3,20,fc,f7,1,ef,fd,ba,0,c1,0,0,7,d0,1,2f,0,5e,1,57,0,63,0,0,1,f4,fe,21,0,c1,0,0,7,d0,2,ae,0,c1,3,9,1,ef,0,0,3,20,0,0,3,e8,ff,ff,ff,1,0,0,ca,1,43,2,3,0,1,f5,14,0,0,3,20,0,0,3,20,0,0,3,20,3,0a,0,f8,fc,f6,0,f8,0,0,3,20,3,0a,0,f8,fc,f6,0,f8,0,0,3,20,fc,f7,1,ef,fd,52,0,c1,0,0,7,d0,3,71,1,56,3,74,1,5a,3,5a,1,ef,0,0,7,d0,0,0,3,20,fd,52,0,c1,fc,d7,2,af,2,29,0,89,3,1e,0,f8,1,75,0,a5,fd,48,1,ef,fd,98,0,a5,3,9,1,ef,0,0,3,20,fc,f7,1,ef,2,ae,0,c1,3,29,2,af,fd,d7,0,89,fc,e2,0,f8,fe,8b,0,a5,2,b8,1,ef,2,68,0,a5,2,ae,0,c1,0,0,7,d0,fc,8f,1,56,fc,8c,1,5a,fc,a6,1,ef,0,0,7,d0,0,0,3,20,3,9,1,ef,0,0,3,20,fc,f6,0,f8,0,0,7,bc,3,0a,0,f8,0,0,3,20,fc,f6,0,f8,0,0,7,bc,3,0a,0,f8,0,0,3,20,fc,f7,1,ef,3,a9,0,a5,fc,57,0,a5,3,a9,0,a5,fc,57,0,a5,3,9,1,ef,0,0,3,20,fc,f7,1,ef,0,0,1,0e,0,0,1,0e,0,0,1,0e,0,0,1,0e,3,9,1,ef,0,0,3,20,fc,f7,1,ef,fd,ba,0,c1,0,0,7,d0,3,71,1,56,3,74,1,5a,0,0,1,f4,fc,a6,1,ef,0,0,7,d0,0,0,3,20,3,9,1,ef,0,0,3,20,0,0,3,e8,ff,ff,ff,2,0,0,ca,1,43,2,3,0,1,a3,c5,fc,f6,0,f8,3,0a,0,f8,0,0,3,20,0,0,3,20,0,0,3,20,0,0,3,20,fc,f6,0,f8,3,0a,0,f8,0,0,3,20,3,9,1,ef,fd,52,0,c1,fc,d7,2,af,2,29,0,89,3,1e,0,f8,1,75,0,a5,fd,48,1,ef,fd,98,0,a5,fd,52,0,c1,0,0,7,d0,3,71,1,56,3,74,1,5a,3,5a,1,ef,0,0,7,d0,0,0,3,20,fc,f7,1,ef,0,0,3,20,3,9,1,ef,2,ae,0,c1,0,0,7,d0,fc,8f,1,56,fc,8c,1,5a,fc,a6,1,ef,0,0,7,d0,0,0,3,20,2,ae,0,c1,3,29,2,af,fd,d7,0,89,fc,e2,0,f8,fe,8b,0,a5,2,b8,1,ef,2,68,0,a5,fc,f7,1,ef,0,0,3,20,3,0a,0,f8,0,0,7,bc,fc,f6,0,f8,0,0,3,20,3,0a,0,f8,0,0,7,bc,fc,f6,0,f8,0,0,3,20,3,9,1,ef,0,0,1,0e,0,0,1,0e,0,0,1,0e,0,0,1,0e,fc,f7,1,ef,0,0,3,20,3,9,1,ef,fc,57,0,a5,3,a9,0,a5,fc,57,0,a5,3,a9,0,a5,fc,f7,1,ef,0,0,3,20,3,9,1,ef,fd,ba,0,c1,fc,d7,2,af,2,29,0,89,3,1e,0,f8,0,0,1,f4,fe,8b,0,a5,2,b8,1,ef,2,68,0,a5,fc,f7,1,ef,0,0,3,20,0,0,3,e8,ff,ff,ff,3,0,0,ca,1,43,2,3,0,1,e3,51,fc,f6,0,f8,3,0a,0,f8,0,0,3,20,0,0,3,20,0,0,3,20,0,0,3,20,fc,f6,0,f8,3,0a,0,f8,0,0,3,20,3,9,1,ef,fd,52,0,c1,fc,ae,3,1d,0,0,2,ee,0,0,2,ee,fe,8b,0,a5,fc,a6,3,39,0,0,3,20,fd,52,0,c1,0,0,7,d0,1,2f,0,5e,1,57,0,63,1,df,0,c1,0,0,7,d0,fd,52,0,c1,fc,f7,1,ef,0,0,3,20,3,9,1,ef,2,ae,0,c1,0,0,7,d0,fe,d1,0,5e,fe,a9,0,63,fe,21,0,c1,0,0,7,d0,2,ae,0,c1,2,ae,0,c1,3,52,3,1d,0,0,2,ee,0,0,2,ee,1,75,0,a5,3,5a,3,39,0,0,3,20,fc,f7,1,ef,0,0,3,20,3,0a,0,f8,3,e8,7,bc,fc,f6,0,f8,0,0,3,20,3,0a,0,f8,fc,18,7,bc,fc,f6,0,f8,0,0,3,20,3,9,1,ef,0,0,1,0e,0,0,1,0e,0,0,1,0e,0,0,1,0e,fc,f7,1,ef,0,0,3,20,3,9,1,ef,fd,9e,0,37,2,62,0,37,fd,9e,0,37,2,62,0,37,fc,f7,1,ef,0,0,3,20,3,9,1,ef,fd,ba,0,c1,fc,ae,3,1d,0,0,2,ee,0,0,2,ee,0,0,1,f4,1,75,0,a5,3,5a,3,39,0,0,3,20,fc,f7,1,ef,0,0,3,20,0,0,3,e8';

var staticCrawlingBotHandle = null;

var CRAWLINGBOTPointData = new Array(
    0x2b, 0x2e, 0x2f, 0x32, 0x3a, 0x40, 0x33, 0x39,
    0x4c, 0x4c, 0x03, 0x05, 0x0, 0x02, 0x06, 0x08,
    0x09, 0x19, 0x1a, 0x2a, 0x41, 0x4b);

var GroupId="";
var TimeDelay="";
try {
   GroupId = document.getElementById('isGroup').value == "false" ? "" : document.getElementById('groupId').value;
}catch(e){

}
const BLEUUID = {
    namePrefix: 'PINGPONG.'+GroupId,
    service: '6e400001-b5a3-f393-e0a9-e50e24dcca9e',
    txChar: '6e400002-b5a3-f393-e0a9-e50e24dcca9e',
    rxChar: '6e400003-b5a3-f393-e0a9-e50e24dcca9e',
    groupID: GroupId
};
const simple_act_degreeradius = {
    degree10: '10',
    degree20: '20',
    degree30: '30',
    degree40: '40',
    degree50: '50',
    degree60: '60',
    degree70: '70',
    degree80: '80',
    degree90: '90',
    degree100: '100',
    degree110: '110',
    degree120: '120',
    degree130: '130',
    degree140: '140',
    degree150: '150',
    degree160: '160',
    degree170: '170',
    degree180: '180',
    degree190: '190',
    degree200: '200',
    degree210: '210',
    degree220: '220',
    degree230: '230',
    degree240: '240',
    degree250: '250',
    degree260: '260',
    degree270: '270',
    degree280: '280',
    degree290: '290',
    degree300: '300',
    degree310: '310',
    degree320: '320',
    degree330: '330',
    degree340: '340',
    degree350: '350',
    degree360: '360'
};

const PingPongG4iCubes = {
    ONE: '1',
    TWO: '2',
    THREE:'3',
    FOUR:'4',
    ALL:'ALL'
};

const PingPongG4ILoDirect = {
    L: 'left',
    R: 'right',
};

class PingPongCrawlingBot {
    constructor (runtime, extensionId) {

        this._runtime = runtime;

        this._ble = null;
        this._runtime.registerPeripheralExtension(extensionId, this);

        this._extensionId = extensionId;

        this.disconnect = this.disconnect.bind(this);
        this._onConnect = this._onConnect.bind(this);
        this._onMessage = this._onMessage.bind(this);

        this.connectCount = 4;

        this.AllConnected = false;
        this.inAction = false;
        this.sendScheduledData = false;
        this.waitScheduledDataResponse = false;

        this.waitResponseOPCode = -1;
        this.receivedLastPointData = -1;
        this.waitLastPointDone = false;

        this.SafeCheckCount = 0;
    }

    scan() {
        if (this._ble) {
            this._ble.disconnect();
        }
        this._ble = new BLE(this._runtime, this._extensionId, {
            filters: [
                { namePrefix: BLEUUID.namePrefix , groupID: BLEUUID.groupID}
            ]
        }, this._onConnect, this.disconnect);
    }

    connect(id) {
        console.log("connect " + id);
        if (this._ble) {
            this._ble.connectPeripheral(id);
        }
    }

    disconnect() {
        if (this._ble) {
            this._ble.disconnect();
        }

        this.sendScheduledData = false;
        this.AllConnected = false;
    }

    isConnected() {
        let connected = false;
        if (this._ble) {
            connected = this._ble.isConnected();
        }

        if (connected == true)
            return this.AllConnected;

        this.AllConnected = false;
        return this.AllConnected;
    }

    send(message, force = false) {
        if (force == false)
            if (!this.isConnected()) return;

        const data = Base64Util.uint8ArrayToBase64(message);

        this._ble.write(BLEUUID.service, BLEUUID.txChar, data, 'base64', false).then(
            () => {
                console.log("send done to scratch links");
            }
        );
    }

    checkResponseData(datas) {

        if (this.waitResponseOPCode == -1) {
            return;
        }

        if (datas.byteLength < 7) {
            return;
        }

        console.log("checkresponsedatas " + datas[6] + " " + this.waitResponseOPCode);

        if (datas[6] == this.waitResponseOPCode) {
            console.log("checkresponsedatas found waitcode " + this.waitResponseOPCode);

            this.waitResponseOPCode = -1;

            if (this.waitScheduledDataResponse == true) {
                this.sendScheduledData = true;
                this.waitScheduledDataResponse = false;
            }
        }
    }

    NotificationEventFC(value)
    {
        if (value == null)
            return;
        
        this.checkResponseData(value);

        if (value.byteLength == 18)
        {
            if (value[6] == 0xad || value[6] == 0xae) {
                if (value[11] == 0x01 && value[12] == 0x02 && value[13] == 0x03) {
                    this.AllConnected = true;

                    if (this.sendScheduledData == false && this.waitScheduledDataResponse == false) {

                        this.waitScheduledDataResponse = true;
                        this.waitResponseOPCode = 0xcd;

                        var strSplit = strScheduledData.split(",");
                        var txCharVal = new Uint8Array(strSplit.length);

                        for (var i = 0; i < strSplit.length; i++) {
                            txCharVal[i] = parseInt(strSplit[i], 16);
                        }

                        this.send(txCharVal);
                    }

                    this._runtime.emit(this._runtime.constructor.PERIPHERAL_CONNECTED);
                }
            }
        }

        if (value.byteLength == 17) {
            if (value[6] == 0xca) {
                this.receivedLastPointData = value[13] * 256 + value[14];
            }
        }
    }

    _onConnect() {
        this._ble.startNotifications(BLEUUID.service, BLEUUID.rxChar, this._onMessage);

        window.setTimeout(() => {
            this.send(PingPongUtil.getSetMultiroleInAction(this.connectCount), true);
        }, 1000);
    }

    _onMessage(base64) {
        const datas = Base64Util.base64ToUint8Array(base64);

        PingPongUtil.printUint8ArrayToHex(datas, "Notification Data");
        this.NotificationEventFC(datas);
    }
}

class Scratch3PingPongCrawlingBotBlocks {
    static get EXTENSION_NAME () {
        return 'Crawling Bot';
    }

    static get EXTENSION_ID () {
        return 'PingPongCrawlingBot';
    }

    constructor (runtime) {
        this.runtime = runtime;

        console.log("Scratch3PingPongAutoCarBlocks constructor called 001");

        // Create a new PingPongAutocar peripheral instance
        this._peripheral = new PingPongCrawlingBot(this.runtime, Scratch3PingPongCrawlingBotBlocks.EXTENSION_ID);

        console.log("Scratch3PingPongAutoCarBlocks constructor called 002");

        this.frameToggle = false;

        setInterval(() => {
            this.frameToggle = !this.frameToggle;
        }, this.runtime.currentStepTime);
    }

    get CUBES(){
      return [
        {   text: formatMessage({
            id: 'pingpong.ONE',
            default: PingPongG4iCubes.ONE,
            description: '1'
            }),
            value: PingPongG4iCubes.ONE
        },
        {
          text: formatMessage({
              id: 'pingpong.TWO',
              default: PingPongG4iCubes.TWO,
              description: '2'
              }),
              value: PingPongG4iCubes.TWO
        },
        {
          text: formatMessage({
              id: 'pingpong.THREE',
              default: PingPongG4iCubes.THREE,
              description: '3'
              }),
              value: PingPongG4iCubes.THREE
        },
        {
          text: formatMessage({
              id: 'pingpong.FOUR',
              default: PingPongG4iCubes.FOUR,
              description: '4'
              }),
              value: PingPongG4iCubes.FOUR
        },
        {
          text: formatMessage({
              id: 'pingpong.ALL',
              default: PingPongG4iCubes.ALL,
              description: 'all'
              }),
              value: PingPongG4iCubes.ALL
        }
      ];
    }

    get LODIRECT_MENU() {
        return [
            {
                text: formatMessage({
                    id: 'pingpongwormbot.PingPongWormBotLoDirect.R',
                    default: 'clockwise',
                    description: 'lotate clock'
                }),
                value: PingPongG4ILoDirect.R
            },
            {
                text: formatMessage({
                    id: 'pingpongwormbot.PingPongWormBotLoDirect.L',
                    default: 'counterclockwise',
                    description: 'lotate counter clock'
                }),
                value: PingPongG4ILoDirect.L
            }
        ];
    }

    getInfo() {
        return {
            id: Scratch3PingPongCrawlingBotBlocks.EXTENSION_ID,
            name: Scratch3PingPongCrawlingBotBlocks.EXTENSION_NAME,
            blockIconURI: blockIconURI,
            showStatusButton: true,
            blocks: [
                {
                    opcode: 'rollingleft',
                    text: formatMessage({
                        id: 'pingpongcrawlingbot.rollingleft',
                        default: 'roll left',
                        description: 'fldgo002'
                    })
                },
                {
                    opcode: 'rollingright',
                    text: formatMessage({
                        id: 'pingpongcrawlingbot.rollingright',
                        default: 'roll right',
                        description: 'fldgo002'
                    })
                },
                {
                    opcode: 'stepleft',
                    text: formatMessage({
                        id: 'pingpongcrawlingbot.stepleft',
                        default: 'move left',
                        description: 'fldgo002'
                    })
                },
                {
                    opcode: 'stepright',
                    text: formatMessage({
                        id: 'pingpongcrawlingbot.stepright',
                        default: 'move right',
                        description: 'fldgo002'
                    })
                },
                {
                    opcode: 'liftleftfoot',
                    text: formatMessage({
                        id: 'pingpongcrawlingbot.liftleftfoot',
                        default: 'lift left foot',
                        description: 'fldgo002'
                    })
                },
                {
                    opcode: 'liftrightfoot',
                    text: formatMessage({
                        id: 'pingpongcrawlingbot.liftrightfoot',
                        default: 'lift right foot',
                        description: 'fldgo002'
                    })
                },
                {
                    opcode: 'liftfoots',
                    text: formatMessage({
                        id: 'pingpongcrawlingbot.liftfoots',
                        default: 'lift feet',
                        description: 'fldgo002'
                    })
                },
                {
                    opcode: 'acrobatleft',
                    text: formatMessage({
                        id: 'pingpongcrawlingbot.acrobatleft',
                        default: 'rotate left',
                        description: 'fldgo002'
                    })
                },
                {
                    opcode: 'acrobatright',
                    text: formatMessage({
                        id: 'pingpongcrawlingbot.acrobatright',
                        default: 'rotate right',
                        description: 'fldgo002'
                    })
                },
                {
                    opcode: 'standup',
                    text: formatMessage({
                        id: 'pingpongcrawlingbot.standup',
                        default: 'stand up',
                        description: 'fldgo002'
                    })
                },
                {
                      opcode: 'motorall',
                      text: formatMessage({
                          id: 'pingpongcrawlingbot.motorall',
                          default: 'rotate motor1: [RADIUS1] degrees [LODIRECT1] motor2: [RADIUS2] degrees [LODIRECT2] motor3: [RADIUS3] degrees [LODIRECT3] motor4: [RADIUS4] degrees [LODIRECT4]',
                          description: 'is tilted in a direction?'
                      }),
                      arguments: {
                        LODIRECT1: {
                            type: ArgumentType.STRING,
                            menu: 'lodirect',
                            defaultValue: PingPongG4ILoDirect.R
                        },
                        LODIRECT2: {
                            type: ArgumentType.STRING,
                            menu: 'lodirect',
                            defaultValue: PingPongG4ILoDirect.R
                        },
                        LODIRECT3: {
                            type: ArgumentType.STRING,
                            menu: 'lodirect',
                            defaultValue: PingPongG4ILoDirect.R
                        },
                        LODIRECT4: {
                            type: ArgumentType.STRING,
                            menu: 'lodirect',
                            defaultValue: PingPongG4ILoDirect.R
                        },
                        RADIUS1: {
                            type: ArgumentType.STRING,
                            defaultValue: simple_act_degreeradius.degree90
                        },
                        RADIUS2: {
                            type: ArgumentType.STRING,
                            defaultValue: simple_act_degreeradius.degree90
                        },
                        RADIUS3: {
                            type: ArgumentType.STRING,
                            defaultValue: simple_act_degreeradius.degree90
                        },
                        RADIUS4: {
                            type: ArgumentType.STRING,
                            defaultValue: simple_act_degreeradius.degree90
                        }
                      }
                  },
                  {
                      opcode: 'motorChoice',
                      text: formatMessage({
                          id: 'pingpongcrawlingbot.motorChoice',
                          default: 'rotate motor[CUBE]: [RADIUS] degrees [LODIRECT]',
                          description: 'move to radius'
                      }),
                      arguments: {
                          CUBE:{
                            type: ArgumentType.STRING,
                            menu: 'cubes',
                            defaultValue: PingPongG4iCubes.ONE
                          },
                          LODIRECT: {
                              type: ArgumentType.STRING,
                              menu: 'lodirect',
                              defaultValue: PingPongG4ILoDirect.R
                          },
                          RADIUS: {
                              type: ArgumentType.STRING,
                              defaultValue: simple_act_degreeradius.degree90
                          }
                      }
                  }
            ],
            menus:{
              cubes : this.CUBES,
              lodirect: this.LODIRECT_MENU
            }
        };
    }

    checkEndSchedulingData(nEndPointData) {

        console.log("checkEndSchedulingData : " + this._peripheral.receivedLastPointData);
        if (this._peripheral.receivedLastPointData == nEndPointData) {
            this._peripheral.receivedLastPointData = -1;
            this._peripheral.waitLastPointDone = true;
        }

        if (this._peripheral.waitLastPointDone == true) {
            PingPongUtil.pingpongsleep(200);

            this._peripheral.inAction = false;
            this._peripheral.waitLastPointDone = false;
            this._peripheral.SafeCheckCount = 0;

            return true;
        }

        if (this._peripheral.isConnected() == false) {
            this._peripheral.inAction = false;
            this._peripheral.waitLastPointDone = false;
            this._peripheral.SafeCheckCount = 0;
            return true;
        }

        if (this._peripheral.SafeCheckCount++ > 140) {
            this._peripheral.inAction = false;
            this._peripheral.waitLastPointDone = false;
            this._peripheral.SafeCheckCount = 0;
            return true;
        }

        return false;
    }

    rollingleft() {
        console.log('rollingleft');

        if (this._peripheral.AllConnected == false)
            return;

        if (this._peripheral.sendScheduledData == false)
            return;

        if (this._peripheral.inAction == true)
            return;

        this._peripheral.inAction = true;

        this._peripheral.send(PingPongUtil.getDefaultPointDatas(0x2b, 0x2e));

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                if (this.checkEndSchedulingData(0x2e) == true) {
                    clearInterval(repeat);
                    resolve();
                }
            }, 200);
        });
    }

    rollingright() {
        console.log('rollingright');

        if (this._peripheral.AllConnected == false)
            return;

        if (this._peripheral.sendScheduledData == false)
            return;

        if (this._peripheral.inAction == true)
            return;

        this._peripheral.inAction = true;

        this._peripheral.send(PingPongUtil.getDefaultPointDatas(0x2f, 0x32));

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                if (this.checkEndSchedulingData(0x32) == true) {
                    clearInterval(repeat);
                    resolve();
                }
            }, 200);
        });
    }

    stepleft() {
        console.log('stepleft');

        if (this._peripheral.AllConnected == false)
            return;

        if (this._peripheral.sendScheduledData == false)
            return;

        if (this._peripheral.inAction == true)
            return;

        this._peripheral.inAction = true;

        this._peripheral.send(PingPongUtil.getDefaultPointDatas(0x3a, 0x40));

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                if (this.checkEndSchedulingData(0x40) == true) {
                    clearInterval(repeat);
                    resolve();
                }
            }, 200);
        });
    }

    stepright() {
        console.log('stepright');

        if (this._peripheral.AllConnected == false)
            return;

        if (this._peripheral.sendScheduledData == false)
            return;

        if (this._peripheral.inAction == true)
            return;

        this._peripheral.inAction = true;

        this._peripheral.send(PingPongUtil.getDefaultPointDatas(0x33, 0x39));

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                if (this.checkEndSchedulingData(0x39) == true) {
                    clearInterval(repeat);
                    resolve();
                }
            }, 200);
        });
    }

    liftleftfoot() {
        console.log('liftleftfoot');

        if (this._peripheral.AllConnected == false)
            return;

        if (this._peripheral.sendScheduledData == false)
            return;

        if (this._peripheral.inAction == true)
            return;

        this._peripheral.inAction = true;

        this._peripheral.send(PingPongUtil.getDefaultPointDatas(0x03, 0x05));

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                if (this.checkEndSchedulingData(0x05) == true) {
                    clearInterval(repeat);
                    resolve();
                }
            }, 200);
        });
    }

    liftrightfoot() {
        console.log('liftrightfoot');

        if (this._peripheral.AllConnected == false)
            return;

        if (this._peripheral.sendScheduledData == false)
            return;

        if (this._peripheral.inAction == true)
            return;

        this._peripheral.inAction = true;

        this._peripheral.send(PingPongUtil.getDefaultPointDatas(0x00, 0x02));

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                if (this.checkEndSchedulingData(0x02) == true) {
                    clearInterval(repeat);
                    resolve();
                }
            }, 200);
        });
    }

    liftfoots() {
        console.log('liftfoots');

        if (this._peripheral.AllConnected == false)
            return;

        if (this._peripheral.sendScheduledData == false)
            return;

        if (this._peripheral.inAction == true)
            return;

        this._peripheral.inAction = true;

        this._peripheral.send(PingPongUtil.getDefaultPointDatas(0x06, 0x08));

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                if (this.checkEndSchedulingData(0x08) == true) {
                    clearInterval(repeat);
                    resolve();
                }
            }, 200);
        });
    }

    acrobatleft() {
        console.log('acrobatleft');

        if (this._peripheral.AllConnected == false)
            return;

        if (this._peripheral.sendScheduledData == false)
            return;

        if (this._peripheral.inAction == true)
            return;

        this._peripheral.inAction = true;

        this._peripheral.send(PingPongUtil.getDefaultPointDatas(0x09, 0x19));

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                if (this.checkEndSchedulingData(0x19) == true) {
                    clearInterval(repeat);
                    resolve();
                }
            }, 200);
        });
    }

    acrobatright() {
        console.log('acrobatright');

        if (this._peripheral.AllConnected == false)
            return;

        if (this._peripheral.sendScheduledData == false)
            return;

        if (this._peripheral.inAction == true)
            return;

        this._peripheral.inAction = true;

        this._peripheral.send(PingPongUtil.getDefaultPointDatas(0x1a, 0x2a));

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                if (this.checkEndSchedulingData(0x2a) == true) {
                    clearInterval(repeat);
                    resolve();
                }
            }, 200);
        });
    }

    standup() {
        console.log('standup');

        if (this._peripheral.AllConnected == false)
            return;

        if (this._peripheral.sendScheduledData == false)
            return;

        if (this._peripheral.inAction == true)
            return;

        this._peripheral.inAction = true;

        this._peripheral.send(PingPongUtil.getDefaultPointDatas(0x41, 0x4b));

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                if (this.checkEndSchedulingData(0x4b) == true) {
                    clearInterval(repeat);
                    resolve();
                }
            }, 200);
        });
    }

    motorall(args) {
        console.log("motorall ");

        if (this._peripheral.AllConnected == false)
            return;

        if (this.inActionC1C2C3C4 == true)
            return;

        var Speed1 = 800;
        var Speed2 = 800;
        var Speed3 = 800;
        var Speed4 = 800;

        this.inActionC1C2C3C4 = true;

        if (args.LODIRECT1 == PingPongG4ILoDirect.L) {
            Speed1 *= -1;
        }

        if (args.LODIRECT2 == PingPongG4ILoDirect.L) {
            Speed2 *= -1;
        }

        if (args.LODIRECT3 == PingPongG4ILoDirect.L) {
            Speed3 *= -1;
        }

        if (args.LODIRECT4 == PingPongG4ILoDirect.L) {
            Speed4 *= -1;
        }

        var Step1 = Math.round(args.RADIUS1 * 5.5);
        var Step2 = Math.round(args.RADIUS2 * 5.5);
        var Step3 = Math.round(args.RADIUS3 * 5.5);
        var Step4 = Math.round(args.RADIUS4 * 5.5);

        console.log(Speed1 + Speed2 + Speed3 + Speed4 + " " + args.RADIUS1 + " " + args.RADIUS2 + " " + args.RADIUS3 + " " + args.RADIUS4);

        var SinglesData = new Array(4);
        SinglesData[0] = PingPongUtil.makeSingleDataByStep(0, 0, Speed1, Step1);
        SinglesData[1] = PingPongUtil.makeSingleDataByStep(1, 0, Speed2, Step2);
        SinglesData[2] = PingPongUtil.makeSingleDataByStep(2, 0, Speed3, Step3);
        SinglesData[3] = PingPongUtil.makeSingleDataByStep(3, 0, Speed4, Step4);
        SinglesData[0][12] = 2; // make resume
        SinglesData[1][12] = 2; // make resume
        SinglesData[2][12] = 2; // make resume
        SinglesData[3][12] = 2; // make resume

        var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(SinglesData, 4, 1);

        var TimeDelay1 = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed1), Step1) + 400;

        var TimeDelay2 = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed2), Step2) + 400;

        var TimeDelay3 = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed3), Step3) + 400;

        var TimeDelay4 = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed4), Step4) + 400;


        var TimeDelay = TimeDelay1;

        if (TimeDelay2 > TimeDelay1)
            TimeDelay = TimeDelay2;

        if (TimeDelay3 > TimeDelay)
            TimeDelay = TimeDelay3;

        if (TimeDelay4 > TimeDelay)
            TimeDelay = TimeDelay4;

        this._peripheral.send(OutPutData);

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2C3C4 = false;
                clearInterval(repeat);
                resolve();
            }, TimeDelay);
        });
    }

    motorAllInOne(args) {
        console.log("motorall ");

        if (this._peripheral.AllConnected == false)
            return;

        if (this.inActionC1C2C3C4 == true)
            return;

        var Speed1 = 800;
        var Speed2 = 800;
        var Speed3 = 800;
        var Speed4 = 800;

        this.inActionC1C2C3C4 = true;

        if (args.LODIRECT == PingPongG4ILoDirect.L) {
            Speed1 *= -1;
        }

        if (args.LODIRECT == PingPongG4ILoDirect.L) {
            Speed2 *= -1;
        }

        if (args.LODIRECT == PingPongG4ILoDirect.L) {
            Speed3 *= -1;
        }

        if (args.LODIRECT == PingPongG4ILoDirect.L) {
            Speed4 *= -1;
        }

        var Step1 = Math.round(args.RADIUS * 5.5);
        var Step2 = Math.round(args.RADIUS * 5.5);
        var Step3 = Math.round(args.RADIUS * 5.5);
        var Step4 = Math.round(args.RADIUS * 5.5);

        console.log(Speed1 + Speed2 + Speed3 + Speed4 + " " + args.RADIUS + " " + args.RADIUS + " " + args.RADIUS + " " + args.RADIUS);

        var SinglesData = new Array(4);
        SinglesData[0] = PingPongUtil.makeSingleDataByStep(0, 0, Speed1, Step1);
        SinglesData[1] = PingPongUtil.makeSingleDataByStep(1, 0, Speed2, Step2);
        SinglesData[2] = PingPongUtil.makeSingleDataByStep(2, 0, Speed3, Step3);
        SinglesData[3] = PingPongUtil.makeSingleDataByStep(3, 0, Speed4, Step4);
        SinglesData[0][12] = 2; // make resume
        SinglesData[1][12] = 2; // make resume
        SinglesData[2][12] = 2; // make resume
        SinglesData[3][12] = 2; // make resume

        var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(SinglesData, 4, 1);

        var TimeDelay1 = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed1), Step1) + 400;

        var TimeDelay2 = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed2), Step2) + 400;

        var TimeDelay3 = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed3), Step3) + 400;

        var TimeDelay4 = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed4), Step4) + 400;


        var TimeDelay = TimeDelay1;

        if (TimeDelay2 > TimeDelay1)
            TimeDelay = TimeDelay2;

        if (TimeDelay3 > TimeDelay)
            TimeDelay = TimeDelay3;

        if (TimeDelay4 > TimeDelay)
            TimeDelay = TimeDelay4;

        this._peripheral.send(OutPutData);

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2C3C4 = false;
                clearInterval(repeat);
                resolve();
            }, TimeDelay);
        });
    }

    motorChoice(args){
      if(args.CUBE == PingPongG4iCubes.ONE){
        this.motor1(args);
      }
      if(args.CUBE == PingPongG4iCubes.TWO){
        this.motor2(args);
      }
      if(args.CUBE == PingPongG4iCubes.THREE){
        this.motor3(args);
      }
      if(args.CUBE == PingPongG4iCubes.FOUR){
        this.motor4(args);
      }
      if(args.CUBE == PingPongG4iCubes.ALL){
        this.motorAllInOne(args);
      }
      // branch function mode selection, pending
      return new Promise(resolve => {
        setInterval(() => {
            this.inActionC1C2C3C4 = false;
            resolve();
            console.log("TimeDelay  " + TimeDelay);
        }, TimeDelay);
    });
    }

    motor1(args) {
        console.log("motor1 ");
        if (this._peripheral.AllConnected == false)
            return;

        if (this.inActionC1C2C3C4 == true)
            return;

        var Speed = 800;

        this.inActionC1C2C3C4 = true;

        if (args.LODIRECT == PingPongG4ILoDirect.L) {
            Speed *= -1;
        }

        var Step = Math.round(args.RADIUS * 5.5);

        console.log(Speed + Step + " " + args.RADIUS + " " + args.RADIUS);

        var OutPutData = PingPongUtil.makeSingleDataByStep(0, 0, Speed, Step);
        OutPutData[12] = 2; // make resume

        var TimeDelay = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed), Step) + 200

        this._peripheral.send(OutPutData);

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2C3C4 = false;
                clearInterval(repeat);
                resolve();
            }, TimeDelay);
        });
    }

    motor2(args) {
        console.log("motor2 ");

        if (this._peripheral.AllConnected == false)
            return;

        if (this.inActionC1C2C3C4 == true)
            return;

        var Speed = 800;

        this.inActionC1C2C3C4 = true;

        if (args.LODIRECT == PingPongG4ILoDirect.L) {
            Speed *= -1;
        }

        var Step = Math.round(args.RADIUS * 5.5);

        console.log(Speed + Step + " " + args.RADIUS + " " + args.RADIUS);

        var OutPutData = PingPongUtil.makeSingleDataByStep(1, 0, Speed, Step);
        OutPutData[12] = 2; // make resume

        var TimeDelay = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed), Step) + 200

        this._peripheral.send(OutPutData);

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2C3C4 = false;
                clearInterval(repeat);
                resolve();
            }, TimeDelay);
        });
    }

    motor3(args) {
        console.log("motor3 ");

        if (this._peripheral.AllConnected == false)
            return;

        if (this.inActionC1C2C3C4 == true)
            return;

        var Speed = 800;

        this.inActionC1C2C3C4 = true;

        if (args.LODIRECT == PingPongG4ILoDirect.L) {
            Speed *= -1;
        }

        var Step = Math.round(args.RADIUS * 5.5);

        console.log(Speed + Step + " " + args.RADIUS + " " + args.RADIUS);

        var OutPutData = PingPongUtil.makeSingleDataByStep(2, 0, Speed, Step);
        OutPutData[12] = 2; // make resume

        var TimeDelay = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed), Step) + 200

        this._peripheral.send(OutPutData);

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2C3C4 = false;
                clearInterval(repeat);
                resolve();
            }, TimeDelay);
        });
    }

    motor4(args) {

        console.log("motor4 ");

        if (this._peripheral.AllConnected == false)
            return;

        if (this.inActionC1C2C3C4 == true)
            return;

        var Speed = 800;

        this.inActionC1C2C3C4 = true;

        if (args.LODIRECT == PingPongG4ILoDirect.L) {
            Speed *= -1;
        }

        var Step = Math.round(args.RADIUS * 5.5);

        console.log(Speed + Step + " " + args.RADIUS + " " + args.RADIUS);

        var OutPutData = PingPongUtil.makeSingleDataByStep(3, 0, Speed, Step);
        OutPutData[12] = 2; // make resume

        var TimeDelay = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed), Step) + 200

        this._peripheral.send(OutPutData);

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2C3C4 = false;
                clearInterval(repeat);
                resolve();
            }, TimeDelay);
        });
    }
}

module.exports = Scratch3PingPongCrawlingBotBlocks;
