const ArgumentType = require('../../extension-support/argument-type');
const BlockType = require('../../extension-support/block-type');
const log = require('../../util/log');
const cast = require('../../util/cast');
const formatMessage = require('format-message');
const BLE = require('../../io/blepingpong');
const Base64Util = require('../../util/base64-util');

const PingPongUtil = require('../../util/pingpong-util');

const blockIconURI = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAABQCAYAAACOEfKtAAAACXBIWXMAAC4jAAAuIwF4pT92AAAF+mlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxNDUgNzkuMTYzNDk5LCAyMDE4LzA4LzEzLTE2OjQwOjIyICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdEV2dD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlRXZlbnQjIiB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iIHhtbG5zOnBob3Rvc2hvcD0iaHR0cDovL25zLmFkb2JlLmNvbS9waG90b3Nob3AvMS4wLyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ0MgMjAxOSAoV2luZG93cykiIHhtcDpDcmVhdGVEYXRlPSIyMDE5LTA2LTA0VDE0OjIwOjMzKzA5OjAwIiB4bXA6TWV0YWRhdGFEYXRlPSIyMDE5LTA2LTA0VDE0OjIwOjMzKzA5OjAwIiB4bXA6TW9kaWZ5RGF0ZT0iMjAxOS0wNi0wNFQxNDoyMDozMyswOTowMCIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDoyYzlkZTY5My00NjdiLWU0NDEtOTc3ZS02MTNiMDNlNzlhNzAiIHhtcE1NOkRvY3VtZW50SUQ9ImFkb2JlOmRvY2lkOnBob3Rvc2hvcDowMTk5NjIyMi1hZDUxLTFjNDMtOTQzMC1hZDIwODM4NWFhMGMiIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDpkOTJjYTk3YS1jMGFjLTA0NDItYTQxNy0yNDViNzY4NTg0NzMiIGRjOmZvcm1hdD0iaW1hZ2UvcG5nIiBwaG90b3Nob3A6Q29sb3JNb2RlPSIzIiBwaG90b3Nob3A6SUNDUHJvZmlsZT0ic1JHQiBJRUM2MTk2Ni0yLjEiPiA8eG1wTU06SGlzdG9yeT4gPHJkZjpTZXE+IDxyZGY6bGkgc3RFdnQ6YWN0aW9uPSJjcmVhdGVkIiBzdEV2dDppbnN0YW5jZUlEPSJ4bXAuaWlkOmQ5MmNhOTdhLWMwYWMtMDQ0Mi1hNDE3LTI0NWI3Njg1ODQ3MyIgc3RFdnQ6d2hlbj0iMjAxOS0wNi0wNFQxNDoyMDozMyswOTowMCIgc3RFdnQ6c29mdHdhcmVBZ2VudD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTkgKFdpbmRvd3MpIi8+IDxyZGY6bGkgc3RFdnQ6YWN0aW9uPSJzYXZlZCIgc3RFdnQ6aW5zdGFuY2VJRD0ieG1wLmlpZDoyYzlkZTY5My00NjdiLWU0NDEtOTc3ZS02MTNiMDNlNzlhNzAiIHN0RXZ0OndoZW49IjIwMTktMDYtMDRUMTQ6MjA6MzMrMDk6MDAiIHN0RXZ0OnNvZnR3YXJlQWdlbnQ9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE5IChXaW5kb3dzKSIgc3RFdnQ6Y2hhbmdlZD0iLyIvPiA8L3JkZjpTZXE+IDwveG1wTU06SGlzdG9yeT4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz4AWRKeAAAemklEQVR4nNWceZBdV33nP+ecu729d7WkttSS5VjeCCYsxuBMTMhkEpOQjA0JmYTsISkqxgYqCaFSJJkJk6okGGPKECAzDEXGxgsYU2YSwha8DXiRbSxLsqzFkix1t3p7/ba7nXPmj/Nea2lJ3bLaouanalX3vfds3/s7v/1cYa3lTJS0G2e8v9rkFUq0Zo5cefju/31Xe+cL6Qt7XzC7MOVfu+UzN1645aKvndfJrIC85R44+PC/n495LFLQP8Dstid/auozn91S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';

var GroupId="";
var TimeDelay="";
try {
   GroupId = document.getElementById('isGroup').value == "false" ? "" : document.getElementById('groupId').value;
}catch(e){

}
const BLEUUID = {
    namePrefix: 'PINGPONG.' + GroupId,
    service: '6e400001-b5a3-f393-e0a9-e50e24dcca9e',
    txChar: '6e400002-b5a3-f393-e0a9-e50e24dcca9e',
    rxChar: '6e400003-b5a3-f393-e0a9-e50e24dcca9e',
    groupID: GroupId
};
class PingPongDrawingBot {

    constructor (runtime, extensionId) {
        this._runtime = runtime;
        this._ble = null;
        this._runtime.registerPeripheralExtension(extensionId, this);
        this._extensionId = extensionId;
        this._busyTimeoutID = null;
        this.disconnect = this.disconnect.bind(this);
        this._onConnect = this._onConnect.bind(this);
        this._onMessage = this._onMessage.bind(this);
        this.connectCount = 3;
        this.AllConnected = false;
        this.waitResponseOPCode = -1;
        this.waitResponseOPCodetimeoutID = null;
    }

    scan() {
        if (this._ble) {
            this._ble.disconnect();
        }
        this._ble = new BLE(this._runtime, this._extensionId, {
            filters: [
                { namePrefix: BLEUUID.namePrefix , groupID: BLEUUID.groupID}
            ]
        }, this._onConnect, this.disconnect);
    }

    connect(id) {
        console.log("connect " + id);
        if (this._ble) {
            this._ble.connectPeripheral(id);
        }
    }

    disconnect() {
        console.log("disconnect called");

        if (this._ble) {
            this._ble.disconnect();
        }
        this.AllConnected = false;
    }

    isConnected() {
        let connected = false;
        if (this._ble) {
            connected = this._ble.isConnected();
        }

        if (connected == true)
            return this.AllConnected;

        this.AllConnected = false;
        return this.AllConnected;
    }

    send(message, force = false) {
        if (force == false)
            if (!this.isConnected()) return;

        if (this.waitResponseOPCode != -1) {
            console.log("waitResponseOPCode(send/cancle) :" + this.waitResponseOPCode);
            console.log("canceld");
            return;
        }
        console.log("waitResponseOPCode(send/willsendData):" + this.waitResponseOPCode);
        console.log("willsendData");
        const data = Base64Util.uint8ArrayToBase64(message);

        this._ble.write(BLEUUID.service, BLEUUID.txChar, data, 'base64', false).then(
            () => {
                console.log("send done to scratch links");
            }
        );
    }

    setWaitResponseOPCode(nCode, nTimeOut) {
        console.log("waitResponseOPCode(set) " + this.waitResponseOPCode);
        if (this.waitResponseOPCode != -1)
            return;
        if (this.waitResponseOPCodetimeoutID != null) {
            console.log("will cancel timer");
            window.clearTimeout(this.waitResponseOPCodetimeoutID);
            this.waitResponseOPCodetimeoutID = null;
        }
        this.waitResponseOPCode = nCode;
        console.log("set opcode" + nCode );
        this.waitResponseOPCodetimeoutID = window.setTimeout(() => {
            console.log("timer called will clear opcode");
            this.waitResponseOPCode = -1;
            this.waitResponseOPCodetimeoutID = null;
        }, nTimeOut);
    }
    // reset this.waitResponseOPCode value
    checkResponseData(value)
    {
        if (this.waitResponseOPCode == -1) {
            return;
        }

        if (value.byteLength < 7) {
            return;
        }
        
        if (value[6] == this.waitResponseOPCode) {
            console.log("value[6]  " + value[6] + " this.waitResponseOPCode  " + this.waitResponseOPCode);
            if (this.waitResponseOPCodetimeoutID != null) {
                console.log("this.waitResponseOPCodetimeoutID" + this.waitResponseOPCodetimeoutID);
                window.clearTimeout(this.waitResponseOPCodetimeoutID);
                this.waitResponseOPCodetimeoutID = null;
            }
            this.waitResponseOPCode = -1;
        }
    }
    
    NotificationEventFC(value) {
        if (value == null)
            return;

        if (value.byteLength == 18) {
            if (value[6] == 0xad || value[6] == 0xae) {
                if (value[11] == 0x01 && value[12] == 0x02) {
                    this.AllConnected = true;
                    this._runtime.emit(this._runtime.constructor.PERIPHERAL_CONNECTED);
                }
            }
        }
    }

    _onConnect() {
        this._ble.startNotifications(BLEUUID.service, BLEUUID.rxChar, this._onMessage);

        window.setTimeout(() => {
            this.send(PingPongUtil.getSetMultiroleInAction(this.connectCount), true);
        }, 1000);
    }

    _onMessage(base64) {
        const datas = Base64Util.base64ToUint8Array(base64);

        PingPongUtil.printUint8ArrayToHex(datas, "Notification Data");
        this.checkResponseData(datas);
        this.NotificationEventFC(datas);
    }
}

const simple_act_direction = {
    Up: '0',
    Down: '1',
    left: '2',
    right: '3'
};

const simple_act_interval = {
    cm10: '10',
    cm20: '20',
    cm30: '30',
    cm40: '40',
    cm50: '50'
};

const simple_act_degree = {
    degree90: '90',
    degree180: '180',
    degree270: '270'
};

const continuous_act_speed = {
    speedI100: '-100',
    speedI90: '-90',
    speedI80: '-80',
    speedI70: '-70',
    speedI60: '-60',
    speedI50: '-50',
    speedI40: '-40',
    speedI30: '-30',
    speedI20: '-20',
    speedI10: '-10',
    speed0: '0',
    speed10: '10',
    speed20: '20',
    speed30: '30',
    speed40: '40',
    speed50: '50',
    speed60: '60',
    speed70: '70',
    speed80: '80',
    speed90: '90',
    speed100: '100'
};

const PingPongAutoCarCubes = {
    LEFT: 'LEFT',
    RIGHT: 'RIGHT',
    ALL:'All'
};

class Scratch3PingPongDrawingBotBlocks {

    static get EXTENSION_NAME () {
        return 'Drawing Bot';
    }

    static get EXTENSION_ID() {
        return 'PingPongDrawingBot';
    }

    get UP_DOWN_DIRECTION() {
        return [
            {
                text: formatMessage({
                    id: 'PingPongAutoCar.simple_act_direction.Up',
                    default: 'forward',
                    description: 'label for front element in up direction'
                }),
                value: simple_act_direction.Up
            },
            {
                text: formatMessage({
                    id: 'PingPongAutoCar.simple_act_direction.Down',
                    default: 'backward',
                    description: 'label for front element in Down direction'
                }),
                value: simple_act_direction.Down
            }
        ];
    }

    get LEFT_RIGHT_DIRECTION() {
        return [
            {
                text: formatMessage({
                    id: 'PingPongAutoCar.simple_act_direction.left',
                    default: 'left',
                    description: 'label for front element in left direction'
                }),
                value: simple_act_direction.left
            },
            {
                text: formatMessage({
                    id: 'PingPongAutoCar.simple_act_direction.right',
                    default: 'right',
                    description: 'label for front element in right direction'
                }),
                value: simple_act_direction.right
            }
        ];
    }

    get INTERVAL() {
        return [
            {
                text: '10',
                value: simple_act_interval.cm10
            },
            {
                text: '20',
                value: simple_act_interval.cm20
            },
            {
                text: '30',
                value: simple_act_interval.cm30
            },
            {
                text: '40',
                value: simple_act_interval.cm40
            },
            {
                text: '50',
                value: simple_act_interval.cm50
            }
        ];
    }

    get UP_DOWN_CONTINUOUS() {
        return [
            {
                text: '-100',
                value: continuous_act_speed.speedI100
            },
            {
                text: '-80',
                value: continuous_act_speed.speedI80
            },
            {
                text: '-60',
                value: continuous_act_speed.speedI60
            },
            {
                text: '-40',
                value: continuous_act_speed.speedI40
            },
            {
                text: '-20',
                value: continuous_act_speed.speedI20
            },
            {
                text: '0',
                value: continuous_act_speed.speed0
            },
            {
                text: '20',
                value: continuous_act_speed.speed20
            },
            {
                text: '40',
                value: continuous_act_speed.speed40
            },
            {
                text: '60',
                value: continuous_act_speed.speed60
            },
            {
                text: '80',
                value: continuous_act_speed.speed80
            },
            {
                text: '100',
                value: continuous_act_speed.speed100
            }
        ];
    }

    get DEGREE() {
        return [
            {
                text: '90',
                value: simple_act_degree.degree90
            },
            {
                text: '180',
                value: simple_act_degree.degree180
            },
            {
                text: '270',
                value: simple_act_degree.degree270
            }
        ];
    }
    //rozen 11.07 add
    get CUBES(){
      return [
          {   text: formatMessage({
              id: 'pingpong.LEFT',
              default: PingPongAutoCarCubes.LEFT,
              description: '1'
              }),
              value: PingPongAutoCarCubes.LEFT
          },
          {
            text: formatMessage({
                id: 'pingpong.RIGHT',
                default: PingPongAutoCarCubes.RIGHT,
                description: '2'
                }),
                value: PingPongAutoCarCubes.RIGHT
          },
          {
            text: formatMessage({
                id: 'pingpong.ALL',
                default: PingPongAutoCarCubes.ALL,
                description: 'all'
                }),
                value: PingPongAutoCarCubes.ALL
          }
      ];
    }

    constructor (runtime) {
        /**
         * The Scratch 3.0 runtime.
         * @type {Runtime}
         */
        this.runtime = runtime;

        console.log("contsructor pingpong drawingbot called");
        // Create a new PingPongDrawingBot peripheral instance
        this._peripheral = new PingPongDrawingBot(this.runtime, Scratch3PingPongDrawingBotBlocks.EXTENSION_ID);

        this.frameToggle = false;

        setInterval(() => {
            this.frameToggle = !this.frameToggle;
        }, this.runtime.currentStepTime);

        this.inActionC1C2 = false;
        this.inActionPencil = false;

        console.log("contsructor pingpong drawingbot called end");

    }

    /**
     * @returns {object} metadata for this extension and its blocks.
     */
    getInfo() {
        console.log("getinfo pingpong drawingbot called");
        return {
            id: Scratch3PingPongDrawingBotBlocks.EXTENSION_ID,
            name: Scratch3PingPongDrawingBotBlocks.EXTENSION_NAME,
            blockIconURI: blockIconURI,
            showStatusButton: true,
            blocks: [

                {
                    opcode: 'updownact',
                    text: formatMessage({
                        id: 'pingpongdrawingbot.updownact',
                        default: 'move [INTERVAL] cm [DIRECTION]',
                        description: 'move interval and direction'
                    }),
                    arguments: {
                        DIRECTION: {
                            type: ArgumentType.STRING,
                            menu: 'updowndirection',
                            defaultValue: simple_act_direction.Up
                        },
                        INTERVAL: {
                            type: ArgumentType.STRING,
                            defaultValue: simple_act_interval.cm10
                        }
                    }
                },
                {
                    opcode: 'leftrightact',
                    text: formatMessage({
                        id: 'pingpongdrawingbot.leftrightact',
                        default: 'turn [DEGREE] degrees [DIRECTION]',
                        description: 'fldgo002'
                    }),
                    arguments: {
                        DIRECTION: {
                            type: ArgumentType.STRING,
                            menu: 'leftrightdirection',
                            defaultValue: simple_act_direction.left
                        },
                        DEGREE: {
                            type: ArgumentType.STRING,
                            defaultValue: simple_act_degree.degree90
                        }
                    }
                },
                {
                    opcode: 'updownactC',
                    text: formatMessage({
                        id: 'pingpongdrawingbot.updownactC',
                        default: 'set velocity to left: [SPEED1] right: [SPEED2]',
                        description: 'fldgo002'
                    }),
                    arguments: {
                        SPEED1: {
                            type: ArgumentType.STRING,
                            menu: 'updowncontinuous',
                            defaultValue: continuous_act_speed.speed100
                        },
                        SPEED2: {
                            type: ArgumentType.STRING,
                            menu: 'updowncontinuous',
                            defaultValue: continuous_act_speed.speed100
                        }
                    }
                },
                {
                    opcode: 'updownactCLA',
                    text: formatMessage({
                        id: 'pingpongautocar.updownactCLA',
                        default: 'set velocity to [CUBE]: [SPEED1]',
                        description: 'fldgo002'
                    }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                        CUBE: {
                          type: ArgumentType.STRING,
                          menu: 'cubes',
                          defaultValue: PingPongAutoCarCubes.LEFT
                        },
                        SPEED1: {
                            type: ArgumentType.STRING,
                            menu: 'updowncontinuous',
                            defaultValue: simple_act_direction.Up
                        }
                    }
                },
                {
                  //rozen 11.07 ADD
                    opcode: 'stopMotors',
                    text: formatMessage({
                        id: 'pingpongautocar.allStop',
                        default: '[CUBE] stop',
                        description: 'fldgo002'
                    }),
                    blockType: BlockType.COMMAND,
                    arguments:{
                      CUBE: {
                        type: ArgumentType.STRING,
                        menu: 'cubes',
                        defaultValue: PingPongAutoCarCubes.LEFT
                      }
                    }
                },
                {
                    opcode: 'penup',
                    text: formatMessage({
                        id: 'pingpongdrawingbot.penup',
                        default: 'hold up pen',
                        description: 'fldgo002'
                    })
                },
                {
                    opcode: 'pendown',
                    text: formatMessage({
                        id: 'pingpongdrawingbot.pendown',
                        default: 'hold down pen',
                        description: 'fldgo002'
                    })
                }
            ],
            menus: {
                updowndirection: this.UP_DOWN_DIRECTION,
                leftrightdirection: this.LEFT_RIGHT_DIRECTION,
                interval: {
                    acceptReporters: true,
                    items: this.INTERVAL
                } ,
                updowncontinuous: this.UP_DOWN_CONTINUOUS,
                degree: {
                    acceptReporters: true,
                    items: this.DEGREE
                },
                cubes : this.CUBES
            }
        };
    }

    updownact(args) {
        console.log("updownAct " + args.DIRECTION + " " + args.INTERVAL);

        if (this._peripheral.AllConnected == false)
            return;

        if (this.inActionC1C2 == true)
            return;

        if (args.DIRECTION != simple_act_direction.Up && args.DIRECTION != simple_act_direction.Down) {
            console.log("updwonAct unknown direction!");
            return;
        }

        var Speed = 80;

        this.inActionC1C2 = true;

        if (args.DIRECTION == simple_act_direction.Down) {
            Speed *= -1;
        }

        var SinglesData = new Array(2);
        SinglesData[0] = PingPongUtil.makeSingleData(0, 0, Speed * -1, args.INTERVAL, 99);
        SinglesData[1] = PingPongUtil.makeSingleData(1, 0, Speed, args.INTERVAL, 99);
        SinglesData[0][12] = 2; // make resume
        SinglesData[1][12] = 2; // make resume

        var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(SinglesData, 2, 1);

        var TimeDelay = PingPongUtil.calculateTimeFromspeeddistance(Speed, args.INTERVAL, 99) + 200;

        console.log("will delay " + TimeDelay);

        this._peripheral.send(OutPutData);
        
        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2 = false;
                clearInterval(repeat);
                resolve();
            }, TimeDelay);
        });
    
    }

    leftrightact(args) {
        console.log("leftrightact " + args.DIRECTION + " " + args.INTERVAL);

        if (this._peripheral.AllConnected == false)
            return;

        if (args.DIRECTION != simple_act_direction.left && args.DIRECTION != simple_act_direction.right) {
            console.log("updwonAct unknown direction!");
            return;
        }

        if (this.inActionC1C2 == true)
            return;

        var Speed = 80;

        this.inActionC1C2 = true;


        if (args.DIRECTION == simple_act_direction.right) {
            Speed *= -1;
        }

        var SinglesData = new Array(2);
        SinglesData[0] = PingPongUtil.makeSingleData(0, 0, Speed, args.DEGREE, 7.486);
        SinglesData[1] = PingPongUtil.makeSingleData(1, 0, Speed, args.DEGREE, 7.486);

        SinglesData[0][12] = 2; // make resume
        SinglesData[1][12] = 2; // make resume

        var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(SinglesData, 2, 1);

        this._peripheral.send(OutPutData);
        
        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2 = false;
                clearInterval(repeat);
                resolve();
            }, TimeDelay);
        });
        
    }

    updownactC(args) {
        console.log("updownActC " + args.SPEED1 + " " + args.SPEED2);

        if (this._peripheral.AllConnected == false)
            return;

        var ContinuousData = new Array(2);
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, args.SPEED1 * -1);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, args.SPEED2);
        var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(ContinuousData, 2, 1);
        console.log("ContinuousData " + ContinuousData);
        console.log("OutPutData " + OutPutData);

        this._peripheral.send(OutPutData);
        this._peripheral.setWaitResponseOPCode(0xcd, 400);
        
        return new Promise(resolve => {
            setInterval(() => {
                resolve();
            }, 400);
        });
    }

    stopMotors(args) {
      if(args.CUBE == PingPongAutoCarCubes.ALL){
        if (this._peripheral.AllConnected == false)
            return;

        var ContinuousData = new Array(2);
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, 0);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, 0);
        var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(ContinuousData, 2, 0);

        this._peripheral.send(OutPutData);
        this._peripheral.setWaitResponseOPCode(0xcd, 400);

      }

      if(args.CUBE == PingPongAutoCarCubes.LEFT){
        var ContinuousData = new Array(2);
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, 0);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, 1000);
        ContinuousData[1][6] = 0x00; // make dummy opcode
        var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(ContinuousData, 2, 0);

        //this._peripheral.send(ContinuousData);
        this._peripheral.send(OutPutData);
        this._peripheral.setWaitResponseOPCode(0xcd, 400);
      }

      if(args.CUBE == PingPongAutoCarCubes.RIGHT){
        var ContinuousData = new Array(2);
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, 1000);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, 0);
        ContinuousData[0][6] = 0x00; // make dummy opcode
        var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(ContinuousData, 2, 0);


        //this._peripheral.send(ContinuousData);
        this._peripheral.send(OutPutData);
        this._peripheral.setWaitResponseOPCode(0xcd, 400);

      }
      return new Promise(resolve => {
          setInterval(() => {
              resolve();
          }, 400);
      });
    }

    updownactCLA(args) {
      if(args.CUBE == PingPongAutoCarCubes.ALL){
        if (this._peripheral.AllConnected == false)
            return;

        var ContinuousData = new Array(2);
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, args.SPEED1);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, args.SPEED1);
        var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(ContinuousData, 2, 0);

        this._peripheral.send(OutPutData);
        this._peripheral.setWaitResponseOPCode(0xcd, 400);

      }

      if(args.CUBE == PingPongAutoCarCubes.LEFT){
        var ContinuousData = new Array(2);
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, args.SPEED1*-1);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, args.SPEED1);
        ContinuousData[1][6] = 0x00; // make dummy opcode
        var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(ContinuousData, 2, 0);

        //this._peripheral.send(ContinuousData);
        this._peripheral.send(OutPutData);
        this._peripheral.setWaitResponseOPCode(0xcd, 400);
      }

      if(args.CUBE == PingPongAutoCarCubes.RIGHT){
        var ContinuousData = new Array(2);
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, args.SPEED1);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, args.SPEED1);
        ContinuousData[0][6] = 0x00; // make dummy opcode
        var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(ContinuousData, 2, 0);


        //this._peripheral.send(ContinuousData);
        this._peripheral.send(OutPutData);
        this._peripheral.setWaitResponseOPCode(0xcd, 400);

      }
      return new Promise(resolve => {
          setInterval(() => {
              resolve();
          }, 400);
      });
    }

    penup() {
        console.log("penup ");

        if (this._peripheral.AllConnected == false)
            return;

        if (this.inActionPencil == true)
            return;

        this.inActionPencil = true;

        var Speed = 700;

        var penupData = PingPongUtil.makeSingleDataByStep(2, 2, Speed, 495);

        penupData[12] = 2; // make resume

        this._peripheral.send(penupData);

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionPencil = false;
                    clearInterval(repeat);
                    resolve();
            }, 2300);
        });
    }

    pendown() {
        console.log("pendown ");

        if (this._peripheral.AllConnected == false)
            return;

        if (this.inActionPencil == true)
            return;

        this.inActionPencil = true;

        var Speed = -700;

        var pendownData = PingPongUtil.makeSingleDataByStep(2, 2, Speed, 495);

        pendownData[12] = 2; // make resume

        this._peripheral.send(pendownData);

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionPencil = false;
                clearInterval(repeat);
                resolve();
            }, 2300);
        });
    }
}

module.exports = Scratch3PingPongDrawingBotBlocks;
