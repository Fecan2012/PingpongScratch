const ArgumentType = require('../../extension-support/argument-type');
const BlockType = require('../../extension-support/block-type');
const log = require('../../util/log');
const cast = require('../../util/cast');
const formatMessage = require('format-message');
const BLE = require('../../io/blepingpong');
const Base64Util = require('../../util/base64-util');

const PingPongUtil = require('../../util/pingpong-util');

const blockIconURI = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAABQCAYAAACOEfKtAAAACXBIWXMAAC4jAAAuIwF4pT92AAAF+mlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxNDUgNzkuMTYzNDk5LCAyMDE4LzA4LzEzLTE2OjQwOjIyICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdEV2dD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlRXZlbnQjIiB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iIHhtbG5zOnBob3Rvc2hvcD0iaHR0cDovL25zLmFkb2JlLmNvbS9waG90b3Nob3AvMS4wLyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ0MgMjAxOSAoV2luZG93cykiIHhtcDpDcmVhdGVEYXRlPSIyMDE5LTA2LTA0VDE0OjIwOjQ0KzA5OjAwIiB4bXA6TWV0YWRhdGFEYXRlPSIyMDE5LTA2LTA0VDE0OjIwOjQ0KzA5OjAwIiB4bXA6TW9kaWZ5RGF0ZT0iMjAxOS0wNi0wNFQxNDoyMDo0NCswOTowMCIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDo1ZDg2MjE4ZC1kZmQyLWI4NDktOGUzMC01Njg0MDBkM2E4OGQiIHhtcE1NOkRvY3VtZW50SUQ9ImFkb2JlOmRvY2lkOnBob3Rvc2hvcDo0MTE2M2ExYi00NWI1LWQwNGMtOTFkMC04MzNkYzYxMjVkNDIiIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDowYTNiYjEwNS0xMTRiLWQ1NGItYWQ5NC1mYzEyYWE1OTUwMTciIGRjOmZvcm1hdD0iaW1hZ2UvcG5nIiBwaG90b3Nob3A6Q29sb3JNb2RlPSIzIiBwaG90b3Nob3A6SUNDUHJvZmlsZT0ic1JHQiBJRUM2MTk2Ni0yLjEiPiA8eG1wTU06SGlzdG9yeT4gPHJkZjpTZXE+IDxyZGY6bGkgc3RFdnQ6YWN0aW9uPSJjcmVhdGVkIiBzdEV2dDppbnN0YW5jZUlEPSJ4bXAuaWlkOjBhM2JiMTA1LTExNGItZDU0Yi1hZDk0LWZjMTJhYTU5NTAxNyIgc3RFdnQ6d2hlbj0iMjAxOS0wNi0wNFQxNDoyMDo0NCswOTowMCIgc3RFdnQ6c29mdHdhcmVBZ2VudD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTkgKFdpbmRvd3MpIi8+IDxyZGY6bGkgc3RFdnQ6YWN0aW9uPSJzYXZlZCIgc3RFdnQ6aW5zdGFuY2VJRD0ieG1wLmlpZDo1ZDg2MjE4ZC1kZmQyLWI4NDktOGUzMC01Njg0MDBkM2E4OGQiIHN0RXZ0OndoZW49IjIwMTktMDYtMDRUMTQ6MjA6NDQrMDk6MDAiIHN0RXZ0OnNvZnR3YXJlQWdlbnQ9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE5IChXaW5kb3dzKSIgc3RFdnQ6Y2hhbmdlZD0iLyIvPiA8L3JkZjpTZXE+IDwveG1wTU06SGlzdG9yeT4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz5FdYLgAAAS9UlEQVR4nO2ce5BkV13HP79z7r3dt7tnpmdndnZ2d3Z2szESHiYQgkpBIgmJIJZKUVoqvigVhVIRLLXiE/1DRY2IURQhBWVRalmKIhLDQx4GSgMJq2SjWTbZ3ck+Zndnd979uq/z8497u6d7ZrOCTcRHf7d6prdv3/M7v+/5vc7v3F1RVUb4r8N8pSfwvx0jAofEiMAhMSJwSIwIHBIjAofEiMAhMSJwSIwIHBIjAofEiMAhMSJwSIwIHBIjAofEiMAhMSJwSIwI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';

const strScheduledData = 'ff,ff,ff,aa,20,0,cd,2,43,2,3,0,0,ff,ff,ff,0,0,0,ca,1,1b,2,3,0,1,c5,17,fc,a5,0,f8,3,5b,0,f8,fc,7c,0,f8,0,0,2,58,3,5b,0,f8,fc,7c,0,f8,0,0,2,58,3,5b,0,f8,0,0,2,58,0,0,3,20,fc,a5,0,f8,0,0,2,58,3,84,0,f8,fc,a5,0,f8,0,0,2,58,3,84,0,f8,fc,a5,0,f8,0,0,2,58,3,5b,0,f8,0,0,3,20,fc,41,1,ef,3,97,1,ef,3,97,1,ef,1,1a,0,6e,fc,48,2,5d,0,0,2,26,2,ff,0,a5,fd,5c,0,a5,0,0,3,20,fc,f2,0,dc,2,b3,0,dc,1,1a,0,6e,3,3c,1,4a,fc,80,1,b8,fc,23,1,ef,3,dd,1,ef,0,0,2,bc,0,0,3,20,fc,41,1,ef,3,97,1,ef,0,0,3,20,fc,23,1,ef,3,dd,1,ef,0,0,2,bc,0,0,3,20,2,b9,0,f8,fc,8d,0,8a,3,73,0,8a,fc,8d,0,8a,3,73,0,8a,fc,7d,1,f0,3,73,0,8a,fc,8d,0,8a,3,73,0,8a,fc,8d,0,8a,fc,7e,0,f7,3,82,1,ef,fc,7d,0,f8,3,ab,1,f0,fc,55,1,f0,3,ab,1,f0,fc,55,0,f8,fc,23,1,ef,3,dd,1,ef,0,0,2,bc,0,0,3,20,0,0,3,e8,ff,ff,ff,1,0,0,ca,1,1b,2,3,0,1,48,bf,fc,a5,0,f8,0,0,2,58,3,84,0,f8,fc,a5,0,f8,0,0,2,58,3,84,0,f8,fc,a5,0,f8,0,0,2,58,3,5b,0,f8,0,0,3,20,fc,a5,0,f8,3,5b,0,f8,fc,7c,0,f8,0,0,2,58,3,5b,0,f8,fc,7c,0,f8,0,0,2,58,3,5b,0,f8,0,0,2,58,0,0,3,20,fc,f2,0,dc,2,b3,0,dc,1,1a,0,6e,3,3c,1,4a,fc,80,1,b8,fc,23,1,ef,3,dd,1,ef,0,0,2,bc,0,0,3,20,fc,41,1,ef,3,97,1,ef,3,97,1,ef,1,1a,0,6e,fc,48,2,5d,0,0,2,26,2,ff,0,a5,fd,5c,0,a5,0,0,3,20,fc,f2,0,dc,2,b3,0,dc,0,0,3,20,0,0,2,26,2,ff,0,a5,fd,5c,0,a5,0,0,3,20,2,b9,0,f8,fc,8d,0,8a,3,73,0,8a,fc,8d,0,8a,3,73,0,8a,fc,7d,1,f0,3,73,0,8a,fc,8d,0,8a,3,73,0,8a,fc,8d,0,8a,fd,20,0,89,3,49,1,81,3,83,0,f8,fc,55,1,f0,3,ab,1,f0,fc,55,1,f0,3,ab,0,f8,0,0,2,26,2,ff,0,a5,fd,5c,0,a5,0,0,3,20,0,0,3,e8';

const WORMBOTPointData = new Array(0x0, 0x9, 0xa, 0x13, 0x14, 0x1c, 0x1d, 0x25,
    0X42, 0x42, 0x26, 0x2c, 0x2d, 0x41);

var GroupId="";
var TimeDelay= "";

try {
   GroupId = document.getElementById('isGroup').value == "false" ? "" : document.getElementById('groupId').value;
}catch(e){}

const BLEUUID = {
    namePrefix: 'PINGPONG.'+ GroupId,
    service: '6e400001-b5a3-f393-e0a9-e50e24dcca9e',
    txChar: '6e400002-b5a3-f393-e0a9-e50e24dcca9e',
    rxChar: '6e400003-b5a3-f393-e0a9-e50e24dcca9e',
    groupID: GroupId
};

const WORMBOTCubes = {
    ONE: '1',
    TWO: '2',
    ALL:'ALL'
};

class PingPongWormBot {
    constructor (runtime, extensionId) {
        this._runtime = runtime;
        
        this._ble = null;
        this._runtime.registerPeripheralExtension(extensionId, this);
        
        // this._ble = null;

        console.log("pingpong wormbot constructor2");
        this._extensionId = extensionId;

        this.disconnect = this.disconnect.bind(this);
        this._onConnect = this._onConnect.bind(this);
        this._onMessage = this._onMessage.bind(this);

        this.connectCount = 2;

        this.AllConnected = false;
        this.inAction = false;
        this.sendScheduledData = false;
        this.waitScheduledDataResponse = false;

        this.waitResponseOPCode = -1;
        this.receivedLastPointData = -1;
        this.waitLastPointDone = false;

        this.SafeCheckCount = 0;
    }

    scan() {
        if (this._ble) {
            this._ble.disconnect();
        }
        this._ble = new BLE(this._runtime, this._extensionId, {
            filters: [
                { namePrefix: BLEUUID.namePrefix , groupID: BLEUUID.groupID}
            ]
        }, this._onConnect, this.disconnect);
    }

    connect(id) {
        console.log("connect " + id);
        if (this._ble) {
            this._ble.connectPeripheral(id);
        }
    }

    disconnect() {
        if (this._ble) {
            this._ble.disconnect();
        }

        this.sendScheduledData = false;
        this.AllConnected = false;
    }

    isConnected() {
        let connected = false;
        if (this._ble) {
            connected = this._ble.isConnected();
        }

        if (connected == true)
            return this.AllConnected;

        this.AllConnected = false;
        return this.AllConnected;
    }

    send(message, force = false) {
        if (force == false)
            if (!this.isConnected()) return;

        const data = Base64Util.uint8ArrayToBase64(message);

        this._ble.write(BLEUUID.service, BLEUUID.txChar, data, 'base64', false).then(
            () => {
                console.log("send done to scratch links");
            }
        );
    }

    checkResponseData(datas) {

        if (this.waitResponseOPCode == -1) {
            return;
        }

        if (datas.byteLength < 7) {
            return;
        }

        console.log("checkresponsedatas " + datas[6] + " " + this.waitResponseOPCode);

        if (datas[6] == this.waitResponseOPCode) {
            console.log("checkresponsedatas found waitcode " + this.waitResponseOPCode);

            this.waitResponseOPCode = -1;

            if (this.waitScheduledDataResponse == true) {
                this.sendScheduledData = true;
                this.waitScheduledDataResponse = false;
            }
        }
    }
    /*
    NotificationEventFC(value)
    {
        if (value == null)
            return;

        this.checkResponseData(value);

        if (value.byteLength == 19)
        {
            if (value[6] == 0xad || value[6] == 0xae) {
                if (value[11] == 0x01) {
                    this.AllConnected = true;

                    if (this.sendScheduledData == false && this.waitScheduledDataResponse == false) {

                        this.waitScheduledDataResponse = true;
                        this.waitResponseOPCode = 0xcd;

                        var strSplit = strScheduledData.split(",");
                        var txCharVal = new Uint8Array(strSplit.length);

                        for (var i = 0; i < strSplit.length; i++) {
                            txCharVal[i] = parseInt(strSplit[i], 16);
                        }

                        this.send(txCharVal);
                    }

                    this._runtime.emit(this._runtime.constructor.PERIPHERAL_CONNECTED);
                }
            }
        }
        
        if (value.byteLength == 17) {
            if (value[6] == 0xca) {
                this.receivedLastPointData = value[13] * 256 + value[14];
            }
        }
    }
    */

   NotificationEventFC(value)
   {
       if (value == 19)
           return;

       this.checkResponseData(value);

       if (value.byteLength == 19)
       {
           if (value[6] == 0xad || value[6] == 0xae) {
               if (value[11] == 0x01) {
                   this.AllConnected = true;

                   if (this.sendScheduledData == false && this.waitScheduledDataResponse == false) {

                       this.waitScheduledDataResponse = true;
                       this.waitResponseOPCode = 0xcd;

                       var strSplit = strScheduledData.split(",");
                       var txCharVal = new Uint8Array(strSplit.length);

                       for (var i = 0; i < strSplit.length; i++) {
                           txCharVal[i] = parseInt(strSplit[i], 16);
                       }

                       this.send(txCharVal);
                   }

                   this._runtime.emit(this._runtime.constructor.PERIPHERAL_CONNECTED);
               }
           }
       }
       
       if (value.byteLength == 17) {
           if (value[6] == 0xca) {
               this.receivedLastPointData = value[13] * 256 + value[14];
           }
       }
   }
    _onConnect() {
        this._ble.startNotifications(BLEUUID.service, BLEUUID.rxChar, this._onMessage);

        window.setTimeout(() => {
            this.send(PingPongUtil.getSetMultiroleInAction(this.connectCount), true);
        }, 1000);
    }

    _onMessage(base64) {
        const datas = Base64Util.base64ToUint8Array(base64);

        PingPongUtil.printUint8ArrayToHex(datas, "Notification Data");
        this.NotificationEventFC(datas);
    }
}


const simple_act_degreeradius = {
    degree10: '10',
    degree20: '20',
    degree30: '30',
    degree40: '40',
    degree50: '50',
    degree60: '60',
    degree70: '70',
    degree80: '80',
    degree90: '90',
    degree100: '100',
    degree110: '110',
    degree120: '120',
    degree130: '130',
    degree140: '140',
    degree150: '150',
    degree160: '160',
    degree170: '170',
    degree180: '180',
    degree190: '190',
    degree200: '200',
    degree210: '210',
    degree220: '220',
    degree230: '230',
    degree240: '240',
    degree250: '250',
    degree260: '260',
    degree270: '270',
    degree280: '280',
    degree290: '290',
    degree300: '300',
    degree310: '310',
    degree320: '320',
    degree330: '330',
    degree340: '340',
    degree350: '350',
    degree360: '360'
};

const PingPongWormBotLoDirect = {
    L: 'left',
    R: 'right',
};

class Scratch3PingPongWormBotBlocks {
    static get EXTENSION_NAME () {
        return 'Worm Bot';
    }

    static get EXTENSION_ID() {
        return 'PingPongWormBot';
    }

    get CUBES(){
      return [
          {   text: formatMessage({
              id: 'pingpong.ONE',
              default: WORMBOTCubes.ONE,
              description: '1'
              }),
              value: WORMBOTCubes.ONE
          },
          {
            text: formatMessage({
                id: 'pingpong.TWO',
                default: WORMBOTCubes.TWO,
                description: '2'
                }),
                value: WORMBOTCubes.TWO
          },
          {
            text: formatMessage({
                id: 'pingpong.ALL',
                default: WORMBOTCubes.ALL,
                description: 'all'
                }),
                value: WORMBOTCubes.ALL
          }
      ];
    }

    get DEGREERADIUSALL() {
        return [
            {
                text: '10',
                value: simple_act_degreeradius.degree10
            },
            {
                text: '20',
                value: simple_act_degreeradius.degree20
            },
            {
                text: '30',
                value: simple_act_degreeradius.degree30
            },
            {
                text: '40',
                value: simple_act_degreeradius.degree40
            },
            {
                text: '50',
                value: simple_act_degreeradius.degree50
            },
            {
                text: '60',
                value: simple_act_degreeradius.degree60
            },
            {
                text: '70',
                value: simple_act_degreeradius.degree70
            },
            {
                text: '80',
                value: simple_act_degreeradius.degree80
            },
            {
                text: '90',
                value: simple_act_degreeradius.degree90
            },
            {
                text: '100',
                value: simple_act_degreeradius.degree100
            },
            {
                text: '110',
                value: simple_act_degreeradius.degree110
            },
            {
                text: '120',
                value: simple_act_degreeradius.degree120
            },
            {
                text: '130',
                value: simple_act_degreeradius.degree130
            },
            {
                text: '140',
                value: simple_act_degreeradius.degree140
            },
            {
                text: '150',
                value: simple_act_degreeradius.degree150
            },
            {
                text: '160',
                value: simple_act_degreeradius.degree160
            },
            {
                text: '170',
                value: simple_act_degreeradius.degree170
            },
            {
                text: '180',
                value: simple_act_degreeradius.degree180
            },
            {
                text: '190',
                value: simple_act_degreeradius.degree190
            },
            {
                text: '200',
                value: simple_act_degreeradius.degree200
            },
            {
                text: '210',
                value: simple_act_degreeradius.degree210
            },
            {
                text: '220',
                value: simple_act_degreeradius.degree220
            },
            {
                text: '230',
                value: simple_act_degreeradius.degree230
            },
            {
                text: '240',
                value: simple_act_degreeradius.degree240
            },
            {
                text: '250',
                value: simple_act_degreeradius.degree250
            },
            {
                text: '260',
                value: simple_act_degreeradius.degree260
            },
            {
                text: '270',
                value: simple_act_degreeradius.degree270
            },
            {
                text: '280',
                value: simple_act_degreeradius.degree280
            },
            {
                text: '290',
                value: simple_act_degreeradius.degree290
            },
            {
                text: '300',
                value: simple_act_degreeradius.degree300
            },
            {
                text: '310',
                value: simple_act_degreeradius.degree310
            },
            {
                text: '320',
                value: simple_act_degreeradius.degree320
            },
            {
                text: '330',
                value: simple_act_degreeradius.degree330
            },
            {
                text: '340',
                value: simple_act_degreeradius.degree340
            },
            {
                text: '350',
                value: simple_act_degreeradius.degree350
            },
            {
                text: '360',
                value: simple_act_degreeradius.degree360
            }
        ];
    }

    get LODIRECT_MENU() {
        return [
            {
                text: formatMessage({
                    id: 'pingpongwormbot.PingPongWormBotLoDirect.R',
                    default: 'clockwise',
                    description: 'lotate clock'
                }),
                value: PingPongWormBotLoDirect.R
            },
            {
                text: formatMessage({
                    id: 'pingpongwormbot.PingPongWormBotLoDirect.L',
                    default: 'counterclockwise',
                    description: 'lotate counter clock'
                }),
                value: PingPongWormBotLoDirect.L
            }
        ];
    }

    constructor (runtime) {
        this.runtime = runtime;

        this._peripheral = new PingPongWormBot(this.runtime, Scratch3PingPongWormBotBlocks.EXTENSION_ID);

        this.frameToggle = false;

        setInterval(() => {
            this.frameToggle = !this.frameToggle;
        }, this.runtime.currentStepTime);
    }

    getInfo() {
        return {
            id: Scratch3PingPongWormBotBlocks.EXTENSION_ID,
            name: Scratch3PingPongWormBotBlocks.EXTENSION_NAME,
            blockIconURI: blockIconURI,
            showStatusButton: true,
            blocks: [
                {
                    opcode: 'crawlleft',
                    text: formatMessage({
                        id: 'pingpongwormbot.crawlleft',
                        default: 'move left',
                        description: 'fldgo002'
                    })
                },
                {
                    opcode: 'crawlright',
                    text: formatMessage({
                        id: 'pingpongwormbot.crawlright',
                        default: 'move right',
                        description: 'fldgo002'
                    })
                },
                {
                    opcode: 'acrobatleft',
                    text: formatMessage({
                        id: 'pingpongwormbot.acrobatleft',
                        default: 'rotate left',
                        description: 'fldgo002'
                    })
                },
                {
                    opcode: 'acrobatright',
                    text: formatMessage({
                        id: 'pingpongwormbot.acrobatright',
                        default: 'rotate right',
                        description: 'fldgo002'
                    })
                },
                {
                    opcode: 'handstanding',
                    text: formatMessage({
                        id: 'pingpongwormbot.handstanding',
                        default: 'stand up',
                        description: 'fldgo002'
                    })
                },
                {
                    opcode: 'dancing',
                    text: formatMessage({
                        id: 'pingpongwormbot.dancing',
                        default: 'doing a dance',
                        description: 'fldgo002'
                    })
                },
                {
                    opcode: 'motorall',
                    text: formatMessage({
                        id: 'pingpongwormbot.motorall',
                        default: 'rotate left: [RADIUS1] degrees [LODIRECT1] right: [RADIUS2] degrees [LODIRECT2]',
                        description: 'is the micro:bit is tilted in a direction?'
                    }),
                    arguments: {
                        LODIRECT1: {
                            type: ArgumentType.STRING,
                            menu: 'lodirect',
                            defaultValue: PingPongWormBotLoDirect.R
                        },
                        LODIRECT2: {
                            type: ArgumentType.STRING,
                            menu: 'lodirect',
                            defaultValue: PingPongWormBotLoDirect.R
                        },
                        RADIUS1: {
                            type: ArgumentType.STRING,
                            defaultValue: simple_act_degreeradius.degree90
                        },
                        RADIUS2: {
                            type: ArgumentType.STRING,
                            defaultValue: simple_act_degreeradius.degree90
                        }
                    }
                },
                {
                    opcode: 'motorChoice',
                    text: formatMessage({
                        id: 'pingpongwormbot.motorChoice',
                        default: 'rotate motor[CUBE]: [RADIUS] degrees [LODIRECT]',
                        description: 'is the micro:bit is tilted in a direction?'
                    }),
                    arguments: {
                        CUBE:{
                          type: ArgumentType.STRING,
                          menu: 'cubes',
                          defaultValue: WORMBOTCubes.ONE
                        },
                        LODIRECT: {
                            type: ArgumentType.STRING,
                            menu: 'lodirect',
                            defaultValue: PingPongWormBotLoDirect.R
                        },
                        RADIUS: {
                            type: ArgumentType.STRING,
                            defaultValue: simple_act_degreeradius.degree90
                        }
                    }
                }
            ],
            menus: {
                lodirect: this.LODIRECT_MENU,
                radius: this.DEGREERADIUSALL,
                cubes: this.CUBES
            }
        };
    }

    checkEndSchedulingData(nEndPointData) {

        console.log("checkEndSchedulingData : " + this._peripheral.receivedLastPointData);
        if (this._peripheral.receivedLastPointData == nEndPointData) {
            this._peripheral.receivedLastPointData = -1;
            this._peripheral.waitLastPointDone = true;
        }

        if (this._peripheral.waitLastPointDone == true) {
            PingPongUtil.pingpongsleep(200);

            this._peripheral.inAction = false;
            this._peripheral.waitLastPointDone = false;
            this._peripheral.SafeCheckCount = 0;

            return true;
        }

        if (this._peripheral.isConnected() == false)
        {
            this._peripheral.inAction = false;
            this._peripheral.waitLastPointDone = false;
            this._peripheral.SafeCheckCount = 0;
            return true;
        }

        if (this._peripheral.SafeCheckCount++ > 70) {
            this._peripheral.inAction = false;
            this._peripheral.waitLastPointDone = false;
            this._peripheral.SafeCheckCount = 0;
            return true;
        }

        return false;
    }

    crawlleft() {
        if (this._peripheral.AllConnected == false)
            return;

        if (this._peripheral.sendScheduledData == false)
            return;

        if (this._peripheral.inAction == true)
            return;

        this._peripheral.inAction = true;

        this._peripheral.send(PingPongUtil.getDefaultPointDatas(0x0, 0x9));

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                if (this.checkEndSchedulingData(0x09) == true) {
                    clearInterval(repeat);
                    resolve();
                }
            }, 200);
        });
     }

    crawlright() {
        if (this._peripheral.AllConnected == false)
            return;

        if (this._peripheral.sendScheduledData == false)
            return;

        if (this._peripheral.inAction == true)
            return;

        this._peripheral.inAction = true;

        this._peripheral.send(PingPongUtil.getDefaultPointDatas(0xa, 0x13));

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                if (this.checkEndSchedulingData(0x13) == true) {
                    clearInterval(repeat);
                    resolve();
                }
            }, 200);
        });
    }

    acrobatleft() {
        if (this._peripheral.AllConnected == false)
            return;

        if (this._peripheral.sendScheduledData == false)
            return;

        if (this._peripheral.inAction == true)
            return;

        this._peripheral.inAction = true;

        this._peripheral.send(PingPongUtil.getDefaultPointDatas(0x14, 0x1c));

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                if (this.checkEndSchedulingData(0x1c) == true) {
                    clearInterval(repeat);
                    resolve();
                }
            }, 200);
        });
    }

    acrobatright() {
        console.log('acrobatright');

        if (this._peripheral.AllConnected == false)
            return;

        if (this._peripheral.sendScheduledData == false)
            return;

        if (this._peripheral.inAction == true)
            return;

        this._peripheral.inAction = true;

        this._peripheral.send(PingPongUtil.getDefaultPointDatas(0x1d, 0x25));

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                if (this.checkEndSchedulingData(0x25) == true) {
                    clearInterval(repeat);
                    resolve();
                }
            }, 200);
        });
    }

    handstanding() {
        if (this._peripheral.AllConnected == false)
            return;

        if (this._peripheral.sendScheduledData == false)
            return;

        if (this._peripheral.inAction == true)
            return;

        this._peripheral.inAction = true;

        this._peripheral.send(PingPongUtil.getDefaultPointDatas(0x26, 0x2c));

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                if (this.checkEndSchedulingData(0x2c) == true) {
                    clearInterval(repeat);
                    resolve();
                }
            }, 200);
        });
    }

    dancing() {
        if (this._peripheral.AllConnected == false)
            return;

        if (this._peripheral.sendScheduledData == false)
            return;

        if (this._peripheral.inAction == true)
            return;

        this._peripheral.inAction = true;

        this._peripheral.send(PingPongUtil.getDefaultPointDatas(0x2d, 0x41));

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                if (this.checkEndSchedulingData(0x41) == true) {
                    clearInterval(repeat);
                    resolve();
                }
            }, 200);
        });
    }


    motorall(args) {

        if (this._peripheral.AllConnected == false)
            return;

        if (this._peripheral.sendScheduledData == false)
            return;

        if (this._peripheral.inAction == true)
            return;

        this._peripheral.inAction = true;

        var Speed1 = 800;
        var Speed2 = 800;

        if (args.LODIRECT1 == PingPongWormBotLoDirect.L) {
            Speed1 *= -1;
        }

        if (args.LODIRECT2 == PingPongWormBotLoDirect.L) {
            Speed2 *= -1;
        }

        var Step1 = Math.round(args.RADIUS1 * 5.5);
        var Step2 = Math.round(args.RADIUS2 * 5.5);

        console.log(Speed1 + Speed2 + " " + args.RADIUS1 + " " + args.RADIUS2);

        var SinglesData = new Array(2);
        SinglesData[0] = PingPongUtil.makeSingleDataByStep(0, 0, Speed1, Step1);
        SinglesData[1] = PingPongUtil.makeSingleDataByStep(1, 0, Speed2, Step2);
        SinglesData[0][12] = 2; // make resume
        SinglesData[1][12] = 2; // make resume

        var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(SinglesData, 2, 1);

        var TimeDelay1 = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed1), Step1) + 400;

        var TimeDelay2 = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed2), Step2) + 400;

        var TimeDelay = TimeDelay1;

        if (TimeDelay2 > TimeDelay1)
            TimeDelay = TimeDelay2;

        this._peripheral.send(OutPutData);

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this._peripheral.inAction = false;
                clearInterval(repeat);
                resolve();
            }, TimeDelay);
        });
    }

    motorChoice(args){
        if(args.CUBE == WORMBOTCubes.ONE){
          this.motor1(args);
        }
        if(args.CUBE == WORMBOTCubes.TWO){
          this.motor2(args);
          console.log("args.CUBE  " + args.CUBE);
        }
        if(args.CUBE == WORMBOTCubes.ALL){
          this.motorallInOne(args);
        }
        // branch function mode selection, pending
        return new Promise(resolve => {
            setInterval(() => {
                this._peripheral.inAction = false;
                resolve();
                console.log("TimeDelay  " + TimeDelay);
            }, TimeDelay);
        });
      }
  
      motor1(args) {
        if (this._peripheral.AllConnected == false)
            return;

        if (this._peripheral.sendScheduledData == false)
            return;

        if (this._peripheral.inAction == true)
            return;

        this._peripheral.inAction = true;

        var Speed = 800;
  
          if (args.LODIRECT == PingPongWormBotLoDirect.L) {
              Speed *= -1;
          }
  
          var Step = Math.round(args.RADIUS * 5.5);
  
          console.log(Speed + Step + " " + args.RADIUS + " " + args.RADIUS);
  
          var OutPutData = PingPongUtil.makeSingleDataByStep(0, 0, Speed, Step);
          OutPutData[12] = 2; // make resume
  
          console.log("OutputData  " + OutPutData);
  
          TimeDelay = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed), Step) + 200
          console.log("TimeDelay  " + TimeDelay);
  
          this._peripheral.send(OutPutData);
  
      }
  
      motor2(args) {
        if (this._peripheral.AllConnected == false)
            return;

        if (this._peripheral.sendScheduledData == false)
            return;

        if (this._peripheral.inAction == true)
            return;

        this._peripheral.inAction = true;

        var Speed = 800;
  
          if (args.LODIRECT == PingPongWormBotLoDirect.L) {
              Speed *= -1;
          }
  
          var Step = Math.round(args.RADIUS * 5.5);
  
          var OutPutData = PingPongUtil.makeSingleDataByStep(1, 0, Speed, Step);
          OutPutData[12] = 2; // make resume
          console.log("OutputData  " + OutPutData);
  
          TimeDelay = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed), Step) + 200;
          console.log("TimeDelay  " + TimeDelay);
  
          this._peripheral.send(OutPutData);
      }
  
/*
    motorChoice(args){
        if(args.CUBE == WORMBOTCubes.ONE){
          this.motor1(args);
        }
        if(args.CUBE == WORMBOTCubes.TWO){
          this.motor2(args);
        }
        if(args.CUBE == WORMBOTCubes.ALL){
          this.motorallInOne(args);
        }
        // branch function mode selection, pending
        return new Promise(resolve => {
            setInterval(() => {
                this.inActionC1C2 = false;
                resolve();
                console.log("TimeDelay  " + TimeDelay);
            }, TimeDelay);
        });
      }

    motor1(args) {
        if (this._peripheral.AllConnected == false)
            return;

        if (this._peripheral.sendScheduledData == false)
            return;

        if (this._peripheral.inAction == true)
            return;

        this._peripheral.inAction = true;

        var Speed = 800;

        if (args.LODIRECT == PingPongWormBotLoDirect.L) {
            Speed *= -1;
        }

        var Step = Math.round(args.RADIUS * 5.5);

        console.log(Speed + Step + " " + args.RADIUS + " " + args.RADIUS);

        var OutPutData = PingPongUtil.makeSingleDataByStep(0, 0, Speed, Step);
        OutPutData[12] = 2; // make resume

        var TimeDelay = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed), Step) + 200;

        this._peripheral.send(OutPutData);
    }

    motor2(args) {

        if (this._peripheral.AllConnected == false)
            return;

        if (this._peripheral.sendScheduledData == false)
            return;

        if (this._peripheral.inAction == true)
            return;

        this._peripheral.inAction = true;

        var Speed = 800;

        this.inActionC1C2 = true;

        if (args.LODIRECT == PingPongWormBotLoDirect.L) {
            Speed *= -1;
        }

        var Step = Math.round(args.RADIUS * 5.5);

        console.log(Speed + Step + " " + args.RADIUS + " " + args.RADIUS);

        var OutPutData = PingPongUtil.makeSingleDataByStep(1, 0, Speed, Step);
        OutPutData[12] = 2; // make resume

        var TimeDelay = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed), Step) + 200;

        this._peripheral.send(OutPutData);
    }
    */
}

module.exports = Scratch3PingPongWormBotBlocks;
