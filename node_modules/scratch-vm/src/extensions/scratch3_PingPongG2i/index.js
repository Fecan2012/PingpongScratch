const ArgumentType = require('../../extension-support/argument-type');
const BlockType = require('../../extension-support/block-type');
const log = require('../../util/log');
const cast = require('../../util/cast');
const formatMessage = require('format-message');
const BLE = require('../../io/blepingpong');
const MathUtil = require('../../util/math-util');
const Base64Util = require('../../util/base64-util');
const PingPongUtil = require('../../util/pingpong-util');
const blockIconURI = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAABQCAYAAACOEfKtAAAACXBIWXMAAC4jAAAuIwF4pT92AAAF+mlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxNDUgNzkuMTYzNDk5LCAyMDE4LzA4LzEzLTE2OjQwOjIyICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdEV2dD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlRXZlbnQjIiB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iIHhtbG5zOnBob3Rvc2hvcD0iaHR0cDovL25zLmFkb2JlLmNvbS9waG90b3Nob3AvMS4wLyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ0MgMjAxOSAoV2luZG93cykiIHhtcDpDcmVhdGVEYXRlPSIyMDE5LTA2LTA0VDEzOjU3OjM4KzA5OjAwIiB4bXA6TWV0YWRhdGFEYXRlPSIyMDE5LTA2LTA0VDEzOjU3OjM4KzA5OjAwIiB4bXA6TW9kaWZ5RGF0ZT0iMjAxOS0wNi0wNFQxMzo1NzozOCswOTowMCIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDpjYzdjODE3ZC1kNTAxLWYxNDQtOGU4My05ZTZiYjBmNWVjNjUiIHhtcE1NOkRvY3VtZW50SUQ9ImFkb2JlOmRvY2lkOnBob3Rvc2hvcDphMDU3YWY0ZC1jMjdlLWNlNDEtYTkwZi1mZmVjNGQyODZiMmQiIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDoyMTgyYjE4Mi00ZTdiLWRhNDEtOThlYS1iY2E4NjAxYTBlYjciIGRjOmZvcm1hdD0iaW1hZ2UvcG5nIiBwaG90b3Nob3A6Q29sb3JNb2RlPSIzIiBwaG90b3Nob3A6SUNDUHJvZmlsZT0ic1JHQiBJRUM2MTk2Ni0yLjEiPiA8eG1wTU06SGlzdG9yeT4gPHJkZjpTZXE+IDxyZGY6bGkgc3RFdnQ6YWN0aW9uPSJjcmVhdGVkIiBzdEV2dDppbnN0YW5jZUlEPSJ4bXAuaWlkOjIxODJiMTgyLTRlN2ItZGE0MS05OGVhLWJjYTg2MDFhMGViNyIgc3RFdnQ6d2hlbj0iMjAxOS0wNi0wNFQxMzo1NzozOCswOTowMCIgc3RFdnQ6c29mdHdhcmVBZ2VudD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTkgKFdpbmRvd3MpIi8+IDxyZGY6bGkgc3RFdnQ6YWN0aW9uPSJzYXZlZCIgc3RFdnQ6aW5zdGFuY2VJRD0ieG1wLmlpZDpjYzdjODE3ZC1kNTAxLWYxNDQtOGU4My05ZTZiYjBmNWVjNjUiIHN0RXZ0OndoZW49IjIwMTktMDYtMDRUMTM6NTc6MzgrMDk6MDAiIHN0RXZ0OnNvZnR3YXJlQWdlbnQ9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE5IChXaW5kb3dzKSIgc3RFdnQ6Y2hhbmdlZD0iLyIvPiA8L3JkZjpTZXE+IDwveG1wTU06SGlzdG9yeT4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6Ca0e+AAASkElEQVR4nO2da3hU1bnHf2vtPXuuyeQ2uYBEoKggWhGvLfWCWKpYWxSreKq1avV4FFu0UEVt1Xospdpiz0Faj9RLsbYHAatUfMAWsYpY5aCAWIRauQjkQpJJMjN7Lnvv1Q87CaHkNpMEgj3/58mXzMxe7/rPu9Z6b+sdEVs52AIkhwhSgj8kISAh6UBKUdfo8Pc9NrtqLGqiDg1NToefDXgFkUKNSIFk+CCNwRENn1+CXwBgNzokUwrEoZoNSge0fh1Bga6Br0AD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';
var GroupId="";
var TimeDelay= "";
try {
   GroupId = document.getElementById('isGroup').value == "false" ? "" : document.getElementById('groupId').value;
}catch(e){

}
const BLEUUID = {
    namePrefix: 'PINGPONG.'+ GroupId,
    service: '6e400001-b5a3-f393-e0a9-e50e24dcca9e',
    txChar: '6e400002-b5a3-f393-e0a9-e50e24dcca9e',
    rxChar: '6e400003-b5a3-f393-e0a9-e50e24dcca9e',
    groupID: GroupId
};
class PingPongG2i {

    constructor (runtime, extensionId) {
        this._runtime = runtime;

        this._ble = null;
        this._runtime.registerPeripheralExtension(extensionId, this);

        this._extensionId = extensionId;

        this.disconnect = this.disconnect.bind(this);
        this._onConnect = this._onConnect.bind(this);
        this._onMessage = this._onMessage.bind(this);

        this.connectCount = 2;

        this.AllConnected = false;

        this.receivedNotifyData = null;
        this.bContinueReceived = false;
        this.waitResponseOPCode = -1;

        this._sensors = {
            C1tiltX: 0,
            C1tiltY: 0,
            C1tiltZ: 0,
            C2tiltX: 0,
            C2tiltY: 0,
            C2tiltZ: 0,

            C1moveX: 0,
            C1moveY: 0,
            c1moveZ: 0,
            C2moveX: 0,
            C2moveY: 0,
            c2moveZ: 0,
            // 2019.12.20 fecan added
            C1ADval: 0,
            C2ADva2: 0
        };
        // 2019.12.23 fecan added
        this._tempo = {
            C1Tempo: 60,
            C2Tempo: 60
        };

        this._buttons = {
            C1Button: 0,
            C2Button: 0
        };

        this._proximity = {
            C1ProxOld: 0,
            C2ProxOld: 0,
            C1Prox: 0,
            C2Prox: 0,
            C1ProxInterVal: 0,
            C2ProxInterVal: 0
        };
    }

    scan() {
        if (this._ble) {
            this._ble.disconnect();
        }
        this._ble = new BLE(this._runtime, this._extensionId, {
            filters: [
                { namePrefix: BLEUUID.namePrefix , groupID: BLEUUID.groupID}
            ]
        }, this._onConnect, this.disconnect);
    }

    connect(id) {
        console.log("connect " + id);
        if (this._ble) {
            this._ble.connectPeripheral(id);
        }
    }

    disconnect() {
        if (this._ble) {
            this._ble.disconnect();
        }

        this.AllConnected = false;
    }

    isConnected() {
        let connected = false;
        if (this._ble) {
            connected = this._ble.isConnected();
        }

        if (connected == true)
            return this.AllConnected;

        this.AllConnected = false;
        return this.AllConnected;
    }

    send(message, force = false) {
        if (force == false)
            if (!this.isConnected()) return;

        const data = Base64Util.uint8ArrayToBase64(message);

        this._ble.write(BLEUUID.service, BLEUUID.txChar, data, 'base64', false).then(
            () => {
                console.log("send done to scratch links");
            }
        );
    }

    CheckProximityData(value)
    {
        var x1 = PingPongUtil.getSignedIntfromByteData(value[12]);
        var x2 = PingPongUtil.getSignedIntfromByteData(value[13]);
        var x3 = PingPongUtil.getSignedIntfromByteData(value[14]);
        var xx = PingPongUtil.getACCDataToDegreeMinus90To90fromByteData(value[15]);
        var yy = PingPongUtil.getACCDataToDegreeMinus90To90fromByteData(value[16]);
        yy *= -1;
        var zz = PingPongUtil.getACCDataToDegreeMinus90To90fromByteData(value[17]);
         // 2019.12.20 Fecan Added
        var ad = PingPongUtil.getUnsignedIntfromByteData(value[19]);

        if (value[3] == 0) {
            console.log("cube1 Detect " + value[3]);

            this._sensors.C1moveX = x1;
            this._sensors.C1moveY = x2;
            this._sensors.C1moveZ = x3;

            this._sensors.C1tiltX = xx;
            this._sensors.C1tiltY = yy;
            this._sensors.C1tiltZ = zz;
            this._sensors.C1ADval = ad;

            this._buttons.C1Button = value[11];           
            this._proximity.C1Prox = PingPongUtil.getUnsignedIntfromByteData(value[18]);
            this._proximity.C1ProxInterVal = this._proximity.C1Prox - this._proximity.C1ProxOld;
            this._proximity.C1ProxOld = this._proximity.C1Prox;
        }

        if (value[3] == 1) {
            console.log("cube2 Detect " + value[3]);

            this._sensors.C2moveX = x1;
            this._sensors.C2moveY = x2;
            this._sensors.C2moveZ = x3;

            this._sensors.C2tiltX = xx;
            this._sensors.C2tiltY = yy;
            this._sensors.C2tiltZ = zz;
            this._sensors.C2ADval = ad;

            this._buttons.C2Button = value[11];
            this._proximity.C2Prox = PingPongUtil.getUnsignedIntfromByteData(value[18]);
            this._proximity.C2ProxInterVal = this._proximity.C2Prox - this._proximity.C2ProxOld;
            this._proximity.C2ProxOld = this._proximity.C2Prox;
        }
    }

    NotificationEventFC(value) {
        if (value == null)
            return;
        
        // check and rule policy
        if (value.byteLength == 18) {
            if (value[6] == 0xad || value[6] == 0xae) {
                if (value[11] == 0x01) {
                    this.AllConnected = true;
                    this._runtime.emit(this._runtime.constructor.PERIPHERAL_CONNECTED);

                    window.setTimeout(() => {
                        if (this._ble) {
                            this.send(PingPongUtil.getSensorsData(0xff, 30));
                        }
                    }, 3000);
                }
            }
        }

        // check
        if (value.byteLength == 19 || value.byteLength == 20) {
            if (value[6] == 0xb8 && value[5] == 0xc8) {
                if (value[8] == 0x13 || value[8] == 0x14) {
                    this.CheckProximityData(value);
                }
            }
        }
    }

    _onConnect() {
        this._ble.startNotifications(BLEUUID.service, BLEUUID.rxChar, this._onMessage);

        window.setTimeout(() => {
            this.send(PingPongUtil.getSetMultiroleInAction(this.connectCount), true);
        }, 1000);
    }

    _onMessage(base64) {
        const datas = Base64Util.base64ToUint8Array(base64);

        PingPongUtil.printUint8ArrayToHex(datas, "Notification Data");
        this.NotificationEventFC(datas);
    }

    setWaitResponseOPCode(nCode, nTimeOut) {
        if (this.waitResponseOPCode != -1)
            return;
        if (this.waitResponseOPCodetimeoutID != null) {
            console.log("will cancel timer");
            window.clearTimeout(this.waitResponseOPCodetimeoutID);
            this.waitResponseOPCodetimeoutID = null;
        }
        this.waitResponseOPCode = nCode;
        console.log("set opcode");
        this.waitResponseOPCodetimeoutID = window.setTimeout(() => {
            console.log("timer called will clear opcode");
            this.waitResponseOPCode = -1;
            this.waitResponseOPCodetimeoutID = null;
        }, nTimeOut);
    }
}
const simple_act_degreeradius = {
    degree10: '10',
    degree20: '20',
    degree30: '30',
    degree40: '40',
    degree50: '50',
    degree60: '60',
    degree70: '70',
    degree80: '80',
    degree90: '90',
    degree100: '100',
    degree110: '110',
    degree120: '120',
    degree130: '130',
    degree140: '140',
    degree150: '150',
    degree160: '160',
    degree170: '170',
    degree180: '180',
    degree190: '190',
    degree200: '200',
    degree210: '210',
    degree220: '220',
    degree230: '230',
    degree240: '240',
    degree250: '250',
    degree260: '260',
    degree270: '270',
    degree280: '280',
    degree290: '290',
    degree300: '300',
    degree310: '310',
    degree320: '320',
    degree330: '330',
    degree340: '340',
    degree350: '350',
    degree360: '360'
};
const continuous_act_speed = {
    speedI100: '-100',
    speedI90: '-90',
    speedI80: '-80',
    speedI70: '-70',
    speedI60: '-60',
    speedI50: '-50',
    speedI40: '-40',
    speedI30: '-30',
    speedI20: '-20',
    speedI10: '-10',
    speed0: '0',
    speed10: '10',
    speed20: '20',
    speed30: '30',
    speed40: '40',
    speed50: '50',
    speed60: '60',
    speed70: '70',
    speed80: '80',
    speed90: '90',
    speed100: '100'
};

const led_turn_onoff = {
    off: '0',
    on: '1'
};
/*
const matrix_pixel_position = {
    position0: '0',
    position1: '1',
    position2: '2',
    position3: '3',
    position4: '4',
    position5: '5',
    position6: '6',
    position7: '7'
};
*/
const play_note_beats = {
    note45: '45',
    note46: '46',
    note47: '47',
    note48: '48',
    note49: '49',
    note50: '50',
    note51: '51',
    note52: '52',
    note53: '53',
    note54: '54',
    note55: '55',
    note56: '56',
    note57: '57',
    note58: '58',
    note59: '59',
    note60: '60',
    note61: '61',
    note62: '62',
    note63: '63',
    note64: '64',
    note65: '65',
    note66: '66',
    note67: '67',
    note68: '68',
    note69: '69',
    note70: '70',
    note71: '71',
    note72: '72'
};

const PingPongG2iCubes = {
    ONE: '1',
    TWO: '2',
    ALL:'ALL'
};

const PingPongG2IButtons = {
    A: 'a',
    B: 'b',
    ANY: 'any'
};

const PingPongG2ILoDirect = {
    L: 'left',
    R: 'right',
};

const PingPongG2ITiltDirection = {
    FRONT: 'front',
    BACK: 'back',
    LEFT: 'left',
    RIGHT: 'right'
};

const PingPongG2IMoveDirection = {
    LEFT: 'left',
    RIGHT: 'right'
};

const PingPongG2IUpperDirection = {
    FRONT: 'front',
    BACK: 'back',
    LEFT: 'left',
    RIGHT: 'right',
    UP: 'up',
    DOWN: 'down'
};

const PingPongG2ISensorType = {
    ADSENSOR: 'adsensor',
    PROXIMITYS: 'proximity'
}


class Scratch3PingPongG2iBlocks {
   static get EXTENSION_NAME () {
        return 'PingPong G2i';
    }

    static get EXTENSION_ID () {
        return 'PingPongG2i';
    }

    static get TILT_THRESHOLD() {
        return 20;
    }

    static get MOVE_THRESHOLD() {
        return 30;
    }

    get UP_DOWN_CONTINUOUS() {
        return [
            {
                text: '-100',
                value: continuous_act_speed.speedI100
            },
            {
                text: '-80',
                value: continuous_act_speed.speedI80
            },
            {
                text: '-60',
                value: continuous_act_speed.speedI60
            },
            {
                text: '-40',
                value: continuous_act_speed.speedI40
            },
            {
                text: '-20',
                value: continuous_act_speed.speedI20
            },
            {
                text: '0',
                value: continuous_act_speed.speed0
            },
            {
                text: '20',
                value: continuous_act_speed.speed20
            },
            {
                text: '40',
                value: continuous_act_speed.speed40
            },
            {
                text: '60',
                value: continuous_act_speed.speed60
            },
            {
                text: '80',
                value: continuous_act_speed.speed80
            },
            {
                text: '100',
                value: continuous_act_speed.speed100
            }
        ];
    }

    get DEGREERADIUSALL() {
        return [
            {
                text: '10',
                value: simple_act_degreeradius.degree10
            },
            {
                text: '20',
                value: simple_act_degreeradius.degree20
            },
            {
                text: '30',
                value: simple_act_degreeradius.degree30
            },
            {
                text: '40',
                value: simple_act_degreeradius.degree40
            },
            {
                text: '50',
                value: simple_act_degreeradius.degree50
            },
            {
                text: '60',
                value: simple_act_degreeradius.degree60
            },
            {
                text: '70',
                value: simple_act_degreeradius.degree70
            },
            {
                text: '80',
                value: simple_act_degreeradius.degree80
            },
            {
                text: '90',
                value: simple_act_degreeradius.degree90
            },
            {
                text: '100',
                value: simple_act_degreeradius.degree100
            },
            {
                text: '110',
                value: simple_act_degreeradius.degree110
            },
            {
                text: '120',
                value: simple_act_degreeradius.degree120
            },
            {
                text: '130',
                value: simple_act_degreeradius.degree130
            },
            {
                text: '140',
                value: simple_act_degreeradius.degree140
            },
            {
                text: '150',
                value: simple_act_degreeradius.degree150
            },
            {
                text: '160',
                value: simple_act_degreeradius.degree160
            },
            {
                text: '170',
                value: simple_act_degreeradius.degree170
            },
            {
                text: '180',
                value: simple_act_degreeradius.degree180
            },
            {
                text: '190',
                value: simple_act_degreeradius.degree190
            },
            {
                text: '200',
                value: simple_act_degreeradius.degree200
            },
            {
                text: '210',
                value: simple_act_degreeradius.degree210
            },
            {
                text: '220',
                value: simple_act_degreeradius.degree220
            },
            {
                text: '230',
                value: simple_act_degreeradius.degree230
            },
            {
                text: '240',
                value: simple_act_degreeradius.degree240
            },
            {
                text: '250',
                value: simple_act_degreeradius.degree250
            },
            {
                text: '260',
                value: simple_act_degreeradius.degree260
            },
            {
                text: '270',
                value: simple_act_degreeradius.degree270
            },
            {
                text: '280',
                value: simple_act_degreeradius.degree280
            },
            {
                text: '290',
                value: simple_act_degreeradius.degree290
            },
            {
                text: '300',
                value: simple_act_degreeradius.degree300
            },
            {
                text: '310',
                value: simple_act_degreeradius.degree310
            },
            {
                text: '320',
                value: simple_act_degreeradius.degree320
            },
            {
                text: '330',
                value: simple_act_degreeradius.degree330
            },
            {
                text: '340',
                value: simple_act_degreeradius.degree340
            },
            {
                text: '350',
                value: simple_act_degreeradius.degree350
            },
            {
                text: '360',
                value: simple_act_degreeradius.degree360
            }
        ];
    }
    // fecan 2019.12.26 ADDED
    get TURN_ON_OFF() {
        return [
            {
                text: formatMessage({
                    id: 'pingpongg1i.led_turn_onoff.on',
                    default: 'on',
                    description: 'Turn on option for the matrix'
                }),
                value:  led_turn_onoff.on
            },
            {
                text: formatMessage({
                    id: 'pingpongg1i.led_turn_onoff.off',
                    default: 'off',
                    description: 'Turn off option for the matrix'
                }),
                value: led_turn_onoff.off
            }
        ];
    }
/*
    get PIXELPOSITION() {
        return [
            {
                text: '0',
                value: matrix_pixel_position.postion0
            },
            {
                text: '1',
                value: matrix_pixel_position.postion1
            },
            {
                text: '2',
                value: matrix_pixel_position.postion2
            },
            {
                text: '3',
                value: matrix_pixel_position.postion3
            },
            {
                text: '4',
                value: matrix_pixel_position.postion4
            },
            {
                text: '5',
                value: matrix_pixel_position.postion5
            },
            {
                text: '6',
                value: matrix_pixel_position.postion6
            },
            {
                text: '7',
                value: matrix_pixel_position.postion7
            }
        ];
    }
*/
    get PLAY_MUSIC_BEATS() {
        return [
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.45',
                    default: 'note45',
                    description: 'Play note 45 for duration'
                }),
                value:  play_note_beats.note45
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.46',
                    default: 'note46',
                    description: 'Play note 46 for duration'
                }),
                value:  play_note_beats.note46
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.47',
                    default: 'note47',
                    description: 'Play note 47 for duration'
                }),
                value:  play_note_beats.note47
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.48',
                    default: 'note48',
                    description: 'Play note 48 for duration'
                }),
                value:  play_note_beats.note48
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.49',
                    default: 'note49',
                    description: 'Play note 49 for duration'
                }),
                value:  play_note_beats.note49
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.50',
                    default: 'note50',
                    description: 'Play note 50 for duration'
                }),
                value:  play_note_beats.note50
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.51',
                    default: 'note51',
                    description: 'Play note 51 for duration'
                }),
                value:  play_note_beats.note51
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.52',
                    default: 'note52',
                    description: 'Play note 52 for duration'
                }),
                value:  play_note_beats.note52
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.53',
                    default: 'note53',
                    description: 'Play note 53 for duration'
                }),
                value:  play_note_beats.note53
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.54',
                    default: 'note54',
                    description: 'Play note 54 for duration'
                }),
                value:  play_note_beats.note54
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.55',
                    default: 'note55',
                    description: 'Play note 55 for duration'
                }),
                value:  play_note_beats.note55
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.56',
                    default: 'note56',
                    description: 'Play note 56 for duration'
                }),
                value:  play_note_beats.note56
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.57',
                    default: 'note57',
                    description: 'Play note 57 for duration'
                }),
                value:  play_note_beats.note57
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.58',
                    default: 'note58',
                    description: 'Play note 58 for duration'
                }),
                value:  play_note_beats.note58
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.59',
                    default: 'note59',
                    description: 'Play note 59 for duration'
                }),
                value:  play_note_beats.note59
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.60',
                    default: 'note60',
                    description: 'Play note 60 for duration'
                }),
                value:  play_note_beats.note60
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.61',
                    default: 'note61',
                    description: 'Play note 61 for duration'
                }),
                value:  play_note_beats.note61
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.62',
                    default: 'note62',
                    description: 'Play note 62 for duration'
                }),
                value:  play_note_beats.note62
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.63',
                    default: 'note63',
                    description: 'Play note 63 for duration'
                }),
                value:  play_note_beats.note63
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.64',
                    default: 'note64',
                    description: 'Play note 64 for duration'
                }),
                value:  play_note_beats.note64
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.65',
                    default: 'note65',
                    description: 'Play note 65 for duration'
                }),
                value:  play_note_beats.note65
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.66',
                    default: 'note66',
                    description: 'Play note 66 for duration'
                }),
                value:  play_note_beats.note66
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.67',
                    default: 'note67',
                    description: 'Play note 67 for duration'
                }),
                value:  play_note_beats.note67
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.68',
                    default: 'note68',
                    description: 'Play note 68 for duration'
                }),
                value:  play_note_beats.note68
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.69',
                    default: 'note69',
                    description: 'Play note 69 for duration'
                }),
                value:  play_note_beats.note69
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.70',
                    default: 'note70',
                    description: 'Play note 70 for duration'
                }),
                value:  play_note_beats.note70
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.71',
                    default: 'note71',
                    description: 'Play note 71 for duration'
                }),
                value:  play_note_beats.note71
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.72',
                    default: 'note72',
                    description: 'Play note 72 for duration'
                }),
                value:  play_note_beats.note72
            }
        ];
    }

    //rozen 11.07 add
    get CUBE(){
      return [
          {   text: formatMessage({
              id: 'pingpong.ONE',
              default: PingPongG2iCubes.ONE,
              description: '1'
              }),
              value: PingPongG2iCubes.ONE
          },
          {
            text: formatMessage({
                id: 'pingpong.TWO',
                default: PingPongG2iCubes.TWO,
                description: '2'
                }),
                value: PingPongG2iCubes.TWO
          }
      ];
    }

    get CUBES(){
      return [
          {   text: formatMessage({
              id: 'pingpong.ONE',
              default: PingPongG2iCubes.ONE,
              description: '1'
              }),
              value: PingPongG2iCubes.ONE
          },
          {
            text: formatMessage({
                id: 'pingpong.TWO',
                default: PingPongG2iCubes.TWO,
                description: '2'
                }),
                value: PingPongG2iCubes.TWO
          },
          {
            text: formatMessage({
                id: 'pingpong.ALL',
                default: PingPongG2iCubes.ALL,
                description: 'all'
                }),
                value: PingPongG2iCubes.ALL
          }
      ];
    }

    get SENSOR(){
        return [
            {   text: formatMessage({
                id: 'pingpongSensor.ADS',
                default: PingPongG2ISensorType.ADSENSOR,
                description: 'adsensor'
                }),
                value: PingPongG2ISensorType.ADSENSOR
            },
            {
              text: formatMessage({
                  id: 'pingpongSensor.PROX',
                  default: PingPongG2ISensorType.PROXIMITYS,
                  description: 'Proximity'
                  }),
                  value: PingPongG2ISensorType.PROXIMITYS
            }
        ];
    }

    get BUTTONS_MENU() {
        return [
            {
                text: '1',
                value: PingPongG2IButtons.A
            },
            {
                text: '2',
                value: PingPongG2IButtons.B
            }
        ];
    }

    get LODIRECT_MENU() {
        return [
            {
                text: formatMessage({
                    id: 'pingpongwormbot.PingPongWormBotLoDirect.R',
                    default: 'clockwise',
                    description: 'lotate clock'
                }),
                value: PingPongG2ILoDirect.R
            },
            {
                text: formatMessage({
                    id: 'pingpongwormbot.PingPongWormBotLoDirect.L',
                    default: 'counterclockwise',
                    description: 'lotate counter clock'
                }),
                value: PingPongG2ILoDirect.L
            }
        ];
    }

    get GESTURES_MENU() {
        return [
            {
                text: 'A',
                value: PingPongG2IButtons.A
            },
            {
                text: 'B',
                value: PingPongG2IButtons.B
            }
        ];
    }

    get SENSOR_MENU() {
        return [
            {
                text: 'A',
                value: PingPongG2IButtons.A
            },
            {
                text: 'B',
                value: PingPongG2IButtons.B
            }
        ];
    }

    get UPPER_DIRECTION_MENU() {
        return [
            {
                text: formatMessage({
                    id: 'pingpongg1i.upperDirectionMenu.front',
                    default: 'rectangle',
                    description: 'label for front element in upper direction'
                }),
                value: PingPongG2IUpperDirection.FRONT
            },
            {
                text: formatMessage({
                    id: 'pingpongg1i.upperDirectionMenu.back',
                    default: 'star',
                    description: 'label for front element in upper direction'
                }),
                value: PingPongG2IUpperDirection.BACK
            },
            {
                text: formatMessage({
                    id: 'pingpongg1i.upperDirectionMenu.left',
                    default: 'triangle',
                    description: 'label for front element in upper direction'
                }),
                value: PingPongG2IUpperDirection.LEFT
            },
            {
                text: formatMessage({
                    id: 'pingpongg1i.upperDirectionMenu.right',
                    default: 'circle',
                    description: 'label for front element in upper direction'
                }),
                value: PingPongG2IUpperDirection.RIGHT
            },
            {
                text: formatMessage({
                    id: 'pingpongg1i.upperDirectionMenu.up',
                    default: 'heart',
                    description: 'label for front element in upper direction'
                }),
                value: PingPongG2IUpperDirection.UP
            },
            {
                text: formatMessage({
                    id: 'pingpongg1i.upperDirectionMenu.down',
                    default: 'none',
                    description: 'label for front element in upper direction'
                }),
                value: PingPongG2IUpperDirection.DOWN
            }
        ];
    }

    get TILT_DIRECTION_MENU() {
        return [
            {
                text: formatMessage({
                    id: 'pingpongg2i.tiltDirectionMenu.front',
                    default: 'circle',
                    description: 'label for element in tilt direction'
                }),
                value: PingPongG2ITiltDirection.FRONT
            },
            {
                text: formatMessage({
                    id: 'pingpongg2i.tiltDirectionMenu.back',
                    default: 'triangle',
                    description: 'label for element in tilt direction'
                }),
                value: PingPongG2ITiltDirection.BACK
            },
            {
                text: formatMessage({
                    id: 'pingpongg2i.tiltDirectionMenu.left',
                    default: 'rectangle',
                    description: 'label for element in tilt direction'
                }),
                value: PingPongG2ITiltDirection.LEFT
            },
            {
                text: formatMessage({
                    id: 'pingpongg2i.tiltDirectionMenu.right',
                    default: 'star',
                    description: 'label for element in tilt direction'
                }),
                value: PingPongG2ITiltDirection.RIGHT
            }
        ];
    }

    get MOVE_DIRECTION_MENU() {
        return [
            {
                text: formatMessage({
                    id: 'PingPongAutoCar.simple_act_direction.left',
                    default: 'left',
                    description: 'label for front element in move direction'
                }),
                value: PingPongG2IMoveDirection.LEFT
            },
            {
                text: formatMessage({
                    id: 'PingPongAutoCar.simple_act_direction.right',
                    default: 'right',
                    description: 'label for front element in move direction'
                }),
                value: PingPongG2IMoveDirection.RIGHT
            }
        ];
    }

    static get BEAT_RANGE () {
        return {min: 0, max: 40};
    }

    static get TEMPO_RANGE () {
        return {min: 20, max: 500};
    }

    constructor(runtime) {
        /**
         * The Scratch 3.0 runtime.
         * @type {Runtime}
         */
        this.runtime = runtime;

        // Create a new PingPongG2i peripheral instance
        this._peripheral = new PingPongG2i(this.runtime, Scratch3PingPongG2iBlocks.EXTENSION_ID);

        this.inActionC1C2 = false;
    }

    /**
     * @returns {object} metadata for this extension and its blocks.
     */
    getInfo() {
        return {
            id: Scratch3PingPongG2iBlocks.EXTENSION_ID,
            name: Scratch3PingPongG2iBlocks.EXTENSION_NAME,
            blockIconURI: blockIconURI,
            showStatusButton: true,
            blocks: [
                {
                    opcode: 'whenButtonPressed',
                    text: formatMessage({
                        id: 'pingpongg2i.whenButtonPressed',
                        default: 'button [BTN] pressed',
                        description: 'when the selected button on the cube is pressed'
                    }),
                    blockType: BlockType.HAT,
                    arguments: {
                        BTN: {
                            type: ArgumentType.STRING,
                            menu: 'buttons',
                            defaultValue: PingPongG2IButtons.A
                        }
                    }
                },
                {
                    opcode: 'whenTilted',
                    text: formatMessage({
                        id: 'pingpongg2i.whenTilted',
                        default: 'cube [BTN] tilted to [DIRECTION]',
                        description: 'the cube is tilted in a direction'
                    }),
                    blockType: BlockType.HAT,
                    arguments: {
                        BTN: {
                            type: ArgumentType.STRING,
                            menu: 'buttons',
                            defaultValue: PingPongG2IButtons.A
                        },
                        DIRECTION: {
                            type: ArgumentType.STRING,
                            menu: 'tiltDirection',
                            defaultValue: PingPongG2ITiltDirection.FRONT
                        }
                    }
                },
                {
                    opcode: 'whenMoved',
                    text: formatMessage({
                        id: 'pingpongg2i.whenMoved',
                        default: 'when cube [BTN] moved to [DIRECTIONM]',
                        description: 'is the cube is moved in a direction?'
                    }),
                    blockType: BlockType.HAT,
                    arguments: {
                        BTN: {
                            type: ArgumentType.STRING,
                            menu: 'buttons',
                            defaultValue: PingPongG2IButtons.A
                        },
                        DIRECTIONM: {
                            type: ArgumentType.STRING,
                            menu: 'moveDirection',
                            defaultValue: PingPongG2IMoveDirection.LEFT
                        }
                    }
                },
                {
                    opcode: 'motorall',
                    text: formatMessage({
                        id: 'pingpongg2i.motorall',
                        default: 'rotate motor1: [RADIUS1] degrees [LODIRECT1] motor2: [RADIUS2] degrees [LODIRECT2]',
                        description: 'is tilted in a direction?'
                    }),
                    arguments: {
                        LODIRECT1: {
                            type: ArgumentType.STRING,
                            menu: 'lodirect',
                            defaultValue: PingPongG2ILoDirect.R
                        },
                        LODIRECT2: {
                            type: ArgumentType.STRING,
                            menu: 'lodirect',
                            defaultValue: PingPongG2ILoDirect.R
                        },
                        RADIUS1: {
                            type: ArgumentType.STRING,
                            defaultValue: simple_act_degreeradius.degree90
                        },
                        RADIUS2: {
                            type: ArgumentType.STRING,
                            defaultValue: simple_act_degreeradius.degree90
                        }
                    }
                },
                {
                    opcode: 'motorChoice',
                    text: formatMessage({
                        id: 'pingpongg2i.motorChoice',
                        default: 'rotate motor[CUBE]: [RADIUS] degrees [LODIRECT]',
                        description: 'rotate'
                    }),
                    arguments: {
                        CUBE:{
                          type: ArgumentType.STRING,
                          menu: 'cubes',
                          defaultValue: PingPongG2iCubes.ONE
                        },
                        LODIRECT: {
                            type: ArgumentType.STRING,
                            menu: 'lodirect',
                            defaultValue: PingPongG2ILoDirect.R
                        },
                        RADIUS: {
                            type: ArgumentType.STRING,
                            defaultValue: simple_act_degreeradius.degree90
                        }
                    }
                },
                {
                    opcode: 'updownactC',
                    text: formatMessage({
                        id: 'pingpongg2i.updownactC',
                        default: 'set velocity to CUBE1: [SPEED1] CUBE2: [SPEED2]',
                        description: 'fldgo002'
                    }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                        SPEED1: {
                            type: ArgumentType.STRING,
                            menu: 'updowncontinuous',
                            defaultValue: continuous_act_speed.speed100
                        },
                        SPEED2: {
                            type: ArgumentType.STRING,
                            menu: 'updowncontinuous',
                            defaultValue: continuous_act_speed.speed100
                        },
                    }
                },
                {
                    opcode: 'updownactCLA',
                    text: formatMessage({
                        id: 'pingpongg2i.updownactCLA',
                        default: 'set velocity to CUBE [CUBE]: [SPEED1]',
                        description: 'fldgo002'
                    }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                        CUBE: {
                          type: ArgumentType.STRING,
                          menu: 'cubes',
                          defaultValue: PingPongG2iCubes.ONE
                        },
                        SPEED1: {
                            type: ArgumentType.STRING,
                            menu: 'updowncontinuous',
                            defaultValue: continuous_act_speed.speed100
                        }
                    }
                },
                {
                  //rozen 11.07 ADD
                    opcode: 'stopMotors',
                    text: formatMessage({
                        id: 'pingpongautocar.allStop',
                        default: 'CUBE [CUBE] stop',
                        description: 'fldgo002'
                    }),
                    blockType: BlockType.COMMAND,
                    arguments:{
                      CUBE: {
                        type: ArgumentType.STRING,
                        menu: 'cubes',
                        defaultValue: PingPongG2iCubes.ONE
                      }
                    }
                },
                // fecan 2019.12.22 ADDED
                {
                    opcode: 'turnonoffLedMatrixPixelEach',
                    text: formatMessage({
                        id: 'pingpongg2i.turnonoffPixelEach',
                        default: 'Led [TURNONOFF] CUBE [CUBE]  x: [COORDX] y: [COORDY]',
                        description: 'display a pixel for each cube'
                   }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                       TURNONOFF: {
                            type: ArgumentType.STRING,
                            menu: 'turnonoffpixels',
                            defaultValue: led_turn_onoff.on
                       }, 
                       CUBE: {
                            type: ArgumentType.STRING,
                            defaultValue: PingPongG2iCubes.ONE
                        },
                       COORDX: {
                            type: ArgumentType.NUMBER,
                            defaultValue: 0
                        },
                       COORDY: {
                             type: ArgumentType.NUMBER,
                             defaultValue: 0
                       }
                    }
                },
                {
                    opcode: 'displayLedMatrixStringDurationEach',
                    text: formatMessage({
                        id: 'pingpongg2i.displayStringDurationEach',
                        default: 'display text CUBE [CUBE]  [MSTRING] for  [MSECOND] second',
                        description: 'display string with duration value'
                   }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                      CUBE: {
                            type: ArgumentType.STRING,
                            defaultValue: PingPongG2iCubes.ONE
                      },
                      MSTRING: {
                           type: ArgumentType.STRING,
                           defaultValue: "Hello!"
                       },
                      MSECOND: {
                          type: ArgumentType.STRING,
                          defaultValue: "1"
                    }
                    }
                 },
                {
                    opcode: 'clearMatrixPixelsEach',
                    text: formatMessage({
                        id: 'pingpongg2i.clearPixelsEach',
                        default: 'clear CUBE [CUBE] display',
                        description: 'clear pixels'
                   }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                        CUBE: {
                              type: ArgumentType.STRING,
                              defaultValue: PingPongG2iCubes.ONE
                        }
                      }
                },
                {
                    opcode: 'setServoDegreeEach',
                    text: formatMessage({
                        id: 'pingpongg2i.setServoDegreeEach',
                        default: 'cube [CUBE]  servo motor angle  [SERVODEGREE]',
                        description: 'set servo degree'
                   }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                        CUBE: {
                            type: ArgumentType.STRING,
                            menu: "cube",
                            defaultValue: PingPongG2iCubes.ONE
                        },
                        SERVODEGREE: {
                             type: ArgumentType.STRING,
                             defaultValue: "0"
                         }
                    }
                },
                {
                    opcode: 'playNoteForBeatsEach',
                    text: formatMessage({
                        id: 'pingpongg2i.playNoteForBeatsEach',
                        default: 'cube [CUBE]  play note [NOTE] for [BEATS] beats',
                        description: 'play a note for a number of beats'
                    }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                        CUBE: {
                            type: ArgumentType.STRING,
                            menu: "cube",
                            defaultValue: PingPongG2iCubes.ONE
                        },
                        NOTE: {
                            type: ArgumentType.STRING,
                            menu: 'playmusicbeats',
                            defaultValue: play_note_beats.note48
                        },
                        BEATS: {
                            type: ArgumentType.STRING,
                            defaultValue: "1"
                        }
                    }
                },
                {
                    opcode: 'restForBeatsEach',
                    text: formatMessage({
                        id: 'pingpongg2i.restForBeatsEach',
                        default: 'cube [CUBE]  rest for [BEATS] beats',
                        description: 'rest (play no sound) for a number of beats'
                    }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                        CUBE: {
                            type: ArgumentType.STRING,
                            menu: "cubes",
                            defaultValue: PingPongG2iCubes.ONE
                        },
                        BEATS: {
                            type: ArgumentType.STRING,
                            defaultValue: "0.5"
                        }
                    }
                },
                {
                    opcode: 'setTempoEach',
                    blockType: BlockType.COMMAND,
                    text: formatMessage({
                        id: 'pingpongg2i.setTempoEach',
                        default: 'cube [CUBE]  set tempo to [TEMPO]',
                        description: 'set tempo (speed) for notes, drums, and rests played'
                    }),
                    arguments: {
                        CUBE: {
                            type: ArgumentType.STRING,
                            menu: "cube",
                            defaultValue: PingPongG2iCubes.ONE
                        },
                        TEMPO: {
                            type: ArgumentType.STRING,
                            defaultValue: "60"
                        }
                    }
                },
                {
                    opcode: 'isButtonPressed',
                    text: formatMessage({
                        id: 'pingpongg2i.isButtonPressed',
                        default: 'button [BTN] pressed?',
                        description: 'is the button on the cube pressed?'
                    }),
                    blockType: BlockType.BOOLEAN,
                    arguments: {
                        BTN: {
                            type: ArgumentType.STRING,
                            menu: 'buttons',
                            defaultValue: PingPongG2IButtons.A
                        }
                    }
                },
                {
                    opcode: 'isTilted',
                    text: formatMessage({
                        id: 'pingpongg2i.isTilted',
                        default: 'cube [BTN] tilted to [DIRECTION]?',
                        description: 'is the cube is tilted in a direction?'
                    }),
                    blockType: BlockType.BOOLEAN,
                    arguments: {
                        BTN: {
                            type: ArgumentType.STRING,
                            menu: 'buttons',
                            defaultValue: PingPongG2IButtons.A
                        },
                        DIRECTION: {
                            type: ArgumentType.STRING,
                            menu: 'tiltDirection',
                            defaultValue: PingPongG2ITiltDirection.FRONT
                        }
                    }
                },
                {
                    opcode: 'isUpper',
                    text: formatMessage({
                        id: 'pingpongg2i.isUpper',
                        default: 'cube [BTN] [DIRECTION] shown in top view?',
                        description: 'is the cube is upper in a direction?'
                    }),
                    blockType: BlockType.BOOLEAN,
                    arguments: {
                        BTN: {
                            type: ArgumentType.STRING,
                            menu: 'buttons',
                            defaultValue: PingPongG2IButtons.A
                        },
                        DIRECTION: {
                            type: ArgumentType.STRING,
                            menu: 'upperDirection',
                            defaultValue: PingPongG2IUpperDirection.FRONT
                        }
                    }
                },
                {
                    opcode: 'getGyroSensor',
                    text: formatMessage({
                        id: 'pingpongg3i.getGyroSensor',
                        default: 'tilt angle of cube[CUBE] to [DIRECTION]',
                        description: 'the value returned by the distance sensor'
                    }),
                    blockType: BlockType.REPORTER,
                    arguments:{
                        CUBE:{
                            type: ArgumentType.STRING,
                            menu: "cube",
                            defaultValue: PingPongG2iCubes.ONE
                        },
                        DIRECTION:{
                          type: ArgumentType.STRING,
                          menu: 'tiltDirection',
                          defaultValue: PingPongG2ITiltDirection.FRONT
                        }
                    }
                },
                // 2019.12.20 Fecan Added
                {
                    opcode: 'getTempoEach',
                    text: formatMessage({
                        id: 'pingpongg2i.getTempoEach',
                        default: 'cube [CUBE]  tempo',
                        description: 'get the current tempo (speed) for notes, drums, and rests played'
                    }),
                    blockType: BlockType.REPORTER,
                    arguments: {
                        CUBE: {
                            type: ArgumentType.STRING,
                            menu: "cube",
                            defaultValue: PingPongG2iCubes.ONE
                        }
                    }
                },
                {
                    opcode: 'getADSensorValueEach',
                    text: formatMessage({
                        id: 'pingpongg2i.getADSensorValueEach',
                        default: 'value of [CUBE]cube [SENSOR] sensor',
                        description: 'the value returned by the each external sensor'
                    }),
                    blockType: BlockType.REPORTER,
                    arguments:{
                        CUBE: {
                            type: ArgumentType.STRING,
                            menu: 'cube',
                            defaultValue: PingPongG2iCubes.ONE
                        },
                        SENSOR:{
                            type: ArgumentType.STRING,
                            menu: "sensor",
                            defaultValue: PingPongG2ISensorType.PROXIMITYS
                        }
                    }               
                }
            ],
            menus: {
                upperDirection: this.UPPER_DIRECTION_MENU,
                tiltDirection: this.TILT_DIRECTION_MENU,
                moveDirection: this.MOVE_DIRECTION_MENU,
                cubes : this.CUBES,
                cube : this.CUBE,
                sensor : this.SENSOR,
                playmusicbeats: {
                    acceptReporters: true,
                    items: this.PLAY_MUSIC_BEATS
                },
                turnonoffpixels: {
                    acceptReporters: true,
                    items: this.TURN_ON_OFF,
                },
                buttons: this.BUTTONS_MENU,
                updowncontinuous: this.UP_DOWN_CONTINUOUS,
                lodirect: this.LODIRECT_MENU
//                gestures: this.GESTURES_MENU
            }
        };
    }

    updownactC(args) {

        console.log("updownActC " + args.SPEED1 + " " + args.SPEED2);

        if (this._peripheral.AllConnected == false)
            return;

        var ContinuousData = new Array(2);
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, args.SPEED1);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, args.SPEED2);
        var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(ContinuousData, 2, 0);

        this._peripheral.send(OutPutData);
        this._peripheral.setWaitResponseOPCode(0xcd, 400);

        /*
        return new Promise(resolve => {
            setInterval(() => {
                console.log('aaa');
                resolve();
            }, 400);
        });
        */
       return new Promise(resolve => {
        var repeat = setInterval(() => {
            this.inActionC1C2 = false;
            clearInterval(repeat);
            resolve();
            console.log("clearInterval ");
        }, 400);
    });
    }

    stopMotors(args) {
      if (this._peripheral.AllConnected == false)
          return;
          var ContinuousData = new Array(2);

      if(args.CUBE == PingPongG2iCubes.ALL){
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, 0);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, 0);
      }

      if(args.CUBE == PingPongG2iCubes.ONE){
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, 0);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, 1000);
        ContinuousData[1][6] = 0x00; // make dummy opcode
      }

      if(args.CUBE == PingPongG2iCubes.TWO){
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, 1000);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, 0);
        ContinuousData[0][6] = 0x00; // make dummy opcode
      }

      var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(ContinuousData, 2, 0);
      this._peripheral.send(OutPutData);
      this._peripheral.setWaitResponseOPCode(0xcd, 400);

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2 = false;
                clearInterval(repeat);
                resolve();
                console.log("clearInterval ");
            }, 400);
        });
    }

    updownactCLA(args) {
      if (this._peripheral.AllConnected == false)
          return;
      var ContinuousData = new Array(2);
      if(args.CUBE == PingPongG2iCubes.ALL){
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, args.SPEED1);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, args.SPEED1);
      }

      if(args.CUBE == PingPongG2iCubes.ONE){
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, args.SPEED1);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, args.SPEED1);
        ContinuousData[1][6] = 0x00; // make dummy opcode
      }

      if(args.CUBE == PingPongG2iCubes.TWO){
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, args.SPEED1);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, args.SPEED1);
        ContinuousData[0][6] = 0x00; // make dummy opcode
      }

      var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(ContinuousData, 2, 0);
      this._peripheral.send(OutPutData);
      this._peripheral.setWaitResponseOPCode(0xcd, 400);
      /*
      return new Promise(resolve => {
          setInterval(() => {
              resolve();
          }, 400);
      });
      */
        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2 = false;
                clearInterval(repeat);
                resolve();
                console.log("clearInterval ");
            }, 400);
        });
    }

    _isTiltedC1(direction) {
        return this._getTiltAngleC1(direction) >= Scratch3PingPongG2iBlocks.TILT_THRESHOLD;
    }

    _isTiltedC2(direction) {
        return this._getTiltAngleC2(direction) >= Scratch3PingPongG2iBlocks.TILT_THRESHOLD;
    }

    _isMovedC1(direction) {
        return this._getMoveC1(direction) >= Scratch3PingPongG2iBlocks.MOVE_THRESHOLD;
    }

    _isMovedC2(direction) {
        return this._getMoveC2(direction) >= Scratch3PingPongG2iBlocks.MOVE_THRESHOLD;
    }

    _getTiltAngle(direction) {
        switch (direction) {
            case PingPongG2ITiltDirection.FRONT:
                return Math.round(this._peripheral._sensors.C1tiltX * -1);
            case PingPongG2ITiltDirection.BACK:
                return Math.round(this._peripheral._sensors.C1tiltX);
            case PingPongG2ITiltDirection.LEFT:
                return Math.round(this._peripheral._sensors.C1tiltY * -1);
            case PingPongG2ITiltDirection.RIGHT:
                return Math.round(this._peripheral._sensors.C1tiltY);
            default:
                log.warn(`Unknown tilt direction in _getTiltAngle: ${direction}`);
        }
    }

    _getTiltAngleC1(direction) {
        switch (direction) {
            case PingPongG2ITiltDirection.FRONT:
                return Math.round(this._peripheral._sensors.C1tiltX * -1);
            case PingPongG2ITiltDirection.BACK:
                return Math.round(this._peripheral._sensors.C1tiltX);
            case PingPongG2ITiltDirection.LEFT:
                return Math.round(this._peripheral._sensors.C1tiltY * -1);
            case PingPongG2ITiltDirection.RIGHT:
                return Math.round(this._peripheral._sensors.C1tiltY);
            default:
                log.warn(`Unknown tilt direction in _getTiltAngle: ${direction}`);
        }
    }

    _getTiltAngleC2(direction) {
        switch (direction) {
            case PingPongG2ITiltDirection.FRONT:
                return Math.round(this._peripheral._sensors.C2tiltX * -1);
            case PingPongG2ITiltDirection.BACK:
                return Math.round(this._peripheral._sensors.C2tiltX);
            case PingPongG2ITiltDirection.LEFT:
                return Math.round(this._peripheral._sensors.C2tiltY * -1);
            case PingPongG2ITiltDirection.RIGHT:
                return Math.round(this._peripheral._sensors.C2tiltY);
            default:
                log.warn(`Unknown tilt direction in _getTiltAngle: ${direction}`);
        }
    }

    _getMoveC1(direction) {
        switch (direction) {
            case PingPongG2IMoveDirection.LEFT:
                return Math.round(this._peripheral._sensors.C1moveZ * -1);
            case PingPongG2IMoveDirection.RIGHT:
                return Math.round(this._peripheral._sensors.C1moveZ);
            default:
                log.warn(`Unknown tilt direction in _getTiltMove: ${direction}`);
        }
    }

    _getMoveC2(direction) {
        switch (direction) {
            case PingPongG2IMoveDirection.LEFT:
                return Math.round(this._peripheral._sensors.C2moveZ * -1);
            case PingPongG2IMoveDirection.RIGHT:
                return Math.round(this._peripheral._sensors.C2moveZ);
            default:
                log.warn(`Unknown tilt direction in _getTiltMove: ${direction}`);
        }
    }

    isTilted(args) {

        if (args.BTN === 'a') {
            return this._isTiltedC1(args.DIRECTION);
        } else if (args.BTN === 'b') {
            return this._isTiltedC2(args.DIRECTION);
        } else if (args.BTN === 'any') {

            if (this._isTiltedC1(args.DIRECTION) == true)
                return true;

            if (this._isTiltedC2(args.DIRECTION) == true)
                return true;
        }
        return false;
    }

    whenTilted(args) {

        if (args.BTN === 'a') {
            return this._isTiltedC1(args.DIRECTION);
        } else if (args.BTN === 'b') {
            return this._isTiltedC2(args.DIRECTION);
        } else if (args.BTN === 'any') {

            if (this._isTiltedC1(args.DIRECTION) == true)
                return true;

            if (this._isTiltedC2(args.DIRECTION) == true)
                return true;
        }
        return false;
    }

    whenMoved(args) {
        if (args.BTN === 'a') {
            return this._isMovedC1(args.DIRECTIONM);
        } else if (args.BTN === 'b') {
            return this._isMovedC2(args.DIRECTIONM);
        }

        return false;
    }

    motorall(args) {

        if (this._peripheral.AllConnected == false)
            return;

        if (this.inActionC1C2 == true)
            return;

        var Speed1 = 800;
        var Speed2 = 800;

        this.inActionC1C2 = true;

        if (args.LODIRECT1 == PingPongG2ILoDirect.L) {
            Speed1 *= -1;
        }

        if (args.LODIRECT2 == PingPongG2ILoDirect.L) {
            Speed2 *= -1;
        }

        var Step1 = Math.round(args.RADIUS1 * 5.5);
        var Step2 = Math.round(args.RADIUS2 * 5.5);

        console.log(Speed1 + Speed2 + " " + args.RADIUS1 + " " + args.RADIUS2);

        var SinglesData = new Array(2);
        SinglesData[0] = PingPongUtil.makeSingleDataByStep(0, 0, Speed1, Step1);
        SinglesData[1] = PingPongUtil.makeSingleDataByStep(1, 0, Speed2, Step2);
        SinglesData[0][12] = 2; // make resume
        SinglesData[1][12] = 2; // make resume

        var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(SinglesData, 2, 1);

        var TimeDelay1 = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed1), Step1) + 400;

        var TimeDelay2 = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed2), Step2) + 400;

        var TimeDelay = TimeDelay1;

        if (TimeDelay2 > TimeDelay1)
            TimeDelay = TimeDelay2;

        this._peripheral.send(OutPutData);
        /*
        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2 = false;
                clearInterval(repeat);
                resolve();
            }, TimeDelay);
        });
        */
       return new Promise(resolve => {
        var repeat = setInterval(() => {
            this.inActionC1C2 = false;
            clearInterval(repeat);
            resolve();
            console.log("clearInterval ");
        }, TimeDelay);
      });
    }

    motorallInOne(args) {
      if (this._peripheral.AllConnected == false)
          return;

      if (this.inActionC1C2 == true)
          return;

      var Speed1 = 800;
      var Speed2 = 800;

      this.inActionC1C2 = true;

      if (args.LODIRECT == PingPongG2ILoDirect.L) {
          Speed1 *= -1;
      }

      if (args.LODIRECT == PingPongG2ILoDirect.L) {
          Speed2 *= -1;
      }

      var Step1 = Math.round(args.RADIUS * 5.5);
      var Step2 = Math.round(args.RADIUS * 5.5);

      console.log(Speed1 + Speed2 + " " + args.RADIUS + " " + args.RADIUS);

      var SinglesData = new Array(2);
      SinglesData[0] = PingPongUtil.makeSingleDataByStep(0, 0, Speed1, Step1);
      SinglesData[1] = PingPongUtil.makeSingleDataByStep(1, 0, Speed2, Step2);
      SinglesData[0][12] = 2; // make resume
      SinglesData[1][12] = 2; // make resume

      var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(SinglesData, 2, 1);

      var TimeDelay1 = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed1), Step1) + 400;

      var TimeDelay2 = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed2), Step2) + 400;

      var TimeDelay = TimeDelay1;

      if (TimeDelay2 > TimeDelay1)
          TimeDelay = TimeDelay2;

      this._peripheral.send(OutPutData);
      /*
      return new Promise(resolve => {
          var repeat = setInterval(() => {
              this.inActionC1C2 = false;
              clearInterval(repeat);
              resolve();
          }, TimeDelay);
      });
      */
     return new Promise(resolve => {
        var repeat = setInterval(() => {
            this.inActionC1C2 = false;
            clearInterval(repeat);
            resolve();
        }, TimeDelay);
      });
    }

    motorChoice(args){
      console.log("args.CUBE " + args.CUBE);
      if(args.CUBE == PingPongG2iCubes.ONE){
        this.motor1(args);
      }
      if(args.CUBE == PingPongG2iCubes.TWO){
        this.motor2(args);
      }
      if(args.CUBE == PingPongG2iCubes.ALL){
        this.motorallInOne(args);
      }
      /* branch function mode selection, pending
      return new Promise(resolve => {
          setInterval(() => {
              this.inActionC1C2 = false;
              resolve();
              console.log("TimeDelay  " + TimeDelay);
          }, TimeDelay);
      });
      */
     return new Promise(resolve => {
        var repeat = setInterval(() => {
            this.inActionC1C2 = false;
            clearInterval(repeat);
            resolve();
        }, TimeDelay);
      });
    }

    motor1(args) {
        if (this._peripheral.AllConnected == false)
            return;

        if (this.inActionC1C2 == true)
            return;

        var Speed = 800;

        this.inActionC1C2 = true;

        if (args.LODIRECT == PingPongG2ILoDirect.L) {
            Speed *= -1;
        }

        var Step = Math.round(args.RADIUS * 5.5);

        console.log(Speed + Step + " " + args.RADIUS + " " + args.RADIUS);

        var OutPutData = PingPongUtil.makeSingleDataByStep(0, 0, Speed, Step);
        OutPutData[12] = 2; // make resume

        console.log("OutputData  " + OutPutData);

        TimeDelay = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed), Step) + 200
        console.log("TimeDelay  " + TimeDelay);

        this._peripheral.send(OutPutData);

    }

    motor2(args) {
        if (this._peripheral.AllConnected == false)
            return;

        if (this.inActionC1C2 == true)
            return;

        var Speed = 800;

        this.inActionC1C2 = true;

        if (args.LODIRECT == PingPongG2ILoDirect.L) {
            Speed *= -1;
        }

        var Step = Math.round(args.RADIUS * 5.5);

        var OutPutData = PingPongUtil.makeSingleDataByStep(1, 0, Speed, Step);
        OutPutData[12] = 2; // make resume
        console.log("OutputData  " + OutPutData);

        TimeDelay = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed), Step) + 200;
        console.log("TimeDelay  " + TimeDelay);

        this._peripheral.send(OutPutData);
    }

    whenButtonPressed(args)
    {
        if (args.BTN === 'a') {
            if (this._peripheral._buttons.C1Button == 1)
                return true;
        } else if (args.BTN === 'b') {
            if (this._peripheral._buttons.C2Button == 1)
                return true;
        } else if (args.BTN === 'any') {
            if (this._peripheral._buttons.C1Button == 1 || this._peripheral._buttons.C2Button == 1)
                return true;
        }
        return false;
    }

    isButtonPressed(args) {
        if (args.BTN === 'a') {
            if (this._peripheral._buttons.C1Button == 1)
                return true;
        } else if (args.BTN === 'b') {
            if (this._peripheral._buttons.C2Button == 1)
                return true;
        } else if (args.BTN === 'any') {
            if (this._peripheral._buttons.C1Button == 1 || this._peripheral._buttons.C2Button == 1)
                return true;
        }
        return false;
    }

    // Display Maxtrix Pixel Each Cube, fecan 2019.12.22 ADDED 
    turnonoffLedMatrixPixelEach(args){
        if(this._peripheral.AllConnected == false)
          return;
        if (this.inActionC1C2 == true)
          return;
  
        this.inActionC1C2 = true;
        var MatrixLedPixelData = PingPongUtil.makeMatrixPixelData(0xe1, args.CUBE, args.COORDX, args.COORDY, args.TURNONOFF);
        this._peripheral.send(MatrixLedPixelData);
        
        console.log("Cube " + args.CUBE + "X  " + args.COORDX + " Y  " + args.COORDY);
        console.log("MatrixLedPixelData " + MatrixLedPixelData);
    
        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2 = false;
                clearInterval(repeat);
                resolve();
                console.log("clearInterval ");
            }, 150);
        });
    }
    /*
    turnOffLedMatrixPixelEach(args){
        if(this._peripheral.AllConnected == false)
          return;
        if (this.inActionC1C2 == true)
          return;
  
        this.inActionC1C2 = true;
        var MatrixLedPixelData = PingPongUtil.makeMatrixPixelData(0xe1, args.CUBE, args.COORDX, args.COORDY, 0x00);
        this._peripheral.send(MatrixLedPixelData);
  
        console.log("Cube " + args.CUBE + "X  " + args.COORDX + " Y  " + args.COORDY);
        console.log("MatrixLedPixelData " + MatrixLedPixelData);
        /*
        return new Promise(resolve => {
          setInterval(() => {
              this.inActionC1C2 = false; // after command
              resolve();
          }, 100);
      });
      
        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2 = false;
                clearInterval(repeat);
                resolve();
                console.log("clearInterval ");
            }, 150);
        });
    }*/
    // Show Matrix String with duration for each Matrix
    displayLedMatrixStringDurationEach(args){
        if(this._peripheral.AllConnected == false)
          return;
        if (this.inActionC1C2 == true)
          return;
        
        this.inActionC1C2 = true;
  
        var MatrixLedStringData = PingPongUtil.makeMatrixStringData(0xe3, args.CUBE, args.MSTRING, args.MSECOND);
        this._peripheral.send(MatrixLedStringData);
        var mDuration = args.MSECOND + 150;
        console.log("MatrixLedStringData  " + MatrixLedStringData);
        /*
        return new Promise(resolve => {
          setInterval(() => {
              this.inActionC1C2 = false; // after command
              resolve();
          }, 200);
      });
      */
        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2 = false;
                clearInterval(repeat);
                resolve();
                console.log("clearInterval ");
            }, mDuration);
        });
    }
    // clear Matrix Pixels
    clearMatrixPixelsEach(args){
        if(this._peripheral.AllConnected == false)
            return;
        if (this.inActionC1C2 == true)
            return;
        
        this.inActionC1C2 = true;

        var MatrixLedStringData = PingPongUtil.makeMatrixStringData(0xe3, args.CUBE, 0x00, 0x00);
        this._peripheral.send(MatrixLedStringData);

        console.log("MatrixLedStringData  " + MatrixLedStringData);
        /*
        return new Promise(resolve => {
            setInterval(() => {
                this.inActionC1C2 = false; // after command
                resolve();
            }, 200);
        });
        */
        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2 = false;
                clearInterval(repeat);
                resolve();
                console.log("clearInterval ");
            }, 200);
        });
    }
    // set Servo Degree
    setServoDegreeEach(args){
        if(this._peripheral.AllConnected == false)
        return;
        if (this.inActionC1C2 == true)
        return;

        this.inActionC1C2 = true;
        var ServoDegreeData = PingPongUtil.makeServoDegreeData(args.CUBE, args.SERVODEGREE);
        this._peripheral.send(ServoDegreeData);

        console.log("ServoDegreeData  " + ServoDegreeData);

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2 = false;
                clearInterval(repeat);
                resolve();
                console.log("clearInterval ");
            }, 100);
        });
    }
    // 2019.12.27 fecan added
    // play note for beats
    playNoteForBeatsEach(args){
        if(this._peripheral.AllConnected == false)
          return;
        if (this.inActionC1C2 == true)
          return;

        this.inActionC1C2 = true;
        beatsEach = this._clampBeats(args.BEATS);
        durationSecEach = this._beatsToDuration(args, beatsEach); 
        console.log("durationSec  " + durationSecEach); 
        var PlayNoteBeatsEach = PingPongUtil.makePlayNoteData(args.CUBE-1, args.NOTE, durationSecEach, 1);
        console.log("PlayNoteBeats " + PlayNoteBeatsEach);
        TimeDelay = (durationSecEach * 10) + 30;
        console.log("TimeDelay  " + TimeDelay); 
        this._peripheral.send(PlayNoteBeatsEach);
        // this._peripheral.setWaitResponseOPCode(0xe8, 400);

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2 = false;
                clearInterval(repeat);
                resolve();
                // console.log("clearInterval ");
            }, TimeDelay);
        });
    }
    // rest for a number of beats with no sound
    restForBeatsEach(args){
        if(this._peripheral.AllConnected == false)
          return;
        if (this.inActionC1C2 == true)
          return;

        this.inActionC1C2 = true;
        beatsEach = this._clampBeats(args.BEATS);       
        durationSecEach = this._beatsToDuration(args, beatsEach); 
        console.log("durationSec " + durationSecEach);   

        TimeDelay = (durationSecEach * 10) + 30;

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2 = false;
                clearInterval(repeat);
                resolve();
                console.log("clearInterval ");
            }, TimeDelay);
        });
    }
    /* 
    restForBeats(args){
        if(this._peripheral.AllConnected == false)
          return;
        if (this.inActionC1C2 == true)
          return;

        this.inActionC1C2 = true;
        beats = this._clampBeats(args.BEATS);       
        durationSec = this._beatsToDuration(beats); 
        console.log("durationSec " + durationSec);   
        // var RestBeatsData = PingPongUtil.makePlayNoteData(0x00, 0x28, durationSec, 2);
        // this._peripheral.send(RestBeatsData);
        
        TimeDelay = (durationSec * 10) + 30;
        console.log("TimeDelay " + TimeDelay);
        //this._peripheral.setWaitResponseOPCode(0xe8, TimeDelay);
  
        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2 = false;
                clearInterval(repeat);
                resolve();
                console.log("clearInterval ");
            }, TimeDelay);
        });
    }
    */
      // set tempo (speed) for notes
    setTempoEach(args){
        // var nCube = Number(args.CUBE) + 1
        if(this._peripheral.AllConnected == false)
          return;
        if (this.inActionC1C2 == true)
          return;

        this.inActionC1C2 = true;

        tempoEach = this._clampTempo(args.TEMPO);
        console.log("get Cube " + args.CUBE);
        
        if(args.CUBE == PingPongG2iCubes.ONE){
            console.log("tempoEach " + tempoEach);
            this._peripheral._tempo.C1Tempo = tempoEach;
            console.log("CUBE  " + args.CUBE + "_clampTempo(after)  " + this._peripheral._tempo.C1Tempo);
        }

        if(args.CUBE == PingPongG2iCubes.TWO){
            console.log("CUBE  " + args.CUBE + "_clampTempo(after)  " + this._peripheral._tempo.C2Tempo);
            this._peripheral._tempo.C2Tempo = tempoEach;
        }

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2 = false;
                clearInterval(repeat);
                resolve();
                console.log("clearInterval ");
            }, 200);
        });
    }
    // get tempo 
    getTempoEach(args) {
        if(typeof args.CUBE == 'undefined') {
            console.log("chord playing");
            return this._peripheral._tempo.C1Tempo;
        }
        else {
            // var nCube = Number(args.CUBE) + 1;
            if(args.CUBE == PingPongG2iCubes.ONE){
                // console.log("get CUBE  " + nCube + "_clampTempo(after)  " + args.TEMPO);
                return this._peripheral._tempo.C1Tempo;
            }

            if(args.CUBE == PingPongG2iCubes.TWO){
                // console.log("get CUBE  " + nCube + "_clampTempo(after)  " + args.TEMPO);
                return this._peripheral._tempo.C2Tempo;
            }
        }
    }

    getButtonC1() {
        //    console.log("getGyroX ");
        return this._peripheral._buttons.C1Button;
    }

    getButtonC2() {
        //    console.log("getGyroX ");
        return this._peripheral._buttons.C2Button;
    }

    getProxiC1Interval() {
        return this._peripheral._proximity.C1ProxInterVal;
    }

    getProxiC2Interval() {
        return this._peripheral._proximity.C2ProxInterVal;
    }

    getProxiC1() {
        //    console.log("getGyroX ");
        return this._peripheral._proximity.C1Prox;
    }

    getProxiC2() {
        //    console.log("getGyroX ");
        return this._peripheral._proximity.C2Prox;
    }

    getGyroSensor(args){
      if(args.CUBE == PingPongG2iCubes.ONE){
        switch (args.DIRECTION) {
            case PingPongG2ITiltDirection.FRONT:
                return this.getGyroXCCircle1();
            case PingPongG2ITiltDirection.BACK:
                return this.getGyroXCTriangle1();
            case PingPongG2ITiltDirection.LEFT:
                return this.getGyroYCSquare1();
            case PingPongG2ITiltDirection.RIGHT:
              return this.getGyroYCStar1();
            default:
        }
      }

      if(args.CUBE == PingPongG2iCubes.TWO){
        switch (args.DIRECTION) {
            case PingPongG2ITiltDirection.FRONT:
                return this.getGyroXCCircle2();
            case PingPongG2ITiltDirection.BACK:
                return this.getGyroXCTriangle2();
            case PingPongG2ITiltDirection.LEFT:
                return this.getGyroYCSquare2();
            case PingPongG2ITiltDirection.RIGHT:
              return this.getGyroYCStar2();
            default:
        }
      }
    }

    getGyroXC1() {
        return this._peripheral._sensors.C1tiltX;
    }

    getGyroYC1() {
        return this._peripheral._sensors.C1tiltY;
    }

    getGyroZC1() {
        return this._peripheral._sensors.C1tiltZ;
    }

    getGyroXC2() {
        return this._peripheral._sensors.C2tiltX;
    }

    getGyroYC2() {
        return this._peripheral._sensors.C2tiltY;
    }

    getGyroZC2() {
        return this._peripheral._sensors.C2tiltZ;
    }

    getGyroXCCircle1() {
        return this._peripheral._sensors.C1tiltX * -1;
    }

    getGyroXCTriangle1() {
        return this._peripheral._sensors.C1tiltX;
    }

    getGyroYCStar1() {
        return this._peripheral._sensors.C1tiltY;
    }

    getGyroYCSquare1() {
        return this._peripheral._sensors.C1tiltY * -1;
    }

    getGyroXCCircle2() {
        return this._peripheral._sensors.C2tiltX * -1;
    }

    getGyroXCTriangle2() {
        return this._peripheral._sensors.C2tiltX;
    }

    getGyroYCStar2() {
        return this._peripheral._sensors.C2tiltY;
    }

    getGyroYCSquare2() {
        return this._peripheral._sensors.C2tiltY * -1;
    }

    getUpper1() {
        if (this._peripheral._sensors.C1tiltX > 70)
            return "circle";

        if (this._peripheral._sensors.C1tiltX < -70)
            return "triangle";

        if (this._peripheral._sensors.C1tiltY > 70)
            return "rectangle";

        if (this._peripheral._sensors.C1tiltY < -70)
            return "star";

        if (this._peripheral._sensors.C1tiltZ > 70)
            return "none";

        if (this._peripheral._sensors.C1tiltZ < -70)
            return "heart";

        return "unknown";
    }

    getADSensorValueEach(args){
        if(args.CUBE == PingPongG2iCubes.ONE){
            if(args.SENSOR == PingPongG2ISensorType.ADSENSOR){
                return this._peripheral._sensors.C1ADval;
            } else {
                return this._peripheral._proximity.C1Prox;
            }       
        }

        if(args.CUBE == PingPongG2iCubes.TWO){
            if(args.SENSOR == PingPongG2ISensorType.ADSENSOR){
                return this._peripheral._sensors.C2ADval;
            } else {
                return this._peripheral._proximity.C2Prox;
            }   
        }
    }

    getUpper2() {
        if (this._peripheral._sensors.C2tiltX > 70)
            return "circle";

        if (this._peripheral._sensors.C2tiltX < -70)
            return "triangle";

        if (this._peripheral._sensors.C2tiltY > 70)
            return "rectangle";

        if (this._peripheral._sensors.C2tiltY < -70)
            return "star";

        if (this._peripheral._sensors.C2tiltZ > 70)
            return "none";

        if (this._peripheral._sensors.C2tiltZ < -70)
            return "heart";

        return "unknown";
    }

    isUpper(args) {

        if (args.BTN == PingPongG2IButtons.A)
        {
            if (args.DIRECTION == PingPongG2IUpperDirection.FRONT) {
                if (this._peripheral._sensors.C1tiltY > 70)
                    return true;
            }

            if (args.DIRECTION == PingPongG2IUpperDirection.BACK) {
                if (this._peripheral._sensors.C1tiltY < -70)
                    return true;
            }

            if (args.DIRECTION == PingPongG2IUpperDirection.LEFT) {
                if (this._peripheral._sensors.C1tiltX < -70)
                    return true;
            }

            if (args.DIRECTION == PingPongG2IUpperDirection.RIGHT) {
                if (this._peripheral._sensors.C1tiltX > 70)
                    return true;
            }

            if (args.DIRECTION == PingPongG2IUpperDirection.UP) {
                if (this._peripheral._sensors.C1tiltZ < -70)
                    return true;
            }

            if (args.DIRECTION == PingPongG2IUpperDirection.DOWN) {
                if (this._peripheral._sensors.C1tiltZ > 70)
                    return true;
            }
        }

        if (args.BTN == PingPongG2IButtons.B)
        {
            if (args.DIRECTION == PingPongG2IUpperDirection.FRONT) {
                if (this._peripheral._sensors.C2tiltY > 70)
                    return true;
            }

            if (args.DIRECTION == PingPongG2IUpperDirection.BACK) {
                if (this._peripheral._sensors.C2tiltY < -70)
                    return true;
            }

            if (args.DIRECTION == PingPongG2IUpperDirection.LEFT) {
                if (this._peripheral._sensors.C2tiltX < -70)
                    return true;
            }

            if (args.DIRECTION == PingPongG2IUpperDirection.RIGHT) {
                if (this._peripheral._sensors.C2tiltX > 70)
                    return true;
            }

            if (args.DIRECTION == PingPongG2IUpperDirection.UP) {
                if (this._peripheral._sensors.C2tiltZ < -70)
                    return true;
            }

            if (args.DIRECTION == PingPongG2IUpperDirection.DOWN) {
                if (this._peripheral._sensors.C2tiltZ > 70)
                    return true;
            }
        }

        return false;
    }
    // beats X 100 = duration
    _beatsToDuration (args, beats) {
        console.log("get Tempo" + this.getTempoEach(args));
        var nDuration = Math.round(((60 / this.getTempoEach(args)) * beats) * 100);
        return nDuration;
    }

    // Clamp a duration in beats to the allowed min adn max duration
    _clampBeats (beats) {
        return MathUtil.clamp(beats, Scratch3PingPongG2iBlocks.BEAT_RANGE.min, Scratch3PingPongG2iBlocks.BEAT_RANGE.max);
    }

    // Clamp a duration in tempos to the allowed min adn max duration
    _clampTempo (tempo) {
        return MathUtil.clamp(tempo, Scratch3PingPongG2iBlocks.TEMPO_RANGE.min, Scratch3PingPongG2iBlocks.TEMPO_RANGE.max);
    }
}

module.exports = Scratch3PingPongG2iBlocks;
