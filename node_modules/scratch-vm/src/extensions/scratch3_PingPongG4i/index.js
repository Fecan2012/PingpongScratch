const ArgumentType = require('../../extension-support/argument-type');
const BlockType = require('../../extension-support/block-type');
const log = require('../../util/log');
const cast = require('../../util/cast');
const formatMessage = require('format-message');
const BLE = require('../../io/blepingpong');
const MathUtil = require('../../util/math-util');
const Base64Util = require('../../util/base64-util');
const PingPongUtil = require('../../util/pingpong-util');
const blockIconURI = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAABQCAIAAAABc2X6AAAACXBIWXMAAC4jAAAuIwF4pT92AAAF+mlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS42LWMxNDUgNzkuMTYzNDk5LCAyMDE4LzA4LzEzLTE2OjQwOjIyICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdEV2dD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlRXZlbnQjIiB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iIHhtbG5zOnBob3Rvc2hvcD0iaHR0cDovL25zLmFkb2JlLmNvbS9waG90b3Nob3AvMS4wLyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ0MgMjAxOSAoV2luZG93cykiIHhtcDpDcmVhdGVEYXRlPSIyMDE5LTA2LTA0VDE0OjAwOjM1KzA5OjAwIiB4bXA6TWV0YWRhdGFEYXRlPSIyMDE5LTA2LTA0VDE0OjAwOjM1KzA5OjAwIiB4bXA6TW9kaWZ5RGF0ZT0iMjAxOS0wNi0wNFQxNDowMDozNSswOTowMCIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDoyNmUzZGY0MS1jZjUyLTY0NGEtYTcxNy02ODQ4NDIyNmQ3N2IiIHhtcE1NOkRvY3VtZW50SUQ9ImFkb2JlOmRvY2lkOnBob3Rvc2hvcDo5MTYyMzk1My0xMTk2LTNjNDItODhkMy0xYmI1NmZjNDdjYWYiIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDpmMzg4MDZmMS0wMTE0LWZmNDktOTJmZC1jNjJiNDM1NzI2OWEiIGRjOmZvcm1hdD0iaW1hZ2UvcG5nIiBwaG90b3Nob3A6Q29sb3JNb2RlPSIzIiBwaG90b3Nob3A6SUNDUHJvZmlsZT0ic1JHQiBJRUM2MTk2Ni0yLjEiPiA8eG1wTU06SGlzdG9yeT4gPHJkZjpTZXE+IDxyZGY6bGkgc3RFdnQ6YWN0aW9uPSJjcmVhdGVkIiBzdEV2dDppbnN0YW5jZUlEPSJ4bXAuaWlkOmYzODgwNmYxLTAxMTQtZmY0OS05MmZkLWM2MmI0MzU3MjY5YSIgc3RFdnQ6d2hlbj0iMjAxOS0wNi0wNFQxNDowMDozNSswOTowMCIgc3RFdnQ6c29mdHdhcmVBZ2VudD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTkgKFdpbmRvd3MpIi8+IDxyZGY6bGkgc3RFdnQ6YWN0aW9uPSJzYXZlZCIgc3RFdnQ6aW5zdGFuY2VJRD0ieG1wLmlpZDoyNmUzZGY0MS1jZjUyLTY0NGEtYTcxNy02ODQ4NDIyNmQ3N2IiIHN0RXZ0OndoZW49IjIwMTktMDYtMDRUMTQ6MDA6MzUrMDk6MDAiIHN0RXZ0OnNvZnR3YXJlQWdlbnQ9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE5IChXaW5kb3dzKSIgc3RFdnQ6Y2hhbmdlZD0iLyIvPiA8L3JkZjpTZXE+IDwveG1wTU06SGlzdG9yeT4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz7mspeEAAAQh0lEQVR4nN1ceZQURZr/RURmVlZlVvVRTVc30JyKHA26iCggIuB4jngMrDCAIujoMOqoMzvjuuM8xwt1x3OcYRyVp+IB4riIAuIBLoKCuiqLtnIfDfTdXdVdZ2ZGxP5R1dBAQ1V1FwL7e/Vev+qqyPp++R3xxRdfBgm/3w3HAIaHwEdhAzHZEha7aviuaqc2KOqCnPODvskYSgqYP4+WBVifUsU0CNwUKkGIR2Iy54IpubqQlCAEhpfCTeBg3257/X/Hvt5sf/Zd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';
var GroupId="";
var TimeDelay="";
try {
   GroupId = document.getElementById('isGroup').value == "false" ? "" : document.getElementById('groupId').value;
}catch(e){

}
const BLEUUID = {
    namePrefix: 'PINGPONG.'+ GroupId,
    service: '6e400001-b5a3-f393-e0a9-e50e24dcca9e',
    txChar: '6e400002-b5a3-f393-e0a9-e50e24dcca9e',
    rxChar: '6e400003-b5a3-f393-e0a9-e50e24dcca9e',
    groupID: GroupId
};
class PingPongG4i {

    constructor (runtime, extensionId) {
        this._runtime = runtime;

        this._ble = null;
        this._runtime.registerPeripheralExtension(extensionId, this);

        this._extensionId = extensionId;

        this.disconnect = this.disconnect.bind(this);
        this._onConnect = this._onConnect.bind(this);
        this._onMessage = this._onMessage.bind(this);

        this.connectCount = 4;

        this.AllConnected = false;

        this.receivedNotifyData = null;
        this.bContinueReceived = false;
        this.waitResponseOPCode = -1;

        this._sensors = {
            C1tiltX: 0,
            C1tiltY: 0,
            C1tiltZ: 0,
            C2tiltX: 0,
            C2tiltY: 0,
            C2tiltZ: 0,
            C3tiltX: 0,
            C3tiltY: 0,
            C3tiltZ: 0,
            C4tiltX: 0,
            C4tiltY: 0,
            C4tiltZ: 0,

            C1moveX: 0,
            C1moveY: 0,
            c1moveZ: 0,
            C2moveX: 0,
            C2moveY: 0,
            c2moveZ: 0,
            C3moveX: 0,
            C3moveY: 0,
            c3moveZ: 0,
            C4moveX: 0,
            C4moveY: 0,
            c4moveZ: 0,

            // 2019.12.20 Fecan added
            C1ADval: 0,
            C2ADval: 0,
            C3ADval: 0,
            C4ADval: 0
        };
        // 2019.12.23 fecan added
        this._tempo = {
            C1Tempo: 60,
            C2Tempo: 60,
            C3Tempo: 60,
            C4Tempo: 60
        };

        this._buttons = {
            C1Button: 0,
            C2Button: 0,
            C3Button: 0,
            C4Button: 0
        };

        this._proximity = {
            C1ProxOld: 0,
            C2ProxOld: 0,
            C3ProxOld: 0,
            C4ProxOld: 0,
            C1Prox: 0,
            C2Prox: 0,
            C3Prox: 0,
            C4Prox: 0,
            C1ProxInterVal: 0,
            C2ProxInterVal: 0,
            C3ProxInterVal: 0,
            C4ProxInterVal: 0
        };

        this.receivedNotifyData = null;
        this.bContinueReceived = false;

        console.log("pingpong g4i constructor call end");
    }

    scan() {
        console.log("pingpong g4i scan");

        if (this._ble) {
            this._ble.disconnect();
        }
        this._ble = new BLE(this._runtime, this._extensionId, {
            filters: [
                { namePrefix: BLEUUID.namePrefix , groupID: BLEUUID.groupID}
            ]
        }, this._onConnect, this.disconnect);
    }

    connect(id) {
        console.log("connect " + id);
        if (this._ble) {
            this._ble.connectPeripheral(id);
        }
    }

    disconnect() {
        if (this._ble) {
            this._ble.disconnect();
        }

        this.AllConnected = false;
    }

    isConnected() {
        let connected = false;
        if (this._ble) {
            connected = this._ble.isConnected();
        }

        if (connected == true)
            return this.AllConnected;

        this.AllConnected = false;
        return this.AllConnected;
    }

    send(message, force = false) {
        if (force == false)
            if (!this.isConnected()) return;

        const data = Base64Util.uint8ArrayToBase64(message);

        this._ble.write(BLEUUID.service, BLEUUID.txChar, data, 'base64', false).then(
            () => {
                // 추후 여기에 코딩 가능
                console.log("send done to scratch links");
            }
        );
    }

    NotificationEventFC(value)
    {
        console.log('NotificationEventFC');

        if (value == null)
            return;

        // check connect
        if (value.byteLength == 18) {
            if (value[6] == 0xad || value[6] == 0xae) {
                if (value[11] == 0x01 && value[12] == 0x02 && value[13] == 0x03) {
                    this.AllConnected = true;
                    this._runtime.emit(this._runtime.constructor.PERIPHERAL_CONNECTED);

                    window.setTimeout(() => {
                        if (this._ble) {
                            this.send(PingPongUtil.getSensorsData(0xff, 40));
                        }
                    }, 3000);
                }
            }
        }

        if (value.byteLength == 19 || value.byteLength == 20) {
            if (value[6] == 0xb8 && value[5] == 0xc8) {
                if (value[8] == 0x13 || value[8] == 0x14) {
                    this.CheckProximityData(value);
                }
            }
        }
    }

    setWaitResponseOPCode(nCode, nTimeOut) {
        if (this.waitResponseOPCode != -1)
            return;
        if (this.waitResponseOPCodetimeoutID != null) {
            console.log("will cancel timer");
            window.clearTimeout(this.waitResponseOPCodetimeoutID);
            this.waitResponseOPCodetimeoutID = null;
        }
        this.waitResponseOPCode = nCode;
        console.log("set opcode");
        this.waitResponseOPCodetimeoutID = window.setTimeout(() => {
            console.log("timer called will clear opcode");
            this.waitResponseOPCode = -1;
            this.waitResponseOPCodetimeoutID = null;
        }, nTimeOut);
    }

    CheckProximityData(value){
        var x1 = PingPongUtil.getSignedIntfromByteData(value[12]);
        var x2 = PingPongUtil.getSignedIntfromByteData(value[13]);
        var x3 = PingPongUtil.getSignedIntfromByteData(value[14]);
        var xx = PingPongUtil.getACCDataToDegreeMinus90To90fromByteData(value[15]);
        var yy = PingPongUtil.getACCDataToDegreeMinus90To90fromByteData(value[16]);
        yy *= -1;
        var zz = PingPongUtil.getACCDataToDegreeMinus90To90fromByteData(value[17]);
        // 2019.12.20 Roborisen Added
        var ad = PingPongUtil.getUnsignedIntfromByteData(value[19]);

        if (value[3] == 0) {
            console.log("cube1 Detect " + value[3]);

            this._sensors.C1moveX = x1;
            this._sensors.C1moveY = x2;
            this._sensors.C1moveZ = x3;

            this._sensors.C1tiltX = xx;
            this._sensors.C1tiltY = yy;
            this._sensors.C1tiltZ = zz;
            this._sensors.C1ADval = ad;

            this._buttons.C1Button = value[11];
            this._proximity.C1Prox = PingPongUtil.getUnsignedIntfromByteData(value[18]);
            this._proximity.C1ProxInterVal = this._proximity.C1Prox - this._proximity.C1ProxOld;
            this._proximity.C1ProxOld = this._proximity.C1Prox;
        }

        if (value[3] == 1) {
            console.log("cube2 Detect " + value[3]);

            this._sensors.C2moveX = x1;
            this._sensors.C2moveY = x2;
            this._sensors.C2moveZ = x3;

            this._sensors.C2tiltX = xx;
            this._sensors.C2tiltY = yy;
            this._sensors.C2tiltZ = zz;
            this._sensors.C2ADval = ad;

            this._buttons.C2Button = value[11];
            this._proximity.C2Prox = PingPongUtil.getUnsignedIntfromByteData(value[18]);
            this._proximity.C2ProxInterVal = this._proximity.C2Prox - this._proximity.C2ProxOld;
            this._proximity.C2ProxOld = this._proximity.C2Prox;
        }

        if(value[3] == 2){
          console.log("cube3 Detect " + value[3]);
          this._sensors.C3moveX = x1;
          this._sensors.C3moveY = x2;
          this._sensors.C3moveZ = x3;

          this._sensors.C3tiltX = xx;
          this._sensors.C3tiltY = yy;
          this._sensors.C3tiltZ = zz;
          this._sensors.C3ADval = ad;

          this._buttons.C3Button = value[11];
          this._proximity.C3Prox = PingPongUtil.getUnsignedIntfromByteData(value[18]);
          this._proximity.C3ProxInterVal = this._proximity.C3Prox - this._proximity.C3ProxOld;
          this._proximity.C3ProxOld = this._proximity.C3Prox;
        }

        if(value[3] == 3){
          console.log("cube4 Detect " + value[3]);
          this._sensors.C4moveX = x1;
          this._sensors.C4moveY = x2;
          this._sensors.C4moveZ = x3;

          this._sensors.C4tiltX = xx;
          this._sensors.C4tiltY = yy;
          this._sensors.C4tiltZ = zz;
          this._sensors.C4ADval = ad;

          this._buttons.C4Button = value[11];
          this._proximity.C4Prox = PingPongUtil.getUnsignedIntfromByteData(value[18]);
          this._proximity.C4ProxInterVal = this._proximity.C4Prox - this._proximity.C4ProxOld;
          this._proximity.C4ProxOld = this._proximity.C4Prox;
        }
    }

    _onConnect() {
        this._ble.startNotifications(BLEUUID.service, BLEUUID.rxChar, this._onMessage);

        window.setTimeout(() => {
            this.send(PingPongUtil.getSetMultiroleInAction(this.connectCount), true);
        }, 1000);
    }

    _onMessage(base64) {
        const datas = Base64Util.base64ToUint8Array(base64);

        PingPongUtil.printUint8ArrayToHex(datas, "Notification Data");
        this.NotificationEventFC(datas);
    }

}

const simple_act_direction = {
    Up: '0',
    Down: '1',
    left: '2',
    right: '3'
};

const simple_act_interval = {
    cm10: '10',
    cm20: '20',
    cm30: '30',
    cm40: '40',
    cm50: '50'
};
const simple_act_degreeradius = {
    degree10: '10',
    degree20: '20',
    degree30: '30',
    degree40: '40',
    degree50: '50',
    degree60: '60',
    degree70: '70',
    degree80: '80',
    degree90: '90',
    degree100: '100',
    degree110: '110',
    degree120: '120',
    degree130: '130',
    degree140: '140',
    degree150: '150',
    degree160: '160',
    degree170: '170',
    degree180: '180',
    degree190: '190',
    degree200: '200',
    degree210: '210',
    degree220: '220',
    degree230: '230',
    degree240: '240',
    degree250: '250',
    degree260: '260',
    degree270: '270',
    degree280: '280',
    degree290: '290',
    degree300: '300',
    degree310: '310',
    degree320: '320',
    degree330: '330',
    degree340: '340',
    degree350: '350',
    degree360: '360'
};

const continuous_act_speed = {
    speedI100: '-100',
    speedI90: '-90',
    speedI80: '-80',
    speedI70: '-70',
    speedI60: '-60',
    speedI50: '-50',
    speedI40: '-40',
    speedI30: '-30',
    speedI20: '-20',
    speedI10: '-10',
    speed0: '0',
    speed10: '10',
    speed20: '20',
    speed30: '30',
    speed40: '40',
    speed50: '50',
    speed60: '60',
    speed70: '70',
    speed80: '80',
    speed90: '90',
    speed100: '100'
};

/*
const matrix_pixel_position = {
    position0: '0',
    position1: '1',
    position2: '2',
    position3: '3',
    position4: '4',
    position5: '5',
    position6: '6',
    position7: '7'
};
*/
const led_turn_onoff = {
    off: '0',
    on: '1'
};
const play_note_beats = {
    note45: '45',
    note46: '46',
    note47: '47',
    note48: '48',
    note49: '49',
    note50: '50',
    note51: '51',
    note52: '52',
    note53: '53',
    note54: '54',
    note55: '55',
    note56: '56',
    note57: '57',
    note58: '58',
    note59: '59',
    note60: '60',
    note61: '61',
    note62: '62',
    note63: '63',
    note64: '64',
    note65: '65',
    note66: '66',
    note67: '67',
    note68: '68',
    note69: '69',
    note70: '70',
    note71: '71',
    note72: '72'
};
const PingPongG4iCube = {
    ONE: '1',
    TWO: '2',
    THREE:'3',
    FOUR:'4'
};
const PingPongG4iCubes = {
    ONE: '1',
    TWO: '2',
    THREE:'3',
    FOUR:'4',
    ALL:'ALL'
};

const PingPongG4IButtons = {
    A: 'a',
    B: 'b',
    C: 'c',
    D: 'd',
    ANY: 'any'
};

const PingPongG4ILoDirect = {
    L: 'left',
    R: 'right',
};

const PingPongG4ITiltDirection = {
    FRONT: '원',
    BACK: '세모',
    LEFT: '네모',
    RIGHT: '별모양',
};
const PingPongG4IUpperDirection = {
    FRONT: 'front',
    BACK: 'back',
    LEFT: 'left',
    RIGHT: 'right',
    UP: 'up',
    DOWN: 'down'
};

const PingPongG4ISensorType = {
    ADSENSOR: 'adsensor',
    PROXIMITYS: 'proximity'
};

class Scratch3PingPongG4iBlocks {

    static get EXTENSION_NAME () {
        return 'PingPong G4i';
    }

    static get EXTENSION_ID () {
        return 'PingPongG4i';
    }

    static get TILT_THRESHOLD() {
        return 20;
    }

    static get MOVE_THRESHOLD() {
        return 30;
    }

    get LEFT_RIGHT_DIRECTION() {
        return [
            {
                text: 'left',
                value: simple_act_direction.left
            },
            {
                text: 'right',
                value: simple_act_direction.right
            }
        ];
    }

    get LODIRECT_MENU() {
        return [
            {
                text: formatMessage({
                    id: 'pingpongwormbot.PingPongWormBotLoDirect.R',
                    default: 'clockwise',
                    description: 'lotate clock'
                }),
                value: PingPongG4ILoDirect.R
            },
            {
                text: formatMessage({
                    id: 'pingpongwormbot.PingPongWormBotLoDirect.L',
                    default: 'counterclockwise',
                    description: 'lotate counter clock'
                }),
                value: PingPongG4ILoDirect.L
            }
        ];
    }

    get TILT_DIRECTION_MENU() {
        return [
            {
                text: formatMessage({
                    id: 'pingpongg3i.tiltDirectionMenu.front',
                    default: '원',
                    description: 'label for front element in tilt direction picker for micro:bit extension'
                }),
                value: PingPongG4ITiltDirection.FRONT
            },
            {
                text: formatMessage({
                    id: 'pingpongg3i.tiltDirectionMenu.back',
                    default: '세모',
                    description: 'label for back element in tilt direction picker for micro:bit extension'
                }),
                value: PingPongG4ITiltDirection.BACK
            },
            {
                text: formatMessage({
                    id: 'pingpongg3i.tiltDirectionMenu.left',
                    default: '네모',
                    description: 'label for left element in tilt direction picker for micro:bit extension'
                }),
                value: PingPongG4ITiltDirection.LEFT
            },
            {
                text: formatMessage({
                    id: 'pingpongg3i.tiltDirectionMenu.right',
                    default: '별모양',
                    description: 'label for right element in tilt direction picker for micro:bit extension'
                }),
                value: PingPongG4ITiltDirection.RIGHT
            }
        ];
    }

    get UP_DOWN_CONTINUOUS() {
        return [
            {
                text: '-100',
                value: continuous_act_speed.speedI100
            },
            {
                text: '-80',
                value: continuous_act_speed.speedI80
            },
            {
                text: '-60',
                value: continuous_act_speed.speedI60
            },
            {
                text: '-40',
                value: continuous_act_speed.speedI40
            },
            {
                text: '-20',
                value: continuous_act_speed.speedI20
            },
            {
                text: '0',
                value: continuous_act_speed.speed0
            },
            {
                text: '20',
                value: continuous_act_speed.speed20
            },
            {
                text: '40',
                value: continuous_act_speed.speed40
            },
            {
                text: '60',
                value: continuous_act_speed.speed60
            },
            {
                text: '80',
                value: continuous_act_speed.speed80
            },
            {
                text: '100',
                value: continuous_act_speed.speed100
            }
        ];
    }

    //rozen 11.07 add
    get CUBE(){
      return [
          {   text: formatMessage({
              id: 'pingpong.ONE',
              default: PingPongG4iCubes.ONE,
              description: '1'
              }),
              value: PingPongG4iCubes.ONE
          },
          {
            text: formatMessage({
                id: 'pingpong.TWO',
                default: PingPongG4iCubes.TWO,
                description: '2'
                }),
                value: PingPongG4iCubes.TWO
          },
          {
            text: formatMessage({
                id: 'pingpong.THREE',
                default: PingPongG4iCubes.THREE,
                description: '3'
                }),
                value: PingPongG4iCubes.THREE
          },
          {
            text: formatMessage({
                id: 'pingpong.FOUR',
                default: PingPongG4iCubes.FOUR,
                description: '4'
                }),
                value: PingPongG4iCubes.FOUR
          }
      ];
    }
    // fecan 2019.12.26 ADDED
    get TURN_ON_OFF() {
        return [
            {
                text: formatMessage({
                    id: 'pingpongg1i.led_turn_onoff.on',
                    default: 'on',
                    description: 'Turn on option for the matrix'
                }),
                value:  led_turn_onoff.on
            },
            {
                text: formatMessage({
                    id: 'pingpongg1i.led_turn_onoff.off',
                    default: 'off',
                    description: 'Turn off option for the matrix'
                }),
                value: led_turn_onoff.off
            }
        ];
    }
    /*
    get PIXELPOSITION() {
        return [
            {
                text: '0',
                value: matrix_pixel_position.postion0
            },
            {
                text: '1',
                value: matrix_pixel_position.postion1
            },
            {
                text: '2',
                value: matrix_pixel_position.postion2
            },
            {
                text: '3',
                value: matrix_pixel_position.postion3
            },
            {
                text: '4',
                value: matrix_pixel_position.postion4
            },
            {
                text: '5',
                value: matrix_pixel_position.postion5
            },
            {
                text: '6',
                value: matrix_pixel_position.postion6
            },
            {
                text: '7',
                value: matrix_pixel_position.postion7
            }
        ];
    }
    */
   get PLAY_MUSIC_BEATS() {
        return [
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.45',
                    default: 'note45',
                    description: 'Play note 45 for duration'
                }),
                value:  play_note_beats.note45
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.46',
                    default: 'note46',
                    description: 'Play note 46 for duration'
                }),
                value:  play_note_beats.note46
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.47',
                    default: 'note47',
                    description: 'Play note 47 for duration'
                }),
                value:  play_note_beats.note47
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.48',
                    default: 'note48',
                    description: 'Play note 48 for duration'
                }),
                value:  play_note_beats.note48
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.49',
                    default: 'note49',
                    description: 'Play note 49 for duration'
                }),
                value:  play_note_beats.note49
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.50',
                    default: 'note50',
                    description: 'Play note 50 for duration'
                }),
                value:  play_note_beats.note50
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.51',
                    default: 'note51',
                    description: 'Play note 51 for duration'
                }),
                value:  play_note_beats.note51
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.52',
                    default: 'note52',
                    description: 'Play note 52 for duration'
                }),
                value:  play_note_beats.note52
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.53',
                    default: 'note53',
                    description: 'Play note 53 for duration'
                }),
                value:  play_note_beats.note53
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.54',
                    default: 'note54',
                    description: 'Play note 54 for duration'
                }),
                value:  play_note_beats.note54
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.55',
                    default: 'note55',
                    description: 'Play note 55 for duration'
                }),
                value:  play_note_beats.note55
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.56',
                    default: 'note56',
                    description: 'Play note 56 for duration'
                }),
                value:  play_note_beats.note56
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.57',
                    default: 'note57',
                    description: 'Play note 57 for duration'
                }),
                value:  play_note_beats.note57
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.58',
                    default: 'note58',
                    description: 'Play note 58 for duration'
                }),
                value:  play_note_beats.note58
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.59',
                    default: 'note59',
                    description: 'Play note 59 for duration'
                }),
                value:  play_note_beats.note59
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.60',
                    default: 'note60',
                    description: 'Play note 60 for duration'
                }),
                value:  play_note_beats.note60
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.61',
                    default: 'note61',
                    description: 'Play note 61 for duration'
                }),
                value:  play_note_beats.note61
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.62',
                    default: 'note62',
                    description: 'Play note 62 for duration'
                }),
                value:  play_note_beats.note62
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.63',
                    default: 'note63',
                    description: 'Play note 63 for duration'
                }),
                value:  play_note_beats.note63
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.64',
                    default: 'note64',
                    description: 'Play note 64 for duration'
                }),
                value:  play_note_beats.note64
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.65',
                    default: 'note65',
                    description: 'Play note 65 for duration'
                }),
                value:  play_note_beats.note65
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.66',
                    default: 'note66',
                    description: 'Play note 66 for duration'
                }),
                value:  play_note_beats.note66
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.67',
                    default: 'note67',
                    description: 'Play note 67 for duration'
                }),
                value:  play_note_beats.note67
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.68',
                    default: 'note68',
                    description: 'Play note 68 for duration'
                }),
                value:  play_note_beats.note68
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.69',
                    default: 'note69',
                    description: 'Play note 69 for duration'
                }),
                value:  play_note_beats.note69
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.70',
                    default: 'note70',
                    description: 'Play note 70 for duration'
                }),
                value:  play_note_beats.note70
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.71',
                    default: 'note71',
                    description: 'Play note 71 for duration'
                }),
                value:  play_note_beats.note71
            },
            {
                text: formatMessage({
                    id: 'Pingpongg1i.play_note_duration.72',
                    default: 'note72',
                    description: 'Play note 72 for duration'
                }),
                value:  play_note_beats.note72
            }
        ];
    }

    get CUBES(){
      return [
        {   text: formatMessage({
            id: 'pingpong.ONE',
            default: PingPongG4iCubes.ONE,
            description: '1'
            }),
            value: PingPongG4iCubes.ONE
        },
        {
          text: formatMessage({
              id: 'pingpong.TWO',
              default: PingPongG4iCubes.TWO,
              description: '2'
              }),
              value: PingPongG4iCubes.TWO
        },
        {
          text: formatMessage({
              id: 'pingpong.THREE',
              default: PingPongG4iCubes.THREE,
              description: '3'
              }),
              value: PingPongG4iCubes.THREE
        },
        {
          text: formatMessage({
              id: 'pingpong.FOUR',
              default: PingPongG4iCubes.FOUR,
              description: '4'
              }),
              value: PingPongG4iCubes.FOUR
        },
        {
          text: formatMessage({
              id: 'pingpong.ALL',
              default: PingPongG4iCubes.ALL,
              description: 'all'
              }),
              value: PingPongG4iCubes.ALL
        }
      ];
    }

    get BUTTONS_MENU() {
        return [
            {
                text: '1',
                value: PingPongG4IButtons.A
            },
            {
                text: '2',
                value: PingPongG4IButtons.B
            },
            {
                text: '3',
                value: PingPongG4IButtons.C
            },
            {
                text: '4',
                value: PingPongG4IButtons.D
            },
            {
                text: 'any',
                value: PingPongG4IButtons.ANY
            }
        ];
    }

    get SENSOR(){
        return [
            {   text: formatMessage({
                id: 'pingpongSensor.ADS',
                default: PingPongG4ISensorType.ADSENSOR,
                description: 'adsensor'
                }),
                value: PingPongG4ISensorType.ADSENSOR
            },
            {
              text: formatMessage({
                  id: 'pingpongSensor.PROX',
                  default: PingPongG4ISensorType.PROXIMITYS,
                  description: 'Proximity'
                  }),
                  value: PingPongG4ISensorType.PROXIMITYS
            }
        ];
    }

    get GESTURES_MENU() {
        return [
            {
                text: 'A',
                value: PingPongG4IButtons.A
            },
            {
                text: 'B',
                value: PingPongG4IButtons.B
            },
            {
                text: 'C',
                value: PingPongG4IButtons.C
            },
            {
                text: 'D',
                value: PingPongG4IButtons.C
            }
        ];
    }

    get UPPER_DIRECTION_MENU() {
        return [
            {
                text: formatMessage({
                    id: 'pingpongg1i.upperDirectionMenu.front',
                    default: 'rectangle',
                    description: 'label for front element in upper direction'
                }),
                value: PingPongG4IUpperDirection.FRONT
            },
            {
                text: formatMessage({
                    id: 'pingpongg1i.upperDirectionMenu.back',
                    default: 'star',
                    description: 'label for front element in upper direction'
                }),
                value: PingPongG4IUpperDirection.BACK
            },
            {
                text: formatMessage({
                    id: 'pingpongg1i.upperDirectionMenu.left',
                    default: 'triangle',
                    description: 'label for front element in upper direction'
                }),
                value: PingPongG4IUpperDirection.LEFT
            },
            {
                text: formatMessage({
                    id: 'pingpongg1i.upperDirectionMenu.right',
                    default: 'circle',
                    description: 'label for front element in upper direction'
                }),
                value: PingPongG4IUpperDirection.RIGHT
            },
            {
                text: formatMessage({
                    id: 'pingpongg1i.upperDirectionMenu.up',
                    default: 'heart',
                    description: 'label for front element in upper direction'
                }),
                value: PingPongG4IUpperDirection.UP
            },
            {
                text: formatMessage({
                    id: 'pingpongg1i.upperDirectionMenu.down',
                    default: 'none',
                    description: 'label for front element in upper direction'
                }),
                value: PingPongG4IUpperDirection.DOWN
            }
        ];
    }
    static get BEAT_RANGE () {
        return {min: 0, max: 40};
    }

    static get TEMPO_RANGE () {
        return {min: 20, max: 500};
    }

    constructor (runtime) {
        this.runtime = runtime;

        console.log("Scratch3PingPongG4iBlocks constructor called 001");

        // Create a new PingPongG4i peripheral instance
        this._peripheral = new PingPongG4i(this.runtime, Scratch3PingPongG4iBlocks.EXTENSION_ID);

        this.inActionC1C2C3C4 = false;
        console.log("Scratch3PingPongG4iBlocks constructor called 002");
    }

    /**
     * @returns {object} metadata for this extension and its blocks.
     */
    getInfo() {
        console.log("getinfo pingpong G4i called");
        return {
            id: Scratch3PingPongG4iBlocks.EXTENSION_ID,
            name: Scratch3PingPongG4iBlocks.EXTENSION_NAME,
            blockIconURI: blockIconURI,
            showStatusButton: true,
            blocks: [
              {
                  opcode: 'whenButtonPressed',
                  text: formatMessage({
                      id: 'pingpongg4i.whenButtonPressed',
                      default: '[BTN] 큐브의 버튼을 눌렀을때',
                      description: 'when the selected button on the cube is pressed'
                  }),
                  blockType: BlockType.HAT,
                  arguments: {
                      BTN: {
                          type: ArgumentType.STRING,
                          menu: 'buttons',
                          defaultValue: PingPongG4IButtons.A
                      }
                  }
              },
              {
                  opcode: 'whenTilted',
                  text: formatMessage({
                      id: 'pingpongg4i.isTilted',
                      default: '[BTN] 큐브가 [DIRECTION] 기울어 졌을때',
                      description: 'is the cube is tilted in a direction?'
                  }),
                  blockType: BlockType.HAT,
                  arguments: {
                      BTN: {
                          type: ArgumentType.STRING,
                          menu: 'buttons',
                          defaultValue: PingPongG4IButtons.A
                      },
                      DIRECTION: {
                          type: ArgumentType.STRING,
                          menu: 'tiltDirectionAny',
                          defaultValue: PingPongG4ITiltDirection.FRONT
                      }
                  }
              },
              {
                    opcode: 'motorall',
                    text: formatMessage({
                        id: 'pingpongg4i.motorall',
                        default: 'rotate motor1: [RADIUS1] degrees [LODIRECT1] motor2: [RADIUS2] degrees [LODIRECT2] motor3: [RADIUS3] degrees [LODIRECT3] motor4: [RADIUS4] degrees [LODIRECT4]',
                        description: 'is tilted in a direction?'
                    }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                        LODIRECT1: {
                            type: ArgumentType.STRING,
                            menu: 'lodirect',
                            defaultValue: PingPongG4ILoDirect.R
                        },
                        LODIRECT2: {
                            type: ArgumentType.STRING,
                            menu: 'lodirect',
                            defaultValue: PingPongG4ILoDirect.R
                        },
                        LODIRECT3: {
                            type: ArgumentType.STRING,
                            menu: 'lodirect',
                            defaultValue: PingPongG4ILoDirect.R
                        },
                        LODIRECT4: {
                            type: ArgumentType.STRING,
                            menu: 'lodirect',
                            defaultValue: PingPongG4ILoDirect.R
                        },
                        RADIUS1: {
                            type: ArgumentType.NUMBER,
                            defaultValue: simple_act_degreeradius.degree90
                        },
                        RADIUS2: {
                            type: ArgumentType.NUMBER,
                            defaultValue: simple_act_degreeradius.degree90
                        },
                        RADIUS3: {
                            type: ArgumentType.NUMBER,
                            defaultValue: simple_act_degreeradius.degree90
                        },
                        RADIUS4: {
                            type: ArgumentType.NUMBER,
                            defaultValue: simple_act_degreeradius.degree90
                        }

                    }
                },
                {
                    opcode: 'motorChoice',
                    text: formatMessage({
                        id: 'pingpongg4i.motorChoice',
                        default: 'rotate motor[CUBE]: [RADIUS] degrees [LODIRECT]',
                        description: 'move to radius'
                    }),
                    arguments: {
                        CUBE:{
                          type: ArgumentType.STRING,
                          menu: 'cubes',
                          defaultValue: PingPongG4iCubes.ONE
                        },
                        LODIRECT: {
                            type: ArgumentType.STRING,
                            menu: 'lodirect',
                            defaultValue: PingPongG4ILoDirect.R
                        },
                        RADIUS: {
                            type: ArgumentType.STRING,
                            defaultValue: simple_act_degreeradius.degree90
                        }
                    }
                },
                {
                    opcode: 'updownactC',
                    text: formatMessage({
                        id: 'pingpongg4i.updownactC',
                        default: 'set velocity to CUBE1: [SPEED1] CUBE2: [SPEED2] CUBE3:[SPEED3] CUBE4:[SPEED4]',
                        description: 'fldgo002'
                    }),
                    arguments: {
                        SPEED1: {
                            type: ArgumentType.STRING,
                            menu: 'updowncontinuous',
                            defaultValue: continuous_act_speed.speed100
                        },
                        SPEED2: {
                            type: ArgumentType.STRING,
                            menu: 'updowncontinuous',
                            defaultValue: continuous_act_speed.speed100
                        },
                        SPEED3: {
                            type: ArgumentType.STRING,
                            menu: 'updowncontinuous',
                            defaultValue: continuous_act_speed.speed100
                        },
                        SPEED4: {
                            type: ArgumentType.STRING,
                            menu: 'updowncontinuous',
                            defaultValue: continuous_act_speed.speed100
                        }
                    }
                },
                {
                    opcode: 'updownactCLA',
                    text: formatMessage({
                        id: 'pingpongg4i.updownactCLA',
                        default: 'set velocity to CUBE [CUBE]: [SPEED1]',
                        description: 'fldgo002'
                    }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                        CUBE: {
                          type: ArgumentType.STRING,
                          menu: 'cubes',
                          defaultValue: PingPongG4iCubes.ONE
                        },
                        SPEED1: {
                            type: ArgumentType.STRING,
                            menu: 'updowncontinuous',
                            defaultValue: continuous_act_speed.speed100
                        }
                    }
                },
                {
                  //rozen 11.07 ADD
                    opcode: 'stopMotors',
                    text: formatMessage({
                        id: 'pingpongg4i.allStop',
                        default: 'CUBE [CUBE] stop',
                        description: 'fldgo002'
                    }),
                    blockType: BlockType.COMMAND,
                    arguments:{
                      CUBE: {
                        type: ArgumentType.STRING,
                        menu: 'cubes',
                        defaultValue: PingPongG4iCubes.ONE
                      }
                    }
                },
                // fecan 2019.12.22 ADDED
                {
                    opcode: 'turnonoffLedMatrixPixelEach',
                    text: formatMessage({
                        id: 'pingpongg2i.displayPixelEach',
                        default: 'Led [TURNONOFF] CUBE [CUBE]  x: [COORDX] y: [COORDY]',
                        description: 'display a pixel for each cube'
                   }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                       TURNONOFF: {
                            type: ArgumentType.STRING,
                            menu: 'turnonoffpixels',
                            defaultValue: led_turn_onoff.on
                        }, 
                       CUBE: {
                            type: ArgumentType.STRING,
                            defaultValue: PingPongG4iCubes.ONE
                        },
                       COORDX: {
                            type: ArgumentType.NUMBER,
                            defaultValue: 0
                        },
                       COORDY: {
                             type: ArgumentType.NUMBER,
                             defaultValue: 0
                       }
                    }
                },
                {
                    opcode: 'displayLedMatrixStringDurationEach',
                    text: formatMessage({
                        id: 'pingpongg2i.displayStringDurationEach',
                        default: 'display text CUBE [CUBE]  [MSTRING] for  [MSECOND] second',
                        description: 'display string with duration value'
                   }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                      CUBE: {
                            type: ArgumentType.STRING,
                            defaultValue: PingPongG4iCubes.ONE
                        },
                      MSTRING: {
                           type: ArgumentType.STRING,
                           defaultValue: "Hello!"
                       },
                      MSECOND: {
                          type: ArgumentType.STRING,
                          defaultValue: "1"
                    }
                    }
                 },
                {
                    opcode: 'clearMatrixPixelsEach',
                    text: formatMessage({
                        id: 'pingpongg2i.clearPixelsEach',
                        default: 'clear CUBE [CUBE] display',
                        description: 'clear pixels'
                   }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                        CUBE: {
                            type: ArgumentType.STRING,
                            defaultValue: PingPongG4iCubes.ONE
                        }
                      }
                },
                {
                    opcode: 'setServoDegreeEach',
                    text: formatMessage({
                        id: 'pingpongg2i.setServoDegreeEach',
                        default: 'servo [CUBE]  motor angle  [SERVODEGREE]',
                        description: 'set servo degree'
                   }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                        CUBE: {
                            type: ArgumentType.STRING,
                            defaultValue: PingPongG4iCubes.ONE
                        },
                        SERVODEGREE: {
                             type: ArgumentType.STRING,
                             defaultValue: "0"
                         }
                    }
                },
                {
                    opcode: 'restForBeatsEach',
                    text: formatMessage({
                        id: 'pingpongg2i.restForBeatsEach',
                        default: 'cube [CUBE]  rest for [BEATS] beats',
                        description: 'rest (play no sound) for a number of beats'
                    }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                        CUBE: {
                            type: ArgumentType.STRING,
                            menu: "cubes",
                            defaultValue: PingPongG4iCubes.ONE
                        },
                        BEATS: {
                            type: ArgumentType.STRING,
                            defaultValue: "0.5"
                        }
                    }
                },
                /*
                {
                    opcode: 'restForBeatsAll',
                    text: formatMessage({
                        id: 'pingpongg2i.restForBeatsAll',
                        default: 'cube all rest for [BEATS] beats',
                        description: 'all cubes rest (play no sound) for a number of beats'
                    }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                        BEATS: {
                            type: ArgumentType.STRING,
                            defaultValue: "0.5"
                        }
                    }
                },
                */
                {
                    opcode: 'playNoteForBeatsEach',
                    text: formatMessage({
                        id: 'pingpongg2i.playNoteForBeatsEach',
                        default: 'cube [CUBE]  play note [NOTE] for [BEATS] beats',
                        description: 'play a note for a number of beats'
                    }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                        CUBE: {
                            type: ArgumentType.STRING,
                            menu: "cube",
                            defaultValue: PingPongG4iCubes.ONE
                        },
                        NOTE: {
                            type: ArgumentType.STRING,
                            menu: 'playmusicbeats',
                            defaultValue: play_note_beats.note48
                        },
                        BEATS: {
                            type: ArgumentType.STRING,
                            defaultValue: "1"
                        }
                    }
                },
                {
                    opcode: 'playChordForBeats',
                    text: formatMessage({
                        id: 'pingpongg2i.playChordForBeats',
                        default: 'cube [CUBE1] play [NOTE1] cube [CUBE2] play [NOTE2] cube [CUBE3] play [NOTE3] for [BEATS] beats',
                        description: 'play a chord note for a number of beats'
                    }),
                    blockType: BlockType.COMMAND,
                    arguments: {
                        CUBE1: {
                            type: ArgumentType.STRING,
                            menu: "cube",
                            defaultValue: PingPongG4iCubes.ONE
                        },
                        CUBE2: {
                            type: ArgumentType.STRING,
                            menu: "cube",
                            defaultValue: PingPongG4iCubes.TWO
                        },
                        CUBE3: {
                            type: ArgumentType.STRING,
                            menu: "cube",
                            defaultValue: PingPongG4iCubes.THREE
                        },
                        NOTE1: {
                            type: ArgumentType.STRING,
                            menu: 'playmusicbeats',
                            defaultValue: play_note_beats.note48
                        },
                        NOTE2: {
                            type: ArgumentType.STRING,
                            menu: 'playmusicbeats',
                            defaultValue: play_note_beats.note48
                        },
                        NOTE3: {
                            type: ArgumentType.STRING,
                            menu: 'playmusicbeats',
                            defaultValue: play_note_beats.note48
                        },
                        BEATS: {
                            type: ArgumentType.STRING,
                            defaultValue: "1"
                        }
                    }
                },
                {
                    opcode: 'setTempoEach',
                    blockType: BlockType.COMMAND,
                    text: formatMessage({
                        id: 'pingpongg2i.setTempoEach',
                        default: 'cube [CUBE]  set tempo to [TEMPO]',
                        description: 'set tempo (speed) for notes, drums, and rests played'
                    }),
                    arguments: {
                        CUBE: {
                            type: ArgumentType.STRING,
                            menu: "cube",
                            defaultValue: PingPongG4iCubes.ONE
                        },
                        TEMPO: {
                            type: ArgumentType.STRING,
                            defaultValue: "60"
                        }
                    }
                },
                {
                    opcode: 'isTilted',
                    text: formatMessage({
                        id: 'pingpongg4i.isTilted',
                        default: '큐브[BTN] 가(이) [DIRECTION]로(으로) 기울어 졌는가?',
                        description: 'is the cube is tilted in a direction?'
                    }),
                    blockType: BlockType.BOOLEAN,
                    arguments: {
                        BTN: {
                            type: ArgumentType.STRING,
                            menu: 'buttons',
                            defaultValue: PingPongG4IButtons.A
                        },
                        DIRECTION: {
                            type: ArgumentType.STRING,
                            menu: 'tiltDirectionAny',
                            defaultValue: PingPongG4ITiltDirection.FRONT
                        }
                    }
                },
                {
                    opcode: 'isUpper',
                    text: formatMessage({
                        id: 'pingpongg4i.isUpper',
                        default: 'cube [BTN] [DIRECTION] shown in top view?',
                        description: 'is the cube is upper in a direction?'
                    }),
                    blockType: BlockType.BOOLEAN,
                    arguments: {
                        BTN: {
                            type: ArgumentType.STRING,
                            menu: 'buttons',
                            defaultValue: PingPongG4IButtons.A
                        },
                        DIRECTION: {
                            type: ArgumentType.STRING,
                            menu: 'upperDirection',
                            defaultValue: PingPongG4IUpperDirection.FRONT
                        }
                    }
                },
                {
                    opcode: 'isButtonPressed',
                    text: formatMessage({
                        id: 'pingpongg4i.isButtonPressed',
                        default: '[BTN] 큐브의 버튼을 눌렀는가?',
                        description: 'is the button on the cube pressed?'
                    }),
                    blockType: BlockType.BOOLEAN,
                    arguments: {
                        BTN: {
                            type: ArgumentType.STRING,
                            menu: 'buttons',
                            defaultValue: PingPongG4IButtons.A
                        }
                    }
                },
                {
                    opcode: 'getGyroSensor',
                    text: formatMessage({
                        id: 'pingpongg4i.getGyroSensor',
                        default: 'tilt angle of cube[CUBE] to [DIRECTION]',
                        description: 'the value returned by the distance sensor'
                    }),
                    blockType: BlockType.REPORTER,
                    arguments:{
                        CUBE:{
                            type: ArgumentType.STRING,
                            menu: "cube",
                            defaultValue: PingPongG4iCube.ONE
                        },
                        DIRECTION:{
                          type: ArgumentType.STRING,
                          menu: 'tiltDirectionAny',
                          defaultValue: PingPongG4ITiltDirection.FRONT
                        }
                    }
                },
                {
                    opcode: 'getADSensorValueEach',
                    text: formatMessage({
                        id: 'pingpongg4i.getADSensorValueEach',
                        default: 'value of [CUBE]cube [SENSOR] sensor',
                        description: 'the value returned by the each external sensor'
                    }),
                    blockType: BlockType.REPORTER,
                    arguments:{
                        CUBE:{
                            type: ArgumentType.STRING,
                            menu: "cube",
                            defaultValue: PingPongG4iCubes.ONE
                        },
                        SENSOR:{
                            type: ArgumentType.STRING,
                            menu: "sensor",
                            defaultValue: PingPongG4ISensorType.PROXIMITYS
                        }
                    }               
                },
                // 2019.12.20 FecanRoborisen Add
                {
                    opcode: 'getTempoEach',
                    text: formatMessage({
                        id: 'pingpongg2i.getTempoEach',
                        default: 'cube [CUBE]  tempo',
                        description: 'get the current tempo (speed) for notes, drums, and rests played'
                    }),
                    blockType: BlockType.REPORTER,
                    arguments: {
                        CUBE: {
                            type: ArgumentType.STRING,
                            menu: "cube",
                            defaultValue: PingPongG4iCubes.ONE
                        }
                    }
                }
                
            ],
            menus: {
                lodirect: this.LODIRECT_MENU,
                tiltDirectionAny: this.TILT_DIRECTION_MENU,
                buttons: this.BUTTONS_MENU,
                cubes : this.CUBES,
                cube : this.CUBE,
                sensor : this.SENSOR,
                playmusicbeats: {
                    acceptReporters: true,
                    items: this.PLAY_MUSIC_BEATS
                },
                turnonoffpixels: {
                    acceptReporters: true,
                    items: this.TURN_ON_OFF,
                },
                updowncontinuous: this.UP_DOWN_CONTINUOUS,
                upperDirection:this.UPPER_DIRECTION_MENU
            }
        };
    }

    isUpper(args) {

        if (args.BTN == PingPongG4IButtons.A)
        {
            if (args.DIRECTION == PingPongG4IUpperDirection.FRONT) {
                if (this._peripheral._sensors.C1tiltY > 70)
                    return true;
            }

            if (args.DIRECTION == PingPongG4IUpperDirection.BACK) {
                if (this._peripheral._sensors.C1tiltY < -70)
                    return true;
            }

            if (args.DIRECTION == PingPongG4IUpperDirection.LEFT) {
                if (this._peripheral._sensors.C1tiltX < -70)
                    return true;
            }

            if (args.DIRECTION == PingPongG4IUpperDirection.RIGHT) {
                if (this._peripheral._sensors.C1tiltX > 70)
                    return true;
            }

            if (args.DIRECTION == PingPongG4IUpperDirection.UP) {
                if (this._peripheral._sensors.C1tiltZ < -70)
                    return true;
            }

            if (args.DIRECTION == PingPongG4IUpperDirection.DOWN) {
                if (this._peripheral._sensors.C1tiltZ > 70)
                    return true;
            }
        }

        if (args.BTN == PingPongG4IButtons.B)
        {
            if (args.DIRECTION == PingPongG4IUpperDirection.FRONT) {
                if (this._peripheral._sensors.C2tiltY > 70)
                    return true;
            }

            if (args.DIRECTION == PingPongG4IUpperDirection.BACK) {
                if (this._peripheral._sensors.C2tiltY < -70)
                    return true;
            }

            if (args.DIRECTION == PingPongG4IUpperDirection.LEFT) {
                if (this._peripheral._sensors.C2tiltX < -70)
                    return true;
            }

            if (args.DIRECTION == PingPongG4IUpperDirection.RIGHT) {
                if (this._peripheral._sensors.C2tiltX > 70)
                    return true;
            }

            if (args.DIRECTION == PingPongG4IUpperDirection.UP) {
                if (this._peripheral._sensors.C2tiltZ < -70)
                    return true;
            }

            if (args.DIRECTION == PingPongG4IUpperDirection.DOWN) {
                if (this._peripheral._sensors.C2tiltZ > 70)
                    return true;
            }
        }


        if (args.BTN == PingPongG4IButtons.C)
        {
            if (args.DIRECTION == PingPongG4IUpperDirection.FRONT) {
                if (this._peripheral._sensors.C3tiltY > 70)
                    return true;
            }

            if (args.DIRECTION == PingPongG4IUpperDirection.BACK) {
                if (this._peripheral._sensors.C3tiltY < -70)
                    return true;
            }

            if (args.DIRECTION == PingPongG4IUpperDirection.LEFT) {
                if (this._peripheral._sensors.C3tiltX < -70)
                    return true;
            }

            if (args.DIRECTION == PingPongG4IUpperDirection.RIGHT) {
                if (this._peripheral._sensors.C3tiltX > 70)
                    return true;
            }

            if (args.DIRECTION == PingPongG4IUpperDirection.UP) {
                if (this._peripheral._sensors.C3tiltZ < -70)
                    return true;
            }

            if (args.DIRECTION == PingPongG4IUpperDirection.DOWN) {
                if (this._peripheral._sensors.C3tiltZ > 70)
                    return true;
            }
        }

        if (args.BTN == PingPongG4IButtons.D)
        {
            if (args.DIRECTION == PingPongG4IUpperDirection.FRONT) {
                if (this._peripheral._sensors.C4tiltY > 70)
                    return true;
            }

            if (args.DIRECTION == PingPongG4IUpperDirection.BACK) {
                if (this._peripheral._sensors.C4tiltY < -70)
                    return true;
            }

            if (args.DIRECTION == PingPongG4IUpperDirection.LEFT) {
                if (this._peripheral._sensors.C4tiltX < -70)
                    return true;
            }

            if (args.DIRECTION == PingPongG4IUpperDirection.RIGHT) {
                if (this._peripheral._sensors.C4tiltX > 70)
                    return true;
            }

            if (args.DIRECTION == PingPongG4IUpperDirection.UP) {
                if (this._peripheral._sensors.C4tiltZ < -70)
                    return true;
            }

            if (args.DIRECTION == PingPongG4IUpperDirection.DOWN) {
                if (this._peripheral._sensors.C4tiltZ > 70)
                    return true;
            }
        }

        return false;
    }

    updownactC(args) {

        console.log("updownActC " + args.SPEED1 + " " + args.SPEED2);

        if (this._peripheral.AllConnected == false)
            return;

        var ContinuousData = new Array(4);
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, args.SPEED1);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, args.SPEED2);
        ContinuousData[2] = PingPongUtil.makeContinuousData(2, 0, args.SPEED3);
        ContinuousData[3] = PingPongUtil.makeContinuousData(3, 0, args.SPEED4);
        var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(ContinuousData, 4, 0);

        this._peripheral.send(OutPutData);
        this._peripheral.setWaitResponseOPCode(0xcd, 400);

        return new Promise(resolve => {
            setInterval(() => {
                resolve();
            }, 400);
        });
    }

    stopMotors(args) {
      var ContinuousData = new Array(4);

      if (this._peripheral.AllConnected == false)
          return;

      if(args.CUBE == PingPongG4iCubes.ALL){
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, 0);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, 0);
        ContinuousData[2] = PingPongUtil.makeContinuousData(2, 0, 0);
        ContinuousData[3] = PingPongUtil.makeContinuousData(3, 0, 0);
      }

      if(args.CUBE == PingPongG4iCubes.ONE){
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, 0);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, 1000);
        ContinuousData[2] = PingPongUtil.makeContinuousData(2, 0, 1000);
        ContinuousData[3] = PingPongUtil.makeContinuousData(3, 0, 1000);
        ContinuousData[1][6] = 0x00; // make dummy opcode
        ContinuousData[2][6] = 0x00; // make dummy opcode
        ContinuousData[3][6] = 0x00; // make dummy opcode
        //this._peripheral.send(ContinuousData);
      }

      if(args.CUBE == PingPongG4iCubes.TWO){
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, 1000);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, 0);
        ContinuousData[2] = PingPongUtil.makeContinuousData(2, 0, 1000);
        ContinuousData[3] = PingPongUtil.makeContinuousData(3, 0, 1000);
        ContinuousData[0][6] = 0x00; // make dummy opcode
        ContinuousData[2][6] = 0x00; // make dummy opcode
        ContinuousData[3][6] = 0x00; // make dummy opcode
      }

      if(args.CUBE == PingPongG4iCubes.THREE){
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, 1000);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, 1000);
        ContinuousData[2] = PingPongUtil.makeContinuousData(2, 0, 0);
        ContinuousData[3] = PingPongUtil.makeContinuousData(3, 0, 1000);
        ContinuousData[0][6] = 0x00; // make dummy opcode
        ContinuousData[1][6] = 0x00; // make dummy opcode
        ContinuousData[3][6] = 0x00; // make dummy opcode
      }
      if(args.CUBE == PingPongG4iCubes.FOUR){
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, 1000);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, 1000);
        ContinuousData[2] = PingPongUtil.makeContinuousData(2, 0, 1000);
        ContinuousData[3] = PingPongUtil.makeContinuousData(3, 0, 0);
        ContinuousData[0][6] = 0x00; // make dummy opcode
        ContinuousData[1][6] = 0x00; // make dummy opcode
        ContinuousData[2][6] = 0x00; // make dummy opcode
      }
      var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(ContinuousData, 4, 0);
      this._peripheral.send(OutPutData);
      this._peripheral.setWaitResponseOPCode(0xcd, 400);

      return new Promise(resolve => {
          setInterval(() => {
              resolve();
          }, 400);
      });
    }

    updownactCLA(args) {
      if (this._peripheral.AllConnected == false)
          return;
      var ContinuousData = new Array(4);
      if(args.CUBE == PingPongG4iCubes.ALL){
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, args.SPEED1);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, args.SPEED1);
        ContinuousData[2] = PingPongUtil.makeContinuousData(2, 0, args.SPEED1);
        ContinuousData[3] = PingPongUtil.makeContinuousData(3, 0, args.SPEED1);
      }

      if(args.CUBE == PingPongG4iCubes.ONE){
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, args.SPEED1);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, args.SPEED1);
        ContinuousData[2] = PingPongUtil.makeContinuousData(2, 0, args.SPEED1);
        ContinuousData[3] = PingPongUtil.makeContinuousData(3, 0, args.SPEED1);
        ContinuousData[1][6] = 0x00; // make dummy opcode
        ContinuousData[2][6] = 0x00; // make dummy opcode
        ContinuousData[3][6] = 0x00; // make dummy opcode
      }

      if(args.CUBE == PingPongG4iCubes.TWO){
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, args.SPEED1);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, args.SPEED1);
        ContinuousData[2] = PingPongUtil.makeContinuousData(2, 0, args.SPEED1);
        ContinuousData[3] = PingPongUtil.makeContinuousData(3, 0, args.SPEED1);
        ContinuousData[0][6] = 0x00; // make dummy opcode
        ContinuousData[2][6] = 0x00; // make dummy opcode
        ContinuousData[3][6] = 0x00; // make dummy opcode

      }
      if(args.CUBE == PingPongG4iCubes.THREE){
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, args.SPEED1);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, args.SPEED1);
        ContinuousData[2] = PingPongUtil.makeContinuousData(2, 0, args.SPEED1);
        ContinuousData[3] = PingPongUtil.makeContinuousData(3, 0, args.SPEED1);
        ContinuousData[0][6] = 0x00; // make dummy opcode
        ContinuousData[1][6] = 0x00; // make dummy opcode
        ContinuousData[3][6] = 0x00; // make dummy opcode
      }
      if(args.CUBE == PingPongG4iCubes.FOUR){
        ContinuousData[0] = PingPongUtil.makeContinuousData(0, 0, args.SPEED1);
        ContinuousData[1] = PingPongUtil.makeContinuousData(1, 0, args.SPEED1);
        ContinuousData[2] = PingPongUtil.makeContinuousData(2, 0, args.SPEED1);
        ContinuousData[3] = PingPongUtil.makeContinuousData(3, 0, args.SPEED1);
        ContinuousData[0][6] = 0x00; // make dummy opcode
        ContinuousData[1][6] = 0x00; // make dummy opcode
        ContinuousData[2][6] = 0x00; // make dummy opcode
      }
      var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(ContinuousData, 4, 0);
      this._peripheral.send(OutPutData);
      this._peripheral.setWaitResponseOPCode(0xcd, 400);
      /*
      return new Promise(resolve => {
          setInterval(() => {
              resolve();
          }, 400);
      });
      */
      return new Promise(resolve => {
        var repeat = setInterval(() => {
            this.inActionC1C2C3C4 = false;
            clearInterval(repeat);
            resolve();
        }, 400);
      });
    }

    motorall(args) {
        console.log("motorall ");

        if (this._peripheral.AllConnected == false)
            return;

        if (this.inActionC1C2C3C4 == true)
            return;

        var Speed1 = 800;
        var Speed2 = 800;
        var Speed3 = 800;
        var Speed4 = 800;

        this.inActionC1C2C3C4 = true;

        if (args.LODIRECT1 == PingPongG4ILoDirect.L) {
            Speed1 *= -1;
        }

        if (args.LODIRECT2 == PingPongG4ILoDirect.L) {
            Speed2 *= -1;
        }

        if (args.LODIRECT3 == PingPongG4ILoDirect.L) {
            Speed3 *= -1;
        }

        if (args.LODIRECT4 == PingPongG4ILoDirect.L) {
            Speed4 *= -1;
        }

        var Step1 = Math.round(args.RADIUS1 * 5.5);
        var Step2 = Math.round(args.RADIUS2 * 5.5);
        var Step3 = Math.round(args.RADIUS3 * 5.5);
        var Step4 = Math.round(args.RADIUS4 * 5.5);

        console.log(Speed1 + Speed2 + Speed3 + Speed4 + " " + args.RADIUS1 + " " + args.RADIUS2 + " " + args.RADIUS3 + " " + args.RADIUS4);

        var SinglesData = new Array(4);
        SinglesData[0] = PingPongUtil.makeSingleDataByStep(0, 0, Speed1, Step1);
        SinglesData[1] = PingPongUtil.makeSingleDataByStep(1, 0, Speed2, Step2);
        SinglesData[2] = PingPongUtil.makeSingleDataByStep(2, 0, Speed3, Step3);
        SinglesData[3] = PingPongUtil.makeSingleDataByStep(3, 0, Speed4, Step4);
        SinglesData[0][12] = 2; // make resume
        SinglesData[1][12] = 2; // make resume
        SinglesData[2][12] = 2; // make resume
        SinglesData[3][12] = 2; // make resume

        var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(SinglesData, 4, 1);

        var TimeDelay1 = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed1), Step1) + 400;

        var TimeDelay2 = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed2), Step2) + 400;

        var TimeDelay3 = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed3), Step3) + 400;

        var TimeDelay4 = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed4), Step4) + 400;


        var TimeDelay = TimeDelay1;

        if (TimeDelay2 > TimeDelay1)
            TimeDelay = TimeDelay2;

        if (TimeDelay3 > TimeDelay)
            TimeDelay = TimeDelay3;

        if (TimeDelay4 > TimeDelay)
            TimeDelay = TimeDelay4;

        this._peripheral.send(OutPutData);

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2C3C4 = false;
                clearInterval(repeat);
                resolve();
            }, TimeDelay);
        });
    }

    motorAllInOne(args) {
        console.log("motorall ");

        if (this._peripheral.AllConnected == false)
            return;

        if (this.inActionC1C2C3C4 == true)
            return;

        var Speed1 = 800;
        var Speed2 = 800;
        var Speed3 = 800;
        var Speed4 = 800;

        this.inActionC1C2C3C4 = true;

        if (args.LODIRECT == PingPongG4ILoDirect.L) {
            Speed1 *= -1;
        }

        if (args.LODIRECT == PingPongG4ILoDirect.L) {
            Speed2 *= -1;
        }

        if (args.LODIRECT == PingPongG4ILoDirect.L) {
            Speed3 *= -1;
        }

        if (args.LODIRECT == PingPongG4ILoDirect.L) {
            Speed4 *= -1;
        }

        var Step1 = Math.round(args.RADIUS * 5.5);
        var Step2 = Math.round(args.RADIUS * 5.5);
        var Step3 = Math.round(args.RADIUS * 5.5);
        var Step4 = Math.round(args.RADIUS * 5.5);

        console.log(Speed1 + Speed2 + Speed3 + Speed4 + " " + args.RADIUS + " " + args.RADIUS + " " + args.RADIUS + " " + args.RADIUS);

        var SinglesData = new Array(4);
        SinglesData[0] = PingPongUtil.makeSingleDataByStep(0, 0, Speed1, Step1);
        SinglesData[1] = PingPongUtil.makeSingleDataByStep(1, 0, Speed2, Step2);
        SinglesData[2] = PingPongUtil.makeSingleDataByStep(2, 0, Speed3, Step3);
        SinglesData[3] = PingPongUtil.makeSingleDataByStep(3, 0, Speed4, Step4);
        SinglesData[0][12] = 2; // make resume
        SinglesData[1][12] = 2; // make resume
        SinglesData[2][12] = 2; // make resume
        SinglesData[3][12] = 2; // make resume

        var OutPutData = PingPongUtil.makeAggregateStepsDataMultiRole(SinglesData, 4, 1);

        var TimeDelay1 = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed1), Step1) + 400;

        var TimeDelay2 = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed2), Step2) + 400;

        var TimeDelay3 = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed3), Step3) + 400;

        var TimeDelay4 = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed4), Step4) + 400;


        var TimeDelay = TimeDelay1;

        if (TimeDelay2 > TimeDelay1)
            TimeDelay = TimeDelay2;

        if (TimeDelay3 > TimeDelay)
            TimeDelay = TimeDelay3;

        if (TimeDelay4 > TimeDelay)
            TimeDelay = TimeDelay4;

        this._peripheral.send(OutPutData);

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2C3C4 = false;
                clearInterval(repeat);
                resolve();
            }, TimeDelay);
        });
    }

    motorChoice(args){
      if(args.CUBE == PingPongG4iCubes.ONE){
        this.motor1(args);
      }
      if(args.CUBE == PingPongG4iCubes.TWO){
        this.motor2(args);
      }
      if(args.CUBE == PingPongG4iCubes.THREE){
        this.motor3(args);
      }
      if(args.CUBE == PingPongG4iCubes.FOUR){
        this.motor4(args);
      }
      if(args.CUBE == PingPongG4iCubes.ALL){
        this.motorallInOne(args);
      }
      // branch function mode selection, pending
      return new Promise(resolve => {
        setInterval(() => {
            this.inActionC1C2C3C4 = false;
            resolve();
            console.log("TimeDelay  " + TimeDelay);
        }, TimeDelay);
      });
    }

    motor1(args) {
        console.log("motor1 ");
        if (this._peripheral.AllConnected == false)
            return;

        if (this.inActionC1C2C3C4 == true)
            return;

        var Speed = 800;

        this.inActionC1C2C3C4 = true;

        if (args.LODIRECT == PingPongG4ILoDirect.L) {
            Speed *= -1;
        }

        var Step = Math.round(args.RADIUS * 5.5);

        console.log(Speed + Step + " " + args.RADIUS + " " + args.RADIUS);

        var OutPutData = PingPongUtil.makeSingleDataByStep(0, 0, Speed, Step);
        OutPutData[12] = 2; // make resume

        TimeDelay = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed), Step) + 200

        this._peripheral.send(OutPutData);

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2C3C4 = false;
                clearInterval(repeat);
                resolve();
            }, TimeDelay);
        });
    }

    motor2(args) {
        console.log("motor2 ");

        if (this._peripheral.AllConnected == false)
            return;

        if (this.inActionC1C2C3C4 == true)
            return;

        var Speed = 800;

        this.inActionC1C2C3C4 = true;

        if (args.LODIRECT == PingPongG4ILoDirect.L) {
            Speed *= -1;
        }

        var Step = Math.round(args.RADIUS * 5.5);

        console.log(Speed + Step + " " + args.RADIUS + " " + args.RADIUS);

        var OutPutData = PingPongUtil.makeSingleDataByStep(1, 0, Speed, Step);
        OutPutData[12] = 2; // make resume

        TimeDelay = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed), Step) + 200

        this._peripheral.send(OutPutData);

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2C3C4 = false;
                clearInterval(repeat);
                resolve();
            }, TimeDelay);
        });
    }

    motor3(args) {
        console.log("motor3 ");

        if (this._peripheral.AllConnected == false)
            return;

        if (this.inActionC1C2C3C4 == true)
            return;

        var Speed = 800;

        this.inActionC1C2C3C4 = true;

        if (args.LODIRECT == PingPongG4ILoDirect.L) {
            Speed *= -1;
        }

        var Step = Math.round(args.RADIUS * 5.5);

        console.log(Speed + Step + " " + args.RADIUS + " " + args.RADIUS);

        var OutPutData = PingPongUtil.makeSingleDataByStep(2, 0, Speed, Step);
        OutPutData[12] = 2; // make resume

        TimeDelay = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed), Step) + 200

        this._peripheral.send(OutPutData);

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2C3C4 = false;
                clearInterval(repeat);
                resolve();
            }, TimeDelay);
        });
    }

    motor4(args) {

        console.log("motor4 ");

        if (this._peripheral.AllConnected == false)
            return;

        if (this.inActionC1C2C3C4 == true)
            return;

        var Speed = 800;

        this.inActionC1C2C3C4 = true;

        if (args.LODIRECT == PingPongG4ILoDirect.L) {
            Speed *= -1;
        }

        var Step = Math.round(args.RADIUS * 5.5);

        console.log(Speed + Step + " " + args.RADIUS + " " + args.RADIUS);

        var OutPutData = PingPongUtil.makeSingleDataByStep(3, 0, Speed, Step);
        OutPutData[12] = 2; // make resume

        TimeDelay = PingPongUtil.calculateTimeFromSPSSTEPS(Math.abs(Speed), Step) + 200

        this._peripheral.send(OutPutData);

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2C3C4 = false;
                clearInterval(repeat);
                resolve();
            }, TimeDelay);
        });
    }

    _isTiltedC1(direction) {
        return this._getTiltAngleC1(direction) >= Scratch3PingPongG4iBlocks.TILT_THRESHOLD;
    }
    _isTiltedC2(direction) {
        return this._getTiltAngleC2(direction) >= Scratch3PingPongG4iBlocks.TILT_THRESHOLD;
    }
    _isTiltedC3(direction) {
        return this._getTiltAngleC3(direction) >= Scratch3PingPongG4iBlocks.TILT_THRESHOLD;
    }
    _isTiltedC4(direction) {
        return this._getTiltAngleC4(direction) >= Scratch3PingPongG4iBlocks.TILT_THRESHOLD;
    }
    _isMovedC1(direction) {
        return this._getMoveC1(direction) >= Scratch3PingPongG4iBlocks.MOVE_THRESHOLD;
    }
    _isMovedC2(direction) {
        return this._getMoveC2(direction) >= Scratch3PingPongG4iBlocks.MOVE_THRESHOLD;
    }
    _isMovedC3(direction) {
        return this._getMoveC3(direction) >= Scratch3PingPongG4iBlocks.MOVE_THRESHOLD;
    }
    _isMovedC4(direction) {
        return this._getMoveC4(direction) >= Scratch3PingPongG4iBlocks.MOVE_THRESHOLD;
    }

    _getTiltAngle(direction) {
        switch (direction) {
            case PingPongG4ITiltDirection.FRONT:
                return Math.round(this._peripheral._sensors.C1tiltX * -1);
            case PingPongG4ITiltDirection.BACK:
                return Math.round(this._peripheral._sensors.C1tiltX);
            case PingPongG4ITiltDirection.LEFT:
                return Math.round(this._peripheral._sensors.C1tiltY * -1);
            case PingPongG4ITiltDirection.RIGHT:
                return Math.round(this._peripheral._sensors.C1tiltY);
            default:
                log.warn(`Unknown tilt direction in _getTiltAngle: ${direction}`);
        }
    }

    _getTiltAngleC1(direction) {
        switch (direction) {
            case PingPongG4ITiltDirection.FRONT:
                return Math.round(this._peripheral._sensors.C1tiltX * -1);
            case PingPongG4ITiltDirection.BACK:
                return Math.round(this._peripheral._sensors.C1tiltX);
            case PingPongG4ITiltDirection.LEFT:
                return Math.round(this._peripheral._sensors.C1tiltY * -1);
            case PingPongG4ITiltDirection.RIGHT:
                return Math.round(this._peripheral._sensors.C1tiltY);
            default:
                log.warn(`Unknown tilt direction in _getTiltAngle: ${direction}`);
        }
    }

    _getTiltAngleC2(direction) {
        switch (direction) {
            case PingPongG4ITiltDirection.FRONT:
                return Math.round(this._peripheral._sensors.C2tiltX * -1);
            case PingPongG4ITiltDirection.BACK:
                return Math.round(this._peripheral._sensors.C2tiltX);
            case PingPongG4ITiltDirection.LEFT:
                return Math.round(this._peripheral._sensors.C2tiltY * -1);
            case PingPongG4ITiltDirection.RIGHT:
                return Math.round(this._peripheral._sensors.C2tiltY);
            default:
                log.warn(`Unknown tilt direction in _getTiltAngle: ${direction}`);
        }
    }

    _getTiltAngleC3(direction) {
        switch (direction) {
            case PingPongG4ITiltDirection.FRONT:
                return Math.round(this._peripheral._sensors.C3tiltX * -1);
            case PingPongG4ITiltDirection.BACK:
                return Math.round(this._peripheral._sensors.C3tiltX);
            case PingPongG4ITiltDirection.LEFT:
                return Math.round(this._peripheral._sensors.C3tiltY * -1);
            case PingPongG4ITiltDirection.RIGHT:
                return Math.round(this._peripheral._sensors.C3tiltY);
            default:
                log.warn(`Unknown tilt direction in _getTiltAngle: ${direction}`);
        }
    }

    _getTiltAngleC4(direction) {
        switch (direction) {
            case PingPongG4ITiltDirection.FRONT:
                return Math.round(this._peripheral._sensors.C4tiltX * -1);
            case PingPongG4ITiltDirection.BACK:
                return Math.round(this._peripheral._sensors.C4tiltX);
            case PingPongG4ITiltDirection.LEFT:
                return Math.round(this._peripheral._sensors.C4tiltY * -1);
            case PingPongG4ITiltDirection.RIGHT:
                return Math.round(this._peripheral._sensors.C4tiltY);
            default:
                log.warn(`Unknown tilt direction in _getTiltAngle: ${direction}`);
        }
    }

    _getMoveC1(direction) {
        switch (direction) {
            case PingPongG4ITiltDirection.LEFT:
                return Math.round(this._peripheral._sensors.C1moveZ * -1);
            case PingPongG4ITiltDirection.RIGHT:
                return Math.round(this._peripheral._sensors.C1moveZ);
            default:
                log.warn(`Unknown tilt direction in _getTiltMove: ${direction}`);
        }
    }

    _getMoveC2(direction) {
        switch (direction) {
            case PingPongG4ITiltDirection.LEFT:
                return Math.round(this._peripheral._sensors.C2moveZ * -1);
            case PingPongG4ITiltDirection.RIGHT:
                return Math.round(this._peripheral._sensors.C2moveZ);
            default:
                log.warn(`Unknown tilt direction in _getTiltMove: ${direction}`);
        }
    }

    _getMoveC3(direction) {
        switch (direction) {
            case PingPongG4ITiltDirection.LEFT:
                return Math.round(this._peripheral._sensors.C3moveZ * -1);
            case PingPongG4ITiltDirection.RIGHT:
                return Math.round(this._peripheral._sensors.C3moveZ);
            default:
                log.warn(`Unknown tilt direction in _getTiltMove: ${direction}`);
        }
    }

    _getMoveC4(direction) {
        switch (direction) {
            case PingPongG4ITiltDirection.LEFT:
                return Math.round(this._peripheral._sensors.C4moveZ * -1);
            case PingPongG4ITiltDirection.RIGHT:
                return Math.round(this._peripheral._sensors.C4moveZ);
            default:
                log.warn(`Unknown tilt direction in _getTiltMove: ${direction}`);
        }
    }


    isTilted(args) {
        if (args.BTN === 'a') {
            return this._isTiltedC1(args.DIRECTION);
        } else if (args.BTN === 'b') {
            return this._isTiltedC2(args.DIRECTION);
        } else if (args.BTN === 'c') {
            return this._isTiltedC3(args.DIRECTION);
        }else if (args.BTN === 'd') {
            return this._isTiltedC4(args.DIRECTION);
        }
        return false;
    }


    whenTilted(args) {
        if (args.BTN === 'a') {
            return this._isTiltedC1(args.DIRECTION);
        } else if (args.BTN === 'b') {
            return this._isTiltedC2(args.DIRECTION);
        } else if (args.BTN === 'c') {
            return this._isTiltedC3(args.DIRECTION);
        } else if (args.BTN === 'd') {
            return this._isTiltedC4(args.DIRECTION);
        } else if (args.BTN === 'any') {

            if (this._isTiltedC1(args.DIRECTION) == true)
                return true;

            if (this._isTiltedC2(args.DIRECTION) == true)
                return true;

            if (this._isTiltedC3(args.DIRECTION) == true)
                return true;

            if (this._isTiltedC4(args.DIRECTION) == true)
                return true;
        }
        return false;
    }

    whenButtonPressed(args)
    {
        if (args.BTN === 'a') {
            if (this._peripheral._buttons.C1Button == 1)
                return true;
        } else if (args.BTN === 'b') {
            if (this._peripheral._buttons.C2Button == 1)
                return true;
        }else if (args.BTN === 'c') {
            if (this._peripheral._buttons.C3Button == 1)
                return true;
        }else if (args.BTN === 'd') {
            if (this._peripheral._buttons.C4Button == 1)
                return true;
        }else if (args.BTN === 'any') {
            if (this._peripheral._buttons.C1Button == 1 || this._peripheral._buttons.C2Button == 1 || this._peripheral._buttons.C3Button == 1 || this._peripheral._buttons.C4Button == 1)
                return true;
        }
        return false;
    }

    isButtonPressed(args) {
        if (args.BTN === 'a') {
            if (this._peripheral._buttons.C1Button == 1)
                return true;
        } else if (args.BTN === 'b') {
            if (this._peripheral._buttons.C2Button == 1)
                return true;
        } else if (args.BTN === 'c') {
            if (this._peripheral._buttons.C3Button == 1)
                return true;
        } else if (args.BTN === 'd') {
            if (this._peripheral._buttons.C4Button == 1)
                return true;
        } else if (args.BTN === 'any') {
            if (this._peripheral._buttons.C1Button == 1 || this._peripheral._buttons.C2Button == 1 || this._peripheral._buttons.C3Button == 1 || this._peripheral._buttons.C4Button == 1)
                return true;
        }
        return false;
    }

    // Display Maxtrix Pixel Each Cube, fecan 2019.12.22 ADDED 
    turnonoffLedMatrixPixelEach(args){
        if(this._peripheral.AllConnected == false)
        return;
        if (this.inActionC1C2C3C4 == true)
        return;

        this.inActionC1C2C3C4 = true;
        var MatrixLedPixelData = PingPongUtil.makeMatrixPixelData(0xe1, args.CUBE, args.COORDX, args.COORDY, args.TURNONOFF);
        this._peripheral.send(MatrixLedPixelData);

        console.log("Cube " + args.CUBE + "X  " + args.COORDX + " Y  " + args.COORDY);
        console.log("MatrixLedPixelData " + MatrixLedPixelData);
        
        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2C3C4 = false;
                clearInterval(repeat);
                resolve();
             }, 250);
        });
    }
    // Show Matrix String with duration for each Matrix
    displayLedMatrixStringDurationEach(args){
        if(this._peripheral.AllConnected == false)
          return;
        if (this.inActionC1C2C3C4 == true)
          return;
        
        this.inActionC1C2C3C4 = true;
  
        var MatrixLedStringData = PingPongUtil.makeMatrixStringData(0xe3, args.CUBE, args.MSTRING, args.MSECOND);
        this._peripheral.send(MatrixLedStringData);  
        console.log("MatrixLedStringData  " + MatrixLedStringData);
        var mDuration = args.MSECOND + 250;

        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2C3C4 = false;
                clearInterval(repeat);
                resolve();
                console.log("clearInterval ");
            }, mDuration);
          });
    }
    // clear Matrix Pixels
    clearMatrixPixelsEach(args){
        if(this._peripheral.AllConnected == false)
            return;
        if (this.inActionC1C2C3C4 == true)
            return;
        
        this.inActionC1C2C3C4 = true;

        var MatrixLedStringData = PingPongUtil.makeMatrixStringData(0xe3, args.CUBE, 0x00, 0x00);
        this._peripheral.send(MatrixLedStringData);

        console.log("MatrixLedStringData  " + MatrixLedStringData);
        
        return new Promise(resolve => {
            setInterval(() => {
                this.inActionC1C2C3C4 = false; // after command
                resolve();
            }, 200);
        });
    }
    // set Servo Degree
    setServoDegreeEach(args){
        if(this._peripheral.AllConnected == false)
        return;
        if (this.inActionC1C2C3C4 == true)
        return;

        this.inActionC1C2C3C4 = true;

        var ServoDegreeData = PingPongUtil.makeServoDegreeData(args.CUBE, args.SERVODEGREE);
        this._peripheral.send(ServoDegreeData);

        console.log("ServoDegreeData  " + ServoDegreeData);
        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2C3C4 = false;
                clearInterval(repeat);
                resolve();
                console.log("clearInterval ");
            }, 100);
        });
    }
    // play note for beats
    playNoteForBeatsEach(args){
        if(this._peripheral.AllConnected == false)
          return;
        if (this.inActionC1C2C3C4 == true)
          return;

        this.inActionC1C2C3C4 = true;
        beatsEach = this._clampBeats(args.BEATS);
        console.log("args.NOTE " + args.NOTE + " after Clamp(beats) " + beatsEach);
        durationSecEach = this._beatsToDuration(args, beatsEach); 
        console.log("durationSec  " + durationSecEach); 

        var PlayNoteBeatsEach = PingPongUtil.makePlayNoteData(args.CUBE, args.NOTE, durationSecEach, 1);
        console.log("PlayNoteBeats " + PlayNoteBeatsEach);
        this._peripheral.send(PlayNoteBeatsEach);
        
        TimeDelay = (durationSecEach * 10) + 50;
        
        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2C3C4 = false;
                clearInterval(repeat);
                resolve();
                console.log("clearInterval ");
            }, TimeDelay);
        });
    }

    // play chord note for beats
    playChordForBeats(args){
        if(this._peripheral.AllConnected == false)
          return;
        if (this.inActionC1C2C3C4 == true)
          return;

        this.inActionC1C2C3C4 = true;
        var beatsEach = this._clampBeats(args.BEATS);
        var durationSecEach = this._beatsToDuration(args, beatsEach);
        var cubeArray = new Array(args.CUBE1, args.CUBE2, args.CUBE3);
        var noteArray = new Array(args.NOTE1, args.NOTE2, args.NOTE3); 
        console.log("beatsEach " + beatsEach);
        var AggMusicNote = PingPongUtil.makeAggregateSetMusicNotes(cubeArray, noteArray, durationSecEach);
        console.log("PlayNoteBeats " + AggMusicNote);
        this._peripheral.send(AggMusicNote);
        
        TimeDelay = (durationSecEach * 10) + 30;
        
        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2C3C4 = false;
                clearInterval(repeat);
                resolve();
                console.log("clearInterval ");
            }, TimeDelay);
        });
    }
    /* rest for a number of beats with no sound
    restForBeats(args){
        if(this._peripheral.AllConnected == false)
          return;
        if (this.inActionC1C2C3C4 == true)
          return;

        this.inActionC1C2C3C4 = true;
        beats = this._clampBeats(args.BEATS);       
        durationSec = this._beatsToDuration(beats); 
        console.log("durationSec " + durationSec);   
        // var RestBeatsData = PingPongUtil.makePlayNoteData(0x00, 0x28, durationSec, 2);
        // this._peripheral.send(RestBeatsData);
        
        TimeDelay = (durationSec * 10) + 30;
        console.log("TimeDelay " + TimeDelay);
        //this._peripheral.setWaitResponseOPCode(0xe8, TimeDelay);
  
        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2C3C4 = false;
                clearInterval(repeat);
                resolve();
                console.log("clearInterval ");
            }, TimeDelay);
        });
    }
    */
    // rest for a number of beats with no sound
    restForBeatsEach(args){
        if(this._peripheral.AllConnected == false)
          return;
        if (this.inActionC1C2C3C4 == true)
          return;

        this.inActionC1C2C3C4 = true;
        beatsEach = this._clampBeats(args.BEATS);       
        durationSecEach = this._beatsToDuration(args, beatsEach); 
        console.log("durationSec " + durationSecEach);   
        // var RestBeatsDataEach = PingPongUtil.makePlayNoteData(args.CUBE, 0x28, durationSecEach, 2);
        // this._peripheral.send(RestBeatsDataEach);
        // console.log("RestBeatsData " + RestBeatsDataEach);

        TimeDelay = (durationSecEach * 10) + 30;
        
        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2C3C4 = false;
                clearInterval(repeat);
                resolve();
                console.log("clearInterval ");
            }, TimeDelay);
        });
    }
    // all cubes rest for a number of beats with no sound
    restForBeatsAll(args){
        if(this._peripheral.AllConnected == false)
          return;
        if (this.inActionC1C2C3 == true)
          return;

        this.inActionC1C2C3 = true;
        beatsEach = this._clampBeats(args.BEATS);       
        durationSecEach = this._beatsToDuration(args, beatsEach); 
        console.log("durationSec " + durationSecEach);   
        // var RestBeatsDataEach = PingPongUtil.makePlayNoteData(args.CUBE, 0x28, durationSecEach, 2);
        // console.log("RestBeatsData " + RestBeatsDataEach);
        // var cubeArray = new Array(1,2,3);
        // var noteArray = new Array(0x28, 0x28, 0x28);
        // var AggMusicNote = PingPongUtil.makeAggregateSetMusicNotes(cubeArray, noteArray, durationSecEach);
        // console.log("PlayNoteBeats " + AggMusicNote);
        // this._peripheral.send(AggMusicNote);
  
        TimeDelay = (durationSecEach * 10) + 30;
        
        return new Promise(resolve => {
            var repeat = setInterval(() => {
                this.inActionC1C2C3 = false;
                clearInterval(repeat);
                resolve();
                console.log("clearInterval ");
            }, TimeDelay);
        });
    }
      // set tempo (speed) for notes
    setTempoEach(args){
        var nCube = Number(args.CUBE) + 1
        if(this._peripheral.AllConnected == false)
          return;
        if (this.inActionC1C2C3C4 == true)
          return;

        this.inActionC1C2C3C4 = true;

        tempoEach = this._clampTempo(args.TEMPO);
        console.log("get Cube " + args.CUBE);
        
        if(nCube == PingPongG4iCubes.ONE){
            console.log("tempoEach " + tempoEach);
            this._peripheral._tempo.C1Tempo = tempoEach;
            console.log("CUBE  " + args.CUBE + "_clampTempo(after)  " + this._peripheral._tempo.C1Tempo);
        }

        if(nCube == PingPongG4iCubes.TWO){
            console.log("CUBE  " + args.CUBE + "_clampTempo(after)  " + this._peripheral._tempo.C2Tempo);
            this._peripheral._tempo.C2Tempo = tempoEach;
            // console.log("CUBE  " + args.CUBE + "_clampTempo(after)  " + this._peripheral._tempo.C2Tempo);
        }

        if(nCube == PingPongG4iCubes.THREE){
            console.log("CUBE  " + args.CUBE + "_clampTempo(after)  " + this._peripheral._tempo.C3Tempo);
            this._peripheral._tempo.C3Tempo = tempoEach;
            // console.log("CUBE  " + args.CUBE + "_clampTempo(after)  " + this._peripheral._tempo.C2Tempo);
        }

        if(nCube == PingPongG4iCubes.FOUR){
            console.log("CUBE  " + args.CUBE + "_clampTempo(after)  " + this._peripheral._tempo.C4Tempo);
            this._peripheral._tempo.C4Tempo = tempoEach;
            // console.log("CUBE  " + args.CUBE + "_clampTempo(after)  " + this._peripheral._tempo.C2Tempo);
        }
              
        return new Promise(resolve => {
          setInterval(() => {
              this.inActionC1C2C3C4 = false; 
              resolve();
          }, 200);
      });
    }
    // get tempo 
    getTempoEach(args) {
        if(typeof args.CUBE == 'undefined') {
            console.log("chord playing");
            return this._peripheral._tempo.C1Tempo;
        } 
        else 
        {
            var nCube = Number(args.CUBE) + 1;
            if(nCube == PingPongG4iCubes.ONE){
                // console.log("get CUBE  " + nCube + "_clampTempo(after)  " + args.TEMPO);
                return this._peripheral._tempo.C1Tempo;
            }

            if(nCube == PingPongG4iCubes.TWO){
                // console.log("get CUBE  " + nCube + "_clampTempo(after)  " + args.TEMPO);
                return this._peripheral._tempo.C2Tempo;
            }

            if(nCube == PingPongG4iCubes.THREE){
                // console.log("get CUBE  " + nCube + "_clampTempo(after)  " + args.TEMPO);
                return this._peripheral._tempo.C3Tempo;
            }

            if(nCube == PingPongG4iCubes.FOUR){
                // console.log("get CUBE  " + nCube + "_clampTempo(after)  " + args.TEMPO);
                return this._peripheral._tempo.C4Tempo;
            }
        
        }
    }
    getButtonC1() {
        //    console.log("getGyroX ");
        return this._peripheral._buttons.C1Button;
    }

    getButtonC2() {
        //    console.log("getGyroX ");
        return this._peripheral._buttons.C2Button;
    }

    getButtonC3() {
        //    console.log("getGyroX ");
        return this._peripheral._buttons.C3Button;
    }
    getButtonC4() {
        //    console.log("getGyroX ");
        return this._peripheral._buttons.C4Button;
    }

    getProxiC1Interval() {
        return this._peripheral._proximity.C1ProxInterVal;
    }
    getProxiC2Interval() {
        return this._peripheral._proximity.C2ProxInterVal;
    }
    getProxiC3Interval() {
        return this._peripheral._proximity.C3ProxInterVal;
    }
    getProxiC4Interval() {
        return this._peripheral._proximity.C4ProxInterVal;
    }
    getProxiC1() {
        //    console.log("getGyroX ");
        return this._peripheral._proximity.C1Prox;
    }
    getProxiC2() {
        //    console.log("getGyroX ");
        return this._peripheral._proximity.C2Prox;
    }
    getProxiC3() {
        //    console.log("getGyroX ");
        return this._peripheral._proximity.C3Prox;
    }
    getProxiC4() {
        //    console.log("getGyroX ");
        return this._peripheral._proximity.C4Prox;
    }
    getGyroXC1() {
        return this._peripheral._sensors.C1tiltX;
    }

    getGyroYC1() {
        return this._peripheral._sensors.C1tiltY;
    }

    getGyroZC1() {
        return this._peripheral._sensors.C1tiltZ;
    }

    getGyroXC2() {
        return this._peripheral._sensors.C2tiltX;
    }

    getGyroYC2() {
        return this._peripheral._sensors.C2tiltY;
    }

    getGyroZC2() {
        return this._peripheral._sensors.C2tiltZ;
    }

    getGyroXC3() {
        return this._peripheral._sensors.C3tiltX;
    }

    getGyroYC3() {
        return this._peripheral._sensors.C3tiltY;
    }

    getGyroZC3() {
        return this._peripheral._sensors.C3tiltZ;
    }

    getGyroXC4() {
        return this._peripheral._sensors.C4tiltX;
    }

    getGyroYC4() {
        return this._peripheral._sensors.C4tiltY;
    }

    getGyroZC4() {
        return this._peripheral._sensors.C4tiltZ;
    }


    getGyroSensor(args){

      if(args.CUBE == PingPongG4iCubes.ONE){
        console.log("Cube "+args.CUBE+"/"+args.DIRECTION);
        switch (args.DIRECTION) {
            case PingPongG4ITiltDirection.FRONT:
                return this.getGyroXCCircle1();
            case PingPongG4ITiltDirection.BACK:
                return this.getGyroXCTriangle1();
            case PingPongG4ITiltDirection.LEFT:
                return this.getGyroYCSquare1();
            case PingPongG4ITiltDirection.RIGHT:
              return this.getGyroYCStar1();
            default:
        }
      }

      if(args.CUBE == PingPongG4iCubes.TWO){
        switch (args.DIRECTION) {
            case PingPongG4ITiltDirection.FRONT:
                return this.getGyroXCCircle2();
            case PingPongG4ITiltDirection.BACK:
                return this.getGyroXCTriangle2();
            case PingPongG4ITiltDirection.LEFT:
                return this.getGyroYCSquare2();
            case PingPongG4ITiltDirection.RIGHT:
              return this.getGyroYCStar2();
            default:

        }
      }

      if(args.CUBE == PingPongG4iCubes.THREE){
        switch (args.DIRECTION) {
            case PingPongG4ITiltDirection.FRONT:
                return this.getGyroXCCircle3();
            case PingPongG4ITiltDirection.BACK:
                return this.getGyroXCTriangle3();
            case PingPongG4ITiltDirection.LEFT:
                return this.getGyroYCSquare3();
            case PingPongG4ITiltDirection.RIGHT:
              return this.getGyroYCStar3();
            default:
        }
      }

      if(args.CUBE == PingPongG4iCubes.FOUR){
        switch (args.DIRECTION) {
            case PingPongG4ITiltDirection.FRONT:
                return this.getGyroXCCircle4();
            case PingPongG4ITiltDirection.BACK:
                return this.getGyroXCTriangle4();
            case PingPongG4ITiltDirection.LEFT:
                return this.getGyroYCSquare4();
            case PingPongG4ITiltDirection.RIGHT:
              return this.getGyroYCStar4();
            default:
        }
      }
    }


    getGyroXCCircle1() {
        return this._peripheral._sensors.C1tiltX * -1;
    }

    getGyroXCTriangle1() {
        return this._peripheral._sensors.C1tiltX;
    }

    getGyroYCStar1() {
        return this._peripheral._sensors.C1tiltY;
    }

    getGyroYCSquare1() {
        return this._peripheral._sensors.C1tiltY * -1;
    }

    getGyroXCCircle2() {
        return this._peripheral._sensors.C2tiltX * -1;
    }

    getGyroXCTriangle2() {
        return this._peripheral._sensors.C2tiltX;
    }

    getGyroYCStar2() {
        return this._peripheral._sensors.C2tiltY;
    }

    getGyroYCSquare2() {
        return this._peripheral._sensors.C2tiltY * -1;
    }

    getGyroXCCircle3() {
        return this._peripheral._sensors.C3tiltX * -1;
    }

    getGyroXCTriangle3() {
        return this._peripheral._sensors.C3tiltX;
    }

    getGyroYCStar3() {
        return this._peripheral._sensors.C3tiltY;
    }
    getGyroYCSquare3() {
        return this._peripheral._sensors.C3tiltY * -1;
    }

    getGyroXCCircle4() {
        return this._peripheral._sensors.C4tiltX * -1;
    }

    getGyroXCTriangle4() {
        return this._peripheral._sensors.C4tiltX;
    }

    getGyroYCStar4() {
        return this._peripheral._sensors.C4tiltY;
    }
    getGyroYCSquare4() {
        return this._peripheral._sensors.C4tiltY * -1;
    }
    // 2019.12.20 Roborisen Added
    getADSensorValueEach(args){
        if(args.CUBE == PingPongG4iCubes.ONE){
            if(args.SENSOR == PingPongG4ISensorType.ADSENSOR){
                return this._peripheral._sensors.C1ADval;
            } else {
                return this._peripheral._proximity.C1Prox;
            }       
        }

        if(args.CUBE == PingPongG4iCubes.TWO){
            if(args.SENSOR == PingPongG4ISensorType.ADSENSOR){
                return this._peripheral._sensors.C2ADval;
            } else {
                return this._peripheral._proximity.C2Prox;
            }   
        }

        if(args.CUBE == PingPongG4iCubes.THREE){
            if(args.SENSOR == PingPongG4ISensorType.ADSENSOR){
                return this._peripheral._sensors.C3ADval;
            } else {
                return this._peripheral._proximity.C3Prox;
            } 
        }

        if(args.CUBE == PingPongG4iCubes.FOUR){
            if(args.SENSOR == PingPongG4ISensorType.ADSENSOR){
                return this._peripheral._sensors.C4ADval;
            } else {
                return this._peripheral._proximity.C4Prox;
            } 
        }
    }
    // beats X 100 = duration
    _beatsToDuration (args, beats) {
        console.log("get Tempo" + this.getTempoEach(args));
        var nDuration = Math.round(((60 / this.getTempoEach(args)) * beats) * 100);
        return nDuration;
    }

    // Clamp a duration in beats to the allowed min adn max duration
    _clampBeats (beats) {
        return MathUtil.clamp(beats, Scratch3PingPongG4iBlocks.BEAT_RANGE.min, Scratch3PingPongG4iBlocks.BEAT_RANGE.max);
    }

    // Clamp a duration in tempos to the allowed min adn max duration
    _clampTempo (tempo) {
        return MathUtil.clamp(tempo, Scratch3PingPongG4iBlocks.TEMPO_RANGE.min, Scratch3PingPongG4iBlocks.TEMPO_RANGE.max);
    }
}

module.exports = Scratch3PingPongG4iBlocks;
